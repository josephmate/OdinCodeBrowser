<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/styles.css"/>
    </head>
<body>
<pre class="code">
/*
 * Copyright (c) 1997, 2008, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */


/*
 * The Original Code is HAT. The Initial Developer of the
 * Original Code is Bill Foote, with contributions from others
 * at JavaSoft/Sun.
 */

package com.sun.tools.hat.internal.oql;

import com.sun.tools.hat.internal.model.*;
import java.io.*;
import java.lang.reflect.*;
import java.util.*;

/**
 * This is Object Query Language Interpreter
 *
 */
public class OQLEngine {
    static {
        try {
            // Do we have javax.script support?
            // create ScriptEngineManager
            Class&lt;?&gt; managerClass = Class.forName(&quot;javax.script.ScriptEngineManager&quot;);
            Object manager = managerClass.newInstance();

            // create JavaScript engine
            Method getEngineMethod = managerClass.getMethod(&quot;getEngineByName&quot;,
                                new Class[] { String.class });
            Object jse = getEngineMethod.invoke(manager, new Object[] {&quot;js&quot;});
            oqlSupported = (jse != null);
        } catch (Exception exp) {
            oqlSupported = false;
        }
    }

    // check OQL is supported or not before creating OQLEngine
    public static boolean isOQLSupported() {
        return oqlSupported;
    }

    public OQLEngine(Snapshot snapshot) {
        if (!isOQLSupported()) {
            throw new UnsupportedOperationException(&quot;OQL not supported&quot;);
        }
        init(snapshot);
    }

    /**
       Query is of the form

          select &amp;lt;java script code to select&amp;gt;
          [ from [instanceof] &amp;lt;class name&amp;gt; [&amp;lt;identifier&amp;gt;]
            [ where &amp;lt;java script boolean expression&amp;gt; ]
          ]
    */
    public synchronized void executeQuery(String query, ObjectVisitor visitor)
                                          throws OQLException {
        debugPrint(&quot;query : &quot; + query);
        StringTokenizer st = new StringTokenizer(query);
        if (st.hasMoreTokens()) {
            String first = st.nextToken();
            if (! first.equals(&quot;select&quot;) ) {
                // Query does not start with 'select' keyword.
                // Just treat it as plain JavaScript and eval it.
                try {
                    Object res = evalScript(query);
                    visitor.visit(res);
                } catch (Exception e) {
                    throw new OQLException(e);
                }
                return;
            }
        } else {
            throw new OQLException(&quot;query syntax error: no 'select' clause&quot;);
        }

        String selectExpr = &quot;&quot;;
        boolean seenFrom = false;
        while (st.hasMoreTokens()) {
            String tok = st.nextToken();
            if (tok.equals(&quot;from&quot;)) {
                seenFrom = true;
                break;
            }
            selectExpr += &quot; &quot; + tok;
        }

        if (selectExpr.equals(&quot;&quot;)) {
            throw new OQLException(&quot;query syntax error: 'select' expression can not be empty&quot;);
        }

        String className = null;
        boolean isInstanceOf = false;
        String whereExpr =  null;
        String identifier = null;

        if (seenFrom) {
            if (st.hasMoreTokens()) {
                String tmp = st.nextToken();
                if (tmp.equals(&quot;instanceof&quot;)) {
                    isInstanceOf = true;
                    if (! st.hasMoreTokens()) {
                        throw new OQLException(&quot;no class name after 'instanceof'&quot;);
                    }
                    className = st.nextToken();
                } else {
                    className = tmp;
                }
            } else {
                throw new OQLException(&quot;query syntax error: class name must follow 'from'&quot;);
            }

            if (st.hasMoreTokens()) {
                identifier = st.nextToken();
                if (identifier.equals(&quot;where&quot;)) {
                    throw new OQLException(&quot;query syntax error: identifier should follow class name&quot;);
                }
                if (st.hasMoreTokens()) {
                    String tmp = st.nextToken();
                    if (! tmp.equals(&quot;where&quot;)) {
                        throw new OQLException(&quot;query syntax error: 'where' clause expected after 'from' clause&quot;);
                    }

                    whereExpr = &quot;&quot;;
                    while (st.hasMoreTokens()) {
                        whereExpr += &quot; &quot; + st.nextToken();
                    }
                    if (whereExpr.equals(&quot;&quot;)) {
                        throw new OQLException(&quot;query syntax error: 'where' clause cannot have empty expression&quot;);
                    }
                }
            } else {
                throw new OQLException(&quot;query syntax error: identifier should follow class name&quot;);
            }
        }

        executeQuery(new OQLQuery(selectExpr, isInstanceOf, className,
                                  identifier, whereExpr), visitor);
    }

    private void executeQuery(OQLQuery q, ObjectVisitor visitor)
                              throws OQLException {
        JavaClass clazz = null;
        if (q.className != null) {
            clazz = snapshot.findClass(q.className);
            if (clazz == null) {
                throw new OQLException(q.className + &quot; is not found!&quot;);
            }
        }

        StringBuffer buf = new StringBuffer();
        buf.append(&quot;function __select__(&quot;);
        if (q.identifier != null) {
            buf.append(q.identifier);
        }
        buf.append(&quot;) { return &quot;);
        buf.append(q.selectExpr.replace('\n', ' '));
        buf.append(&quot;; }&quot;);

        String selectCode = buf.toString();
        debugPrint(selectCode);
        String whereCode = null;
        if (q.whereExpr != null) {
            buf = new StringBuffer();
            buf.append(&quot;function __where__(&quot;);
            buf.append(q.identifier);
            buf.append(&quot;) { return &quot;);
            buf.append(q.whereExpr.replace('\n', ' '));
            buf.append(&quot;; }&quot;);
            whereCode = buf.toString();
        }
        debugPrint(whereCode);

        // compile select expression and where condition
        try {
            evalMethod.invoke(engine, new Object[] { selectCode });
            if (whereCode != null) {
                evalMethod.invoke(engine, new Object[] { whereCode });
            }

            if (q.className != null) {
                Enumeration objects = clazz.getInstances(q.isInstanceOf);
                while (objects.hasMoreElements()) {
                    JavaHeapObject obj = (JavaHeapObject) objects.nextElement();
                    Object[] args = new Object[] { wrapJavaObject(obj) };
                    boolean b = (whereCode == null);
                    if (!b) {
                        Object res = call(&quot;__where__&quot;, args);
                        if (res instanceof Boolean) {
                            b = ((Boolean)res).booleanValue();
                        } else if (res instanceof Number) {
                            b = ((Number)res).intValue() != 0;
                        } else {
                            b = (res != null);
                        }
                    }

                    if (b) {
                        Object select = call(&quot;__select__&quot;, args);
                        if (visitor.visit(select)) return;
                    }
                }
            } else {
                // simple &quot;select &lt;expr&gt;&quot; query
                Object select = call(&quot;__select__&quot;, new Object[] {});
                visitor.visit(select);
            }
        } catch (Exception e) {
            throw new OQLException(e);
        }
    }

    public Object evalScript(String script) throws Exception {
        return evalMethod.invoke(engine, new Object[] { script });
    }

    public Object wrapJavaObject(JavaHeapObject obj) throws Exception {
        return call(&quot;wrapJavaObject&quot;, new Object[] { obj });
    }

    public Object toHtml(Object obj) throws Exception {
        return call(&quot;toHtml&quot;, new Object[] { obj });
    }

    public Object call(String func, Object[] args) throws Exception {
        return invokeMethod.invoke(engine, new Object[] { func, args });
    }

    private static void debugPrint(String msg) {
        if (debug) System.out.println(msg);
    }

    private void init(Snapshot snapshot) throws RuntimeException {
        this.snapshot = snapshot;
        try {
            // create ScriptEngineManager
            Class&lt;?&gt; managerClass = Class.forName(&quot;javax.script.ScriptEngineManager&quot;);
            Object manager = managerClass.newInstance();

            // create JavaScript engine
            Method getEngineMethod = managerClass.getMethod(&quot;getEngineByName&quot;,
                                new Class[] { String.class });
            engine = getEngineMethod.invoke(manager, new Object[] {&quot;js&quot;});

            // initialize engine with init file (hat.js)
            InputStream strm = getInitStream();
            Class&lt;?&gt; engineClass = Class.forName(&quot;javax.script.ScriptEngine&quot;);
            evalMethod = engineClass.getMethod(&quot;eval&quot;,
                                new Class[] { Reader.class });
            evalMethod.invoke(engine, new Object[] {new InputStreamReader(strm)});

            // initialize ScriptEngine.eval(String) and
            // Invocable.invokeFunction(String, Object[]) methods.
            Class&lt;?&gt; invocableClass = Class.forName(&quot;javax.script.Invocable&quot;);

            evalMethod = engineClass.getMethod(&quot;eval&quot;,
                                  new Class[] { String.class });
            invokeMethod = invocableClass.getMethod(&quot;invokeFunction&quot;,
                                  new Class[] { String.class, Object[].class });

            // initialize ScriptEngine.put(String, Object) method
            Method putMethod = engineClass.getMethod(&quot;put&quot;,
                                  new Class[] { String.class, Object.class });

            // call ScriptEngine.put to initialize built-in heap object
            putMethod.invoke(engine, new Object[] {
                        &quot;heap&quot;, call(&quot;wrapHeapSnapshot&quot;, new Object[] { snapshot })
                    });
        } catch (Exception e) {
            if (debug) e.printStackTrace();
            throw new RuntimeException(e);
        }
    }

    private InputStream getInitStream() {
        return getClass().getResourceAsStream(&quot;/com/sun/tools/hat/resources/hat.js&quot;);
    }

    private Object engine;
    private Method evalMethod;
    private Method invokeMethod;
    private Snapshot snapshot;
    private static boolean debug = false;
    private static boolean oqlSupported;
}
</pre>
</body>
</html>
