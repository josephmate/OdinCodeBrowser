<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/styles.css"/>
    </head>
<body>
<pre class="code">
/*
 * Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package com.sun.tools.attach.spi;

import java.io.IOException;
import java.util.Collections;
import java.util.Iterator;
import java.util.ArrayList;
import java.util.List;
import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.VirtualMachineDescriptor;
import com.sun.tools.attach.AttachPermission;
import com.sun.tools.attach.AttachNotSupportedException;
import java.util.ServiceLoader;

/**
 * Attach provider class for attaching to a Java virtual machine.
 *
 * &lt;p&gt; An attach provider is a concrete subclass of this class that has a
 * zero-argument constructor and implements the abstract methods specified
 * below. &lt;/p&gt;
 *
 * &lt;p&gt; An attach provider implementation is typically tied to a Java virtual
 * machine implementation, version, or even mode of operation. That is, a specific
 * provider implementation will typically only be capable of attaching to
 * a specific Java virtual machine implementation or version. For example, Sun's
 * JDK implementation ships with provider implementations that can only attach to
 * Sun's &lt;i&gt;HotSpot&lt;/i&gt; virtual machine. In general, if an environment
 * consists of Java virtual machines of different versions and from different
 * vendors then there will be an attach provider implementation for each
 * &lt;i&gt;family&lt;/i&gt; of implementations or versions. &lt;/p&gt;
 *
 * &lt;p&gt; An attach provider is identified by its {@link #name &lt;i&gt;name&lt;/i&gt;} and
 * {@link #type &lt;i&gt;type&lt;/i&gt;}. The &lt;i&gt;name&lt;/i&gt; is typically, but not required to
 * be, a name that corresponds to the VM vendor. The Sun JDK implementation,
 * for example, ships with attach providers that use the name &lt;i&gt;&quot;sun&quot;&lt;/i&gt;. The
 * &lt;i&gt;type&lt;/i&gt; typically corresponds to the attach mechanism. For example, an
 * implementation that uses the Doors inter-process communication mechanism
 * might use the type &lt;i&gt;&quot;doors&quot;&lt;/i&gt;. The purpose of the name and type is to
 * identify providers in environments where there are multiple providers
 * installed. &lt;/p&gt;
 *
 * &lt;p&gt; AttachProvider implementations are loaded and instantiated at the first
 * invocation of the {@link #providers() providers} method. This method
 * attempts to load all provider implementations that are installed on the
 * platform. &lt;/p&gt;
 *
 * &lt;p&gt; All of the methods in this class are safe for use by multiple
 * concurrent threads. &lt;/p&gt;
 *
 * @since 1.6
 */

@jdk.Exported
public abstract class AttachProvider {

    private static final Object lock = new Object();
    private static List&lt;AttachProvider&gt; providers = null;

    /**
     * Initializes a new instance of this class.  &lt;/p&gt;
     *
     * @throws  SecurityException
     *          If a security manager has been installed and it denies
     *          {@link com.sun.tools.attach.AttachPermission AttachPermission}
     *          &lt;tt&gt;(&quot;createAttachProvider&quot;)&lt;/tt&gt;
     */
    protected AttachProvider() {
        SecurityManager sm = System.getSecurityManager();
        if (sm != null)
            sm.checkPermission(new AttachPermission(&quot;createAttachProvider&quot;));
    }

    /**
     * Return this provider's name. &lt;/p&gt;
     *
     * @return  The name of this provider
     */
    public abstract String name();

    /**
     * Return this provider's type. &lt;/p&gt;
     *
     * @return  The type of this provider
     */
    public abstract String type();

    /**
     * Attaches to a Java virtual machine.
     *
     * &lt;p&gt; A Java virtual machine is identified by an abstract identifier. The
     * nature of this identifier is platform dependent but in many cases it will be the
     * string representation of the process identifier (or pid). &lt;/p&gt;
     *
     * &lt;p&gt; This method parses the identifier and maps the identifier to a Java
     * virtual machine (in an implementation dependent manner). If the identifier
     * cannot be parsed by the provider then an {@link
     * com.sun.tools.attach.AttachNotSupportedException AttachNotSupportedException}
     * is thrown. Once parsed this method attempts to attach to the Java virtual machine.
     * If the provider detects that the identifier corresponds to a Java virtual machine
     * that does not exist, or it corresponds to a Java virtual machine that does not support
     * the attach mechanism implemented by this provider, or it detects that the
     * Java virtual machine is a version to which this provider cannot attach, then
     * an &lt;code&gt;AttachNotSupportedException&lt;/code&gt; is thrown. &lt;/p&gt;
     *
     * @param  id
     *         The abstract identifier that identifies the Java virtual machine.
     *
     * @return  VirtualMachine representing the target virtual machine.
     *
     * @throws  SecurityException
     *          If a security manager has been installed and it denies
     *          {@link com.sun.tools.attach.AttachPermission AttachPermission}
     *          &lt;tt&gt;(&quot;attachVirtualMachine&quot;)&lt;/tt&gt;, or other permission
     *          required by the implementation.
     *
     * @throws  AttachNotSupportedException
     *          If the identifier cannot be parsed, or it corresponds to
     *          to a Java virtual machine that does not exist, or it
     *          corresponds to a Java virtual machine which this
     *          provider cannot attach.
     *
     * @throws  IOException
     *          If some other I/O error occurs
     *
     * @throws  NullPointerException
     *          If &lt;code&gt;id&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     */
    public abstract VirtualMachine attachVirtualMachine(String id)
        throws AttachNotSupportedException, IOException;

    /**
     * Attaches to a Java virtual machine.
     *
     * &lt;p&gt; A Java virtual machine can be described using a {@link
     * com.sun.tools.attach.VirtualMachineDescriptor VirtualMachineDescriptor}.
     * This method invokes the descriptor's {@link
     * com.sun.tools.attach.VirtualMachineDescriptor#provider() provider()} method
     * to check that it is equal to this provider. It then attempts to attach to the
     * Java virtual machine.
     *
     * @param  vmd
     *         The virtual machine descriptor
     *
     * @return  VirtualMachine representing the target virtual machine.
     *
     * @throws  SecurityException
     *          If a security manager has been installed and it denies
     *          {@link com.sun.tools.attach.AttachPermission AttachPermission}
     *          &lt;tt&gt;(&quot;attachVirtualMachine&quot;)&lt;/tt&gt;, or other permission
     *          required by the implementation.
     *
     * @throws  AttachNotSupportedException
     *          If the descriptor's {@link
     *          com.sun.tools.attach.VirtualMachineDescriptor#provider() provider()} method
     *          returns a provider that is not this provider, or it does not correspond
     *          to a Java virtual machine to which this provider can attach.
     *
     * @throws  IOException
     *          If some other I/O error occurs
     *
     * @throws  NullPointerException
     *          If &lt;code&gt;vmd&lt;/code&gt; is &lt;code&gt;null&lt;/code&gt;
     */
    public VirtualMachine attachVirtualMachine(VirtualMachineDescriptor vmd)
        throws AttachNotSupportedException, IOException
    {
        if (vmd.provider() != this) {
            throw new AttachNotSupportedException(&quot;provider mismatch&quot;);
        }
        return attachVirtualMachine(vmd.id());
    }

    /**
     * Lists the Java virtual machines known to this provider.
     *
     * &lt;p&gt; This method returns a list of {@link
     * com.sun.tools.attach.VirtualMachineDescriptor} elements. Each
     * &lt;code&gt;VirtualMachineDescriptor&lt;/code&gt; describes a Java virtual machine
     * to which this provider can &lt;i&gt;potentially&lt;/i&gt; attach.  There isn't any
     * guarantee that invoking {@link #attachVirtualMachine(VirtualMachineDescriptor)
     * attachVirtualMachine} on each descriptor in the list will succeed.
     *
     * @return  The list of virtual machine descriptors which describe the
     *          Java virtual machines known to this provider (may be empty).
     */
    public abstract List&lt;VirtualMachineDescriptor&gt; listVirtualMachines();


    /**
     * Returns a list of the installed attach providers.
     *
     * &lt;p&gt; An AttachProvider is installed on the platform if:
     *
     * &lt;ul&gt;
     *   &lt;li&gt;&lt;p&gt;It is installed in a JAR file that is visible to the defining
     *   class loader of the AttachProvider type (usually, but not required
     *   to be, the {@link java.lang.ClassLoader#getSystemClassLoader system
     *   class loader}).&lt;/p&gt;&lt;/li&gt;
     *
     *   &lt;li&gt;&lt;p&gt;The JAR file contains a provider configuration named
     *   &lt;tt&gt;com.sun.tools.attach.spi.AttachProvider&lt;/tt&gt; in the resource directory
     *   &lt;tt&gt;META-INF/services&lt;/tt&gt;. &lt;/p&gt;&lt;/li&gt;
     *
     *   &lt;li&gt;&lt;p&gt;The provider configuration file lists the full-qualified class
     *   name of the AttachProvider implementation. &lt;/p&gt;&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * &lt;p&gt; The format of the provider configuration file is one fully-qualified
     * class name per line. Space and tab characters surrounding each class name,
     * as well as blank lines are ignored. The comment character is
     *  &lt;tt&gt;'#'&lt;/tt&gt; (&lt;tt&gt;0x23&lt;/tt&gt;), and on each line all characters following
     * the first comment character are ignored. The file must be encoded in
     * UTF-8. &lt;/p&gt;
     *
     * &lt;p&gt; AttachProvider implementations are loaded and instantiated
     * (using the zero-arg constructor) at the first invocation of this method.
     * The list returned by the first invocation of this method is the list
     * of providers. Subsequent invocations of this method return a list of the same
     * providers. The list is unmodifable.&lt;/p&gt;
     *
     * @return  A list of the installed attach providers.
     */
    public static List&lt;AttachProvider&gt; providers() {
        synchronized (lock) {
            if (providers == null) {
                providers = new ArrayList&lt;AttachProvider&gt;();

                ServiceLoader&lt;AttachProvider&gt; providerLoader =
                    ServiceLoader.load(AttachProvider.class,
                                       AttachProvider.class.getClassLoader());

                Iterator&lt;AttachProvider&gt; i = providerLoader.iterator();

                while (i.hasNext()) {
                    try {
                        providers.add(i.next());
                    } catch (Throwable t) {
                        if (t instanceof ThreadDeath) {
                            ThreadDeath td = (ThreadDeath)t;
                            throw td;
                        }
                        // Ignore errors and exceptions
                        System.err.println(t);
                    }
                }
            }
            return Collections.unmodifiableList(providers);
        }
    }
}
</pre>
</body>
</html>
