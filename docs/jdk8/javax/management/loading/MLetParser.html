<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/styles.css"/>
    </head>
<body>
<pre class="code">
/*
 * Copyright (c) 1999, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package javax.management.loading;

import static com.sun.jmx.defaults.JmxProperties.MLET_LOGGER;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.Reader;
import java.net.URL;
import java.net.URLConnection;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.logging.Level;

/**
 * This class is used for parsing URLs.
 *
 * @since 1.5
 */
class MLetParser {

/*
  * ------------------------------------------
  *   PRIVATE VARIABLES
  * ------------------------------------------
  */

    /**
     * The current character
     */
    private int c;

    /**
     * Tag to parse.
     */
    private static String tag = &quot;mlet&quot;;


  /*
  * ------------------------------------------
  *   CONSTRUCTORS
  * ------------------------------------------
  */

    /**
     * Create an MLet parser object
     */
    public MLetParser() {
    }

    /*
     * ------------------------------------------
     *   PUBLIC METHODS
     * ------------------------------------------
     */

    /**
     * Scan spaces.
     */
    public void skipSpace(Reader in) throws IOException {
        while ((c &gt;= 0) &amp;&amp; ((c == ' ') || (c == '\t') || (c == '\n') || (c == '\r'))) {
            c = in.read();
        }
    }

    /**
     * Scan identifier
     */
    public String scanIdentifier(Reader in) throws IOException {
        StringBuilder buf = new StringBuilder();
        while (true) {
            if (((c &gt;= 'a') &amp;&amp; (c &lt;= 'z')) ||
                ((c &gt;= 'A') &amp;&amp; (c &lt;= 'Z')) ||
                ((c &gt;= '0') &amp;&amp; (c &lt;= '9')) || (c == '_')) {
                buf.append((char)c);
                c = in.read();
            } else {
                return buf.toString();
            }
        }
    }

    /**
     * Scan tag
     */
    public Map&lt;String,String&gt; scanTag(Reader in) throws IOException {
        Map&lt;String,String&gt; atts = new HashMap&lt;String,String&gt;();
        skipSpace(in);
        while (c &gt;= 0 &amp;&amp; c != '&gt;') {
            if (c == '&lt;')
                throw new IOException(&quot;Missing '&gt;' in tag&quot;);
            String att = scanIdentifier(in);
            String val = &quot;&quot;;
            skipSpace(in);
            if (c == '=') {
                int quote = -1;
                c = in.read();
                skipSpace(in);
                if ((c == '\'') || (c == '\&quot;')) {
                    quote = c;
                    c = in.read();
                }
                StringBuilder buf = new StringBuilder();
                while ((c &gt; 0) &amp;&amp;
                       (((quote &lt; 0) &amp;&amp; (c != ' ') &amp;&amp; (c != '\t') &amp;&amp;
                         (c != '\n') &amp;&amp; (c != '\r') &amp;&amp; (c != '&gt;'))
                        || ((quote &gt;= 0) &amp;&amp; (c != quote)))) {
                    buf.append((char)c);
                    c = in.read();
                }
                if (c == quote) {
                    c = in.read();
                }
                skipSpace(in);
                val = buf.toString();
            }
            atts.put(att.toLowerCase(), val);
            skipSpace(in);
        }
        return atts;
    }

    /**
     * Scan an html file for {@literal &lt;mlet&gt;} tags.
     */
    public List&lt;MLetContent&gt; parse(URL url) throws IOException {
        String mth = &quot;parse&quot;;
        // Warning Messages
        String requiresTypeWarning = &quot;&lt;arg type=... value=...&gt; tag requires type parameter.&quot;;
        String requiresValueWarning = &quot;&lt;arg type=... value=...&gt; tag requires value parameter.&quot;;
        String paramOutsideWarning = &quot;&lt;arg&gt; tag outside &lt;mlet&gt; ... &lt;/mlet&gt;.&quot;;
        String requiresCodeWarning = &quot;&lt;mlet&gt; tag requires either code or object parameter.&quot;;
        String requiresJarsWarning = &quot;&lt;mlet&gt; tag requires archive parameter.&quot;;

        URLConnection conn;

        conn = url.openConnection();
        Reader in = new BufferedReader(new InputStreamReader(conn.getInputStream(),
                                                             &quot;UTF-8&quot;));

        // The original URL may have been redirected - this
        // sets it to whatever URL/codebase we ended up getting
        //
        url = conn.getURL();

        List&lt;MLetContent&gt; mlets = new ArrayList&lt;MLetContent&gt;();
        Map&lt;String,String&gt; atts = null;

        List&lt;String&gt; types = new ArrayList&lt;String&gt;();
        List&lt;String&gt; values = new ArrayList&lt;String&gt;();

        // debug(&quot;parse&quot;,&quot;*** Parsing &quot; + url );
        while(true) {
            c = in.read();
            if (c == -1)
                break;
            if (c == '&lt;') {
                c = in.read();
                if (c == '/') {
                    c = in.read();
                    String nm = scanIdentifier(in);
                    if (c != '&gt;')
                        throw new IOException(&quot;Missing '&gt;' in tag&quot;);
                    if (nm.equalsIgnoreCase(tag)) {
                        if (atts != null) {
                            mlets.add(new MLetContent(url, atts, types, values));
                        }
                        atts = null;
                        types = new ArrayList&lt;String&gt;();
                        values = new ArrayList&lt;String&gt;();
                    }
                } else {
                    String nm = scanIdentifier(in);
                    if (nm.equalsIgnoreCase(&quot;arg&quot;)) {
                        Map&lt;String,String&gt; t = scanTag(in);
                        String att = t.get(&quot;type&quot;);
                        if (att == null) {
                            MLET_LOGGER.logp(Level.FINER,
                                    MLetParser.class.getName(),
                                    mth, requiresTypeWarning);
                            throw new IOException(requiresTypeWarning);
                        } else {
                            if (atts != null) {
                                types.add(att);
                            } else {
                                MLET_LOGGER.logp(Level.FINER,
                                        MLetParser.class.getName(),
                                        mth, paramOutsideWarning);
                                throw new IOException(paramOutsideWarning);
                            }
                        }
                        String val = t.get(&quot;value&quot;);
                        if (val == null) {
                            MLET_LOGGER.logp(Level.FINER,
                                    MLetParser.class.getName(),
                                    mth, requiresValueWarning);
                            throw new IOException(requiresValueWarning);
                        } else {
                            if (atts != null) {
                                values.add(val);
                            } else {
                                MLET_LOGGER.logp(Level.FINER,
                                        MLetParser.class.getName(),
                                        mth, paramOutsideWarning);
                                throw new IOException(paramOutsideWarning);
                            }
                        }
                    } else {
                        if (nm.equalsIgnoreCase(tag)) {
                            atts = scanTag(in);
                            if (atts.get(&quot;code&quot;) == null &amp;&amp; atts.get(&quot;object&quot;) == null) {
                                MLET_LOGGER.logp(Level.FINER,
                                        MLetParser.class.getName(),
                                        mth, requiresCodeWarning);
                                throw new IOException(requiresCodeWarning);
                            }
                            if (atts.get(&quot;archive&quot;) == null) {
                                MLET_LOGGER.logp(Level.FINER,
                                        MLetParser.class.getName(),
                                        mth, requiresJarsWarning);
                                throw new IOException(requiresJarsWarning);
                            }
                        }
                    }
                }
            }
        }
        in.close();
        return mlets;
    }

    /**
     * Parse the document pointed by the URL urlname
     */
    public List&lt;MLetContent&gt; parseURL(String urlname) throws IOException {
        // Parse the document
        //
        URL url;
        if (urlname.indexOf(':') &lt;= 1) {
            String userDir = System.getProperty(&quot;user.dir&quot;);
            String prot;
            if (userDir.charAt(0) == '/' ||
                userDir.charAt(0) == File.separatorChar) {
                prot = &quot;file:&quot;;
            } else {
                prot = &quot;file:/&quot;;
            }
            url =
                new URL(prot + userDir.replace(File.separatorChar, '/') + &quot;/&quot;);
            url = new URL(url, urlname);
        } else {
            url = new URL(urlname);
        }
        // Return list of parsed MLets
        //
        return parse(url);
    }

}
</pre>
</body>
</html>
