<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/styles.css"/>
    </head>
<body>
<table>
<tr>
<td><a class="linenum-cell" data-linenum="1" href="#"></a></td>
<td><pre>/*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2" href="#"></a></td>
<td><pre> * Copyright (c) 2008, 2013, Oracle and/or its affiliates. All rights reserved.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3" href="#"></a></td>
<td><pre> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="5" href="#"></a></td>
<td><pre> * This code is free software; you can redistribute it and/or modify it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="6" href="#"></a></td>
<td><pre> * under the terms of the GNU General Public License version 2 only, as</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="7" href="#"></a></td>
<td><pre> * published by the Free Software Foundation.  Oracle designates this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="8" href="#"></a></td>
<td><pre> * particular file as subject to the &quot;Classpath&quot; exception as provided</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="9" href="#"></a></td>
<td><pre> * by Oracle in the LICENSE file that accompanied this code.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="10" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="11" href="#"></a></td>
<td><pre> * This code is distributed in the hope that it will be useful, but WITHOUT</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="12" href="#"></a></td>
<td><pre> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="13" href="#"></a></td>
<td><pre> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="14" href="#"></a></td>
<td><pre> * version 2 for more details (a copy is included in the LICENSE file that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="15" href="#"></a></td>
<td><pre> * accompanied this code).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="16" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="17" href="#"></a></td>
<td><pre> * You should have received a copy of the GNU General Public License version</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="18" href="#"></a></td>
<td><pre> * 2 along with this work; if not, write to the Free Software Foundation,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="19" href="#"></a></td>
<td><pre> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="20" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="21" href="#"></a></td>
<td><pre> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="22" href="#"></a></td>
<td><pre> * or visit www.oracle.com if you need additional information or have any</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="23" href="#"></a></td>
<td><pre> * questions.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="24" href="#"></a></td>
<td><pre> */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="25" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="26" href="#"></a></td>
<td><pre>package sun.font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="27" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="28" href="#"></a></td>
<td><pre>import java.awt.Font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="29" href="#"></a></td>
<td><pre>import java.awt.FontFormatException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="30" href="#"></a></td>
<td><pre>import java.io.BufferedReader;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="31" href="#"></a></td>
<td><pre>import java.io.File;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="32" href="#"></a></td>
<td><pre>import java.io.FileInputStream;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="33" href="#"></a></td>
<td><pre>import java.io.FilenameFilter;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="34" href="#"></a></td>
<td><pre>import java.io.IOException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="35" href="#"></a></td>
<td><pre>import java.io.InputStreamReader;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="36" href="#"></a></td>
<td><pre>import java.security.AccessController;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="37" href="#"></a></td>
<td><pre>import java.security.PrivilegedAction;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="38" href="#"></a></td>
<td><pre>import java.util.ArrayList;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="39" href="#"></a></td>
<td><pre>import java.util.HashMap;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="40" href="#"></a></td>
<td><pre>import java.util.HashSet;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="41" href="#"></a></td>
<td><pre>import java.util.Hashtable;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="42" href="#"></a></td>
<td><pre>import java.util.Iterator;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="43" href="#"></a></td>
<td><pre>import java.util.Locale;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="44" href="#"></a></td>
<td><pre>import java.util.Map;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="45" href="#"></a></td>
<td><pre>import java.util.NoSuchElementException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="46" href="#"></a></td>
<td><pre>import java.util.StringTokenizer;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="47" href="#"></a></td>
<td><pre>import java.util.TreeMap;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="48" href="#"></a></td>
<td><pre>import java.util.Vector;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="49" href="#"></a></td>
<td><pre>import java.util.concurrent.ConcurrentHashMap;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="50" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="51" href="#"></a></td>
<td><pre>import javax.swing.plaf.FontUIResource;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="52" href="#"></a></td>
<td><pre>import sun.awt.AppContext;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="53" href="#"></a></td>
<td><pre>import sun.awt.FontConfiguration;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="54" href="#"></a></td>
<td><pre>import sun.awt.SunToolkit;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="55" href="#"></a></td>
<td><pre>import sun.java2d.FontSupport;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="56" href="#"></a></td>
<td><pre>import sun.util.logging.PlatformLogger;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="57" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="58" href="#"></a></td>
<td><pre>/**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="59" href="#"></a></td>
<td><pre> * The base implementation of the {@link FontManager} interface. It implements</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="60" href="#"></a></td>
<td><pre> * the platform independent, shared parts of OpenJDK's FontManager</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="61" href="#"></a></td>
<td><pre> * implementations. The platform specific parts are declared as abstract</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="62" href="#"></a></td>
<td><pre> * methods that have to be implemented by specific implementations.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="63" href="#"></a></td>
<td><pre> */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="64" href="#"></a></td>
<td><pre>public abstract class SunFontManager implements FontSupport, FontManagerForSGE {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="65" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="66" href="#"></a></td>
<td><pre>    private static class TTFilter implements FilenameFilter {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="67" href="#"></a></td>
<td><pre>        public boolean accept(File dir,String name) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="68" href="#"></a></td>
<td><pre>            /* all conveniently have the same suffix length */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="69" href="#"></a></td>
<td><pre>            int offset = name.length()-4;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="70" href="#"></a></td>
<td><pre>            if (offset &lt;= 0) { /* must be at least A.ttf */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="71" href="#"></a></td>
<td><pre>                return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="72" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="73" href="#"></a></td>
<td><pre>                return(name.startsWith(&quot;.ttf&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="74" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.TTF&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="75" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.ttc&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="76" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.TTC&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="77" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.otf&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="78" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.OTF&quot;, offset));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="79" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="80" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="81" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="82" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="83" href="#"></a></td>
<td><pre>    private static class T1Filter implements FilenameFilter {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="84" href="#"></a></td>
<td><pre>        public boolean accept(File dir,String name) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="85" href="#"></a></td>
<td><pre>            if (noType1Font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="86" href="#"></a></td>
<td><pre>                return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="87" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="88" href="#"></a></td>
<td><pre>            /* all conveniently have the same suffix length */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="89" href="#"></a></td>
<td><pre>            int offset = name.length()-4;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="90" href="#"></a></td>
<td><pre>            if (offset &lt;= 0) { /* must be at least A.pfa */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="91" href="#"></a></td>
<td><pre>                return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="92" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="93" href="#"></a></td>
<td><pre>                return(name.startsWith(&quot;.pfa&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="94" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.pfb&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="95" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.PFA&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="96" href="#"></a></td>
<td><pre>                       name.startsWith(&quot;.PFB&quot;, offset));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="97" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="98" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="99" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="100" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="101" href="#"></a></td>
<td><pre>     private static class TTorT1Filter implements FilenameFilter {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="102" href="#"></a></td>
<td><pre>        public boolean accept(File dir, String name) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="103" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="104" href="#"></a></td>
<td><pre>            /* all conveniently have the same suffix length */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="105" href="#"></a></td>
<td><pre>            int offset = name.length()-4;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="106" href="#"></a></td>
<td><pre>            if (offset &lt;= 0) { /* must be at least A.ttf or A.pfa */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="107" href="#"></a></td>
<td><pre>                return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="108" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="109" href="#"></a></td>
<td><pre>                boolean isTT =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="110" href="#"></a></td>
<td><pre>                    name.startsWith(&quot;.ttf&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="111" href="#"></a></td>
<td><pre>                    name.startsWith(&quot;.TTF&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="112" href="#"></a></td>
<td><pre>                    name.startsWith(&quot;.ttc&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="113" href="#"></a></td>
<td><pre>                    name.startsWith(&quot;.TTC&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="114" href="#"></a></td>
<td><pre>                    name.startsWith(&quot;.otf&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="115" href="#"></a></td>
<td><pre>                    name.startsWith(&quot;.OTF&quot;, offset);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="116" href="#"></a></td>
<td><pre>                if (isTT) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="117" href="#"></a></td>
<td><pre>                    return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="118" href="#"></a></td>
<td><pre>                } else if (noType1Font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="119" href="#"></a></td>
<td><pre>                    return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="120" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="121" href="#"></a></td>
<td><pre>                    return(name.startsWith(&quot;.pfa&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="122" href="#"></a></td>
<td><pre>                           name.startsWith(&quot;.pfb&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="123" href="#"></a></td>
<td><pre>                           name.startsWith(&quot;.PFA&quot;, offset) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="124" href="#"></a></td>
<td><pre>                           name.startsWith(&quot;.PFB&quot;, offset));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="125" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="126" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="127" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="128" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="129" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="130" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_NONE = -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="131" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_TRUETYPE = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="132" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_TYPE1 = 1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="133" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_T2K = 2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="134" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_TTC = 3;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="135" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_COMPOSITE = 4;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="136" href="#"></a></td>
<td><pre>     public static final int FONTFORMAT_NATIVE = 5;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="137" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="138" href="#"></a></td>
<td><pre>     /* Pool of 20 font file channels chosen because some UTF-8 locale</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="139" href="#"></a></td>
<td><pre>      * composite fonts can use up to 16 platform fonts (including the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="140" href="#"></a></td>
<td><pre>      * Lucida fall back). This should prevent channel thrashing when</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="141" href="#"></a></td>
<td><pre>      * dealing with one of these fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="142" href="#"></a></td>
<td><pre>      * The pool array stores the fonts, rather than directly referencing</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="143" href="#"></a></td>
<td><pre>      * the channels, as the font needs to do the open/close work.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="144" href="#"></a></td>
<td><pre>      */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="145" href="#"></a></td>
<td><pre>     // MACOSX begin -- need to access these in subclass</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="146" href="#"></a></td>
<td><pre>     protected static final int CHANNELPOOLSIZE = 20;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="147" href="#"></a></td>
<td><pre>     protected FileFont fontFileCache[] = new FileFont[CHANNELPOOLSIZE];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="148" href="#"></a></td>
<td><pre>     // MACOSX end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="149" href="#"></a></td>
<td><pre>     private int lastPoolIndex = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="150" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="151" href="#"></a></td>
<td><pre>    /* Need to implement a simple linked list scheme for fast</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="152" href="#"></a></td>
<td><pre>     * traversal and lookup.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="153" href="#"></a></td>
<td><pre>     * Also want to &quot;fast path&quot; dialog so there's minimal overhead.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="154" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="155" href="#"></a></td>
<td><pre>    /* There are at exactly 20 composite fonts: 5 faces (but some are not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="156" href="#"></a></td>
<td><pre>     * usually different), in 4 styles. The array may be auto-expanded</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="157" href="#"></a></td>
<td><pre>     * later if more are needed, eg for user-defined composites or locale</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="158" href="#"></a></td>
<td><pre>     * variants.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="159" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="160" href="#"></a></td>
<td><pre>    private int maxCompFont = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="161" href="#"></a></td>
<td><pre>    private CompositeFont [] compFonts = new CompositeFont[20];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="162" href="#"></a></td>
<td><pre>    private ConcurrentHashMap&lt;String, CompositeFont&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="163" href="#"></a></td>
<td><pre>        compositeFonts = new ConcurrentHashMap&lt;String, CompositeFont&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="164" href="#"></a></td>
<td><pre>    private ConcurrentHashMap&lt;String, PhysicalFont&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="165" href="#"></a></td>
<td><pre>        physicalFonts = new ConcurrentHashMap&lt;String, PhysicalFont&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="166" href="#"></a></td>
<td><pre>    private ConcurrentHashMap&lt;String, PhysicalFont&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="167" href="#"></a></td>
<td><pre>        registeredFonts = new ConcurrentHashMap&lt;String, PhysicalFont&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="168" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="169" href="#"></a></td>
<td><pre>    /* given a full name find the Font. Remind: there's duplication</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="170" href="#"></a></td>
<td><pre>     * here in that this contains the content of compositeFonts +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="171" href="#"></a></td>
<td><pre>     * physicalFonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="172" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="173" href="#"></a></td>
<td><pre>    // MACOSX begin -- need to access this in subclass</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="174" href="#"></a></td>
<td><pre>    protected ConcurrentHashMap&lt;String, Font2D&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="175" href="#"></a></td>
<td><pre>        fullNameToFont = new ConcurrentHashMap&lt;String, Font2D&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="176" href="#"></a></td>
<td><pre>    // MACOSX end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="177" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="178" href="#"></a></td>
<td><pre>    /* TrueType fonts have localised names. Support searching all</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="179" href="#"></a></td>
<td><pre>     * of these before giving up on a name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="180" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="181" href="#"></a></td>
<td><pre>    private HashMap&lt;String, TrueTypeFont&gt; localeFullNamesToFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="182" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="183" href="#"></a></td>
<td><pre>    private PhysicalFont defaultPhysicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="184" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="185" href="#"></a></td>
<td><pre>    static boolean longAddresses;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="186" href="#"></a></td>
<td><pre>    private boolean loaded1dot0Fonts = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="187" href="#"></a></td>
<td><pre>    boolean loadedAllFonts = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="188" href="#"></a></td>
<td><pre>    boolean loadedAllFontFiles = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="189" href="#"></a></td>
<td><pre>    HashMap&lt;String,String&gt; jreFontMap;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="190" href="#"></a></td>
<td><pre>    HashSet&lt;String&gt; jreLucidaFontFiles;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="191" href="#"></a></td>
<td><pre>    String[] jreOtherFontFiles;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="192" href="#"></a></td>
<td><pre>    boolean noOtherJREFontFiles = false; // initial assumption.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="193" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="194" href="#"></a></td>
<td><pre>    public static final String lucidaFontName = &quot;Lucida Sans Regular&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="195" href="#"></a></td>
<td><pre>    public static String jreLibDirName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="196" href="#"></a></td>
<td><pre>    public static String jreFontDirName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="197" href="#"></a></td>
<td><pre>    private static HashSet&lt;String&gt; missingFontFiles = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="198" href="#"></a></td>
<td><pre>    private String defaultFontName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="199" href="#"></a></td>
<td><pre>    private String defaultFontFileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="200" href="#"></a></td>
<td><pre>    protected HashSet registeredFontFiles = new HashSet();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="201" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="202" href="#"></a></td>
<td><pre>    private ArrayList badFonts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="203" href="#"></a></td>
<td><pre>    /* fontPath is the location of all fonts on the system, excluding the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="204" href="#"></a></td>
<td><pre>     * JRE's own font directory but including any path specified using the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="205" href="#"></a></td>
<td><pre>     * sun.java2d.fontpath property. Together with that property,  it is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="206" href="#"></a></td>
<td><pre>     * initialised by the getPlatformFontPath() method</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="207" href="#"></a></td>
<td><pre>     * This call must be followed by a call to registerFontDirs(fontPath)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="208" href="#"></a></td>
<td><pre>     * once any extra debugging path has been appended.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="209" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="210" href="#"></a></td>
<td><pre>    protected String fontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="211" href="#"></a></td>
<td><pre>    private FontConfiguration fontConfig;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="212" href="#"></a></td>
<td><pre>    /* discoveredAllFonts is set to true when all fonts on the font path are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="213" href="#"></a></td>
<td><pre>     * discovered. This usually also implies opening, validating and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="214" href="#"></a></td>
<td><pre>     * registering, but an implementation may be optimized to avold this.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="215" href="#"></a></td>
<td><pre>     * So see also &quot;loadedAllFontFiles&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="216" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="217" href="#"></a></td>
<td><pre>    private boolean discoveredAllFonts = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="218" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="219" href="#"></a></td>
<td><pre>    /* No need to keep consing up new instances - reuse a singleton.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="220" href="#"></a></td>
<td><pre>     * The trade-off is that these objects don't get GC'd.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="221" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="222" href="#"></a></td>
<td><pre>    private static final FilenameFilter ttFilter = new TTFilter();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="223" href="#"></a></td>
<td><pre>    private static final FilenameFilter t1Filter = new T1Filter();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="224" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="225" href="#"></a></td>
<td><pre>    private Font[] allFonts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="226" href="#"></a></td>
<td><pre>    private String[] allFamilies; // cache for default locale only</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="227" href="#"></a></td>
<td><pre>    private Locale lastDefaultLocale;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="228" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="229" href="#"></a></td>
<td><pre>    public static boolean noType1Font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="230" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="231" href="#"></a></td>
<td><pre>    /* Used to indicate required return type from toArray(..); */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="232" href="#"></a></td>
<td><pre>    private static String[] STR_ARRAY = new String[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="233" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="234" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="235" href="#"></a></td>
<td><pre>     * Deprecated, unsupported hack - actually invokes a bug!</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="236" href="#"></a></td>
<td><pre>     * Left in for a customer, don't remove.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="237" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="238" href="#"></a></td>
<td><pre>    private boolean usePlatformFontMetrics = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="239" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="240" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="241" href="#"></a></td>
<td><pre>     * Returns the global SunFontManager instance. This is similar to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="242" href="#"></a></td>
<td><pre>     * {@link FontManagerFactory#getInstance()} but it returns a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="243" href="#"></a></td>
<td><pre>     * SunFontManager instance instead. This is only used in internal classes</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="244" href="#"></a></td>
<td><pre>     * where we can safely assume that a SunFontManager is to be used.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="245" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="246" href="#"></a></td>
<td><pre>     * @return the global SunFontManager instance</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="247" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="248" href="#"></a></td>
<td><pre>    public static SunFontManager getInstance() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="249" href="#"></a></td>
<td><pre>        FontManager fm = FontManagerFactory.getInstance();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="250" href="#"></a></td>
<td><pre>        return (SunFontManager) fm;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="251" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="252" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="253" href="#"></a></td>
<td><pre>    public FilenameFilter getTrueTypeFilter() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="254" href="#"></a></td>
<td><pre>        return ttFilter;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="255" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="256" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="257" href="#"></a></td>
<td><pre>    public FilenameFilter getType1Filter() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="258" href="#"></a></td>
<td><pre>        return t1Filter;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="259" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="260" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="261" href="#"></a></td>
<td><pre>    @Override</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="262" href="#"></a></td>
<td><pre>    public boolean usingPerAppContextComposites() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="263" href="#"></a></td>
<td><pre>        return _usingPerAppContextComposites;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="264" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="265" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="266" href="#"></a></td>
<td><pre>    private void initJREFontMap() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="267" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="268" href="#"></a></td>
<td><pre>        /* Key is familyname+style value as an int.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="269" href="#"></a></td>
<td><pre>         * Value is filename containing the font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="270" href="#"></a></td>
<td><pre>         * If no mapping exists, it means there is no font file for the style</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="271" href="#"></a></td>
<td><pre>         * If the mapping exists but the file doesn't exist in the deferred</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="272" href="#"></a></td>
<td><pre>         * list then it means its not installed.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="273" href="#"></a></td>
<td><pre>         * This looks like a lot of code and strings but if it saves even</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="274" href="#"></a></td>
<td><pre>         * a single file being opened at JRE start-up there's a big payoff.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="275" href="#"></a></td>
<td><pre>         * Lucida Sans is probably the only important case as the others</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="276" href="#"></a></td>
<td><pre>         * are rarely used. Consider removing the other mappings if there's</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="277" href="#"></a></td>
<td><pre>         * no evidence they are useful in practice.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="278" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="279" href="#"></a></td>
<td><pre>        jreFontMap = new HashMap&lt;String,String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="280" href="#"></a></td>
<td><pre>        jreLucidaFontFiles = new HashSet&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="281" href="#"></a></td>
<td><pre>        if (isOpenJDK()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="282" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="283" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="284" href="#"></a></td>
<td><pre>        /* Lucida Sans Family */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="285" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans0&quot;,   &quot;LucidaSansRegular.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="286" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans1&quot;,   &quot;LucidaSansDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="287" href="#"></a></td>
<td><pre>        /* Lucida Sans full names (map Bold and DemiBold to same file) */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="288" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans regular0&quot;, &quot;LucidaSansRegular.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="289" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans regular1&quot;, &quot;LucidaSansDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="290" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans bold1&quot;, &quot;LucidaSansDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="291" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans demibold1&quot;, &quot;LucidaSansDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="292" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="293" href="#"></a></td>
<td><pre>        /* Lucida Sans Typewriter Family */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="294" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans typewriter0&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="295" href="#"></a></td>
<td><pre>                       &quot;LucidaTypewriterRegular.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="296" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans typewriter1&quot;, &quot;LucidaTypewriterBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="297" href="#"></a></td>
<td><pre>        /* Typewriter full names (map Bold and DemiBold to same file) */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="298" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans typewriter regular0&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="299" href="#"></a></td>
<td><pre>                       &quot;LucidaTypewriter.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="300" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans typewriter regular1&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="301" href="#"></a></td>
<td><pre>                       &quot;LucidaTypewriterBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="302" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans typewriter bold1&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="303" href="#"></a></td>
<td><pre>                       &quot;LucidaTypewriterBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="304" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida sans typewriter demibold1&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="305" href="#"></a></td>
<td><pre>                       &quot;LucidaTypewriterBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="306" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="307" href="#"></a></td>
<td><pre>        /* Lucida Bright Family */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="308" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright0&quot;, &quot;LucidaBrightRegular.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="309" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright1&quot;, &quot;LucidaBrightDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="310" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright2&quot;, &quot;LucidaBrightItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="311" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright3&quot;, &quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="312" href="#"></a></td>
<td><pre>        /* Lucida Bright full names (map Bold and DemiBold to same file) */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="313" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright regular0&quot;, &quot;LucidaBrightRegular.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="314" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright regular1&quot;, &quot;LucidaBrightDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="315" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright regular2&quot;, &quot;LucidaBrightItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="316" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright regular3&quot;, &quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="317" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright bold1&quot;, &quot;LucidaBrightDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="318" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright bold3&quot;, &quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="319" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright demibold1&quot;, &quot;LucidaBrightDemiBold.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="320" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright demibold3&quot;,&quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="321" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright italic2&quot;, &quot;LucidaBrightItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="322" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright italic3&quot;, &quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="323" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright bold italic3&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="324" href="#"></a></td>
<td><pre>                       &quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="325" href="#"></a></td>
<td><pre>        jreFontMap.put(&quot;lucida bright demibold italic3&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="326" href="#"></a></td>
<td><pre>                       &quot;LucidaBrightDemiItalic.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="327" href="#"></a></td>
<td><pre>        for (String ffile : jreFontMap.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="328" href="#"></a></td>
<td><pre>            jreLucidaFontFiles.add(ffile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="329" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="330" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="331" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="332" href="#"></a></td>
<td><pre>    static {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="333" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="334" href="#"></a></td>
<td><pre>        java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="335" href="#"></a></td>
<td><pre>                                    new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="336" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="337" href="#"></a></td>
<td><pre>           public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="338" href="#"></a></td>
<td><pre>               FontManagerNativeLibrary.load();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="339" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="340" href="#"></a></td>
<td><pre>               // JNI throws an exception if a class/method/field is not found,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="341" href="#"></a></td>
<td><pre>               // so there's no need to do anything explicit here.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="342" href="#"></a></td>
<td><pre>               initIDs();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="343" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="344" href="#"></a></td>
<td><pre>               switch (StrikeCache.nativeAddressSize) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="345" href="#"></a></td>
<td><pre>               case 8: longAddresses = true; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="346" href="#"></a></td>
<td><pre>               case 4: longAddresses = false; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="347" href="#"></a></td>
<td><pre>               default: throw new RuntimeException(&quot;Unexpected address size&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="348" href="#"></a></td>
<td><pre>               }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="349" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="350" href="#"></a></td>
<td><pre>               noType1Font =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="351" href="#"></a></td>
<td><pre>                   &quot;true&quot;.equals(System.getProperty(&quot;sun.java2d.noType1Font&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="352" href="#"></a></td>
<td><pre>               jreLibDirName =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="353" href="#"></a></td>
<td><pre>                   System.getProperty(&quot;java.home&quot;,&quot;&quot;) + File.separator + &quot;lib&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="354" href="#"></a></td>
<td><pre>               jreFontDirName = jreLibDirName + File.separator + &quot;fonts&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="355" href="#"></a></td>
<td><pre>               File lucidaFile =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="356" href="#"></a></td>
<td><pre>                   new File(jreFontDirName + File.separator + FontUtilities.LUCIDA_FILE_NAME);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="357" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="358" href="#"></a></td>
<td><pre>               return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="359" href="#"></a></td>
<td><pre>           }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="360" href="#"></a></td>
<td><pre>        });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="361" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="362" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="363" href="#"></a></td>
<td><pre>    public TrueTypeFont getEUDCFont() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="364" href="#"></a></td>
<td><pre>        // Overridden in Windows.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="365" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="366" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="367" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="368" href="#"></a></td>
<td><pre>    /* Initialise ptrs used by JNI methods */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="369" href="#"></a></td>
<td><pre>    private static native void initIDs();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="370" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="371" href="#"></a></td>
<td><pre>    @SuppressWarnings(&quot;unchecked&quot;)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="372" href="#"></a></td>
<td><pre>    protected SunFontManager() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="373" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="374" href="#"></a></td>
<td><pre>        initJREFontMap();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="375" href="#"></a></td>
<td><pre>        java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="376" href="#"></a></td>
<td><pre>                new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="377" href="#"></a></td>
<td><pre>                    public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="378" href="#"></a></td>
<td><pre>                        File badFontFile =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="379" href="#"></a></td>
<td><pre>                            new File(jreFontDirName + File.separator +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="380" href="#"></a></td>
<td><pre>                                     &quot;badfonts.txt&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="381" href="#"></a></td>
<td><pre>                        if (badFontFile.exists()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="382" href="#"></a></td>
<td><pre>                            FileInputStream fis = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="383" href="#"></a></td>
<td><pre>                            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="384" href="#"></a></td>
<td><pre>                                badFonts = new ArrayList();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="385" href="#"></a></td>
<td><pre>                                fis = new FileInputStream(badFontFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="386" href="#"></a></td>
<td><pre>                                InputStreamReader isr = new InputStreamReader(fis);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="387" href="#"></a></td>
<td><pre>                                BufferedReader br = new BufferedReader(isr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="388" href="#"></a></td>
<td><pre>                                while (true) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="389" href="#"></a></td>
<td><pre>                                    String name = br.readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="390" href="#"></a></td>
<td><pre>                                    if (name == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="391" href="#"></a></td>
<td><pre>                                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="392" href="#"></a></td>
<td><pre>                                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="393" href="#"></a></td>
<td><pre>                                        if (FontUtilities.debugFonts()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="394" href="#"></a></td>
<td><pre>                                            FontUtilities.getLogger().warning(&quot;read bad font: &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="395" href="#"></a></td>
<td><pre>                                                           name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="396" href="#"></a></td>
<td><pre>                                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="397" href="#"></a></td>
<td><pre>                                        badFonts.add(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="398" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="399" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="400" href="#"></a></td>
<td><pre>                            } catch (IOException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="401" href="#"></a></td>
<td><pre>                                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="402" href="#"></a></td>
<td><pre>                                    if (fis != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="403" href="#"></a></td>
<td><pre>                                        fis.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="404" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="405" href="#"></a></td>
<td><pre>                                } catch (IOException ioe) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="406" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="407" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="408" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="409" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="410" href="#"></a></td>
<td><pre>                        /* Here we get the fonts in jre/lib/fonts and register</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="411" href="#"></a></td>
<td><pre>                         * them so they are always available and preferred over</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="412" href="#"></a></td>
<td><pre>                         * other fonts. This needs to be registered before the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="413" href="#"></a></td>
<td><pre>                         * composite fonts as otherwise some native font that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="414" href="#"></a></td>
<td><pre>                         * corresponds may be found as we don't have a way to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="415" href="#"></a></td>
<td><pre>                         * handle two fonts of the same name, so the JRE one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="416" href="#"></a></td>
<td><pre>                         * must be the first one registered. Pass &quot;true&quot; to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="417" href="#"></a></td>
<td><pre>                         * registerFonts method as on-screen these JRE fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="418" href="#"></a></td>
<td><pre>                         * always go through the T2K rasteriser.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="419" href="#"></a></td>
<td><pre>                         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="420" href="#"></a></td>
<td><pre>                        if (FontUtilities.isLinux) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="421" href="#"></a></td>
<td><pre>                            /* Linux font configuration uses these fonts */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="422" href="#"></a></td>
<td><pre>                            registerFontDir(jreFontDirName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="423" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="424" href="#"></a></td>
<td><pre>                        registerFontsInDir(jreFontDirName, true, Font2D.JRE_RANK,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="425" href="#"></a></td>
<td><pre>                                           true, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="426" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="427" href="#"></a></td>
<td><pre>                        /* Create the font configuration and get any font path</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="428" href="#"></a></td>
<td><pre>                         * that might be specified.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="429" href="#"></a></td>
<td><pre>                         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="430" href="#"></a></td>
<td><pre>                        fontConfig = createFontConfiguration();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="431" href="#"></a></td>
<td><pre>                        if (isOpenJDK()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="432" href="#"></a></td>
<td><pre>                            String[] fontInfo = getDefaultPlatformFont();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="433" href="#"></a></td>
<td><pre>                            defaultFontName = fontInfo[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="434" href="#"></a></td>
<td><pre>                            defaultFontFileName = fontInfo[1];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="435" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="436" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="437" href="#"></a></td>
<td><pre>                        String extraFontPath = fontConfig.getExtraFontPath();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="438" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="439" href="#"></a></td>
<td><pre>                        /* In prior releases the debugging font path replaced</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="440" href="#"></a></td>
<td><pre>                         * all normally located font directories except for the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="441" href="#"></a></td>
<td><pre>                         * JRE fonts dir. This directory is still always located</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="442" href="#"></a></td>
<td><pre>                         * and placed at the head of the path but as an</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="443" href="#"></a></td>
<td><pre>                         * augmentation to the previous behaviour the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="444" href="#"></a></td>
<td><pre>                         * changes below allow you to additionally append to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="445" href="#"></a></td>
<td><pre>                         * the font path by starting with append: or prepend by</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="446" href="#"></a></td>
<td><pre>                         * starting with a prepend: sign. Eg: to append</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="447" href="#"></a></td>
<td><pre>                         * -Dsun.java2d.fontpath=append:/usr/local/myfonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="448" href="#"></a></td>
<td><pre>                         * and to prepend</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="449" href="#"></a></td>
<td><pre>                         * -Dsun.java2d.fontpath=prepend:/usr/local/myfonts Disp</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="450" href="#"></a></td>
<td><pre>                         *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="451" href="#"></a></td>
<td><pre>                         * If there is an appendedfontpath it in the font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="452" href="#"></a></td>
<td><pre>                         * configuration it is used instead of searching the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="453" href="#"></a></td>
<td><pre>                         * system for dirs.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="454" href="#"></a></td>
<td><pre>                         * The behaviour of append and prepend is then similar</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="455" href="#"></a></td>
<td><pre>                         * to the normal case. ie it goes after what</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="456" href="#"></a></td>
<td><pre>                         * you prepend and * before what you append. If the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="457" href="#"></a></td>
<td><pre>                         * sun.java2d.fontpath property is used, but it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="458" href="#"></a></td>
<td><pre>                         * neither the append or prepend syntaxes is used then</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="459" href="#"></a></td>
<td><pre>                         * as except for the JRE dir the path is replaced and it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="460" href="#"></a></td>
<td><pre>                         * is up to you to make sure that all the right</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="461" href="#"></a></td>
<td><pre>                         * directories are located. This is platform and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="462" href="#"></a></td>
<td><pre>                         * locale-specific so its almost impossible to get</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="463" href="#"></a></td>
<td><pre>                         * right, so it should be used with caution.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="464" href="#"></a></td>
<td><pre>                         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="465" href="#"></a></td>
<td><pre>                        boolean prependToPath = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="466" href="#"></a></td>
<td><pre>                        boolean appendToPath = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="467" href="#"></a></td>
<td><pre>                        String dbgFontPath =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="468" href="#"></a></td>
<td><pre>                            System.getProperty(&quot;sun.java2d.fontpath&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="469" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="470" href="#"></a></td>
<td><pre>                        if (dbgFontPath != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="471" href="#"></a></td>
<td><pre>                            if (dbgFontPath.startsWith(&quot;prepend:&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="472" href="#"></a></td>
<td><pre>                                prependToPath = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="473" href="#"></a></td>
<td><pre>                                dbgFontPath =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="474" href="#"></a></td>
<td><pre>                                    dbgFontPath.substring(&quot;prepend:&quot;.length());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="475" href="#"></a></td>
<td><pre>                            } else if (dbgFontPath.startsWith(&quot;append:&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="476" href="#"></a></td>
<td><pre>                                appendToPath = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="477" href="#"></a></td>
<td><pre>                                dbgFontPath =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="478" href="#"></a></td>
<td><pre>                                    dbgFontPath.substring(&quot;append:&quot;.length());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="479" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="480" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="481" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="482" href="#"></a></td>
<td><pre>                        if (FontUtilities.debugFonts()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="483" href="#"></a></td>
<td><pre>                            PlatformLogger logger = FontUtilities.getLogger();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="484" href="#"></a></td>
<td><pre>                            logger.info(&quot;JRE font directory: &quot; + jreFontDirName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="485" href="#"></a></td>
<td><pre>                            logger.info(&quot;Extra font path: &quot; + extraFontPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="486" href="#"></a></td>
<td><pre>                            logger.info(&quot;Debug font path: &quot; + dbgFontPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="487" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="488" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="489" href="#"></a></td>
<td><pre>                        if (dbgFontPath != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="490" href="#"></a></td>
<td><pre>                            /* In debugging mode we register all the paths</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="491" href="#"></a></td>
<td><pre>                             * Caution: this is a very expensive call on Solaris:-</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="492" href="#"></a></td>
<td><pre>                             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="493" href="#"></a></td>
<td><pre>                            fontPath = getPlatformFontPath(noType1Font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="494" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="495" href="#"></a></td>
<td><pre>                            if (extraFontPath != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="496" href="#"></a></td>
<td><pre>                                fontPath =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="497" href="#"></a></td>
<td><pre>                                    extraFontPath + File.pathSeparator + fontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="498" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="499" href="#"></a></td>
<td><pre>                            if (appendToPath) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="500" href="#"></a></td>
<td><pre>                                fontPath =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="501" href="#"></a></td>
<td><pre>                                    fontPath + File.pathSeparator + dbgFontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="502" href="#"></a></td>
<td><pre>                            } else if (prependToPath) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="503" href="#"></a></td>
<td><pre>                                fontPath =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="504" href="#"></a></td>
<td><pre>                                    dbgFontPath + File.pathSeparator + fontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="505" href="#"></a></td>
<td><pre>                            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="506" href="#"></a></td>
<td><pre>                                fontPath = dbgFontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="507" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="508" href="#"></a></td>
<td><pre>                            registerFontDirs(fontPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="509" href="#"></a></td>
<td><pre>                        } else if (extraFontPath != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="510" href="#"></a></td>
<td><pre>                            /* If the font configuration contains an</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="511" href="#"></a></td>
<td><pre>                             * &quot;appendedfontpath&quot; entry, it is interpreted as a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="512" href="#"></a></td>
<td><pre>                             * set of locations that should always be registered.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="513" href="#"></a></td>
<td><pre>                             * It may be additional to locations normally found</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="514" href="#"></a></td>
<td><pre>                             * for that place, or it may be locations that need</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="515" href="#"></a></td>
<td><pre>                             * to have all their paths registered to locate all</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="516" href="#"></a></td>
<td><pre>                             * the needed platform names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="517" href="#"></a></td>
<td><pre>                             * This is typically when the same .TTF file is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="518" href="#"></a></td>
<td><pre>                             * referenced from multiple font.dir files and all</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="519" href="#"></a></td>
<td><pre>                             * of these must be read to find all the native</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="520" href="#"></a></td>
<td><pre>                             * (XLFD) names for the font, so that X11 font APIs</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="521" href="#"></a></td>
<td><pre>                             * can be used for as many code points as possible.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="522" href="#"></a></td>
<td><pre>                             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="523" href="#"></a></td>
<td><pre>                            registerFontDirs(extraFontPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="524" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="525" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="526" href="#"></a></td>
<td><pre>                        /* On Solaris, we need to register the Japanese TrueType</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="527" href="#"></a></td>
<td><pre>                         * directory so that we can find the corresponding</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="528" href="#"></a></td>
<td><pre>                         * bitmap fonts. This could be done by listing the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="529" href="#"></a></td>
<td><pre>                         * directory in the font configuration file, but we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="530" href="#"></a></td>
<td><pre>                         * don't want to confuse users with this quirk. There</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="531" href="#"></a></td>
<td><pre>                         * are no bitmap fonts for other writing systems that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="532" href="#"></a></td>
<td><pre>                         * correspond to TrueType fonts and have matching XLFDs.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="533" href="#"></a></td>
<td><pre>                         * We need to register the bitmap fonts only in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="534" href="#"></a></td>
<td><pre>                         * environments where they're on the X font path, i.e.,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="535" href="#"></a></td>
<td><pre>                         * in the Japanese locale. Note that if the X Toolkit</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="536" href="#"></a></td>
<td><pre>                         * is in use the font path isn't set up by JDK, but</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="537" href="#"></a></td>
<td><pre>                         * users of a JA locale should have it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="538" href="#"></a></td>
<td><pre>                         * set up already by their login environment.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="539" href="#"></a></td>
<td><pre>                         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="540" href="#"></a></td>
<td><pre>                        if (FontUtilities.isSolaris &amp;&amp; Locale.JAPAN.equals(Locale.getDefault())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="541" href="#"></a></td>
<td><pre>                            registerFontDir(&quot;/usr/openwin/lib/locale/ja/X11/fonts/TT&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="542" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="543" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="544" href="#"></a></td>
<td><pre>                        initCompositeFonts(fontConfig, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="545" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="546" href="#"></a></td>
<td><pre>                        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="547" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="548" href="#"></a></td>
<td><pre>                });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="549" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="550" href="#"></a></td>
<td><pre>        boolean platformFont = AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="551" href="#"></a></td>
<td><pre>                        new PrivilegedAction&lt;Boolean&gt;() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="552" href="#"></a></td>
<td><pre>                                public Boolean run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="553" href="#"></a></td>
<td><pre>                                        String prop =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="554" href="#"></a></td>
<td><pre>                                                System.getProperty(&quot;java2d.font.usePlatformFont&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="555" href="#"></a></td>
<td><pre>                                        String env = System.getenv(&quot;JAVA2D_USEPLATFORMFONT&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="556" href="#"></a></td>
<td><pre>                                        return &quot;true&quot;.equals(prop) || env != null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="557" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="558" href="#"></a></td>
<td><pre>                        });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="559" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="560" href="#"></a></td>
<td><pre>        if (platformFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="561" href="#"></a></td>
<td><pre>            usePlatformFontMetrics = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="562" href="#"></a></td>
<td><pre>            System.out.println(&quot;Enabling platform font metrics for win32. This is an unsupported option.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="563" href="#"></a></td>
<td><pre>            System.out.println(&quot;This yields incorrect composite font metrics as reported by 1.1.x releases.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="564" href="#"></a></td>
<td><pre>            System.out.println(&quot;It is appropriate only for use by applications which do not use any Java 2&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="565" href="#"></a></td>
<td><pre>            System.out.println(&quot;functionality. This property will be removed in a later release.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="566" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="567" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="568" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="569" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="570" href="#"></a></td>
<td><pre>     * This method is provided for internal and exclusive use by Swing.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="571" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="572" href="#"></a></td>
<td><pre>     * @param font representing a physical font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="573" href="#"></a></td>
<td><pre>     * @return true if the underlying font is a TrueType or OpenType font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="574" href="#"></a></td>
<td><pre>     * that claims to support the Microsoft Windows encoding corresponding to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="575" href="#"></a></td>
<td><pre>     * the default file.encoding property of this JRE instance.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="576" href="#"></a></td>
<td><pre>     * This narrow value is useful for Swing to decide if the font is useful</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="577" href="#"></a></td>
<td><pre>     * for the the Windows Look and Feel, or, if a  composite font should be</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="578" href="#"></a></td>
<td><pre>     * used instead.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="579" href="#"></a></td>
<td><pre>     * The information used to make the decision is obtained from</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="580" href="#"></a></td>
<td><pre>     * the ulCodePageRange fields in the font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="581" href="#"></a></td>
<td><pre>     * A caller can use isLogicalFont(Font) in this class before calling</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="582" href="#"></a></td>
<td><pre>     * this method and would not need to call this method if that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="583" href="#"></a></td>
<td><pre>     * returns true.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="584" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="585" href="#"></a></td>
<td><pre>//     static boolean fontSupportsDefaultEncoding(Font font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="586" href="#"></a></td>
<td><pre>//      String encoding =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="587" href="#"></a></td>
<td><pre>//          (String) java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="588" href="#"></a></td>
<td><pre>//                new sun.security.action.GetPropertyAction(&quot;file.encoding&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="589" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="590" href="#"></a></td>
<td><pre>//      if (encoding == null || font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="591" href="#"></a></td>
<td><pre>//          return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="592" href="#"></a></td>
<td><pre>//      }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="593" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="594" href="#"></a></td>
<td><pre>//      encoding = encoding.toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="595" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="596" href="#"></a></td>
<td><pre>//      return FontManager.fontSupportsEncoding(font, encoding);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="597" href="#"></a></td>
<td><pre>//     }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="598" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="599" href="#"></a></td>
<td><pre>    public Font2DHandle getNewComposite(String family, int style,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="600" href="#"></a></td>
<td><pre>                                        Font2DHandle handle) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="601" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="602" href="#"></a></td>
<td><pre>        if (!(handle.font2D instanceof CompositeFont)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="603" href="#"></a></td>
<td><pre>            return handle;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="604" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="605" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="606" href="#"></a></td>
<td><pre>        CompositeFont oldComp = (CompositeFont)handle.font2D;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="607" href="#"></a></td>
<td><pre>        PhysicalFont oldFont = oldComp.getSlotFont(0);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="608" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="609" href="#"></a></td>
<td><pre>        if (family == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="610" href="#"></a></td>
<td><pre>            family = oldFont.getFamilyName(null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="611" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="612" href="#"></a></td>
<td><pre>        if (style == -1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="613" href="#"></a></td>
<td><pre>            style = oldComp.getStyle();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="614" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="615" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="616" href="#"></a></td>
<td><pre>        Font2D newFont = findFont2D(family, style, NO_FALLBACK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="617" href="#"></a></td>
<td><pre>        if (!(newFont instanceof PhysicalFont)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="618" href="#"></a></td>
<td><pre>            newFont = oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="619" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="620" href="#"></a></td>
<td><pre>        PhysicalFont physicalFont = (PhysicalFont)newFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="621" href="#"></a></td>
<td><pre>        CompositeFont dialog2D =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="622" href="#"></a></td>
<td><pre>            (CompositeFont)findFont2D(&quot;dialog&quot;, style, NO_FALLBACK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="623" href="#"></a></td>
<td><pre>        if (dialog2D == null) { /* shouldn't happen */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="624" href="#"></a></td>
<td><pre>            return handle;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="625" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="626" href="#"></a></td>
<td><pre>        CompositeFont compFont = new CompositeFont(physicalFont, dialog2D);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="627" href="#"></a></td>
<td><pre>        Font2DHandle newHandle = new Font2DHandle(compFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="628" href="#"></a></td>
<td><pre>        return newHandle;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="629" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="630" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="631" href="#"></a></td>
<td><pre>    protected void registerCompositeFont(String compositeName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="632" href="#"></a></td>
<td><pre>                                      String[] componentFileNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="633" href="#"></a></td>
<td><pre>                                      String[] componentNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="634" href="#"></a></td>
<td><pre>                                      int numMetricsSlots,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="635" href="#"></a></td>
<td><pre>                                      int[] exclusionRanges,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="636" href="#"></a></td>
<td><pre>                                      int[] exclusionMaxIndex,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="637" href="#"></a></td>
<td><pre>                                      boolean defer) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="638" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="639" href="#"></a></td>
<td><pre>        CompositeFont cf = new CompositeFont(compositeName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="640" href="#"></a></td>
<td><pre>                                             componentFileNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="641" href="#"></a></td>
<td><pre>                                             componentNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="642" href="#"></a></td>
<td><pre>                                             numMetricsSlots,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="643" href="#"></a></td>
<td><pre>                                             exclusionRanges,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="644" href="#"></a></td>
<td><pre>                                             exclusionMaxIndex, defer, this);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="645" href="#"></a></td>
<td><pre>        addCompositeToFontList(cf, Font2D.FONT_CONFIG_RANK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="646" href="#"></a></td>
<td><pre>        synchronized (compFonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="647" href="#"></a></td>
<td><pre>            compFonts[maxCompFont++] = cf;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="648" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="649" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="650" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="651" href="#"></a></td>
<td><pre>    /* This variant is used only when the application specifies</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="652" href="#"></a></td>
<td><pre>     * a variant of composite fonts which prefers locale specific or</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="653" href="#"></a></td>
<td><pre>     * proportional fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="654" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="655" href="#"></a></td>
<td><pre>    protected static void registerCompositeFont(String compositeName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="656" href="#"></a></td>
<td><pre>                                                String[] componentFileNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="657" href="#"></a></td>
<td><pre>                                                String[] componentNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="658" href="#"></a></td>
<td><pre>                                                int numMetricsSlots,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="659" href="#"></a></td>
<td><pre>                                                int[] exclusionRanges,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="660" href="#"></a></td>
<td><pre>                                                int[] exclusionMaxIndex,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="661" href="#"></a></td>
<td><pre>                                                boolean defer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="662" href="#"></a></td>
<td><pre>                                                ConcurrentHashMap&lt;String, Font2D&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="663" href="#"></a></td>
<td><pre>                                                altNameCache) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="664" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="665" href="#"></a></td>
<td><pre>        CompositeFont cf = new CompositeFont(compositeName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="666" href="#"></a></td>
<td><pre>                                             componentFileNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="667" href="#"></a></td>
<td><pre>                                             componentNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="668" href="#"></a></td>
<td><pre>                                             numMetricsSlots,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="669" href="#"></a></td>
<td><pre>                                             exclusionRanges,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="670" href="#"></a></td>
<td><pre>                                             exclusionMaxIndex, defer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="671" href="#"></a></td>
<td><pre>                                             SunFontManager.getInstance());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="672" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="673" href="#"></a></td>
<td><pre>        /* if the cache has an existing composite for this case, make</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="674" href="#"></a></td>
<td><pre>         * its handle point to this new font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="675" href="#"></a></td>
<td><pre>         * This ensures that when the altNameCache that is passed in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="676" href="#"></a></td>
<td><pre>         * is the global mapNameCache - ie we are running as an application -</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="677" href="#"></a></td>
<td><pre>         * that any statically created java.awt.Font instances which already</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="678" href="#"></a></td>
<td><pre>         * have a Font2D instance will have that re-directed to the new Font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="679" href="#"></a></td>
<td><pre>         * on subsequent uses. This is particularly important for &quot;the&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="680" href="#"></a></td>
<td><pre>         * default font instance, or similar cases where a UI toolkit (eg</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="681" href="#"></a></td>
<td><pre>         * Swing) has cached a java.awt.Font. Note that if Swing is using</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="682" href="#"></a></td>
<td><pre>         * a custom composite APIs which update the standard composites have</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="683" href="#"></a></td>
<td><pre>         * no effect - this is typically the case only when using the Windows</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="684" href="#"></a></td>
<td><pre>         * L&amp;F where these APIs would conflict with that L&amp;F anyway.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="685" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="686" href="#"></a></td>
<td><pre>        Font2D oldFont = (Font2D)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="687" href="#"></a></td>
<td><pre>            altNameCache.get(compositeName.toLowerCase(Locale.ENGLISH));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="688" href="#"></a></td>
<td><pre>        if (oldFont instanceof CompositeFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="689" href="#"></a></td>
<td><pre>            oldFont.handle.font2D = cf;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="690" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="691" href="#"></a></td>
<td><pre>        altNameCache.put(compositeName.toLowerCase(Locale.ENGLISH), cf);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="692" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="693" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="694" href="#"></a></td>
<td><pre>    private void addCompositeToFontList(CompositeFont f, int rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="695" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="696" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="697" href="#"></a></td>
<td><pre>            FontUtilities.getLogger().info(&quot;Add to Family &quot;+ f.familyName +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="698" href="#"></a></td>
<td><pre>                        &quot;, Font &quot; + f.fullName + &quot; rank=&quot;+rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="699" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="700" href="#"></a></td>
<td><pre>        f.setRank(rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="701" href="#"></a></td>
<td><pre>        compositeFonts.put(f.fullName, f);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="702" href="#"></a></td>
<td><pre>        fullNameToFont.put(f.fullName.toLowerCase(Locale.ENGLISH), f);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="703" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="704" href="#"></a></td>
<td><pre>        FontFamily family = FontFamily.getFamily(f.familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="705" href="#"></a></td>
<td><pre>        if (family == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="706" href="#"></a></td>
<td><pre>            family = new FontFamily(f.familyName, true, rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="707" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="708" href="#"></a></td>
<td><pre>        family.setFont(f, f.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="709" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="710" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="711" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="712" href="#"></a></td>
<td><pre>     * Systems may have fonts with the same name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="713" href="#"></a></td>
<td><pre>     * We want to register only one of such fonts (at least until</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="714" href="#"></a></td>
<td><pre>     * such time as there might be APIs which can accommodate &gt; 1).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="715" href="#"></a></td>
<td><pre>     * Rank is 1) font configuration fonts, 2) JRE fonts, 3) OT/TT fonts,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="716" href="#"></a></td>
<td><pre>     * 4) Type1 fonts, 5) native fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="717" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="718" href="#"></a></td>
<td><pre>     * If the new font has the same name as the old font, the higher</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="719" href="#"></a></td>
<td><pre>     * ranked font gets added, replacing the lower ranked one.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="720" href="#"></a></td>
<td><pre>     * If the fonts are of equal rank, then make a special case of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="721" href="#"></a></td>
<td><pre>     * font configuration rank fonts, which are on closer inspection,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="722" href="#"></a></td>
<td><pre>     * OT/TT fonts such that the larger font is registered. This is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="723" href="#"></a></td>
<td><pre>     * a heuristic since a font may be &quot;larger&quot; in the sense of more</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="724" href="#"></a></td>
<td><pre>     * code points, or be a larger &quot;file&quot; because it has more bitmaps.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="725" href="#"></a></td>
<td><pre>     * So it is possible that using filesize may lead to less glyphs, and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="726" href="#"></a></td>
<td><pre>     * using glyphs may lead to lower quality display. Probably number</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="727" href="#"></a></td>
<td><pre>     * of glyphs is the ideal, but filesize is information we already</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="728" href="#"></a></td>
<td><pre>     * have and is good enough for the known cases.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="729" href="#"></a></td>
<td><pre>     * Also don't want to register fonts that match JRE font families</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="730" href="#"></a></td>
<td><pre>     * but are coming from a source other than the JRE.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="731" href="#"></a></td>
<td><pre>     * This will ensure that we will algorithmically style the JRE</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="732" href="#"></a></td>
<td><pre>     * plain font and get the same set of glyphs for all styles.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="733" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="734" href="#"></a></td>
<td><pre>     * Note that this method returns a value</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="735" href="#"></a></td>
<td><pre>     * if it returns the same object as its argument that means this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="736" href="#"></a></td>
<td><pre>     * font was newly registered.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="737" href="#"></a></td>
<td><pre>     * If it returns a different object it means this font already exists,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="738" href="#"></a></td>
<td><pre>     * and you should use that one.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="739" href="#"></a></td>
<td><pre>     * If it returns null means this font was not registered and none</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="740" href="#"></a></td>
<td><pre>     * in that name is registered. The caller must find a substitute</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="741" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="742" href="#"></a></td>
<td><pre>    // MACOSX begin -- need to access this in subclass</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="743" href="#"></a></td>
<td><pre>    protected PhysicalFont addToFontList(PhysicalFont f, int rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="744" href="#"></a></td>
<td><pre>    // MACOSX end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="745" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="746" href="#"></a></td>
<td><pre>        String fontName = f.fullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="747" href="#"></a></td>
<td><pre>        String familyName = f.familyName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="748" href="#"></a></td>
<td><pre>        if (fontName == null || &quot;&quot;.equals(fontName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="749" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="750" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="751" href="#"></a></td>
<td><pre>        if (compositeFonts.containsKey(fontName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="752" href="#"></a></td>
<td><pre>            /* Don't register any font that has the same name as a composite */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="753" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="754" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="755" href="#"></a></td>
<td><pre>        f.setRank(rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="756" href="#"></a></td>
<td><pre>        if (!physicalFonts.containsKey(fontName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="757" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="758" href="#"></a></td>
<td><pre>                FontUtilities.getLogger().info(&quot;Add to Family &quot;+familyName +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="759" href="#"></a></td>
<td><pre>                            &quot;, Font &quot; + fontName + &quot; rank=&quot;+rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="760" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="761" href="#"></a></td>
<td><pre>            physicalFonts.put(fontName, f);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="762" href="#"></a></td>
<td><pre>            FontFamily family = FontFamily.getFamily(familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="763" href="#"></a></td>
<td><pre>            if (family == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="764" href="#"></a></td>
<td><pre>                family = new FontFamily(familyName, false, rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="765" href="#"></a></td>
<td><pre>                family.setFont(f, f.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="766" href="#"></a></td>
<td><pre>            } else if (family.getRank() &gt;= rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="767" href="#"></a></td>
<td><pre>                family.setFont(f, f.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="768" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="769" href="#"></a></td>
<td><pre>            fullNameToFont.put(fontName.toLowerCase(Locale.ENGLISH), f);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="770" href="#"></a></td>
<td><pre>            return f;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="771" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="772" href="#"></a></td>
<td><pre>            PhysicalFont newFont = f;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="773" href="#"></a></td>
<td><pre>            PhysicalFont oldFont = physicalFonts.get(fontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="774" href="#"></a></td>
<td><pre>            if (oldFont == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="775" href="#"></a></td>
<td><pre>                return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="776" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="777" href="#"></a></td>
<td><pre>            /* If the new font is of an equal or higher rank, it is a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="778" href="#"></a></td>
<td><pre>             * candidate to replace the current one, subject to further tests.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="779" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="780" href="#"></a></td>
<td><pre>            if (oldFont.getRank() &gt;= rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="781" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="782" href="#"></a></td>
<td><pre>                /* All fonts initialise their mapper when first</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="783" href="#"></a></td>
<td><pre>                 * used. If the mapper is non-null then this font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="784" href="#"></a></td>
<td><pre>                 * has been accessed at least once. In that case</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="785" href="#"></a></td>
<td><pre>                 * do not replace it. This may be overly stringent,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="786" href="#"></a></td>
<td><pre>                 * but its probably better not to replace a font that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="787" href="#"></a></td>
<td><pre>                 * someone is already using without a compelling reason.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="788" href="#"></a></td>
<td><pre>                 * Additionally the primary case where it is known</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="789" href="#"></a></td>
<td><pre>                 * this behaviour is important is in certain composite</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="790" href="#"></a></td>
<td><pre>                 * fonts, and since all the components of a given</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="791" href="#"></a></td>
<td><pre>                 * composite are usually initialised together this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="792" href="#"></a></td>
<td><pre>                 * is unlikely. For this to be a problem, there would</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="793" href="#"></a></td>
<td><pre>                 * have to be a case where two different composites used</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="794" href="#"></a></td>
<td><pre>                 * different versions of the same-named font, and they</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="795" href="#"></a></td>
<td><pre>                 * were initialised and used at separate times.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="796" href="#"></a></td>
<td><pre>                 * In that case we continue on and allow the new font to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="797" href="#"></a></td>
<td><pre>                 * be installed, but replaceFont will continue to allow</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="798" href="#"></a></td>
<td><pre>                 * the original font to be used in Composite fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="799" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="800" href="#"></a></td>
<td><pre>                if (oldFont.mapper != null &amp;&amp; rank &gt; Font2D.FONT_CONFIG_RANK) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="801" href="#"></a></td>
<td><pre>                    return oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="802" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="803" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="804" href="#"></a></td>
<td><pre>                /* Normally we require a higher rank to replace a font,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="805" href="#"></a></td>
<td><pre>                 * but as a special case, if the two fonts are the same rank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="806" href="#"></a></td>
<td><pre>                 * and are instances of TrueTypeFont we want the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="807" href="#"></a></td>
<td><pre>                 * more complete (larger) one.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="808" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="809" href="#"></a></td>
<td><pre>                if (oldFont.getRank() == rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="810" href="#"></a></td>
<td><pre>                    if (oldFont instanceof TrueTypeFont &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="811" href="#"></a></td>
<td><pre>                        newFont instanceof TrueTypeFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="812" href="#"></a></td>
<td><pre>                        TrueTypeFont oldTTFont = (TrueTypeFont)oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="813" href="#"></a></td>
<td><pre>                        TrueTypeFont newTTFont = (TrueTypeFont)newFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="814" href="#"></a></td>
<td><pre>                        if (oldTTFont.fileSize &gt;= newTTFont.fileSize) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="815" href="#"></a></td>
<td><pre>                            return oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="816" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="817" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="818" href="#"></a></td>
<td><pre>                        return oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="819" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="820" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="821" href="#"></a></td>
<td><pre>                /* Don't replace ever JRE fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="822" href="#"></a></td>
<td><pre>                 * This test is in case a font configuration references</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="823" href="#"></a></td>
<td><pre>                 * a Lucida font, which has been mapped to a Lucida</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="824" href="#"></a></td>
<td><pre>                 * from the host O/S. The assumption here is that any</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="825" href="#"></a></td>
<td><pre>                 * such font configuration file is probably incorrect, or</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="826" href="#"></a></td>
<td><pre>                 * the host O/S version is for the use of AWT.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="827" href="#"></a></td>
<td><pre>                 * In other words if we reach here, there's a possible</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="828" href="#"></a></td>
<td><pre>                 * problem with our choice of font configuration fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="829" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="830" href="#"></a></td>
<td><pre>                if (oldFont.platName.startsWith(jreFontDirName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="831" href="#"></a></td>
<td><pre>                    if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="832" href="#"></a></td>
<td><pre>                        FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="833" href="#"></a></td>
<td><pre>                              .warning(&quot;Unexpected attempt to replace a JRE &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="834" href="#"></a></td>
<td><pre>                                       &quot; font &quot; + fontName + &quot; from &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="835" href="#"></a></td>
<td><pre>                                        oldFont.platName +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="836" href="#"></a></td>
<td><pre>                                       &quot; with &quot; + newFont.platName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="837" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="838" href="#"></a></td>
<td><pre>                    return oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="839" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="840" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="841" href="#"></a></td>
<td><pre>                if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="842" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="843" href="#"></a></td>
<td><pre>                          .info(&quot;Replace in Family &quot; + familyName +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="844" href="#"></a></td>
<td><pre>                                &quot;,Font &quot; + fontName + &quot; new rank=&quot;+rank +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="845" href="#"></a></td>
<td><pre>                                &quot; from &quot; + oldFont.platName +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="846" href="#"></a></td>
<td><pre>                                &quot; with &quot; + newFont.platName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="847" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="848" href="#"></a></td>
<td><pre>                replaceFont(oldFont, newFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="849" href="#"></a></td>
<td><pre>                physicalFonts.put(fontName, newFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="850" href="#"></a></td>
<td><pre>                fullNameToFont.put(fontName.toLowerCase(Locale.ENGLISH),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="851" href="#"></a></td>
<td><pre>                                   newFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="852" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="853" href="#"></a></td>
<td><pre>                FontFamily family = FontFamily.getFamily(familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="854" href="#"></a></td>
<td><pre>                if (family == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="855" href="#"></a></td>
<td><pre>                    family = new FontFamily(familyName, false, rank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="856" href="#"></a></td>
<td><pre>                    family.setFont(newFont, newFont.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="857" href="#"></a></td>
<td><pre>                } else if (family.getRank() &gt;= rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="858" href="#"></a></td>
<td><pre>                    family.setFont(newFont, newFont.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="859" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="860" href="#"></a></td>
<td><pre>                return newFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="861" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="862" href="#"></a></td>
<td><pre>                return oldFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="863" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="864" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="865" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="866" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="867" href="#"></a></td>
<td><pre>    public Font2D[] getRegisteredFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="868" href="#"></a></td>
<td><pre>        PhysicalFont[] physFonts = getPhysicalFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="869" href="#"></a></td>
<td><pre>        int mcf = maxCompFont; /* for MT-safety */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="870" href="#"></a></td>
<td><pre>        Font2D[] regFonts = new Font2D[physFonts.length+mcf];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="871" href="#"></a></td>
<td><pre>        System.arraycopy(compFonts, 0, regFonts, 0, mcf);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="872" href="#"></a></td>
<td><pre>        System.arraycopy(physFonts, 0, regFonts, mcf, physFonts.length);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="873" href="#"></a></td>
<td><pre>        return regFonts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="874" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="875" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="876" href="#"></a></td>
<td><pre>    protected PhysicalFont[] getPhysicalFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="877" href="#"></a></td>
<td><pre>        return physicalFonts.values().toArray(new PhysicalFont[0]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="878" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="879" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="880" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="881" href="#"></a></td>
<td><pre>    /* The class FontRegistrationInfo is used when a client says not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="882" href="#"></a></td>
<td><pre>     * to register a font immediately. This mechanism is used to defer</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="883" href="#"></a></td>
<td><pre>     * initialisation of all the components of composite fonts at JRE</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="884" href="#"></a></td>
<td><pre>     * start-up. The CompositeFont class is &quot;aware&quot; of this and when it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="885" href="#"></a></td>
<td><pre>     * is first used it asks for the registration of its components.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="886" href="#"></a></td>
<td><pre>     * Also in the event that any physical font is requested the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="887" href="#"></a></td>
<td><pre>     * deferred fonts are initialised before triggering a search of the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="888" href="#"></a></td>
<td><pre>     * system.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="889" href="#"></a></td>
<td><pre>     * Two maps are used. One to track the deferred fonts. The</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="890" href="#"></a></td>
<td><pre>     * other to track the fonts that have been initialised through this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="891" href="#"></a></td>
<td><pre>     * mechanism.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="892" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="893" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="894" href="#"></a></td>
<td><pre>    private static final class FontRegistrationInfo {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="895" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="896" href="#"></a></td>
<td><pre>        String fontFilePath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="897" href="#"></a></td>
<td><pre>        String[] nativeNames;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="898" href="#"></a></td>
<td><pre>        int fontFormat;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="899" href="#"></a></td>
<td><pre>        boolean javaRasterizer;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="900" href="#"></a></td>
<td><pre>        int fontRank;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="901" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="902" href="#"></a></td>
<td><pre>        FontRegistrationInfo(String fontPath, String[] names, int format,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="903" href="#"></a></td>
<td><pre>                             boolean useJavaRasterizer, int rank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="904" href="#"></a></td>
<td><pre>            this.fontFilePath = fontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="905" href="#"></a></td>
<td><pre>            this.nativeNames = names;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="906" href="#"></a></td>
<td><pre>            this.fontFormat = format;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="907" href="#"></a></td>
<td><pre>            this.javaRasterizer = useJavaRasterizer;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="908" href="#"></a></td>
<td><pre>            this.fontRank = rank;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="909" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="910" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="911" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="912" href="#"></a></td>
<td><pre>    private final ConcurrentHashMap&lt;String, FontRegistrationInfo&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="913" href="#"></a></td>
<td><pre>        deferredFontFiles =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="914" href="#"></a></td>
<td><pre>        new ConcurrentHashMap&lt;String, FontRegistrationInfo&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="915" href="#"></a></td>
<td><pre>    private final ConcurrentHashMap&lt;String, Font2DHandle&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="916" href="#"></a></td>
<td><pre>        initialisedFonts = new ConcurrentHashMap&lt;String, Font2DHandle&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="917" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="918" href="#"></a></td>
<td><pre>    /* Remind: possibly enhance initialiseDeferredFonts() to be</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="919" href="#"></a></td>
<td><pre>     * optionally given a name and a style and it could stop when it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="920" href="#"></a></td>
<td><pre>     * finds that font - but this would be a problem if two of the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="921" href="#"></a></td>
<td><pre>     * fonts reference the same font face name (cf the Solaris</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="922" href="#"></a></td>
<td><pre>     * euro fonts).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="923" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="924" href="#"></a></td>
<td><pre>    protected synchronized void initialiseDeferredFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="925" href="#"></a></td>
<td><pre>        for (String fileName : deferredFontFiles.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="926" href="#"></a></td>
<td><pre>            initialiseDeferredFont(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="927" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="928" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="929" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="930" href="#"></a></td>
<td><pre>    protected synchronized void registerDeferredJREFonts(String jreDir) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="931" href="#"></a></td>
<td><pre>        for (FontRegistrationInfo info : deferredFontFiles.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="932" href="#"></a></td>
<td><pre>            if (info.fontFilePath != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="933" href="#"></a></td>
<td><pre>                info.fontFilePath.startsWith(jreDir)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="934" href="#"></a></td>
<td><pre>                initialiseDeferredFont(info.fontFilePath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="935" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="936" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="937" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="938" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="939" href="#"></a></td>
<td><pre>    public boolean isDeferredFont(String fileName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="940" href="#"></a></td>
<td><pre>        return deferredFontFiles.containsKey(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="941" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="942" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="943" href="#"></a></td>
<td><pre>    /* We keep a map of the files which contain the Lucida fonts so we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="944" href="#"></a></td>
<td><pre>     * don't need to search for them.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="945" href="#"></a></td>
<td><pre>     * But since we know what fonts these files contain, we can also avoid</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="946" href="#"></a></td>
<td><pre>     * opening them to look for a font name we don't recognise - see</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="947" href="#"></a></td>
<td><pre>     * findDeferredFont().</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="948" href="#"></a></td>
<td><pre>     * For typical cases where the font isn't a JRE one the overhead is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="949" href="#"></a></td>
<td><pre>     * this method call, HashMap.get() and null reference test, then</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="950" href="#"></a></td>
<td><pre>     * a boolean test of noOtherJREFontFiles.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="951" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="952" href="#"></a></td>
<td><pre>    public</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="953" href="#"></a></td>
<td><pre>    /*private*/ PhysicalFont findJREDeferredFont(String name, int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="954" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="955" href="#"></a></td>
<td><pre>        PhysicalFont physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="956" href="#"></a></td>
<td><pre>        String nameAndStyle = name.toLowerCase(Locale.ENGLISH) + style;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="957" href="#"></a></td>
<td><pre>        String fileName = jreFontMap.get(nameAndStyle);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="958" href="#"></a></td>
<td><pre>        if (fileName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="959" href="#"></a></td>
<td><pre>            fileName = jreFontDirName + File.separator + fileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="960" href="#"></a></td>
<td><pre>            if (deferredFontFiles.get(fileName) != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="961" href="#"></a></td>
<td><pre>                physicalFont = initialiseDeferredFont(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="962" href="#"></a></td>
<td><pre>                if (physicalFont != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="963" href="#"></a></td>
<td><pre>                    (physicalFont.getFontName(null).equalsIgnoreCase(name) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="964" href="#"></a></td>
<td><pre>                     physicalFont.getFamilyName(null).equalsIgnoreCase(name))</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="965" href="#"></a></td>
<td><pre>                    &amp;&amp; physicalFont.style == style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="966" href="#"></a></td>
<td><pre>                    return physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="967" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="968" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="969" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="970" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="971" href="#"></a></td>
<td><pre>        /* Iterate over the deferred font files looking for any in the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="972" href="#"></a></td>
<td><pre>         * jre directory that we didn't recognise, open each of these.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="973" href="#"></a></td>
<td><pre>         * In almost all installations this will quickly fall through</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="974" href="#"></a></td>
<td><pre>         * because only the Lucidas will be present and jreOtherFontFiles</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="975" href="#"></a></td>
<td><pre>         * will be empty.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="976" href="#"></a></td>
<td><pre>         * noOtherJREFontFiles is used so we can skip this block as soon</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="977" href="#"></a></td>
<td><pre>         * as its determined that its not needed - almost always after the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="978" href="#"></a></td>
<td><pre>         * very first time through.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="979" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="980" href="#"></a></td>
<td><pre>        if (noOtherJREFontFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="981" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="982" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="983" href="#"></a></td>
<td><pre>        synchronized (jreLucidaFontFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="984" href="#"></a></td>
<td><pre>            if (jreOtherFontFiles == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="985" href="#"></a></td>
<td><pre>                HashSet&lt;String&gt; otherFontFiles = new HashSet&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="986" href="#"></a></td>
<td><pre>                for (String deferredFile : deferredFontFiles.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="987" href="#"></a></td>
<td><pre>                    File file = new File(deferredFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="988" href="#"></a></td>
<td><pre>                    String dir = file.getParent();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="989" href="#"></a></td>
<td><pre>                    String fname = file.getName();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="990" href="#"></a></td>
<td><pre>                    /* skip names which aren't absolute, aren't in the JRE</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="991" href="#"></a></td>
<td><pre>                     * directory, or are known Lucida fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="992" href="#"></a></td>
<td><pre>                     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="993" href="#"></a></td>
<td><pre>                    if (dir == null ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="994" href="#"></a></td>
<td><pre>                        !dir.equals(jreFontDirName) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="995" href="#"></a></td>
<td><pre>                        jreLucidaFontFiles.contains(fname)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="996" href="#"></a></td>
<td><pre>                        continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="997" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="998" href="#"></a></td>
<td><pre>                    otherFontFiles.add(deferredFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="999" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1000" href="#"></a></td>
<td><pre>                jreOtherFontFiles = otherFontFiles.toArray(STR_ARRAY);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1001" href="#"></a></td>
<td><pre>                if (jreOtherFontFiles.length == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1002" href="#"></a></td>
<td><pre>                    noOtherJREFontFiles = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1003" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1004" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1005" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1006" href="#"></a></td>
<td><pre>            for (int i=0; i&lt;jreOtherFontFiles.length;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1007" href="#"></a></td>
<td><pre>                fileName = jreOtherFontFiles[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1008" href="#"></a></td>
<td><pre>                if (fileName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1009" href="#"></a></td>
<td><pre>                    continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1010" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1011" href="#"></a></td>
<td><pre>                jreOtherFontFiles[i] = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1012" href="#"></a></td>
<td><pre>                physicalFont = initialiseDeferredFont(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1013" href="#"></a></td>
<td><pre>                if (physicalFont != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1014" href="#"></a></td>
<td><pre>                    (physicalFont.getFontName(null).equalsIgnoreCase(name) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1015" href="#"></a></td>
<td><pre>                     physicalFont.getFamilyName(null).equalsIgnoreCase(name))</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1016" href="#"></a></td>
<td><pre>                    &amp;&amp; physicalFont.style == style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1017" href="#"></a></td>
<td><pre>                    return physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1018" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1019" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1020" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1021" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1022" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1023" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1024" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1025" href="#"></a></td>
<td><pre>    /* This skips JRE installed fonts. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1026" href="#"></a></td>
<td><pre>    private PhysicalFont findOtherDeferredFont(String name, int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1027" href="#"></a></td>
<td><pre>        for (String fileName : deferredFontFiles.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1028" href="#"></a></td>
<td><pre>            File file = new File(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1029" href="#"></a></td>
<td><pre>            String dir = file.getParent();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1030" href="#"></a></td>
<td><pre>            String fname = file.getName();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1031" href="#"></a></td>
<td><pre>            if (dir != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1032" href="#"></a></td>
<td><pre>                dir.equals(jreFontDirName) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1033" href="#"></a></td>
<td><pre>                jreLucidaFontFiles.contains(fname)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1034" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1035" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1036" href="#"></a></td>
<td><pre>            PhysicalFont physicalFont = initialiseDeferredFont(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1037" href="#"></a></td>
<td><pre>            if (physicalFont != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1038" href="#"></a></td>
<td><pre>                (physicalFont.getFontName(null).equalsIgnoreCase(name) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1039" href="#"></a></td>
<td><pre>                physicalFont.getFamilyName(null).equalsIgnoreCase(name)) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1040" href="#"></a></td>
<td><pre>                physicalFont.style == style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1041" href="#"></a></td>
<td><pre>                return physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1042" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1043" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1044" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1045" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1046" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1047" href="#"></a></td>
<td><pre>    private PhysicalFont findDeferredFont(String name, int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1048" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1049" href="#"></a></td>
<td><pre>        PhysicalFont physicalFont = findJREDeferredFont(name, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1050" href="#"></a></td>
<td><pre>        if (physicalFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1051" href="#"></a></td>
<td><pre>            return physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1052" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1053" href="#"></a></td>
<td><pre>            return findOtherDeferredFont(name, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1054" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1055" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1056" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1057" href="#"></a></td>
<td><pre>    public void registerDeferredFont(String fileNameKey,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1058" href="#"></a></td>
<td><pre>                                     String fullPathName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1059" href="#"></a></td>
<td><pre>                                     String[] nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1060" href="#"></a></td>
<td><pre>                                     int fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1061" href="#"></a></td>
<td><pre>                                     boolean useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1062" href="#"></a></td>
<td><pre>                                     int fontRank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1063" href="#"></a></td>
<td><pre>        FontRegistrationInfo regInfo =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1064" href="#"></a></td>
<td><pre>            new FontRegistrationInfo(fullPathName, nativeNames, fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1065" href="#"></a></td>
<td><pre>                                     useJavaRasterizer, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1066" href="#"></a></td>
<td><pre>        deferredFontFiles.put(fileNameKey, regInfo);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1067" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1068" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1069" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1070" href="#"></a></td>
<td><pre>    public synchronized</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1071" href="#"></a></td>
<td><pre>         PhysicalFont initialiseDeferredFont(String fileNameKey) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1072" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1073" href="#"></a></td>
<td><pre>        if (fileNameKey == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1074" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1075" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1076" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1077" href="#"></a></td>
<td><pre>            FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1078" href="#"></a></td>
<td><pre>                            .info(&quot;Opening deferred font file &quot; + fileNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1079" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1080" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1081" href="#"></a></td>
<td><pre>        PhysicalFont physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1082" href="#"></a></td>
<td><pre>        FontRegistrationInfo regInfo = deferredFontFiles.get(fileNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1083" href="#"></a></td>
<td><pre>        if (regInfo != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1084" href="#"></a></td>
<td><pre>            deferredFontFiles.remove(fileNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1085" href="#"></a></td>
<td><pre>            physicalFont = registerFontFile(regInfo.fontFilePath,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1086" href="#"></a></td>
<td><pre>                                            regInfo.nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1087" href="#"></a></td>
<td><pre>                                            regInfo.fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1088" href="#"></a></td>
<td><pre>                                            regInfo.javaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1089" href="#"></a></td>
<td><pre>                                            regInfo.fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1090" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1091" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1092" href="#"></a></td>
<td><pre>            if (physicalFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1093" href="#"></a></td>
<td><pre>                /* Store the handle, so that if a font is bad, we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1094" href="#"></a></td>
<td><pre>                 * retrieve the substituted font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1095" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1096" href="#"></a></td>
<td><pre>                initialisedFonts.put(fileNameKey, physicalFont.handle);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1097" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1098" href="#"></a></td>
<td><pre>                initialisedFonts.put(fileNameKey,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1099" href="#"></a></td>
<td><pre>                                     getDefaultPhysicalFont().handle);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1100" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1101" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1102" href="#"></a></td>
<td><pre>            Font2DHandle handle = initialisedFonts.get(fileNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1103" href="#"></a></td>
<td><pre>            if (handle == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1104" href="#"></a></td>
<td><pre>                /* Probably shouldn't happen, but just in case */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1105" href="#"></a></td>
<td><pre>                physicalFont = getDefaultPhysicalFont();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1106" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1107" href="#"></a></td>
<td><pre>                physicalFont = (PhysicalFont)(handle.font2D);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1108" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1109" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1110" href="#"></a></td>
<td><pre>        return physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1111" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1112" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1113" href="#"></a></td>
<td><pre>    public boolean isRegisteredFontFile(String name) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1114" href="#"></a></td>
<td><pre>        return registeredFonts.containsKey(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1115" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1116" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1117" href="#"></a></td>
<td><pre>    public PhysicalFont getRegisteredFontFile(String name) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1118" href="#"></a></td>
<td><pre>        return registeredFonts.get(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1119" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1120" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1121" href="#"></a></td>
<td><pre>    /* Note that the return value from this method is not always</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1122" href="#"></a></td>
<td><pre>     * derived from this file, and may be null. See addToFontList for</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1123" href="#"></a></td>
<td><pre>     * some explanation of this.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1124" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1125" href="#"></a></td>
<td><pre>    public PhysicalFont registerFontFile(String fileName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1126" href="#"></a></td>
<td><pre>                                         String[] nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1127" href="#"></a></td>
<td><pre>                                         int fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1128" href="#"></a></td>
<td><pre>                                         boolean useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1129" href="#"></a></td>
<td><pre>                                         int fontRank) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1130" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1131" href="#"></a></td>
<td><pre>        PhysicalFont regFont = registeredFonts.get(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1132" href="#"></a></td>
<td><pre>        if (regFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1133" href="#"></a></td>
<td><pre>            return regFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1134" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1135" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1136" href="#"></a></td>
<td><pre>        PhysicalFont physicalFont = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1137" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1138" href="#"></a></td>
<td><pre>            String name;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1139" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1140" href="#"></a></td>
<td><pre>            switch (fontFormat) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1141" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1142" href="#"></a></td>
<td><pre>            case FONTFORMAT_TRUETYPE:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1143" href="#"></a></td>
<td><pre>                int fn = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1144" href="#"></a></td>
<td><pre>                TrueTypeFont ttf;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1145" href="#"></a></td>
<td><pre>                do {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1146" href="#"></a></td>
<td><pre>                    ttf = new TrueTypeFont(fileName, nativeNames, fn++,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1147" href="#"></a></td>
<td><pre>                                           useJavaRasterizer);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1148" href="#"></a></td>
<td><pre>                    PhysicalFont pf = addToFontList(ttf, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1149" href="#"></a></td>
<td><pre>                    if (physicalFont == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1150" href="#"></a></td>
<td><pre>                        physicalFont = pf;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1151" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1152" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1153" href="#"></a></td>
<td><pre>                while (fn &lt; ttf.getFontCount());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1154" href="#"></a></td>
<td><pre>                break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1155" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1156" href="#"></a></td>
<td><pre>            case FONTFORMAT_TYPE1:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1157" href="#"></a></td>
<td><pre>                Type1Font t1f = new Type1Font(fileName, nativeNames);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1158" href="#"></a></td>
<td><pre>                physicalFont = addToFontList(t1f, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1159" href="#"></a></td>
<td><pre>                break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1160" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1161" href="#"></a></td>
<td><pre>            case FONTFORMAT_NATIVE:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1162" href="#"></a></td>
<td><pre>                NativeFont nf = new NativeFont(fileName, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1163" href="#"></a></td>
<td><pre>                physicalFont = addToFontList(nf, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1164" href="#"></a></td>
<td><pre>            default:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1165" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1166" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1167" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1168" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1169" href="#"></a></td>
<td><pre>                      .info(&quot;Registered file &quot; + fileName + &quot; as font &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1170" href="#"></a></td>
<td><pre>                            physicalFont + &quot; rank=&quot;  + fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1171" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1172" href="#"></a></td>
<td><pre>        } catch (FontFormatException ffe) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1173" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1174" href="#"></a></td>
<td><pre>                FontUtilities.getLogger().warning(&quot;Unusable font: &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1175" href="#"></a></td>
<td><pre>                               fileName + &quot; &quot; + ffe.toString());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1176" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1177" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1178" href="#"></a></td>
<td><pre>        if (physicalFont != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1179" href="#"></a></td>
<td><pre>            fontFormat != FONTFORMAT_NATIVE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1180" href="#"></a></td>
<td><pre>            registeredFonts.put(fileName, physicalFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1181" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1182" href="#"></a></td>
<td><pre>        return physicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1183" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1184" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1185" href="#"></a></td>
<td><pre>    public void registerFonts(String[] fileNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1186" href="#"></a></td>
<td><pre>                              String[][] nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1187" href="#"></a></td>
<td><pre>                              int fontCount,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1188" href="#"></a></td>
<td><pre>                              int fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1189" href="#"></a></td>
<td><pre>                              boolean useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1190" href="#"></a></td>
<td><pre>                              int fontRank, boolean defer) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1191" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1192" href="#"></a></td>
<td><pre>        for (int i=0; i &lt; fontCount; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1193" href="#"></a></td>
<td><pre>            if (defer) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1194" href="#"></a></td>
<td><pre>                registerDeferredFont(fileNames[i],fileNames[i], nativeNames[i],</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1195" href="#"></a></td>
<td><pre>                                     fontFormat, useJavaRasterizer, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1196" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1197" href="#"></a></td>
<td><pre>                registerFontFile(fileNames[i], nativeNames[i],</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1198" href="#"></a></td>
<td><pre>                                 fontFormat, useJavaRasterizer, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1199" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1200" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1201" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1202" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1203" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1204" href="#"></a></td>
<td><pre>     * This is the Physical font used when some other font on the system</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1205" href="#"></a></td>
<td><pre>     * can't be located. There has to be at least one font or the font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1206" href="#"></a></td>
<td><pre>     * system is not useful and the graphics environment cannot sustain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1207" href="#"></a></td>
<td><pre>     * the Java platform.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1208" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1209" href="#"></a></td>
<td><pre>    public PhysicalFont getDefaultPhysicalFont() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1210" href="#"></a></td>
<td><pre>        if (defaultPhysicalFont == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1211" href="#"></a></td>
<td><pre>            /* findFont2D will load all fonts before giving up the search.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1212" href="#"></a></td>
<td><pre>             * If the JRE Lucida isn't found (eg because the JRE fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1213" href="#"></a></td>
<td><pre>             * directory is missing), it could find another version of Lucida</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1214" href="#"></a></td>
<td><pre>             * from the host system. This is OK because at that point we are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1215" href="#"></a></td>
<td><pre>             * trying to gracefully handle/recover from a system</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1216" href="#"></a></td>
<td><pre>             * misconfiguration and this is probably a reasonable substitution.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1217" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1218" href="#"></a></td>
<td><pre>            defaultPhysicalFont = (PhysicalFont)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1219" href="#"></a></td>
<td><pre>                findFont2D(&quot;Lucida Sans Regular&quot;, Font.PLAIN, NO_FALLBACK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1220" href="#"></a></td>
<td><pre>            if (defaultPhysicalFont == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1221" href="#"></a></td>
<td><pre>                defaultPhysicalFont = (PhysicalFont)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1222" href="#"></a></td>
<td><pre>                    findFont2D(&quot;Arial&quot;, Font.PLAIN, NO_FALLBACK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1223" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1224" href="#"></a></td>
<td><pre>            if (defaultPhysicalFont == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1225" href="#"></a></td>
<td><pre>                /* Because of the findFont2D call above, if we reach here, we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1226" href="#"></a></td>
<td><pre>                 * know all fonts have already been loaded, just accept any</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1227" href="#"></a></td>
<td><pre>                 * match at this point. If this fails we are in real trouble</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1228" href="#"></a></td>
<td><pre>                 * and I don't know how to recover from there being absolutely</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1229" href="#"></a></td>
<td><pre>                 * no fonts anywhere on the system.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1230" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1231" href="#"></a></td>
<td><pre>                Iterator i = physicalFonts.values().iterator();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1232" href="#"></a></td>
<td><pre>                if (i.hasNext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1233" href="#"></a></td>
<td><pre>                    defaultPhysicalFont = (PhysicalFont)i.next();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1234" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1235" href="#"></a></td>
<td><pre>                    throw new Error(&quot;Probable fatal error:No fonts found.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1236" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1237" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1238" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1239" href="#"></a></td>
<td><pre>        return defaultPhysicalFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1240" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1241" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1242" href="#"></a></td>
<td><pre>    public Font2D getDefaultLogicalFont(int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1243" href="#"></a></td>
<td><pre>        return findFont2D(&quot;dialog&quot;, style, NO_FALLBACK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1244" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1245" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1246" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1247" href="#"></a></td>
<td><pre>     * return String representation of style prepended with &quot;.&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1248" href="#"></a></td>
<td><pre>     * This is useful for performance to avoid unnecessary string operations.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1249" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1250" href="#"></a></td>
<td><pre>    private static String dotStyleStr(int num) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1251" href="#"></a></td>
<td><pre>        switch(num){</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1252" href="#"></a></td>
<td><pre>          case Font.BOLD:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1253" href="#"></a></td>
<td><pre>            return &quot;.bold&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1254" href="#"></a></td>
<td><pre>          case Font.ITALIC:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1255" href="#"></a></td>
<td><pre>            return &quot;.italic&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1256" href="#"></a></td>
<td><pre>          case Font.ITALIC | Font.BOLD:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1257" href="#"></a></td>
<td><pre>            return &quot;.bolditalic&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1258" href="#"></a></td>
<td><pre>          default:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1259" href="#"></a></td>
<td><pre>            return &quot;.plain&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1260" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1261" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1262" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1263" href="#"></a></td>
<td><pre>    /* This is implemented only on windows and is called from code that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1264" href="#"></a></td>
<td><pre>     * executes only on windows. This isn't pretty but its not a precedent</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1265" href="#"></a></td>
<td><pre>     * in this file. This very probably should be cleaned up at some point.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1266" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1267" href="#"></a></td>
<td><pre>    protected void</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1268" href="#"></a></td>
<td><pre>        populateFontFileNameMap(HashMap&lt;String,String&gt; fontToFileMap,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1269" href="#"></a></td>
<td><pre>                                HashMap&lt;String,String&gt; fontToFamilyNameMap,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1270" href="#"></a></td>
<td><pre>                                HashMap&lt;String,ArrayList&lt;String&gt;&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1271" href="#"></a></td>
<td><pre>                                familyToFontListMap,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1272" href="#"></a></td>
<td><pre>                                Locale locale) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1273" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1274" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1275" href="#"></a></td>
<td><pre>    /* Obtained from Platform APIs (windows only)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1276" href="#"></a></td>
<td><pre>     * Map from lower-case font full name to basename of font file.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1277" href="#"></a></td>
<td><pre>     * Eg &quot;arial bold&quot; -&gt; ARIALBD.TTF.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1278" href="#"></a></td>
<td><pre>     * For TTC files, there is a mapping for each font in the file.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1279" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1280" href="#"></a></td>
<td><pre>    private HashMap&lt;String,String&gt; fontToFileMap = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1281" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1282" href="#"></a></td>
<td><pre>    /* Obtained from Platform APIs (windows only)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1283" href="#"></a></td>
<td><pre>     * Map from lower-case font full name to the name of its font family</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1284" href="#"></a></td>
<td><pre>     * Eg &quot;arial bold&quot; -&gt; &quot;Arial&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1285" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1286" href="#"></a></td>
<td><pre>    private HashMap&lt;String,String&gt; fontToFamilyNameMap = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1287" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1288" href="#"></a></td>
<td><pre>    /* Obtained from Platform APIs (windows only)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1289" href="#"></a></td>
<td><pre>     * Map from a lower-case family name to a list of full names of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1290" href="#"></a></td>
<td><pre>     * the member fonts, eg:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1291" href="#"></a></td>
<td><pre>     * &quot;arial&quot; -&gt; [&quot;Arial&quot;, &quot;Arial Bold&quot;, &quot;Arial Italic&quot;,&quot;Arial Bold Italic&quot;]</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1292" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1293" href="#"></a></td>
<td><pre>    private HashMap&lt;String,ArrayList&lt;String&gt;&gt; familyToFontListMap= null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1294" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1295" href="#"></a></td>
<td><pre>    /* The directories which contain platform fonts */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1296" href="#"></a></td>
<td><pre>    private String[] pathDirs = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1297" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1298" href="#"></a></td>
<td><pre>    private boolean haveCheckedUnreferencedFontFiles;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1299" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1300" href="#"></a></td>
<td><pre>    private String[] getFontFilesFromPath(boolean noType1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1301" href="#"></a></td>
<td><pre>        final FilenameFilter filter;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1302" href="#"></a></td>
<td><pre>        if (noType1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1303" href="#"></a></td>
<td><pre>            filter = ttFilter;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1304" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1305" href="#"></a></td>
<td><pre>            filter = new TTorT1Filter();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1306" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1307" href="#"></a></td>
<td><pre>        return (String[])AccessController.doPrivileged(new PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1308" href="#"></a></td>
<td><pre>            public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1309" href="#"></a></td>
<td><pre>                if (pathDirs.length == 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1310" href="#"></a></td>
<td><pre>                    File dir = new File(pathDirs[0]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1311" href="#"></a></td>
<td><pre>                    String[] files = dir.list(filter);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1312" href="#"></a></td>
<td><pre>                    if (files == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1313" href="#"></a></td>
<td><pre>                        return new String[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1314" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1315" href="#"></a></td>
<td><pre>                    for (int f=0; f&lt;files.length; f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1316" href="#"></a></td>
<td><pre>                        files[f] = files[f].toLowerCase();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1317" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1318" href="#"></a></td>
<td><pre>                    return files;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1319" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1320" href="#"></a></td>
<td><pre>                    ArrayList&lt;String&gt; fileList = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1321" href="#"></a></td>
<td><pre>                    for (int i = 0; i&lt; pathDirs.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1322" href="#"></a></td>
<td><pre>                        File dir = new File(pathDirs[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1323" href="#"></a></td>
<td><pre>                        String[] files = dir.list(filter);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1324" href="#"></a></td>
<td><pre>                        if (files == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1325" href="#"></a></td>
<td><pre>                            continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1326" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1327" href="#"></a></td>
<td><pre>                        for (int f=0; f&lt;files.length ; f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1328" href="#"></a></td>
<td><pre>                            fileList.add(files[f].toLowerCase());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1329" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1330" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1331" href="#"></a></td>
<td><pre>                    return fileList.toArray(STR_ARRAY);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1332" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1333" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1334" href="#"></a></td>
<td><pre>        });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1335" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1336" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1337" href="#"></a></td>
<td><pre>    /* This is needed since some windows registry names don't match</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1338" href="#"></a></td>
<td><pre>     * the font names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1339" href="#"></a></td>
<td><pre>     * - UPC styled font names have a double space, but the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1340" href="#"></a></td>
<td><pre>     * registry entry mapping to a file doesn't.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1341" href="#"></a></td>
<td><pre>     * - Marlett is in a hidden file not listed in the registry</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1342" href="#"></a></td>
<td><pre>     * - The registry advertises that the file david.ttf contains a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1343" href="#"></a></td>
<td><pre>     * font with the full name &quot;David Regular&quot; when in fact its</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1344" href="#"></a></td>
<td><pre>     * just &quot;David&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1345" href="#"></a></td>
<td><pre>     * Directly fix up these known cases as this is faster.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1346" href="#"></a></td>
<td><pre>     * If a font which doesn't match these known cases has no file,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1347" href="#"></a></td>
<td><pre>     * it may be a font that has been temporarily added to the known set</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1348" href="#"></a></td>
<td><pre>     * or it may be an installed font with a missing registry entry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1349" href="#"></a></td>
<td><pre>     * Installed fonts are those in the windows font directories.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1350" href="#"></a></td>
<td><pre>     * Make a best effort attempt to locate these.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1351" href="#"></a></td>
<td><pre>     * We obtain the list of TrueType fonts in these directories and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1352" href="#"></a></td>
<td><pre>     * filter out all the font files we already know about from the registry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1353" href="#"></a></td>
<td><pre>     * What remains may be &quot;bad&quot; fonts, duplicate fonts, or perhaps the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1354" href="#"></a></td>
<td><pre>     * missing font(s) we are looking for.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1355" href="#"></a></td>
<td><pre>     * Open each of these files to find out.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1356" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1357" href="#"></a></td>
<td><pre>    private void resolveWindowsFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1358" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1359" href="#"></a></td>
<td><pre>        ArrayList&lt;String&gt; unmappedFontNames = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1360" href="#"></a></td>
<td><pre>        for (String font : fontToFamilyNameMap.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1361" href="#"></a></td>
<td><pre>            String file = fontToFileMap.get(font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1362" href="#"></a></td>
<td><pre>            if (file == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1363" href="#"></a></td>
<td><pre>                if (font.indexOf(&quot;  &quot;) &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1364" href="#"></a></td>
<td><pre>                    String newName = font.replaceFirst(&quot;  &quot;, &quot; &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1365" href="#"></a></td>
<td><pre>                    file = fontToFileMap.get(newName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1366" href="#"></a></td>
<td><pre>                    /* If this name exists and isn't for a valid name</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1367" href="#"></a></td>
<td><pre>                     * replace the mapping to the file with this font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1368" href="#"></a></td>
<td><pre>                     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1369" href="#"></a></td>
<td><pre>                    if (file != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1370" href="#"></a></td>
<td><pre>                        !fontToFamilyNameMap.containsKey(newName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1371" href="#"></a></td>
<td><pre>                        fontToFileMap.remove(newName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1372" href="#"></a></td>
<td><pre>                        fontToFileMap.put(font, file);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1373" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1374" href="#"></a></td>
<td><pre>                } else if (font.equals(&quot;marlett&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1375" href="#"></a></td>
<td><pre>                    fontToFileMap.put(font, &quot;marlett.ttf&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1376" href="#"></a></td>
<td><pre>                } else if (font.equals(&quot;david&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1377" href="#"></a></td>
<td><pre>                    file = fontToFileMap.get(&quot;david regular&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1378" href="#"></a></td>
<td><pre>                    if (file != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1379" href="#"></a></td>
<td><pre>                        fontToFileMap.remove(&quot;david regular&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1380" href="#"></a></td>
<td><pre>                        fontToFileMap.put(&quot;david&quot;, file);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1381" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1382" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1383" href="#"></a></td>
<td><pre>                    if (unmappedFontNames == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1384" href="#"></a></td>
<td><pre>                        unmappedFontNames = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1385" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1386" href="#"></a></td>
<td><pre>                    unmappedFontNames.add(font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1387" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1388" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1389" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1390" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1391" href="#"></a></td>
<td><pre>        if (unmappedFontNames != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1392" href="#"></a></td>
<td><pre>            HashSet&lt;String&gt; unmappedFontFiles = new HashSet&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1393" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1394" href="#"></a></td>
<td><pre>            /* Every font key in fontToFileMap ought to correspond to a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1395" href="#"></a></td>
<td><pre>             * font key in fontToFamilyNameMap. Entries that don't seem</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1396" href="#"></a></td>
<td><pre>             * to correspond are likely fonts that were named differently</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1397" href="#"></a></td>
<td><pre>             * by GDI than in the registry. One known cause of this is when</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1398" href="#"></a></td>
<td><pre>             * Windows has had its regional settings changed so that from</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1399" href="#"></a></td>
<td><pre>             * GDI we get a localised (eg Chinese or Japanese) name for the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1400" href="#"></a></td>
<td><pre>             * font, but the registry retains the English version of the name</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1401" href="#"></a></td>
<td><pre>             * that corresponded to the &quot;install&quot; locale for windows.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1402" href="#"></a></td>
<td><pre>             * Since we are in this code block because there are unmapped</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1403" href="#"></a></td>
<td><pre>             * font names, we can look to find unused font-&gt;file mappings</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1404" href="#"></a></td>
<td><pre>             * and then open the files to read the names. We don't generally</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1405" href="#"></a></td>
<td><pre>             * want to open font files, as its a performance hit, but this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1406" href="#"></a></td>
<td><pre>             * occurs only for a small number of fonts on specific system</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1407" href="#"></a></td>
<td><pre>             * configs - ie is believed that a &quot;true&quot; Japanese windows would</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1408" href="#"></a></td>
<td><pre>             * have JA names in the registry too.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1409" href="#"></a></td>
<td><pre>             * Clone fontToFileMap and remove from the clone all keys which</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1410" href="#"></a></td>
<td><pre>             * match a fontToFamilyNameMap key. What remains maps to the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1411" href="#"></a></td>
<td><pre>             * files we want to open to find the fonts GDI returned.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1412" href="#"></a></td>
<td><pre>             * A font in such a file is added to the fontToFileMap after</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1413" href="#"></a></td>
<td><pre>             * checking its one of the unmappedFontNames we are looking for.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1414" href="#"></a></td>
<td><pre>             * The original name that didn't map is removed from fontToFileMap</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1415" href="#"></a></td>
<td><pre>             * so essentially this &quot;fixes up&quot; fontToFileMap to use the same</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1416" href="#"></a></td>
<td><pre>             * name as GDI.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1417" href="#"></a></td>
<td><pre>             * Also note that typically the fonts for which this occurs in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1418" href="#"></a></td>
<td><pre>             * CJK locales are TTC fonts and not all fonts in a TTC may have</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1419" href="#"></a></td>
<td><pre>             * localised names. Eg MSGOTHIC.TTC contains 3 fonts and one of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1420" href="#"></a></td>
<td><pre>             * them &quot;MS UI Gothic&quot; has no JA name whereas the other two do.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1421" href="#"></a></td>
<td><pre>             * So not every font in these files is unmapped or new.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1422" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1423" href="#"></a></td>
<td><pre>            HashMap&lt;String,String&gt; ffmapCopy =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1424" href="#"></a></td>
<td><pre>                (HashMap&lt;String,String&gt;)(fontToFileMap.clone());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1425" href="#"></a></td>
<td><pre>            for (String key : fontToFamilyNameMap.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1426" href="#"></a></td>
<td><pre>                ffmapCopy.remove(key);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1427" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1428" href="#"></a></td>
<td><pre>            for (String key : ffmapCopy.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1429" href="#"></a></td>
<td><pre>                unmappedFontFiles.add(ffmapCopy.get(key));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1430" href="#"></a></td>
<td><pre>                fontToFileMap.remove(key);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1431" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1432" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1433" href="#"></a></td>
<td><pre>            resolveFontFiles(unmappedFontFiles, unmappedFontNames);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1434" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1435" href="#"></a></td>
<td><pre>            /* If there are still unmapped font names, this means there's</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1436" href="#"></a></td>
<td><pre>             * something that wasn't in the registry. We need to get all</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1437" href="#"></a></td>
<td><pre>             * the font files directly and look at the ones that weren't</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1438" href="#"></a></td>
<td><pre>             * found in the registry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1439" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1440" href="#"></a></td>
<td><pre>            if (unmappedFontNames.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1441" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1442" href="#"></a></td>
<td><pre>                /* getFontFilesFromPath() returns all lower case names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1443" href="#"></a></td>
<td><pre>                 * To compare we also need lower case</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1444" href="#"></a></td>
<td><pre>                 * versions of the names from the registry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1445" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1446" href="#"></a></td>
<td><pre>                ArrayList&lt;String&gt; registryFiles = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1447" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1448" href="#"></a></td>
<td><pre>                for (String regFile : fontToFileMap.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1449" href="#"></a></td>
<td><pre>                    registryFiles.add(regFile.toLowerCase());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1450" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1451" href="#"></a></td>
<td><pre>                /* We don't look for Type1 files here as windows will</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1452" href="#"></a></td>
<td><pre>                 * not enumerate these, so aren't useful in reconciling</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1453" href="#"></a></td>
<td><pre>                 * GDI's unmapped files. We do find these later when</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1454" href="#"></a></td>
<td><pre>                 * we enumerate all fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1455" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1456" href="#"></a></td>
<td><pre>                for (String pathFile : getFontFilesFromPath(true)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1457" href="#"></a></td>
<td><pre>                    if (!registryFiles.contains(pathFile)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1458" href="#"></a></td>
<td><pre>                        unmappedFontFiles.add(pathFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1459" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1460" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1461" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1462" href="#"></a></td>
<td><pre>                resolveFontFiles(unmappedFontFiles, unmappedFontNames);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1463" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1464" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1465" href="#"></a></td>
<td><pre>            /* remove from the set of names that will be returned to the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1466" href="#"></a></td>
<td><pre>             * user any fonts that can't be mapped to files.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1467" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1468" href="#"></a></td>
<td><pre>            if (unmappedFontNames.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1469" href="#"></a></td>
<td><pre>                int sz = unmappedFontNames.size();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1470" href="#"></a></td>
<td><pre>                for (int i=0; i&lt;sz; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1471" href="#"></a></td>
<td><pre>                    String name = unmappedFontNames.get(i);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1472" href="#"></a></td>
<td><pre>                    String familyName = fontToFamilyNameMap.get(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1473" href="#"></a></td>
<td><pre>                    if (familyName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1474" href="#"></a></td>
<td><pre>                        ArrayList family = familyToFontListMap.get(familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1475" href="#"></a></td>
<td><pre>                        if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1476" href="#"></a></td>
<td><pre>                            if (family.size() &lt;= 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1477" href="#"></a></td>
<td><pre>                                familyToFontListMap.remove(familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1478" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1479" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1480" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1481" href="#"></a></td>
<td><pre>                    fontToFamilyNameMap.remove(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1482" href="#"></a></td>
<td><pre>                    if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1483" href="#"></a></td>
<td><pre>                        FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1484" href="#"></a></td>
<td><pre>                                             .info(&quot;No file for font:&quot; + name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1485" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1486" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1487" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1488" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1489" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1490" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1491" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1492" href="#"></a></td>
<td><pre>     * In some cases windows may have fonts in the fonts folder that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1493" href="#"></a></td>
<td><pre>     * don't show up in the registry or in the GDI calls to enumerate fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1494" href="#"></a></td>
<td><pre>     * The only way to find these is to list the directory. We invoke this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1495" href="#"></a></td>
<td><pre>     * only in getAllFonts/Families, so most searches for a specific</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1496" href="#"></a></td>
<td><pre>     * font that is satisfied by the GDI/registry calls don't take the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1497" href="#"></a></td>
<td><pre>     * additional hit of listing the directory. This hit is small enough</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1498" href="#"></a></td>
<td><pre>     * that its not significant in these 'enumerate all the fonts' cases.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1499" href="#"></a></td>
<td><pre>     * The basic approach is to cross-reference the files windows found</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1500" href="#"></a></td>
<td><pre>     * with the ones in the directory listing approach, and for each</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1501" href="#"></a></td>
<td><pre>     * in the latter list that is missing from the former list, register it.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1502" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1503" href="#"></a></td>
<td><pre>    private synchronized void checkForUnreferencedFontFiles() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1504" href="#"></a></td>
<td><pre>        if (haveCheckedUnreferencedFontFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1505" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1506" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1507" href="#"></a></td>
<td><pre>        haveCheckedUnreferencedFontFiles = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1508" href="#"></a></td>
<td><pre>        if (!FontUtilities.isWindows) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1509" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1510" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1511" href="#"></a></td>
<td><pre>        /* getFontFilesFromPath() returns all lower case names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1512" href="#"></a></td>
<td><pre>         * To compare we also need lower case</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1513" href="#"></a></td>
<td><pre>         * versions of the names from the registry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1514" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1515" href="#"></a></td>
<td><pre>        ArrayList&lt;String&gt; registryFiles = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1516" href="#"></a></td>
<td><pre>        for (String regFile : fontToFileMap.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1517" href="#"></a></td>
<td><pre>            registryFiles.add(regFile.toLowerCase());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1518" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1519" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1520" href="#"></a></td>
<td><pre>        /* To avoid any issues with concurrent modification, create</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1521" href="#"></a></td>
<td><pre>         * copies of the existing maps, add the new fonts into these</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1522" href="#"></a></td>
<td><pre>         * and then replace the references to the old ones with the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1523" href="#"></a></td>
<td><pre>         * new maps. ConcurrentHashmap is another option but its a lot</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1524" href="#"></a></td>
<td><pre>         * more changes and with this exception, these maps are intended</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1525" href="#"></a></td>
<td><pre>         * to be static.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1526" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1527" href="#"></a></td>
<td><pre>        HashMap&lt;String,String&gt; fontToFileMap2 = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1528" href="#"></a></td>
<td><pre>        HashMap&lt;String,String&gt; fontToFamilyNameMap2 = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1529" href="#"></a></td>
<td><pre>        HashMap&lt;String,ArrayList&lt;String&gt;&gt; familyToFontListMap2 = null;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1530" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1531" href="#"></a></td>
<td><pre>        for (String pathFile : getFontFilesFromPath(false)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1532" href="#"></a></td>
<td><pre>            if (!registryFiles.contains(pathFile)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1533" href="#"></a></td>
<td><pre>                if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1534" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1535" href="#"></a></td>
<td><pre>                                 .info(&quot;Found non-registry file : &quot; + pathFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1536" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1537" href="#"></a></td>
<td><pre>                PhysicalFont f = registerFontFile(getPathName(pathFile));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1538" href="#"></a></td>
<td><pre>                if (f == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1539" href="#"></a></td>
<td><pre>                    continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1540" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1541" href="#"></a></td>
<td><pre>                if (fontToFileMap2 == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1542" href="#"></a></td>
<td><pre>                    fontToFileMap2 = new HashMap&lt;String,String&gt;(fontToFileMap);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1543" href="#"></a></td>
<td><pre>                    fontToFamilyNameMap2 =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1544" href="#"></a></td>
<td><pre>                        new HashMap&lt;String,String&gt;(fontToFamilyNameMap);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1545" href="#"></a></td>
<td><pre>                    familyToFontListMap2 = new</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1546" href="#"></a></td>
<td><pre>                        HashMap&lt;String,ArrayList&lt;String&gt;&gt;(familyToFontListMap);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1547" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1548" href="#"></a></td>
<td><pre>                String fontName = f.getFontName(null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1549" href="#"></a></td>
<td><pre>                String family = f.getFamilyName(null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1550" href="#"></a></td>
<td><pre>                String familyLC = family.toLowerCase();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1551" href="#"></a></td>
<td><pre>                fontToFamilyNameMap2.put(fontName, family);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1552" href="#"></a></td>
<td><pre>                fontToFileMap2.put(fontName, pathFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1553" href="#"></a></td>
<td><pre>                ArrayList&lt;String&gt; fonts = familyToFontListMap2.get(familyLC);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1554" href="#"></a></td>
<td><pre>                if (fonts == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1555" href="#"></a></td>
<td><pre>                    fonts = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1556" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1557" href="#"></a></td>
<td><pre>                    fonts = new ArrayList&lt;String&gt;(fonts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1558" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1559" href="#"></a></td>
<td><pre>                fonts.add(fontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1560" href="#"></a></td>
<td><pre>                familyToFontListMap2.put(familyLC, fonts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1561" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1562" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1563" href="#"></a></td>
<td><pre>        if (fontToFileMap2 != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1564" href="#"></a></td>
<td><pre>            fontToFileMap = fontToFileMap2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1565" href="#"></a></td>
<td><pre>            familyToFontListMap = familyToFontListMap2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1566" href="#"></a></td>
<td><pre>            fontToFamilyNameMap = fontToFamilyNameMap2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1567" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1568" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1569" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1570" href="#"></a></td>
<td><pre>    private void resolveFontFiles(HashSet&lt;String&gt; unmappedFiles,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1571" href="#"></a></td>
<td><pre>                                  ArrayList&lt;String&gt; unmappedFonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1572" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1573" href="#"></a></td>
<td><pre>        Locale l = SunToolkit.getStartupLocale();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1574" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1575" href="#"></a></td>
<td><pre>        for (String file : unmappedFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1576" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1577" href="#"></a></td>
<td><pre>                int fn = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1578" href="#"></a></td>
<td><pre>                TrueTypeFont ttf;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1579" href="#"></a></td>
<td><pre>                String fullPath = getPathName(file);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1580" href="#"></a></td>
<td><pre>                if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1581" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1582" href="#"></a></td>
<td><pre>                                   .info(&quot;Trying to resolve file &quot; + fullPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1583" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1584" href="#"></a></td>
<td><pre>                do {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1585" href="#"></a></td>
<td><pre>                    ttf = new TrueTypeFont(fullPath, null, fn++, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1586" href="#"></a></td>
<td><pre>                    //  prefer the font's locale name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1587" href="#"></a></td>
<td><pre>                    String fontName = ttf.getFontName(l).toLowerCase();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1588" href="#"></a></td>
<td><pre>                    if (unmappedFonts.contains(fontName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1589" href="#"></a></td>
<td><pre>                        fontToFileMap.put(fontName, file);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1590" href="#"></a></td>
<td><pre>                        unmappedFonts.remove(fontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1591" href="#"></a></td>
<td><pre>                        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1592" href="#"></a></td>
<td><pre>                            FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1593" href="#"></a></td>
<td><pre>                                  .info(&quot;Resolved absent registry entry for &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1594" href="#"></a></td>
<td><pre>                                        fontName + &quot; located in &quot; + fullPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1595" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1596" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1597" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1598" href="#"></a></td>
<td><pre>                while (fn &lt; ttf.getFontCount());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1599" href="#"></a></td>
<td><pre>            } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1600" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1601" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1602" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1603" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1604" href="#"></a></td>
<td><pre>    /* Hardwire the English names and expected file names of fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1605" href="#"></a></td>
<td><pre>     * commonly used at start up. Avoiding until later even the small</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1606" href="#"></a></td>
<td><pre>     * cost of calling platform APIs to locate these can help.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1607" href="#"></a></td>
<td><pre>     * The code that registers these fonts needs to &quot;bail&quot; if any</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1608" href="#"></a></td>
<td><pre>     * of the files do not exist, so it will verify the existence of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1609" href="#"></a></td>
<td><pre>     * all non-null file names first.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1610" href="#"></a></td>
<td><pre>     * They are added in to a map with nominally the first</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1611" href="#"></a></td>
<td><pre>     * word in the name of the family as the key. In all the cases</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1612" href="#"></a></td>
<td><pre>     * we are using the the family name is a single word, and as is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1613" href="#"></a></td>
<td><pre>     * more or less required the family name is the initial sequence</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1614" href="#"></a></td>
<td><pre>     * in a full name. So lookup first finds the matching description,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1615" href="#"></a></td>
<td><pre>     * then registers the whole family, returning the right font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1616" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1617" href="#"></a></td>
<td><pre>    public static class FamilyDescription {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1618" href="#"></a></td>
<td><pre>        public String familyName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1619" href="#"></a></td>
<td><pre>        public String plainFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1620" href="#"></a></td>
<td><pre>        public String boldFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1621" href="#"></a></td>
<td><pre>        public String italicFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1622" href="#"></a></td>
<td><pre>        public String boldItalicFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1623" href="#"></a></td>
<td><pre>        public String plainFileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1624" href="#"></a></td>
<td><pre>        public String boldFileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1625" href="#"></a></td>
<td><pre>        public String italicFileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1626" href="#"></a></td>
<td><pre>        public String boldItalicFileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1627" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1628" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1629" href="#"></a></td>
<td><pre>    static HashMap&lt;String, FamilyDescription&gt; platformFontMap;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1630" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1631" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1632" href="#"></a></td>
<td><pre>     * default implementation does nothing.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1633" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1634" href="#"></a></td>
<td><pre>    public HashMap&lt;String, FamilyDescription&gt; populateHardcodedFileNameMap() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1635" href="#"></a></td>
<td><pre>        return new HashMap&lt;String, FamilyDescription&gt;(0);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1636" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1637" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1638" href="#"></a></td>
<td><pre>    Font2D findFontFromPlatformMap(String lcName, int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1639" href="#"></a></td>
<td><pre>        if (platformFontMap == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1640" href="#"></a></td>
<td><pre>            platformFontMap = populateHardcodedFileNameMap();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1641" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1642" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1643" href="#"></a></td>
<td><pre>        if (platformFontMap == null || platformFontMap.size() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1644" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1645" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1646" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1647" href="#"></a></td>
<td><pre>        int spaceIndex = lcName.indexOf(' ');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1648" href="#"></a></td>
<td><pre>        String firstWord = lcName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1649" href="#"></a></td>
<td><pre>        if (spaceIndex &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1650" href="#"></a></td>
<td><pre>            firstWord = lcName.substring(0, spaceIndex);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1651" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1652" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1653" href="#"></a></td>
<td><pre>        FamilyDescription fd = platformFontMap.get(firstWord);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1654" href="#"></a></td>
<td><pre>        if (fd == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1655" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1656" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1657" href="#"></a></td>
<td><pre>        /* Once we've established that its at least the first word,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1658" href="#"></a></td>
<td><pre>         * we need to dig deeper to make sure its a match for either</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1659" href="#"></a></td>
<td><pre>         * a full name, or the family name, to make sure its not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1660" href="#"></a></td>
<td><pre>         * a request for some other font that just happens to start</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1661" href="#"></a></td>
<td><pre>         * with the same first word.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1662" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1663" href="#"></a></td>
<td><pre>        int styleIndex = -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1664" href="#"></a></td>
<td><pre>        if (lcName.equalsIgnoreCase(fd.plainFullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1665" href="#"></a></td>
<td><pre>            styleIndex = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1666" href="#"></a></td>
<td><pre>        } else if (lcName.equalsIgnoreCase(fd.boldFullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1667" href="#"></a></td>
<td><pre>            styleIndex = 1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1668" href="#"></a></td>
<td><pre>        } else if (lcName.equalsIgnoreCase(fd.italicFullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1669" href="#"></a></td>
<td><pre>            styleIndex = 2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1670" href="#"></a></td>
<td><pre>        } else if (lcName.equalsIgnoreCase(fd.boldItalicFullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1671" href="#"></a></td>
<td><pre>            styleIndex = 3;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1672" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1673" href="#"></a></td>
<td><pre>        if (styleIndex == -1 &amp;&amp; !lcName.equalsIgnoreCase(fd.familyName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1674" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1675" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1676" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1677" href="#"></a></td>
<td><pre>        String plainFile = null, boldFile = null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1678" href="#"></a></td>
<td><pre>            italicFile = null, boldItalicFile = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1679" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1680" href="#"></a></td>
<td><pre>        boolean failure = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1681" href="#"></a></td>
<td><pre>        /* In a terminal server config, its possible that getPathName()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1682" href="#"></a></td>
<td><pre>         * will return null, if the file doesn't exist, hence the null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1683" href="#"></a></td>
<td><pre>         * checks on return. But in the normal client config we need to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1684" href="#"></a></td>
<td><pre>         * follow this up with a check to see if all the files really</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1685" href="#"></a></td>
<td><pre>         * exist for the non-null paths.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1686" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1687" href="#"></a></td>
<td><pre>         getPlatformFontDirs(noType1Font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1688" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1689" href="#"></a></td>
<td><pre>        if (fd.plainFileName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1690" href="#"></a></td>
<td><pre>            plainFile = getPathName(fd.plainFileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1691" href="#"></a></td>
<td><pre>            if (plainFile == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1692" href="#"></a></td>
<td><pre>                failure = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1693" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1694" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1695" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1696" href="#"></a></td>
<td><pre>        if (fd.boldFileName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1697" href="#"></a></td>
<td><pre>            boldFile = getPathName(fd.boldFileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1698" href="#"></a></td>
<td><pre>            if (boldFile == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1699" href="#"></a></td>
<td><pre>                failure = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1700" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1701" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1702" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1703" href="#"></a></td>
<td><pre>        if (fd.italicFileName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1704" href="#"></a></td>
<td><pre>            italicFile = getPathName(fd.italicFileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1705" href="#"></a></td>
<td><pre>            if (italicFile == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1706" href="#"></a></td>
<td><pre>                failure = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1707" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1708" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1709" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1710" href="#"></a></td>
<td><pre>        if (fd.boldItalicFileName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1711" href="#"></a></td>
<td><pre>            boldItalicFile = getPathName(fd.boldItalicFileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1712" href="#"></a></td>
<td><pre>            if (boldItalicFile == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1713" href="#"></a></td>
<td><pre>                failure = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1714" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1715" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1716" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1717" href="#"></a></td>
<td><pre>        if (failure) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1718" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1719" href="#"></a></td>
<td><pre>                FontUtilities.getLogger().</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1720" href="#"></a></td>
<td><pre>                    info(&quot;Hardcoded file missing looking for &quot; + lcName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1721" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1722" href="#"></a></td>
<td><pre>            platformFontMap.remove(firstWord);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1723" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1724" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1725" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1726" href="#"></a></td>
<td><pre>        /* Some of these may be null,as not all styles have to exist */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1727" href="#"></a></td>
<td><pre>        final String[] files = {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1728" href="#"></a></td>
<td><pre>            plainFile, boldFile, italicFile, boldItalicFile } ;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1729" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1730" href="#"></a></td>
<td><pre>        failure = java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1731" href="#"></a></td>
<td><pre>                 new java.security.PrivilegedAction&lt;Boolean&gt;() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1732" href="#"></a></td>
<td><pre>                     public Boolean run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1733" href="#"></a></td>
<td><pre>                         for (int i=0; i&lt;files.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1734" href="#"></a></td>
<td><pre>                             if (files[i] == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1735" href="#"></a></td>
<td><pre>                                 continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1736" href="#"></a></td>
<td><pre>                             }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1737" href="#"></a></td>
<td><pre>                             File f = new File(files[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1738" href="#"></a></td>
<td><pre>                             if (!f.exists()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1739" href="#"></a></td>
<td><pre>                                 return Boolean.TRUE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1740" href="#"></a></td>
<td><pre>                             }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1741" href="#"></a></td>
<td><pre>                         }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1742" href="#"></a></td>
<td><pre>                         return Boolean.FALSE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1743" href="#"></a></td>
<td><pre>                     }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1744" href="#"></a></td>
<td><pre>                 });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1745" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1746" href="#"></a></td>
<td><pre>        if (failure) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1747" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1748" href="#"></a></td>
<td><pre>                FontUtilities.getLogger().</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1749" href="#"></a></td>
<td><pre>                    info(&quot;Hardcoded file missing looking for &quot; + lcName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1750" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1751" href="#"></a></td>
<td><pre>            platformFontMap.remove(firstWord);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1752" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1753" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1754" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1755" href="#"></a></td>
<td><pre>        /* If we reach here we know that we have all the files we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1756" href="#"></a></td>
<td><pre>         * expect, so all should be fine so long as the contents</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1757" href="#"></a></td>
<td><pre>         * are what we'd expect. Now on to registering the fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1758" href="#"></a></td>
<td><pre>         * Currently this code only looks for TrueType fonts, so format</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1759" href="#"></a></td>
<td><pre>         * and rank can be specified without looking at the filename.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1760" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1761" href="#"></a></td>
<td><pre>        Font2D font = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1762" href="#"></a></td>
<td><pre>        for (int f=0;f&lt;files.length;f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1763" href="#"></a></td>
<td><pre>            if (files[f] == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1764" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1765" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1766" href="#"></a></td>
<td><pre>            PhysicalFont pf =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1767" href="#"></a></td>
<td><pre>                registerFontFile(files[f], null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1768" href="#"></a></td>
<td><pre>                                 FONTFORMAT_TRUETYPE, false, Font2D.TTF_RANK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1769" href="#"></a></td>
<td><pre>            if (f == styleIndex) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1770" href="#"></a></td>
<td><pre>                font = pf;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1771" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1772" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1773" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1774" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1775" href="#"></a></td>
<td><pre>        /* Two general cases need a bit more work here.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1776" href="#"></a></td>
<td><pre>         * 1) If font is null, then it was perhaps a request for a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1777" href="#"></a></td>
<td><pre>         * non-existent font, such as &quot;Tahoma Italic&quot;, or a family name -</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1778" href="#"></a></td>
<td><pre>         * where family and full name of the plain font differ.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1779" href="#"></a></td>
<td><pre>         * Fall back to finding the closest one in the family.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1780" href="#"></a></td>
<td><pre>         * This could still fail if a client specified &quot;Segoe&quot; instead of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1781" href="#"></a></td>
<td><pre>         * &quot;Segoe UI&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1782" href="#"></a></td>
<td><pre>         * 2) The request is of the form &quot;MyFont Bold&quot;, style=Font.ITALIC,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1783" href="#"></a></td>
<td><pre>         * and so we want to see if there's a Bold Italic font, or</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1784" href="#"></a></td>
<td><pre>         * &quot;MyFamily&quot;, style=Font.BOLD, and we may have matched the plain,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1785" href="#"></a></td>
<td><pre>         * but now need to revise that to the BOLD font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1786" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1787" href="#"></a></td>
<td><pre>        FontFamily fontFamily = FontFamily.getFamily(fd.familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1788" href="#"></a></td>
<td><pre>        if (fontFamily != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1789" href="#"></a></td>
<td><pre>            if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1790" href="#"></a></td>
<td><pre>                font = fontFamily.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1791" href="#"></a></td>
<td><pre>                if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1792" href="#"></a></td>
<td><pre>                    font = fontFamily.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1793" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1794" href="#"></a></td>
<td><pre>            } else if (style &gt; 0 &amp;&amp; style != font.style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1795" href="#"></a></td>
<td><pre>                style |= font.style;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1796" href="#"></a></td>
<td><pre>                font = fontFamily.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1797" href="#"></a></td>
<td><pre>                if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1798" href="#"></a></td>
<td><pre>                    font = fontFamily.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1799" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1800" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1801" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1802" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1803" href="#"></a></td>
<td><pre>        return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1804" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1805" href="#"></a></td>
<td><pre>    private synchronized HashMap&lt;String,String&gt; getFullNameToFileMap() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1806" href="#"></a></td>
<td><pre>        if (fontToFileMap == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1807" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1808" href="#"></a></td>
<td><pre>            pathDirs = getPlatformFontDirs(noType1Font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1809" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1810" href="#"></a></td>
<td><pre>            fontToFileMap = new HashMap&lt;String,String&gt;(100);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1811" href="#"></a></td>
<td><pre>            fontToFamilyNameMap = new HashMap&lt;String,String&gt;(100);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1812" href="#"></a></td>
<td><pre>            familyToFontListMap = new HashMap&lt;String,ArrayList&lt;String&gt;&gt;(50);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1813" href="#"></a></td>
<td><pre>            populateFontFileNameMap(fontToFileMap,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1814" href="#"></a></td>
<td><pre>                                    fontToFamilyNameMap,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1815" href="#"></a></td>
<td><pre>                                    familyToFontListMap,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1816" href="#"></a></td>
<td><pre>                                    Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1817" href="#"></a></td>
<td><pre>            if (FontUtilities.isWindows) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1818" href="#"></a></td>
<td><pre>                resolveWindowsFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1819" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1820" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1821" href="#"></a></td>
<td><pre>                logPlatformFontInfo();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1822" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1823" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1824" href="#"></a></td>
<td><pre>        return fontToFileMap;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1825" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1826" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1827" href="#"></a></td>
<td><pre>    private void logPlatformFontInfo() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1828" href="#"></a></td>
<td><pre>        PlatformLogger logger = FontUtilities.getLogger();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1829" href="#"></a></td>
<td><pre>        for (int i=0; i&lt; pathDirs.length;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1830" href="#"></a></td>
<td><pre>            logger.info(&quot;fontdir=&quot;+pathDirs[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1831" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1832" href="#"></a></td>
<td><pre>        for (String keyName : fontToFileMap.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1833" href="#"></a></td>
<td><pre>            logger.info(&quot;font=&quot;+keyName+&quot; file=&quot;+ fontToFileMap.get(keyName));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1834" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1835" href="#"></a></td>
<td><pre>        for (String keyName : fontToFamilyNameMap.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1836" href="#"></a></td>
<td><pre>            logger.info(&quot;font=&quot;+keyName+&quot; family=&quot;+</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1837" href="#"></a></td>
<td><pre>                        fontToFamilyNameMap.get(keyName));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1838" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1839" href="#"></a></td>
<td><pre>        for (String keyName : familyToFontListMap.keySet()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1840" href="#"></a></td>
<td><pre>            logger.info(&quot;family=&quot;+keyName+ &quot; fonts=&quot;+</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1841" href="#"></a></td>
<td><pre>                        familyToFontListMap.get(keyName));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1842" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1843" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1844" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1845" href="#"></a></td>
<td><pre>    /* Note this return list excludes logical fonts and JRE fonts */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1846" href="#"></a></td>
<td><pre>    protected String[] getFontNamesFromPlatform() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1847" href="#"></a></td>
<td><pre>        if (getFullNameToFileMap().size() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1848" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1849" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1850" href="#"></a></td>
<td><pre>        checkForUnreferencedFontFiles();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1851" href="#"></a></td>
<td><pre>        /* This odd code with TreeMap is used to preserve a historical</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1852" href="#"></a></td>
<td><pre>         * behaviour wrt the sorting order .. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1853" href="#"></a></td>
<td><pre>        ArrayList&lt;String&gt; fontNames = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1854" href="#"></a></td>
<td><pre>        for (ArrayList&lt;String&gt; a : familyToFontListMap.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1855" href="#"></a></td>
<td><pre>            for (String s : a) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1856" href="#"></a></td>
<td><pre>                fontNames.add(s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1857" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1858" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1859" href="#"></a></td>
<td><pre>        return fontNames.toArray(STR_ARRAY);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1860" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1861" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1862" href="#"></a></td>
<td><pre>    public boolean gotFontsFromPlatform() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1863" href="#"></a></td>
<td><pre>        return getFullNameToFileMap().size() != 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1864" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1865" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1866" href="#"></a></td>
<td><pre>    public String getFileNameForFontName(String fontName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1867" href="#"></a></td>
<td><pre>        String fontNameLC = fontName.toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1868" href="#"></a></td>
<td><pre>        return fontToFileMap.get(fontNameLC);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1869" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1870" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1871" href="#"></a></td>
<td><pre>    private PhysicalFont registerFontFile(String file) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1872" href="#"></a></td>
<td><pre>        if (new File(file).isAbsolute() &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1873" href="#"></a></td>
<td><pre>            !registeredFonts.contains(file)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1874" href="#"></a></td>
<td><pre>            int fontFormat = FONTFORMAT_NONE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1875" href="#"></a></td>
<td><pre>            int fontRank = Font2D.UNKNOWN_RANK;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1876" href="#"></a></td>
<td><pre>            if (ttFilter.accept(null, file)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1877" href="#"></a></td>
<td><pre>                fontFormat = FONTFORMAT_TRUETYPE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1878" href="#"></a></td>
<td><pre>                fontRank = Font2D.TTF_RANK;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1879" href="#"></a></td>
<td><pre>            } else if</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1880" href="#"></a></td>
<td><pre>                (t1Filter.accept(null, file)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1881" href="#"></a></td>
<td><pre>                fontFormat = FONTFORMAT_TYPE1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1882" href="#"></a></td>
<td><pre>                fontRank = Font2D.TYPE1_RANK;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1883" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1884" href="#"></a></td>
<td><pre>            if (fontFormat == FONTFORMAT_NONE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1885" href="#"></a></td>
<td><pre>                return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1886" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1887" href="#"></a></td>
<td><pre>            return registerFontFile(file, null, fontFormat, false, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1888" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1889" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1890" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1891" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1892" href="#"></a></td>
<td><pre>    /* Used to register any font files that are found by platform APIs</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1893" href="#"></a></td>
<td><pre>     * that weren't previously found in the standard font locations.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1894" href="#"></a></td>
<td><pre>     * the isAbsolute() check is needed since that's whats stored in the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1895" href="#"></a></td>
<td><pre>     * set, and on windows, the fonts in the system font directory that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1896" href="#"></a></td>
<td><pre>     * are in the fontToFileMap are just basenames. We don't want to try</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1897" href="#"></a></td>
<td><pre>     * to register those again, but we do want to register other registry</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1898" href="#"></a></td>
<td><pre>     * installed fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1899" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1900" href="#"></a></td>
<td><pre>    protected void registerOtherFontFiles(HashSet registeredFontFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1901" href="#"></a></td>
<td><pre>        if (getFullNameToFileMap().size() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1902" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1903" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1904" href="#"></a></td>
<td><pre>        for (String file : fontToFileMap.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1905" href="#"></a></td>
<td><pre>            registerFontFile(file);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1906" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1907" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1908" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1909" href="#"></a></td>
<td><pre>    public boolean</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1910" href="#"></a></td>
<td><pre>        getFamilyNamesFromPlatform(TreeMap&lt;String,String&gt; familyNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1911" href="#"></a></td>
<td><pre>                                   Locale requestedLocale) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1912" href="#"></a></td>
<td><pre>        if (getFullNameToFileMap().size() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1913" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1914" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1915" href="#"></a></td>
<td><pre>        checkForUnreferencedFontFiles();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1916" href="#"></a></td>
<td><pre>        for (String name : fontToFamilyNameMap.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1917" href="#"></a></td>
<td><pre>            familyNames.put(name.toLowerCase(requestedLocale), name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1918" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1919" href="#"></a></td>
<td><pre>        return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1920" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1921" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1922" href="#"></a></td>
<td><pre>    /* Path may be absolute or a base file name relative to one of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1923" href="#"></a></td>
<td><pre>     * the platform font directories</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1924" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1925" href="#"></a></td>
<td><pre>    private String getPathName(final String s) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1926" href="#"></a></td>
<td><pre>        File f = new File(s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1927" href="#"></a></td>
<td><pre>        if (f.isAbsolute()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1928" href="#"></a></td>
<td><pre>            return s;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1929" href="#"></a></td>
<td><pre>        } else if (pathDirs.length==1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1930" href="#"></a></td>
<td><pre>            return pathDirs[0] + File.separator + s;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1931" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1932" href="#"></a></td>
<td><pre>            String path = java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1933" href="#"></a></td>
<td><pre>                 new java.security.PrivilegedAction&lt;String&gt;() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1934" href="#"></a></td>
<td><pre>                     public String run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1935" href="#"></a></td>
<td><pre>                         for (int p=0; p&lt;pathDirs.length; p++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1936" href="#"></a></td>
<td><pre>                             File f = new File(pathDirs[p] +File.separator+ s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1937" href="#"></a></td>
<td><pre>                             if (f.exists()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1938" href="#"></a></td>
<td><pre>                                 return f.getAbsolutePath();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1939" href="#"></a></td>
<td><pre>                             }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1940" href="#"></a></td>
<td><pre>                         }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1941" href="#"></a></td>
<td><pre>                         return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1942" href="#"></a></td>
<td><pre>                     }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1943" href="#"></a></td>
<td><pre>                });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1944" href="#"></a></td>
<td><pre>            if (path != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1945" href="#"></a></td>
<td><pre>                return path;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1946" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1947" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1948" href="#"></a></td>
<td><pre>        return s; // shouldn't happen, but harmless</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1949" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1950" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1951" href="#"></a></td>
<td><pre>    /* lcName is required to be lower case for use as a key.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1952" href="#"></a></td>
<td><pre>     * lcName may be a full name, or a family name, and style may</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1953" href="#"></a></td>
<td><pre>     * be specified in addition to either of these. So be sure to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1954" href="#"></a></td>
<td><pre>     * get the right one. Since an app *could* ask for &quot;Foo Regular&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1955" href="#"></a></td>
<td><pre>     * and later ask for &quot;Foo Italic&quot;, if we don't register all the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1956" href="#"></a></td>
<td><pre>     * styles, then logic in findFont2D may try to style the original</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1957" href="#"></a></td>
<td><pre>     * so we register the entire family if we get a match here.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1958" href="#"></a></td>
<td><pre>     * This is still a big win because this code is invoked where</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1959" href="#"></a></td>
<td><pre>     * otherwise we would register all fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1960" href="#"></a></td>
<td><pre>     * It's also useful for the case where &quot;Foo Bold&quot; was specified with</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1961" href="#"></a></td>
<td><pre>     * style Font.ITALIC, as we would want in that case to try to return</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1962" href="#"></a></td>
<td><pre>     * &quot;Foo Bold Italic&quot; if it exists, and it is only by locating &quot;Foo Bold&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1963" href="#"></a></td>
<td><pre>     * and opening it that we really &quot;know&quot; it's Bold, and can look for</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1964" href="#"></a></td>
<td><pre>     * a font that supports that and the italic style.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1965" href="#"></a></td>
<td><pre>     * The code in here is not overtly windows-specific but in fact it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1966" href="#"></a></td>
<td><pre>     * is unlikely to be useful as is on other platforms. It is maintained</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1967" href="#"></a></td>
<td><pre>     * in this shared source file to be close to its sole client and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1968" href="#"></a></td>
<td><pre>     * because so much of the logic is intertwined with the logic in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1969" href="#"></a></td>
<td><pre>     * findFont2D.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1970" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1971" href="#"></a></td>
<td><pre>    private Font2D findFontFromPlatform(String lcName, int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1972" href="#"></a></td>
<td><pre>        if (getFullNameToFileMap().size() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1973" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1974" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1975" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1976" href="#"></a></td>
<td><pre>        ArrayList&lt;String&gt; family = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1977" href="#"></a></td>
<td><pre>        String fontFile = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1978" href="#"></a></td>
<td><pre>        String familyName = fontToFamilyNameMap.get(lcName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1979" href="#"></a></td>
<td><pre>        if (familyName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1980" href="#"></a></td>
<td><pre>            fontFile = fontToFileMap.get(lcName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1981" href="#"></a></td>
<td><pre>            family = familyToFontListMap.get</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1982" href="#"></a></td>
<td><pre>                (familyName.toLowerCase(Locale.ENGLISH));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1983" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1984" href="#"></a></td>
<td><pre>            family = familyToFontListMap.get(lcName); // is lcName is a family?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1985" href="#"></a></td>
<td><pre>            if (family != null &amp;&amp; family.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1986" href="#"></a></td>
<td><pre>                String lcFontName = family.get(0).toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1987" href="#"></a></td>
<td><pre>                if (lcFontName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1988" href="#"></a></td>
<td><pre>                    familyName = fontToFamilyNameMap.get(lcFontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1989" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1990" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1991" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1992" href="#"></a></td>
<td><pre>        if (family == null || familyName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1993" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1994" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1995" href="#"></a></td>
<td><pre>        String [] fontList = (String[])family.toArray(STR_ARRAY);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1996" href="#"></a></td>
<td><pre>        if (fontList.length == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1997" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1998" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1999" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2000" href="#"></a></td>
<td><pre>        /* first check that for every font in this family we can find</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2001" href="#"></a></td>
<td><pre>         * a font file. The specific reason for doing this is that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2002" href="#"></a></td>
<td><pre>         * in at least one case on Windows a font has the face name &quot;David&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2003" href="#"></a></td>
<td><pre>         * but the registry entry is &quot;David Regular&quot;. That is the &quot;unique&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2004" href="#"></a></td>
<td><pre>         * name of the font but in other cases the registry contains the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2005" href="#"></a></td>
<td><pre>         * &quot;full&quot; name. See the specifications of name ids 3 and 4 in the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2006" href="#"></a></td>
<td><pre>         * TrueType 'name' table.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2007" href="#"></a></td>
<td><pre>         * In general this could cause a problem that we fail to register</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2008" href="#"></a></td>
<td><pre>         * if we all members of a family that we may end up mapping to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2009" href="#"></a></td>
<td><pre>         * the wrong font member: eg return Bold when Plain is needed.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2010" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2011" href="#"></a></td>
<td><pre>        for (int f=0;f&lt;fontList.length;f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2012" href="#"></a></td>
<td><pre>            String fontNameLC = fontList[f].toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2013" href="#"></a></td>
<td><pre>            String fileName = fontToFileMap.get(fontNameLC);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2014" href="#"></a></td>
<td><pre>            if (fileName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2015" href="#"></a></td>
<td><pre>                if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2016" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2017" href="#"></a></td>
<td><pre>                          .info(&quot;Platform lookup : No file for font &quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2018" href="#"></a></td>
<td><pre>                                fontList[f] + &quot; in family &quot; +familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2019" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2020" href="#"></a></td>
<td><pre>                return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2021" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2022" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2023" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2024" href="#"></a></td>
<td><pre>        /* Currently this code only looks for TrueType fonts, so format</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2025" href="#"></a></td>
<td><pre>         * and rank can be specified without looking at the filename.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2026" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2027" href="#"></a></td>
<td><pre>        PhysicalFont physicalFont = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2028" href="#"></a></td>
<td><pre>        if (fontFile != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2029" href="#"></a></td>
<td><pre>            physicalFont = registerFontFile(getPathName(fontFile), null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2030" href="#"></a></td>
<td><pre>                                            FONTFORMAT_TRUETYPE, false,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2031" href="#"></a></td>
<td><pre>                                            Font2D.TTF_RANK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2032" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2033" href="#"></a></td>
<td><pre>        /* Register all fonts in this family. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2034" href="#"></a></td>
<td><pre>        for (int f=0;f&lt;fontList.length;f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2035" href="#"></a></td>
<td><pre>            String fontNameLC = fontList[f].toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2036" href="#"></a></td>
<td><pre>            String fileName = fontToFileMap.get(fontNameLC);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2037" href="#"></a></td>
<td><pre>            if (fontFile != null &amp;&amp; fontFile.equals(fileName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2038" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2039" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2040" href="#"></a></td>
<td><pre>            /* Currently this code only looks for TrueType fonts, so format</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2041" href="#"></a></td>
<td><pre>             * and rank can be specified without looking at the filename.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2042" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2043" href="#"></a></td>
<td><pre>            registerFontFile(getPathName(fileName), null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2044" href="#"></a></td>
<td><pre>                             FONTFORMAT_TRUETYPE, false, Font2D.TTF_RANK);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2045" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2046" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2047" href="#"></a></td>
<td><pre>        Font2D font = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2048" href="#"></a></td>
<td><pre>        FontFamily fontFamily = FontFamily.getFamily(familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2049" href="#"></a></td>
<td><pre>        /* Handle case where request &quot;MyFont Bold&quot;, style=Font.ITALIC */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2050" href="#"></a></td>
<td><pre>        if (physicalFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2051" href="#"></a></td>
<td><pre>            style |= physicalFont.style;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2052" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2053" href="#"></a></td>
<td><pre>        if (fontFamily != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2054" href="#"></a></td>
<td><pre>            font = fontFamily.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2055" href="#"></a></td>
<td><pre>            if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2056" href="#"></a></td>
<td><pre>                font = fontFamily.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2057" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2058" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2059" href="#"></a></td>
<td><pre>        return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2060" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2061" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2062" href="#"></a></td>
<td><pre>    private ConcurrentHashMap&lt;String, Font2D&gt; fontNameCache =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2063" href="#"></a></td>
<td><pre>        new ConcurrentHashMap&lt;String, Font2D&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2064" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2065" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2066" href="#"></a></td>
<td><pre>     * The client supplies a name and a style.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2067" href="#"></a></td>
<td><pre>     * The name could be a family name, or a full name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2068" href="#"></a></td>
<td><pre>     * A font may exist with the specified style, or it may</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2069" href="#"></a></td>
<td><pre>     * exist only in some other style. For non-native fonts the scaler</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2070" href="#"></a></td>
<td><pre>     * may be able to emulate the required style.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2071" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2072" href="#"></a></td>
<td><pre>    public Font2D findFont2D(String name, int style, int fallback) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2073" href="#"></a></td>
<td><pre>        String lowerCaseName = name.toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2074" href="#"></a></td>
<td><pre>        String mapName = lowerCaseName + dotStyleStr(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2075" href="#"></a></td>
<td><pre>        Font2D font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2076" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2077" href="#"></a></td>
<td><pre>        /* If preferLocaleFonts() or preferProportionalFonts() has been</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2078" href="#"></a></td>
<td><pre>         * called we may be using an alternate set of composite fonts in this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2079" href="#"></a></td>
<td><pre>         * app context. The presence of a pre-built name map indicates whether</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2080" href="#"></a></td>
<td><pre>         * this is so, and gives access to the alternate composite for the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2081" href="#"></a></td>
<td><pre>         * name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2082" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2083" href="#"></a></td>
<td><pre>        if (_usingPerAppContextComposites) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2084" href="#"></a></td>
<td><pre>            ConcurrentHashMap&lt;String, Font2D&gt; altNameCache =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2085" href="#"></a></td>
<td><pre>                (ConcurrentHashMap&lt;String, Font2D&gt;)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2086" href="#"></a></td>
<td><pre>                AppContext.getAppContext().get(CompositeFont.class);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2087" href="#"></a></td>
<td><pre>            if (altNameCache != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2088" href="#"></a></td>
<td><pre>                font = (Font2D)altNameCache.get(mapName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2089" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2090" href="#"></a></td>
<td><pre>                font = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2091" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2092" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2093" href="#"></a></td>
<td><pre>            font = fontNameCache.get(mapName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2094" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2095" href="#"></a></td>
<td><pre>        if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2096" href="#"></a></td>
<td><pre>            return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2097" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2098" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2099" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2100" href="#"></a></td>
<td><pre>            FontUtilities.getLogger().info(&quot;Search for font: &quot; + name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2101" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2102" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2103" href="#"></a></td>
<td><pre>        // The check below is just so that the bitmap fonts being set by</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2104" href="#"></a></td>
<td><pre>        // AWT and Swing thru the desktop properties do not trigger the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2105" href="#"></a></td>
<td><pre>        // the load fonts case. The two bitmap fonts are now mapped to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2106" href="#"></a></td>
<td><pre>        // appropriate equivalents for serif and sansserif.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2107" href="#"></a></td>
<td><pre>        // Note that the cost of this comparison is only for the first</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2108" href="#"></a></td>
<td><pre>        // call until the map is filled.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2109" href="#"></a></td>
<td><pre>        if (FontUtilities.isWindows) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2110" href="#"></a></td>
<td><pre>            if (lowerCaseName.equals(&quot;ms sans serif&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2111" href="#"></a></td>
<td><pre>                name = &quot;sansserif&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2112" href="#"></a></td>
<td><pre>            } else if (lowerCaseName.equals(&quot;ms serif&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2113" href="#"></a></td>
<td><pre>                name = &quot;serif&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2114" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2115" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2116" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2117" href="#"></a></td>
<td><pre>        /* This isn't intended to support a client passing in the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2118" href="#"></a></td>
<td><pre>         * string default, but if a client passes in null for the name</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2119" href="#"></a></td>
<td><pre>         * the java.awt.Font class internally substitutes this name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2120" href="#"></a></td>
<td><pre>         * So we need to recognise it here to prevent a loadFonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2121" href="#"></a></td>
<td><pre>         * on the unrecognised name. The only potential problem with</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2122" href="#"></a></td>
<td><pre>         * this is it would hide any real font called &quot;default&quot;!</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2123" href="#"></a></td>
<td><pre>         * But that seems like a potential problem we can ignore for now.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2124" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2125" href="#"></a></td>
<td><pre>        if (lowerCaseName.equals(&quot;default&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2126" href="#"></a></td>
<td><pre>            name = &quot;dialog&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2127" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2128" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2129" href="#"></a></td>
<td><pre>        /* First see if its a family name. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2130" href="#"></a></td>
<td><pre>        FontFamily family = FontFamily.getFamily(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2131" href="#"></a></td>
<td><pre>        if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2132" href="#"></a></td>
<td><pre>            font = family.getFontWithExactStyleMatch(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2133" href="#"></a></td>
<td><pre>            if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2134" href="#"></a></td>
<td><pre>                font = findDeferredFont(name, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2135" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2136" href="#"></a></td>
<td><pre>            if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2137" href="#"></a></td>
<td><pre>                font = family.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2138" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2139" href="#"></a></td>
<td><pre>            if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2140" href="#"></a></td>
<td><pre>                font = family.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2141" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2142" href="#"></a></td>
<td><pre>            if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2143" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2144" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2145" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2146" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2147" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2148" href="#"></a></td>
<td><pre>        /* If it wasn't a family name, it should be a full name of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2149" href="#"></a></td>
<td><pre>         * either a composite, or a physical font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2150" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2151" href="#"></a></td>
<td><pre>        font = fullNameToFont.get(lowerCaseName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2152" href="#"></a></td>
<td><pre>        if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2153" href="#"></a></td>
<td><pre>            /* Check that the requested style matches the matched font's style.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2154" href="#"></a></td>
<td><pre>             * But also match style automatically if the requested style is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2155" href="#"></a></td>
<td><pre>             * &quot;plain&quot;. This because the existing behaviour is that the fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2156" href="#"></a></td>
<td><pre>             * listed via getAllFonts etc always list their style as PLAIN.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2157" href="#"></a></td>
<td><pre>             * This does lead to non-commutative behaviours where you might</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2158" href="#"></a></td>
<td><pre>             * start with &quot;Lucida Sans Regular&quot; and ask for a BOLD version</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2159" href="#"></a></td>
<td><pre>             * and get &quot;Lucida Sans DemiBold&quot; but if you ask for the PLAIN</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2160" href="#"></a></td>
<td><pre>             * style of &quot;Lucida Sans DemiBold&quot; you get &quot;Lucida Sans DemiBold&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2161" href="#"></a></td>
<td><pre>             * This consistent however with what happens if you have a bold</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2162" href="#"></a></td>
<td><pre>             * version of a font and no plain version exists - alg. styling</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2163" href="#"></a></td>
<td><pre>             * doesn't &quot;unbolden&quot; the font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2164" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2165" href="#"></a></td>
<td><pre>            if (font.style == style || style == Font.PLAIN) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2166" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2167" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2168" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2169" href="#"></a></td>
<td><pre>                /* If it was a full name like &quot;Lucida Sans Regular&quot;, but</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2170" href="#"></a></td>
<td><pre>                 * the style requested is &quot;bold&quot;, then we want to see if</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2171" href="#"></a></td>
<td><pre>                 * there's the appropriate match against another font in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2172" href="#"></a></td>
<td><pre>                 * that family before trying to load all fonts, or applying a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2173" href="#"></a></td>
<td><pre>                 * algorithmic styling</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2174" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2175" href="#"></a></td>
<td><pre>                family = FontFamily.getFamily(font.getFamilyName(null));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2176" href="#"></a></td>
<td><pre>                if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2177" href="#"></a></td>
<td><pre>                    Font2D familyFont = family.getFont(style|font.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2178" href="#"></a></td>
<td><pre>                    /* We exactly matched the requested style, use it! */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2179" href="#"></a></td>
<td><pre>                    if (familyFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2180" href="#"></a></td>
<td><pre>                        fontNameCache.put(mapName, familyFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2181" href="#"></a></td>
<td><pre>                        return familyFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2182" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2183" href="#"></a></td>
<td><pre>                        /* This next call is designed to support the case</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2184" href="#"></a></td>
<td><pre>                         * where bold italic is requested, and if we must</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2185" href="#"></a></td>
<td><pre>                         * style, then base it on either bold or italic -</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2186" href="#"></a></td>
<td><pre>                         * not on plain!</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2187" href="#"></a></td>
<td><pre>                         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2188" href="#"></a></td>
<td><pre>                        familyFont = family.getClosestStyle(style|font.style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2189" href="#"></a></td>
<td><pre>                        if (familyFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2190" href="#"></a></td>
<td><pre>                            /* The next check is perhaps one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2191" href="#"></a></td>
<td><pre>                             * that shouldn't be done. ie if we get this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2192" href="#"></a></td>
<td><pre>                             * far we have probably as close a match as we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2193" href="#"></a></td>
<td><pre>                             * are going to get. We could load all fonts to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2194" href="#"></a></td>
<td><pre>                             * see if somehow some parts of the family are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2195" href="#"></a></td>
<td><pre>                             * loaded but not all of it.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2196" href="#"></a></td>
<td><pre>                             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2197" href="#"></a></td>
<td><pre>                            if (familyFont.canDoStyle(style|font.style)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2198" href="#"></a></td>
<td><pre>                                fontNameCache.put(mapName, familyFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2199" href="#"></a></td>
<td><pre>                                return familyFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2200" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2201" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2202" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2203" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2204" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2205" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2206" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2207" href="#"></a></td>
<td><pre>        if (FontUtilities.isWindows) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2208" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2209" href="#"></a></td>
<td><pre>            font = findFontFromPlatformMap(lowerCaseName, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2210" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2211" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2212" href="#"></a></td>
<td><pre>                    .info(&quot;findFontFromPlatformMap returned &quot; + font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2213" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2214" href="#"></a></td>
<td><pre>            if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2215" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2216" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2217" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2218" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2219" href="#"></a></td>
<td><pre>            /* Don't want Windows to return a Lucida Sans font from</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2220" href="#"></a></td>
<td><pre>             * C:\Windows\Fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2221" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2222" href="#"></a></td>
<td><pre>            if (deferredFontFiles.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2223" href="#"></a></td>
<td><pre>                font = findJREDeferredFont(lowerCaseName, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2224" href="#"></a></td>
<td><pre>                if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2225" href="#"></a></td>
<td><pre>                    fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2226" href="#"></a></td>
<td><pre>                    return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2227" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2228" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2229" href="#"></a></td>
<td><pre>            font = findFontFromPlatform(lowerCaseName, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2230" href="#"></a></td>
<td><pre>            if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2231" href="#"></a></td>
<td><pre>                if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2232" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2233" href="#"></a></td>
<td><pre>                          .info(&quot;Found font via platform API for request:\&quot;&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2234" href="#"></a></td>
<td><pre>                                name + &quot;\&quot;:, style=&quot;+style+</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2235" href="#"></a></td>
<td><pre>                                &quot; found font: &quot; + font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2236" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2237" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2238" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2239" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2240" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2241" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2242" href="#"></a></td>
<td><pre>        /* If reach here and no match has been located, then if there are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2243" href="#"></a></td>
<td><pre>         * uninitialised deferred fonts, load as many of those as needed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2244" href="#"></a></td>
<td><pre>         * to find the deferred font. If none is found through that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2245" href="#"></a></td>
<td><pre>         * search continue on.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2246" href="#"></a></td>
<td><pre>         * There is possibly a minor issue when more than one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2247" href="#"></a></td>
<td><pre>         * deferred font implements the same font face. Since deferred</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2248" href="#"></a></td>
<td><pre>         * fonts are only those in font configuration files, this is a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2249" href="#"></a></td>
<td><pre>         * controlled situation, the known case being Solaris euro_fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2250" href="#"></a></td>
<td><pre>         * versions of Arial, Times New Roman, Courier New. However</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2251" href="#"></a></td>
<td><pre>         * the larger font will transparently replace the smaller one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2252" href="#"></a></td>
<td><pre>         *  - see addToFontList() - when it is needed by the composite font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2253" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2254" href="#"></a></td>
<td><pre>        if (deferredFontFiles.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2255" href="#"></a></td>
<td><pre>            font = findDeferredFont(name, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2256" href="#"></a></td>
<td><pre>            if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2257" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2258" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2259" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2260" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2261" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2262" href="#"></a></td>
<td><pre>        /* Some apps use deprecated 1.0 names such as helvetica and courier. On</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2263" href="#"></a></td>
<td><pre>         * Solaris these are Type1 fonts in /usr/openwin/lib/X11/fonts/Type1.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2264" href="#"></a></td>
<td><pre>         * If running on Solaris will register all the fonts in this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2265" href="#"></a></td>
<td><pre>         * directory.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2266" href="#"></a></td>
<td><pre>         * May as well register the whole directory without actually testing</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2267" href="#"></a></td>
<td><pre>         * the font name is one of the deprecated names as the next step would</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2268" href="#"></a></td>
<td><pre>         * load all fonts which are in this directory anyway.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2269" href="#"></a></td>
<td><pre>         * In the event that this lookup is successful it potentially &quot;hides&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2270" href="#"></a></td>
<td><pre>         * TrueType versions of such fonts that are elsewhere but since they</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2271" href="#"></a></td>
<td><pre>         * do not exist on Solaris this is not a problem.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2272" href="#"></a></td>
<td><pre>         * Set a flag to indicate we've done this registration to avoid</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2273" href="#"></a></td>
<td><pre>         * repetition and more seriously, to avoid recursion.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2274" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2275" href="#"></a></td>
<td><pre>        if (FontUtilities.isSolaris &amp;&amp;!loaded1dot0Fonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2276" href="#"></a></td>
<td><pre>            /* &quot;timesroman&quot; is a special case since that's not the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2277" href="#"></a></td>
<td><pre>             * name of any known font on Solaris or elsewhere.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2278" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2279" href="#"></a></td>
<td><pre>            if (lowerCaseName.equals(&quot;timesroman&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2280" href="#"></a></td>
<td><pre>                font = findFont2D(&quot;serif&quot;, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2281" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2282" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2283" href="#"></a></td>
<td><pre>            register1dot0Fonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2284" href="#"></a></td>
<td><pre>            loaded1dot0Fonts = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2285" href="#"></a></td>
<td><pre>            Font2D ff = findFont2D(name, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2286" href="#"></a></td>
<td><pre>            return ff;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2287" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2288" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2289" href="#"></a></td>
<td><pre>        /* We check for application registered fonts before</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2290" href="#"></a></td>
<td><pre>         * explicitly loading all fonts as if necessary the registration</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2291" href="#"></a></td>
<td><pre>         * code will have done so anyway. And we don't want to needlessly</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2292" href="#"></a></td>
<td><pre>         * load the actual files for all fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2293" href="#"></a></td>
<td><pre>         * Just as for installed fonts we check for family before fullname.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2294" href="#"></a></td>
<td><pre>         * We do not add these fonts to fontNameCache for the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2295" href="#"></a></td>
<td><pre>         * app context case which eliminates the overhead of a per context</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2296" href="#"></a></td>
<td><pre>         * cache for these.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2297" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2298" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2299" href="#"></a></td>
<td><pre>        if (fontsAreRegistered || fontsAreRegisteredPerAppContext) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2300" href="#"></a></td>
<td><pre>            Hashtable&lt;String, FontFamily&gt; familyTable = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2301" href="#"></a></td>
<td><pre>            Hashtable&lt;String, Font2D&gt; nameTable;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2302" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2303" href="#"></a></td>
<td><pre>            if (fontsAreRegistered) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2304" href="#"></a></td>
<td><pre>                familyTable = createdByFamilyName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2305" href="#"></a></td>
<td><pre>                nameTable = createdByFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2306" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2307" href="#"></a></td>
<td><pre>                AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2308" href="#"></a></td>
<td><pre>                familyTable =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2309" href="#"></a></td>
<td><pre>                    (Hashtable&lt;String,FontFamily&gt;)appContext.get(regFamilyKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2310" href="#"></a></td>
<td><pre>                nameTable =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2311" href="#"></a></td>
<td><pre>                    (Hashtable&lt;String,Font2D&gt;)appContext.get(regFullNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2312" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2313" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2314" href="#"></a></td>
<td><pre>            family = familyTable.get(lowerCaseName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2315" href="#"></a></td>
<td><pre>            if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2316" href="#"></a></td>
<td><pre>                font = family.getFontWithExactStyleMatch(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2317" href="#"></a></td>
<td><pre>                if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2318" href="#"></a></td>
<td><pre>                    font = family.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2319" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2320" href="#"></a></td>
<td><pre>                if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2321" href="#"></a></td>
<td><pre>                    font = family.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2322" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2323" href="#"></a></td>
<td><pre>                if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2324" href="#"></a></td>
<td><pre>                    if (fontsAreRegistered) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2325" href="#"></a></td>
<td><pre>                        fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2326" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2327" href="#"></a></td>
<td><pre>                    return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2328" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2329" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2330" href="#"></a></td>
<td><pre>            font = nameTable.get(lowerCaseName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2331" href="#"></a></td>
<td><pre>            if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2332" href="#"></a></td>
<td><pre>                if (fontsAreRegistered) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2333" href="#"></a></td>
<td><pre>                    fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2334" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2335" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2336" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2337" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2338" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2339" href="#"></a></td>
<td><pre>        /* If reach here and no match has been located, then if all fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2340" href="#"></a></td>
<td><pre>         * are not yet loaded, do so, and then recurse.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2341" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2342" href="#"></a></td>
<td><pre>        if (!loadedAllFonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2343" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2344" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2345" href="#"></a></td>
<td><pre>                                       .info(&quot;Load fonts looking for:&quot; + name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2346" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2347" href="#"></a></td>
<td><pre>            loadFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2348" href="#"></a></td>
<td><pre>            loadedAllFonts = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2349" href="#"></a></td>
<td><pre>            return findFont2D(name, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2350" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2351" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2352" href="#"></a></td>
<td><pre>        if (!loadedAllFontFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2353" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2354" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2355" href="#"></a></td>
<td><pre>                                  .info(&quot;Load font files looking for:&quot; + name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2356" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2357" href="#"></a></td>
<td><pre>            loadFontFiles();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2358" href="#"></a></td>
<td><pre>            loadedAllFontFiles = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2359" href="#"></a></td>
<td><pre>            return findFont2D(name, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2360" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2361" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2362" href="#"></a></td>
<td><pre>        /* The primary name is the locale default - ie not US/English but</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2363" href="#"></a></td>
<td><pre>         * whatever is the default in this locale. This is the way it always</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2364" href="#"></a></td>
<td><pre>         * has been but may be surprising to some developers if &quot;Arial Regular&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2365" href="#"></a></td>
<td><pre>         * were hard-coded in their app and yet &quot;Arial Regular&quot; was not the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2366" href="#"></a></td>
<td><pre>         * default name. Fortunately for them, as a consequence of the JDK</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2367" href="#"></a></td>
<td><pre>         * supporting returning names and family names for arbitrary locales,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2368" href="#"></a></td>
<td><pre>         * we also need to support searching all localised names for a match.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2369" href="#"></a></td>
<td><pre>         * But because this case of the name used to reference a font is not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2370" href="#"></a></td>
<td><pre>         * the same as the default for this locale is rare, it makes sense to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2371" href="#"></a></td>
<td><pre>         * search a much shorter list of default locale names and only go to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2372" href="#"></a></td>
<td><pre>         * a longer list of names in the event that no match was found.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2373" href="#"></a></td>
<td><pre>         * So add here code which searches localised names too.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2374" href="#"></a></td>
<td><pre>         * As in 1.4.x this happens only after loading all fonts, which</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2375" href="#"></a></td>
<td><pre>         * is probably the right order.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2376" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2377" href="#"></a></td>
<td><pre>        if ((font = findFont2DAllLocales(name, style)) != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2378" href="#"></a></td>
<td><pre>            fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2379" href="#"></a></td>
<td><pre>            return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2380" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2381" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2382" href="#"></a></td>
<td><pre>        /* Perhaps its a &quot;compatibility&quot; name - timesroman, helvetica,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2383" href="#"></a></td>
<td><pre>         * or courier, which 1.0 apps used for logical fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2384" href="#"></a></td>
<td><pre>         * We look for these &quot;late&quot; after a loadFonts as we must not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2385" href="#"></a></td>
<td><pre>         * hide real fonts of these names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2386" href="#"></a></td>
<td><pre>         * Map these appropriately:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2387" href="#"></a></td>
<td><pre>         * On windows this means according to the rules specified by the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2388" href="#"></a></td>
<td><pre>         * FontConfiguration : do it only for encoding==Cp1252</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2389" href="#"></a></td>
<td><pre>         *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2390" href="#"></a></td>
<td><pre>         * REMIND: this is something we plan to remove.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2391" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2392" href="#"></a></td>
<td><pre>        if (FontUtilities.isWindows) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2393" href="#"></a></td>
<td><pre>            String compatName =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2394" href="#"></a></td>
<td><pre>                getFontConfiguration().getFallbackFamilyName(name, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2395" href="#"></a></td>
<td><pre>            if (compatName != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2396" href="#"></a></td>
<td><pre>                font = findFont2D(compatName, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2397" href="#"></a></td>
<td><pre>                fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2398" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2399" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2400" href="#"></a></td>
<td><pre>        } else if (lowerCaseName.equals(&quot;timesroman&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2401" href="#"></a></td>
<td><pre>            font = findFont2D(&quot;serif&quot;, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2402" href="#"></a></td>
<td><pre>            fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2403" href="#"></a></td>
<td><pre>            return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2404" href="#"></a></td>
<td><pre>        } else if (lowerCaseName.equals(&quot;helvetica&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2405" href="#"></a></td>
<td><pre>            font = findFont2D(&quot;sansserif&quot;, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2406" href="#"></a></td>
<td><pre>            fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2407" href="#"></a></td>
<td><pre>            return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2408" href="#"></a></td>
<td><pre>        } else if (lowerCaseName.equals(&quot;courier&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2409" href="#"></a></td>
<td><pre>            font = findFont2D(&quot;monospaced&quot;, style, fallback);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2410" href="#"></a></td>
<td><pre>            fontNameCache.put(mapName, font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2411" href="#"></a></td>
<td><pre>            return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2412" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2413" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2414" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2415" href="#"></a></td>
<td><pre>            FontUtilities.getLogger().info(&quot;No font found for:&quot; + name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2416" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2417" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2418" href="#"></a></td>
<td><pre>        switch (fallback) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2419" href="#"></a></td>
<td><pre>        case PHYSICAL_FALLBACK: return getDefaultPhysicalFont();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2420" href="#"></a></td>
<td><pre>        case LOGICAL_FALLBACK: return getDefaultLogicalFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2421" href="#"></a></td>
<td><pre>        default: return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2422" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2423" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2424" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2425" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2426" href="#"></a></td>
<td><pre>     * Workaround for apps which are dependent on a font metrics bug</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2427" href="#"></a></td>
<td><pre>     * in JDK 1.1. This is an unsupported win32 private setting.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2428" href="#"></a></td>
<td><pre>     * Left in for a customer - do not remove.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2429" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2430" href="#"></a></td>
<td><pre>    public boolean usePlatformFontMetrics() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2431" href="#"></a></td>
<td><pre>        return usePlatformFontMetrics;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2432" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2433" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2434" href="#"></a></td>
<td><pre>    public int getNumFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2435" href="#"></a></td>
<td><pre>        return physicalFonts.size()+maxCompFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2436" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2437" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2438" href="#"></a></td>
<td><pre>    private static boolean fontSupportsEncoding(Font font, String encoding) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2439" href="#"></a></td>
<td><pre>        return FontUtilities.getFont2D(font).supportsEncoding(encoding);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2440" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2441" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2442" href="#"></a></td>
<td><pre>    protected abstract String getFontPath(boolean noType1Fonts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2443" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2444" href="#"></a></td>
<td><pre>    // MACOSX begin -- need to access this in subclass</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2445" href="#"></a></td>
<td><pre>    protected Thread fileCloser = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2446" href="#"></a></td>
<td><pre>    // MACOSX end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2447" href="#"></a></td>
<td><pre>    Vector&lt;File&gt; tmpFontFiles = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2448" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2449" href="#"></a></td>
<td><pre>    public Font2D createFont2D(File fontFile, int fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2450" href="#"></a></td>
<td><pre>                               boolean isCopy, CreatedFontTracker tracker)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2451" href="#"></a></td>
<td><pre>    throws FontFormatException {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2452" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2453" href="#"></a></td>
<td><pre>        String fontFilePath = fontFile.getPath();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2454" href="#"></a></td>
<td><pre>        FileFont font2D = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2455" href="#"></a></td>
<td><pre>        final File fFile = fontFile;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2456" href="#"></a></td>
<td><pre>        final CreatedFontTracker _tracker = tracker;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2457" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2458" href="#"></a></td>
<td><pre>            switch (fontFormat) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2459" href="#"></a></td>
<td><pre>            case Font.TRUETYPE_FONT:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2460" href="#"></a></td>
<td><pre>                font2D = new TrueTypeFont(fontFilePath, null, 0, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2461" href="#"></a></td>
<td><pre>                break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2462" href="#"></a></td>
<td><pre>            case Font.TYPE1_FONT:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2463" href="#"></a></td>
<td><pre>                font2D = new Type1Font(fontFilePath, null, isCopy);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2464" href="#"></a></td>
<td><pre>                break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2465" href="#"></a></td>
<td><pre>            default:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2466" href="#"></a></td>
<td><pre>                throw new FontFormatException(&quot;Unrecognised Font Format&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2467" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2468" href="#"></a></td>
<td><pre>        } catch (FontFormatException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2469" href="#"></a></td>
<td><pre>            if (isCopy) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2470" href="#"></a></td>
<td><pre>                java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2471" href="#"></a></td>
<td><pre>                     new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2472" href="#"></a></td>
<td><pre>                          public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2473" href="#"></a></td>
<td><pre>                              if (_tracker != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2474" href="#"></a></td>
<td><pre>                                  _tracker.subBytes((int)fFile.length());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2475" href="#"></a></td>
<td><pre>                              }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2476" href="#"></a></td>
<td><pre>                              fFile.delete();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2477" href="#"></a></td>
<td><pre>                              return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2478" href="#"></a></td>
<td><pre>                          }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2479" href="#"></a></td>
<td><pre>                });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2480" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2481" href="#"></a></td>
<td><pre>            throw(e);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2482" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2483" href="#"></a></td>
<td><pre>        if (isCopy) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2484" href="#"></a></td>
<td><pre>            font2D.setFileToRemove(fontFile, tracker);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2485" href="#"></a></td>
<td><pre>            synchronized (FontManager.class) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2486" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2487" href="#"></a></td>
<td><pre>                if (tmpFontFiles == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2488" href="#"></a></td>
<td><pre>                    tmpFontFiles = new Vector&lt;File&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2489" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2490" href="#"></a></td>
<td><pre>                tmpFontFiles.add(fontFile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2491" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2492" href="#"></a></td>
<td><pre>                if (fileCloser == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2493" href="#"></a></td>
<td><pre>                    final Runnable fileCloserRunnable = new Runnable() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2494" href="#"></a></td>
<td><pre>                      public void run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2495" href="#"></a></td>
<td><pre>                         java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2496" href="#"></a></td>
<td><pre>                         new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2497" href="#"></a></td>
<td><pre>                         public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2498" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2499" href="#"></a></td>
<td><pre>                            for (int i=0;i&lt;CHANNELPOOLSIZE;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2500" href="#"></a></td>
<td><pre>                                if (fontFileCache[i] != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2501" href="#"></a></td>
<td><pre>                                    try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2502" href="#"></a></td>
<td><pre>                                        fontFileCache[i].close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2503" href="#"></a></td>
<td><pre>                                    } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2504" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2505" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2506" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2507" href="#"></a></td>
<td><pre>                            if (tmpFontFiles != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2508" href="#"></a></td>
<td><pre>                                File[] files = new File[tmpFontFiles.size()];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2509" href="#"></a></td>
<td><pre>                                files = tmpFontFiles.toArray(files);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2510" href="#"></a></td>
<td><pre>                                for (int f=0; f&lt;files.length;f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2511" href="#"></a></td>
<td><pre>                                    try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2512" href="#"></a></td>
<td><pre>                                        files[f].delete();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2513" href="#"></a></td>
<td><pre>                                    } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2514" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2515" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2516" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2517" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2518" href="#"></a></td>
<td><pre>                            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2519" href="#"></a></td>
<td><pre>                          }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2520" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2521" href="#"></a></td>
<td><pre>                          });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2522" href="#"></a></td>
<td><pre>                      }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2523" href="#"></a></td>
<td><pre>                    };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2524" href="#"></a></td>
<td><pre>                    java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2525" href="#"></a></td>
<td><pre>                       new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2526" href="#"></a></td>
<td><pre>                          public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2527" href="#"></a></td>
<td><pre>                              /* The thread must be a member of a thread group</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2528" href="#"></a></td>
<td><pre>                               * which will not get GCed before VM exit.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2529" href="#"></a></td>
<td><pre>                               * Make its parent the top-level thread group.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2530" href="#"></a></td>
<td><pre>                               */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2531" href="#"></a></td>
<td><pre>                              ThreadGroup tg =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2532" href="#"></a></td>
<td><pre>                                  Thread.currentThread().getThreadGroup();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2533" href="#"></a></td>
<td><pre>                              for (ThreadGroup tgn = tg;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2534" href="#"></a></td>
<td><pre>                                   tgn != null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2535" href="#"></a></td>
<td><pre>                                   tg = tgn, tgn = tg.getParent());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2536" href="#"></a></td>
<td><pre>                              fileCloser = new Thread(tg, fileCloserRunnable);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2537" href="#"></a></td>
<td><pre>                              fileCloser.setContextClassLoader(null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2538" href="#"></a></td>
<td><pre>                              Runtime.getRuntime().addShutdownHook(fileCloser);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2539" href="#"></a></td>
<td><pre>                              return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2540" href="#"></a></td>
<td><pre>                          }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2541" href="#"></a></td>
<td><pre>                    });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2542" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2543" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2544" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2545" href="#"></a></td>
<td><pre>        return font2D;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2546" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2547" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2548" href="#"></a></td>
<td><pre>    /* remind: used in X11GraphicsEnvironment and called often enough</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2549" href="#"></a></td>
<td><pre>     * that we ought to obsolete this code</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2550" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2551" href="#"></a></td>
<td><pre>    public synchronized String getFullNameByFileName(String fileName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2552" href="#"></a></td>
<td><pre>        PhysicalFont[] physFonts = getPhysicalFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2553" href="#"></a></td>
<td><pre>        for (int i=0;i&lt;physFonts.length;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2554" href="#"></a></td>
<td><pre>            if (physFonts[i].platName.equals(fileName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2555" href="#"></a></td>
<td><pre>                return (physFonts[i].getFontName(null));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2556" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2557" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2558" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2559" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2560" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2561" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2562" href="#"></a></td>
<td><pre>     * This is called when font is determined to be invalid/bad.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2563" href="#"></a></td>
<td><pre>     * It designed to be called (for example) by the font scaler</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2564" href="#"></a></td>
<td><pre>     * when in processing a font file it is discovered to be incorrect.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2565" href="#"></a></td>
<td><pre>     * This is different than the case where fonts are discovered to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2566" href="#"></a></td>
<td><pre>     * be incorrect during initial verification, as such fonts are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2567" href="#"></a></td>
<td><pre>     * never registered.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2568" href="#"></a></td>
<td><pre>     * Handles to this font held are re-directed to a default font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2569" href="#"></a></td>
<td><pre>     * This default may not be an ideal substitute buts it better than</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2570" href="#"></a></td>
<td><pre>     * crashing This code assumes a PhysicalFont parameter as it doesn't</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2571" href="#"></a></td>
<td><pre>     * make sense for a Composite to be &quot;bad&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2572" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2573" href="#"></a></td>
<td><pre>    public synchronized void deRegisterBadFont(Font2D font2D) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2574" href="#"></a></td>
<td><pre>        if (!(font2D instanceof PhysicalFont)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2575" href="#"></a></td>
<td><pre>            /* We should never reach here, but just in case */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2576" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2577" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2578" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2579" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2580" href="#"></a></td>
<td><pre>                                     .severe(&quot;Deregister bad font: &quot; + font2D);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2581" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2582" href="#"></a></td>
<td><pre>            replaceFont((PhysicalFont)font2D, getDefaultPhysicalFont());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2583" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2584" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2585" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2586" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2587" href="#"></a></td>
<td><pre>     * This encapsulates all the work that needs to be done when a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2588" href="#"></a></td>
<td><pre>     * Font2D is replaced by a different Font2D.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2589" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2590" href="#"></a></td>
<td><pre>    public synchronized void replaceFont(PhysicalFont oldFont,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2591" href="#"></a></td>
<td><pre>                                         PhysicalFont newFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2592" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2593" href="#"></a></td>
<td><pre>        if (oldFont.handle.font2D != oldFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2594" href="#"></a></td>
<td><pre>            /* already done */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2595" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2596" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2597" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2598" href="#"></a></td>
<td><pre>        /* If we try to replace the font with itself, that won't work,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2599" href="#"></a></td>
<td><pre>         * so pick any alternative physical font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2600" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2601" href="#"></a></td>
<td><pre>        if (oldFont == newFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2602" href="#"></a></td>
<td><pre>            if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2603" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2604" href="#"></a></td>
<td><pre>                      .severe(&quot;Can't replace bad font with itself &quot; + oldFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2605" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2606" href="#"></a></td>
<td><pre>            PhysicalFont[] physFonts = getPhysicalFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2607" href="#"></a></td>
<td><pre>            for (int i=0; i&lt;physFonts.length;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2608" href="#"></a></td>
<td><pre>                if (physFonts[i] != newFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2609" href="#"></a></td>
<td><pre>                    newFont = physFonts[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2610" href="#"></a></td>
<td><pre>                    break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2611" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2612" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2613" href="#"></a></td>
<td><pre>            if (oldFont == newFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2614" href="#"></a></td>
<td><pre>                if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2615" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2616" href="#"></a></td>
<td><pre>                           .severe(&quot;This is bad. No good physicalFonts found.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2617" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2618" href="#"></a></td>
<td><pre>                return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2619" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2620" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2621" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2622" href="#"></a></td>
<td><pre>        /* eliminate references to this font, so it won't be located</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2623" href="#"></a></td>
<td><pre>         * by future callers, and will be eligible for GC when all</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2624" href="#"></a></td>
<td><pre>         * references are removed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2625" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2626" href="#"></a></td>
<td><pre>        oldFont.handle.font2D = newFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2627" href="#"></a></td>
<td><pre>        physicalFonts.remove(oldFont.fullName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2628" href="#"></a></td>
<td><pre>        fullNameToFont.remove(oldFont.fullName.toLowerCase(Locale.ENGLISH));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2629" href="#"></a></td>
<td><pre>        FontFamily.remove(oldFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2630" href="#"></a></td>
<td><pre>        if (localeFullNamesToFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2631" href="#"></a></td>
<td><pre>            Map.Entry[] mapEntries =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2632" href="#"></a></td>
<td><pre>                (Map.Entry[])localeFullNamesToFont.entrySet().</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2633" href="#"></a></td>
<td><pre>                toArray(new Map.Entry[0]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2634" href="#"></a></td>
<td><pre>            /* Should I be replacing these, or just I just remove</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2635" href="#"></a></td>
<td><pre>             * the names from the map?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2636" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2637" href="#"></a></td>
<td><pre>            for (int i=0; i&lt;mapEntries.length;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2638" href="#"></a></td>
<td><pre>                if (mapEntries[i].getValue() == oldFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2639" href="#"></a></td>
<td><pre>                    try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2640" href="#"></a></td>
<td><pre>                        mapEntries[i].setValue(newFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2641" href="#"></a></td>
<td><pre>                    } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2642" href="#"></a></td>
<td><pre>                        /* some maps don't support this operation.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2643" href="#"></a></td>
<td><pre>                         * In this case just give up and remove the entry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2644" href="#"></a></td>
<td><pre>                         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2645" href="#"></a></td>
<td><pre>                        localeFullNamesToFont.remove(mapEntries[i].getKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2646" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2647" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2648" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2649" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2650" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2651" href="#"></a></td>
<td><pre>        for (int i=0; i&lt;maxCompFont; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2652" href="#"></a></td>
<td><pre>            /* Deferred initialization of composites shouldn't be</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2653" href="#"></a></td>
<td><pre>             * a problem for this case, since a font must have been</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2654" href="#"></a></td>
<td><pre>             * initialised to be discovered to be bad.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2655" href="#"></a></td>
<td><pre>             * Some JRE composites on Solaris use two versions of the same</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2656" href="#"></a></td>
<td><pre>             * font. The replaced font isn't bad, just &quot;smaller&quot; so there's</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2657" href="#"></a></td>
<td><pre>             * no need to make the slot point to the new font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2658" href="#"></a></td>
<td><pre>             * Since composites have a direct reference to the Font2D (not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2659" href="#"></a></td>
<td><pre>             * via a handle) making this substitution is not safe and could</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2660" href="#"></a></td>
<td><pre>             * cause an additional problem and so this substitution is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2661" href="#"></a></td>
<td><pre>             * warranted only when a font is truly &quot;bad&quot; and could cause</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2662" href="#"></a></td>
<td><pre>             * a crash. So we now replace it only if its being substituted</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2663" href="#"></a></td>
<td><pre>             * with some font other than a fontconfig rank font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2664" href="#"></a></td>
<td><pre>             * Since in practice a substitution will have the same rank</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2665" href="#"></a></td>
<td><pre>             * this may never happen, but the code is safer even if its</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2666" href="#"></a></td>
<td><pre>             * also now a no-op.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2667" href="#"></a></td>
<td><pre>             * The only obvious &quot;glitch&quot; from this stems from the current</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2668" href="#"></a></td>
<td><pre>             * implementation that when asked for the number of glyphs in a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2669" href="#"></a></td>
<td><pre>             * composite it lies and returns the number in slot 0 because</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2670" href="#"></a></td>
<td><pre>             * composite glyphs aren't contiguous. Since we live with that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2671" href="#"></a></td>
<td><pre>             * we can live with the glitch that depending on how it was</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2672" href="#"></a></td>
<td><pre>             * initialised a composite may return different values for this.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2673" href="#"></a></td>
<td><pre>             * Fixing the issues with composite glyph ids is tricky as</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2674" href="#"></a></td>
<td><pre>             * there are exclusion ranges and unlike other fonts even the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2675" href="#"></a></td>
<td><pre>             * true &quot;numGlyphs&quot; isn't a contiguous range. Likely the only</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2676" href="#"></a></td>
<td><pre>             * solution is an API that returns an array of glyph ranges</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2677" href="#"></a></td>
<td><pre>             * which takes precedence over the existing API. That might</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2678" href="#"></a></td>
<td><pre>             * also need to address excluding ranges which represent a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2679" href="#"></a></td>
<td><pre>             * code point supported by an earlier component.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2680" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2681" href="#"></a></td>
<td><pre>            if (newFont.getRank() &gt; Font2D.FONT_CONFIG_RANK) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2682" href="#"></a></td>
<td><pre>                compFonts[i].replaceComponentFont(oldFont, newFont);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2683" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2684" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2685" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2686" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2687" href="#"></a></td>
<td><pre>    private synchronized void loadLocaleNames() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2688" href="#"></a></td>
<td><pre>        if (localeFullNamesToFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2689" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2690" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2691" href="#"></a></td>
<td><pre>        localeFullNamesToFont = new HashMap&lt;String, TrueTypeFont&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2692" href="#"></a></td>
<td><pre>        Font2D[] fonts = getRegisteredFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2693" href="#"></a></td>
<td><pre>        for (int i=0; i&lt;fonts.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2694" href="#"></a></td>
<td><pre>            if (fonts[i] instanceof TrueTypeFont) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2695" href="#"></a></td>
<td><pre>                TrueTypeFont ttf = (TrueTypeFont)fonts[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2696" href="#"></a></td>
<td><pre>                String[] fullNames = ttf.getAllFullNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2697" href="#"></a></td>
<td><pre>                for (int n=0; n&lt;fullNames.length; n++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2698" href="#"></a></td>
<td><pre>                    localeFullNamesToFont.put(fullNames[n], ttf);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2699" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2700" href="#"></a></td>
<td><pre>                FontFamily family = FontFamily.getFamily(ttf.familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2701" href="#"></a></td>
<td><pre>                if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2702" href="#"></a></td>
<td><pre>                    FontFamily.addLocaleNames(family, ttf.getAllFamilyNames());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2703" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2704" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2705" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2706" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2707" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2708" href="#"></a></td>
<td><pre>    /* This replicate the core logic of findFont2D but operates on</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2709" href="#"></a></td>
<td><pre>     * all the locale names. This hasn't been merged into findFont2D to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2710" href="#"></a></td>
<td><pre>     * keep the logic simpler and reduce overhead, since this case is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2711" href="#"></a></td>
<td><pre>     * almost never used. The main case in which it is called is when</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2712" href="#"></a></td>
<td><pre>     * a bogus font name is used and we need to check all possible names</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2713" href="#"></a></td>
<td><pre>     * before returning the default case.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2714" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2715" href="#"></a></td>
<td><pre>    private Font2D findFont2DAllLocales(String name, int style) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2716" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2717" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2718" href="#"></a></td>
<td><pre>            FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2719" href="#"></a></td>
<td><pre>                           .info(&quot;Searching localised font names for:&quot; + name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2720" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2721" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2722" href="#"></a></td>
<td><pre>        /* If reach here and no match has been located, then if we have</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2723" href="#"></a></td>
<td><pre>         * not yet built the map of localeFullNamesToFont for TT fonts, do so</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2724" href="#"></a></td>
<td><pre>         * now. This method must be called after all fonts have been loaded.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2725" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2726" href="#"></a></td>
<td><pre>        if (localeFullNamesToFont == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2727" href="#"></a></td>
<td><pre>            loadLocaleNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2728" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2729" href="#"></a></td>
<td><pre>        String lowerCaseName = name.toLowerCase();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2730" href="#"></a></td>
<td><pre>        Font2D font = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2731" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2732" href="#"></a></td>
<td><pre>        /* First see if its a family name. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2733" href="#"></a></td>
<td><pre>        FontFamily family = FontFamily.getLocaleFamily(lowerCaseName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2734" href="#"></a></td>
<td><pre>        if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2735" href="#"></a></td>
<td><pre>          font = family.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2736" href="#"></a></td>
<td><pre>          if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2737" href="#"></a></td>
<td><pre>            font = family.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2738" href="#"></a></td>
<td><pre>          }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2739" href="#"></a></td>
<td><pre>          if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2740" href="#"></a></td>
<td><pre>              return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2741" href="#"></a></td>
<td><pre>          }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2742" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2743" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2744" href="#"></a></td>
<td><pre>        /* If it wasn't a family name, it should be a full name. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2745" href="#"></a></td>
<td><pre>        synchronized (this) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2746" href="#"></a></td>
<td><pre>            font = localeFullNamesToFont.get(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2747" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2748" href="#"></a></td>
<td><pre>        if (font != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2749" href="#"></a></td>
<td><pre>            if (font.style == style || style == Font.PLAIN) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2750" href="#"></a></td>
<td><pre>                return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2751" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2752" href="#"></a></td>
<td><pre>                family = FontFamily.getFamily(font.getFamilyName(null));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2753" href="#"></a></td>
<td><pre>                if (family != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2754" href="#"></a></td>
<td><pre>                    Font2D familyFont = family.getFont(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2755" href="#"></a></td>
<td><pre>                    /* We exactly matched the requested style, use it! */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2756" href="#"></a></td>
<td><pre>                    if (familyFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2757" href="#"></a></td>
<td><pre>                        return familyFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2758" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2759" href="#"></a></td>
<td><pre>                        familyFont = family.getClosestStyle(style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2760" href="#"></a></td>
<td><pre>                        if (familyFont != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2761" href="#"></a></td>
<td><pre>                            /* The next check is perhaps one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2762" href="#"></a></td>
<td><pre>                             * that shouldn't be done. ie if we get this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2763" href="#"></a></td>
<td><pre>                             * far we have probably as close a match as we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2764" href="#"></a></td>
<td><pre>                             * are going to get. We could load all fonts to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2765" href="#"></a></td>
<td><pre>                             * see if somehow some parts of the family are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2766" href="#"></a></td>
<td><pre>                             * loaded but not all of it.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2767" href="#"></a></td>
<td><pre>                             * This check is commented out for now.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2768" href="#"></a></td>
<td><pre>                             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2769" href="#"></a></td>
<td><pre>                            if (!familyFont.canDoStyle(style)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2770" href="#"></a></td>
<td><pre>                                familyFont = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2771" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2772" href="#"></a></td>
<td><pre>                            return familyFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2773" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2774" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2775" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2776" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2777" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2778" href="#"></a></td>
<td><pre>        return font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2779" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2780" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2781" href="#"></a></td>
<td><pre>    /* Supporting &quot;alternate&quot; composite fonts on 2D graphics objects</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2782" href="#"></a></td>
<td><pre>     * is accessed by the application by calling methods on the local</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2783" href="#"></a></td>
<td><pre>     * GraphicsEnvironment. The overall implementation is described</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2784" href="#"></a></td>
<td><pre>     * in one place, here, since otherwise the implementation is spread</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2785" href="#"></a></td>
<td><pre>     * around it may be difficult to track.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2786" href="#"></a></td>
<td><pre>     * The methods below call into SunGraphicsEnvironment which creates a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2787" href="#"></a></td>
<td><pre>     * new FontConfiguration instance. The FontConfiguration class,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2788" href="#"></a></td>
<td><pre>     * and its platform sub-classes are updated to take parameters requesting</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2789" href="#"></a></td>
<td><pre>     * these behaviours. This is then used to create new composite font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2790" href="#"></a></td>
<td><pre>     * instances. Since this calls the initCompositeFont method in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2791" href="#"></a></td>
<td><pre>     * SunGraphicsEnvironment it performs the same initialization as is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2792" href="#"></a></td>
<td><pre>     * performed normally. There may be some duplication of effort, but</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2793" href="#"></a></td>
<td><pre>     * that code is already written to be able to perform properly if called</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2794" href="#"></a></td>
<td><pre>     * to duplicate work. The main difference is that if we detect we are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2795" href="#"></a></td>
<td><pre>     * running in an applet/browser/Java plugin environment these new fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2796" href="#"></a></td>
<td><pre>     * are not placed in the &quot;default&quot; maps but into an AppContext instance.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2797" href="#"></a></td>
<td><pre>     * The font lookup mechanism in java.awt.Font.getFont2D() is also updated</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2798" href="#"></a></td>
<td><pre>     * so that look-up for composite fonts will in that case always</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2799" href="#"></a></td>
<td><pre>     * do a lookup rather than returning a cached result.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2800" href="#"></a></td>
<td><pre>     * This is inefficient but necessary else singleton java.awt.Font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2801" href="#"></a></td>
<td><pre>     * instances would not retrieve the correct Font2D for the appcontext.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2802" href="#"></a></td>
<td><pre>     * sun.font.FontManager.findFont2D is also updated to that it uses</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2803" href="#"></a></td>
<td><pre>     * a name map cache specific to that appcontext.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2804" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2805" href="#"></a></td>
<td><pre>     * Getting an AppContext is expensive, so there is a global variable</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2806" href="#"></a></td>
<td><pre>     * that records whether these methods have ever been called and can</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2807" href="#"></a></td>
<td><pre>     * avoid the expense for almost all applications. Once the correct</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2808" href="#"></a></td>
<td><pre>     * CompositeFont is associated with the Font, everything should work</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2809" href="#"></a></td>
<td><pre>     * through existing mechanisms.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2810" href="#"></a></td>
<td><pre>     * A special case is that GraphicsEnvironment.getAllFonts() must</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2811" href="#"></a></td>
<td><pre>     * return an AppContext specific list.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2812" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2813" href="#"></a></td>
<td><pre>     * Calling the methods below is &quot;heavyweight&quot; but it is expected that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2814" href="#"></a></td>
<td><pre>     * these methods will be called very rarely.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2815" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2816" href="#"></a></td>
<td><pre>     * If _usingPerAppContextComposites is true, we are in &quot;applet&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2817" href="#"></a></td>
<td><pre>     * (eg browser) environment and at least one context has selected</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2818" href="#"></a></td>
<td><pre>     * an alternate composite font behaviour.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2819" href="#"></a></td>
<td><pre>     * If _usingAlternateComposites is true, we are not in an &quot;applet&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2820" href="#"></a></td>
<td><pre>     * environment and the (single) application has selected</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2821" href="#"></a></td>
<td><pre>     * an alternate composite font behaviour.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2822" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2823" href="#"></a></td>
<td><pre>     * - Printing: The implementation delegates logical fonts to an AWT</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2824" href="#"></a></td>
<td><pre>     * mechanism which cannot use these alternate configurations.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2825" href="#"></a></td>
<td><pre>     * We can detect that alternate fonts are in use and back-off to 2D, but</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2826" href="#"></a></td>
<td><pre>     * that uses outlines. Much of this can be fixed with additional work</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2827" href="#"></a></td>
<td><pre>     * but that may have to wait. The results should be correct, just not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2828" href="#"></a></td>
<td><pre>     * optimal.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2829" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2830" href="#"></a></td>
<td><pre>    private static final Object altJAFontKey       = new Object();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2831" href="#"></a></td>
<td><pre>    private static final Object localeFontKey       = new Object();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2832" href="#"></a></td>
<td><pre>    private static final Object proportionalFontKey = new Object();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2833" href="#"></a></td>
<td><pre>    private boolean _usingPerAppContextComposites = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2834" href="#"></a></td>
<td><pre>    private boolean _usingAlternateComposites = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2835" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2836" href="#"></a></td>
<td><pre>    /* These values are used only if we are running as a standalone</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2837" href="#"></a></td>
<td><pre>     * application, as determined by maybeMultiAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2838" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2839" href="#"></a></td>
<td><pre>    private static boolean gAltJAFont = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2840" href="#"></a></td>
<td><pre>    private boolean gLocalePref = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2841" href="#"></a></td>
<td><pre>    private boolean gPropPref = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2842" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2843" href="#"></a></td>
<td><pre>    /* This method doesn't check if alternates are selected in this app</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2844" href="#"></a></td>
<td><pre>     * context. Its used by the FontMetrics caching code which in such</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2845" href="#"></a></td>
<td><pre>     * a case cannot retrieve a cached metrics solely on the basis of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2846" href="#"></a></td>
<td><pre>     * the Font.equals() method since it needs to also check if the Font2D</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2847" href="#"></a></td>
<td><pre>     * is the same.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2848" href="#"></a></td>
<td><pre>     * We also use non-standard composites for Swing native L&amp;F fonts on</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2849" href="#"></a></td>
<td><pre>     * Windows. In that case the policy is that the metrics reported are</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2850" href="#"></a></td>
<td><pre>     * based solely on the physical font in the first slot which is the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2851" href="#"></a></td>
<td><pre>     * visible java.awt.Font. So in that case the metrics cache which tests</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2852" href="#"></a></td>
<td><pre>     * the Font does what we want. In the near future when we expand the GTK</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2853" href="#"></a></td>
<td><pre>     * logical font definitions we may need to revisit this if GTK reports</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2854" href="#"></a></td>
<td><pre>     * combined metrics instead. For now though this test can be simple.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2855" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2856" href="#"></a></td>
<td><pre>    public boolean maybeUsingAlternateCompositeFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2857" href="#"></a></td>
<td><pre>       return _usingAlternateComposites || _usingPerAppContextComposites;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2858" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2859" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2860" href="#"></a></td>
<td><pre>    public boolean usingAlternateCompositeFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2861" href="#"></a></td>
<td><pre>        return (_usingAlternateComposites ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2862" href="#"></a></td>
<td><pre>                (_usingPerAppContextComposites &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2863" href="#"></a></td>
<td><pre>                AppContext.getAppContext().get(CompositeFont.class) != null));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2864" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2865" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2866" href="#"></a></td>
<td><pre>    private static boolean maybeMultiAppContext() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2867" href="#"></a></td>
<td><pre>        Boolean appletSM = (Boolean)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2868" href="#"></a></td>
<td><pre>            java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2869" href="#"></a></td>
<td><pre>                new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2870" href="#"></a></td>
<td><pre>                        public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2871" href="#"></a></td>
<td><pre>                            SecurityManager sm = System.getSecurityManager();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2872" href="#"></a></td>
<td><pre>                            return new Boolean</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2873" href="#"></a></td>
<td><pre>                                (sm instanceof sun.applet.AppletSecurity);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2874" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2875" href="#"></a></td>
<td><pre>                    });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2876" href="#"></a></td>
<td><pre>        return appletSM.booleanValue();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2877" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2878" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2879" href="#"></a></td>
<td><pre>    /* Modifies the behaviour of a subsequent call to preferLocaleFonts()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2880" href="#"></a></td>
<td><pre>     * to use Mincho instead of Gothic for dialoginput in JA locales</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2881" href="#"></a></td>
<td><pre>     * on windows. Not needed on other platforms.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2882" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2883" href="#"></a></td>
<td><pre>    public synchronized void useAlternateFontforJALocales() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2884" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2885" href="#"></a></td>
<td><pre>            FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2886" href="#"></a></td>
<td><pre>                .info(&quot;Entered useAlternateFontforJALocales().&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2887" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2888" href="#"></a></td>
<td><pre>        if (!FontUtilities.isWindows) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2889" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2890" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2891" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2892" href="#"></a></td>
<td><pre>        if (!maybeMultiAppContext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2893" href="#"></a></td>
<td><pre>            gAltJAFont = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2894" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2895" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2896" href="#"></a></td>
<td><pre>            appContext.put(altJAFontKey, altJAFontKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2897" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2898" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2899" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2900" href="#"></a></td>
<td><pre>    public boolean usingAlternateFontforJALocales() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2901" href="#"></a></td>
<td><pre>        if (!maybeMultiAppContext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2902" href="#"></a></td>
<td><pre>            return gAltJAFont;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2903" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2904" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2905" href="#"></a></td>
<td><pre>            return appContext.get(altJAFontKey) == altJAFontKey;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2906" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2907" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2908" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2909" href="#"></a></td>
<td><pre>    public synchronized void preferLocaleFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2910" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2911" href="#"></a></td>
<td><pre>            FontUtilities.getLogger().info(&quot;Entered preferLocaleFonts().&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2912" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2913" href="#"></a></td>
<td><pre>        /* Test if re-ordering will have any effect */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2914" href="#"></a></td>
<td><pre>        if (!FontConfiguration.willReorderForStartupLocale()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2915" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2916" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2917" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2918" href="#"></a></td>
<td><pre>        if (!maybeMultiAppContext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2919" href="#"></a></td>
<td><pre>            if (gLocalePref == true) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2920" href="#"></a></td>
<td><pre>                return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2921" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2922" href="#"></a></td>
<td><pre>            gLocalePref = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2923" href="#"></a></td>
<td><pre>            createCompositeFonts(fontNameCache, gLocalePref, gPropPref);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2924" href="#"></a></td>
<td><pre>            _usingAlternateComposites = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2925" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2926" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2927" href="#"></a></td>
<td><pre>            if (appContext.get(localeFontKey) == localeFontKey) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2928" href="#"></a></td>
<td><pre>                return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2929" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2930" href="#"></a></td>
<td><pre>            appContext.put(localeFontKey, localeFontKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2931" href="#"></a></td>
<td><pre>            boolean acPropPref =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2932" href="#"></a></td>
<td><pre>                appContext.get(proportionalFontKey) == proportionalFontKey;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2933" href="#"></a></td>
<td><pre>            ConcurrentHashMap&lt;String, Font2D&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2934" href="#"></a></td>
<td><pre>                altNameCache = new ConcurrentHashMap&lt;String, Font2D&gt; ();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2935" href="#"></a></td>
<td><pre>            /* If there is an existing hashtable, we can drop it. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2936" href="#"></a></td>
<td><pre>            appContext.put(CompositeFont.class, altNameCache);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2937" href="#"></a></td>
<td><pre>            _usingPerAppContextComposites = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2938" href="#"></a></td>
<td><pre>            createCompositeFonts(altNameCache, true, acPropPref);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2939" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2940" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2941" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2942" href="#"></a></td>
<td><pre>    public synchronized void preferProportionalFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2943" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2944" href="#"></a></td>
<td><pre>            FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2945" href="#"></a></td>
<td><pre>                .info(&quot;Entered preferProportionalFonts().&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2946" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2947" href="#"></a></td>
<td><pre>        /* If no proportional fonts are configured, there's no need</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2948" href="#"></a></td>
<td><pre>         * to take any action.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2949" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2950" href="#"></a></td>
<td><pre>        if (!FontConfiguration.hasMonoToPropMap()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2951" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2952" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2953" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2954" href="#"></a></td>
<td><pre>        if (!maybeMultiAppContext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2955" href="#"></a></td>
<td><pre>            if (gPropPref == true) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2956" href="#"></a></td>
<td><pre>                return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2957" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2958" href="#"></a></td>
<td><pre>            gPropPref = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2959" href="#"></a></td>
<td><pre>            createCompositeFonts(fontNameCache, gLocalePref, gPropPref);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2960" href="#"></a></td>
<td><pre>            _usingAlternateComposites = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2961" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2962" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2963" href="#"></a></td>
<td><pre>            if (appContext.get(proportionalFontKey) == proportionalFontKey) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2964" href="#"></a></td>
<td><pre>                return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2965" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2966" href="#"></a></td>
<td><pre>            appContext.put(proportionalFontKey, proportionalFontKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2967" href="#"></a></td>
<td><pre>            boolean acLocalePref =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2968" href="#"></a></td>
<td><pre>                appContext.get(localeFontKey) == localeFontKey;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2969" href="#"></a></td>
<td><pre>            ConcurrentHashMap&lt;String, Font2D&gt;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2970" href="#"></a></td>
<td><pre>                altNameCache = new ConcurrentHashMap&lt;String, Font2D&gt; ();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2971" href="#"></a></td>
<td><pre>            /* If there is an existing hashtable, we can drop it. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2972" href="#"></a></td>
<td><pre>            appContext.put(CompositeFont.class, altNameCache);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2973" href="#"></a></td>
<td><pre>            _usingPerAppContextComposites = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2974" href="#"></a></td>
<td><pre>            createCompositeFonts(altNameCache, acLocalePref, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2975" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2976" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2977" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2978" href="#"></a></td>
<td><pre>    private static HashSet&lt;String&gt; installedNames = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2979" href="#"></a></td>
<td><pre>    private static HashSet&lt;String&gt; getInstalledNames() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2980" href="#"></a></td>
<td><pre>        if (installedNames == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2981" href="#"></a></td>
<td><pre>           Locale l = getSystemStartupLocale();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2982" href="#"></a></td>
<td><pre>           SunFontManager fontManager = SunFontManager.getInstance();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2983" href="#"></a></td>
<td><pre>           String[] installedFamilies =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2984" href="#"></a></td>
<td><pre>               fontManager.getInstalledFontFamilyNames(l);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2985" href="#"></a></td>
<td><pre>           Font[] installedFonts = fontManager.getAllInstalledFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2986" href="#"></a></td>
<td><pre>           HashSet&lt;String&gt; names = new HashSet&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2987" href="#"></a></td>
<td><pre>           for (int i=0; i&lt;installedFamilies.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2988" href="#"></a></td>
<td><pre>               names.add(installedFamilies[i].toLowerCase(l));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2989" href="#"></a></td>
<td><pre>           }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2990" href="#"></a></td>
<td><pre>           for (int i=0; i&lt;installedFonts.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2991" href="#"></a></td>
<td><pre>               names.add(installedFonts[i].getFontName(l).toLowerCase(l));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2992" href="#"></a></td>
<td><pre>           }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2993" href="#"></a></td>
<td><pre>           installedNames = names;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2994" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2995" href="#"></a></td>
<td><pre>        return installedNames;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2996" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2997" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2998" href="#"></a></td>
<td><pre>    /* Keys are used to lookup per-AppContext Hashtables */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2999" href="#"></a></td>
<td><pre>    private static final Object regFamilyKey  = new Object();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3000" href="#"></a></td>
<td><pre>    private static final Object regFullNameKey = new Object();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3001" href="#"></a></td>
<td><pre>    private Hashtable&lt;String,FontFamily&gt; createdByFamilyName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3002" href="#"></a></td>
<td><pre>    private Hashtable&lt;String,Font2D&gt;     createdByFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3003" href="#"></a></td>
<td><pre>    private boolean fontsAreRegistered = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3004" href="#"></a></td>
<td><pre>    private boolean fontsAreRegisteredPerAppContext = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3005" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3006" href="#"></a></td>
<td><pre>    public boolean registerFont(Font font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3007" href="#"></a></td>
<td><pre>        /* This method should not be called with &quot;null&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3008" href="#"></a></td>
<td><pre>         * It is the caller's responsibility to ensure that.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3009" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3010" href="#"></a></td>
<td><pre>        if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3011" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3012" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3013" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3014" href="#"></a></td>
<td><pre>        /* Initialise these objects only once we start to use this API */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3015" href="#"></a></td>
<td><pre>        synchronized (regFamilyKey) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3016" href="#"></a></td>
<td><pre>            if (createdByFamilyName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3017" href="#"></a></td>
<td><pre>                createdByFamilyName = new Hashtable&lt;String,FontFamily&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3018" href="#"></a></td>
<td><pre>                createdByFullName = new Hashtable&lt;String,Font2D&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3019" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3020" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3021" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3022" href="#"></a></td>
<td><pre>        if (! FontAccess.getFontAccess().isCreatedFont(font)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3023" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3024" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3025" href="#"></a></td>
<td><pre>        /* We want to ensure that this font cannot override existing</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3026" href="#"></a></td>
<td><pre>         * installed fonts. Check these conditions :</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3027" href="#"></a></td>
<td><pre>         * - family name is not that of an installed font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3028" href="#"></a></td>
<td><pre>         * - full name is not that of an installed font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3029" href="#"></a></td>
<td><pre>         * - family name is not the same as the full name of an installed font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3030" href="#"></a></td>
<td><pre>         * - full name is not the same as the family name of an installed font</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3031" href="#"></a></td>
<td><pre>         * The last two of these may initially look odd but the reason is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3032" href="#"></a></td>
<td><pre>         * that (unfortunately) Font constructors do not distinuguish these.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3033" href="#"></a></td>
<td><pre>         * An extreme example of such a problem would be a font which has</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3034" href="#"></a></td>
<td><pre>         * family name &quot;Dialog.Plain&quot; and full name of &quot;Dialog&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3035" href="#"></a></td>
<td><pre>         * The one arguably overly stringent restriction here is that if an</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3036" href="#"></a></td>
<td><pre>         * application wants to supply a new member of an existing family</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3037" href="#"></a></td>
<td><pre>         * It will get rejected. But since the JRE can perform synthetic</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3038" href="#"></a></td>
<td><pre>         * styling in many cases its not necessary.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3039" href="#"></a></td>
<td><pre>         * We don't apply the same logic to registered fonts. If apps want</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3040" href="#"></a></td>
<td><pre>         * to do this lets assume they have a reason. It won't cause problems</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3041" href="#"></a></td>
<td><pre>         * except for themselves.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3042" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3043" href="#"></a></td>
<td><pre>        HashSet&lt;String&gt; names = getInstalledNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3044" href="#"></a></td>
<td><pre>        Locale l = getSystemStartupLocale();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3045" href="#"></a></td>
<td><pre>        String familyName = font.getFamily(l).toLowerCase();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3046" href="#"></a></td>
<td><pre>        String fullName = font.getFontName(l).toLowerCase();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3047" href="#"></a></td>
<td><pre>        if (names.contains(familyName) || names.contains(fullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3048" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3049" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3050" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3051" href="#"></a></td>
<td><pre>        /* Checks passed, now register the font */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3052" href="#"></a></td>
<td><pre>        Hashtable&lt;String,FontFamily&gt; familyTable;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3053" href="#"></a></td>
<td><pre>        Hashtable&lt;String,Font2D&gt; fullNameTable;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3054" href="#"></a></td>
<td><pre>        if (!maybeMultiAppContext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3055" href="#"></a></td>
<td><pre>            familyTable = createdByFamilyName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3056" href="#"></a></td>
<td><pre>            fullNameTable = createdByFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3057" href="#"></a></td>
<td><pre>            fontsAreRegistered = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3058" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3059" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3060" href="#"></a></td>
<td><pre>            familyTable =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3061" href="#"></a></td>
<td><pre>                (Hashtable&lt;String,FontFamily&gt;)appContext.get(regFamilyKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3062" href="#"></a></td>
<td><pre>            fullNameTable =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3063" href="#"></a></td>
<td><pre>                (Hashtable&lt;String,Font2D&gt;)appContext.get(regFullNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3064" href="#"></a></td>
<td><pre>            if (familyTable == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3065" href="#"></a></td>
<td><pre>                familyTable = new Hashtable&lt;String,FontFamily&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3066" href="#"></a></td>
<td><pre>                fullNameTable = new Hashtable&lt;String,Font2D&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3067" href="#"></a></td>
<td><pre>                appContext.put(regFamilyKey, familyTable);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3068" href="#"></a></td>
<td><pre>                appContext.put(regFullNameKey, fullNameTable);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3069" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3070" href="#"></a></td>
<td><pre>            fontsAreRegisteredPerAppContext = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3071" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3072" href="#"></a></td>
<td><pre>        /* Create the FontFamily and add font to the tables */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3073" href="#"></a></td>
<td><pre>        Font2D font2D = FontUtilities.getFont2D(font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3074" href="#"></a></td>
<td><pre>        int style = font2D.getStyle();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3075" href="#"></a></td>
<td><pre>        FontFamily family = familyTable.get(familyName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3076" href="#"></a></td>
<td><pre>        if (family == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3077" href="#"></a></td>
<td><pre>            family = new FontFamily(font.getFamily(l));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3078" href="#"></a></td>
<td><pre>            familyTable.put(familyName, family);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3079" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3080" href="#"></a></td>
<td><pre>        /* Remove name cache entries if not using app contexts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3081" href="#"></a></td>
<td><pre>         * To accommodate a case where code may have registered first a plain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3082" href="#"></a></td>
<td><pre>         * family member and then used it and is now registering a bold family</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3083" href="#"></a></td>
<td><pre>         * member, we need to remove all members of the family, so that the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3084" href="#"></a></td>
<td><pre>         * new style can get picked up rather than continuing to synthesise.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3085" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3086" href="#"></a></td>
<td><pre>        if (fontsAreRegistered) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3087" href="#"></a></td>
<td><pre>            removeFromCache(family.getFont(Font.PLAIN));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3088" href="#"></a></td>
<td><pre>            removeFromCache(family.getFont(Font.BOLD));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3089" href="#"></a></td>
<td><pre>            removeFromCache(family.getFont(Font.ITALIC));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3090" href="#"></a></td>
<td><pre>            removeFromCache(family.getFont(Font.BOLD|Font.ITALIC));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3091" href="#"></a></td>
<td><pre>            removeFromCache(fullNameTable.get(fullName));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3092" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3093" href="#"></a></td>
<td><pre>        family.setFont(font2D, style);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3094" href="#"></a></td>
<td><pre>        fullNameTable.put(fullName, font2D);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3095" href="#"></a></td>
<td><pre>        return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3096" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3097" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3098" href="#"></a></td>
<td><pre>    /* Remove from the name cache all references to the Font2D */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3099" href="#"></a></td>
<td><pre>    private void removeFromCache(Font2D font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3100" href="#"></a></td>
<td><pre>        if (font == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3101" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3102" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3103" href="#"></a></td>
<td><pre>        String[] keys = (String[])(fontNameCache.keySet().toArray(STR_ARRAY));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3104" href="#"></a></td>
<td><pre>        for (int k=0; k&lt;keys.length;k++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3105" href="#"></a></td>
<td><pre>            if (fontNameCache.get(keys[k]) == font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3106" href="#"></a></td>
<td><pre>                fontNameCache.remove(keys[k]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3107" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3108" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3109" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3110" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3111" href="#"></a></td>
<td><pre>    // It may look odd to use TreeMap but its more convenient to the caller.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3112" href="#"></a></td>
<td><pre>    public TreeMap&lt;String, String&gt; getCreatedFontFamilyNames() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3113" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3114" href="#"></a></td>
<td><pre>        Hashtable&lt;String,FontFamily&gt; familyTable;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3115" href="#"></a></td>
<td><pre>        if (fontsAreRegistered) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3116" href="#"></a></td>
<td><pre>            familyTable = createdByFamilyName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3117" href="#"></a></td>
<td><pre>        } else if (fontsAreRegisteredPerAppContext) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3118" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3119" href="#"></a></td>
<td><pre>            familyTable =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3120" href="#"></a></td>
<td><pre>                (Hashtable&lt;String,FontFamily&gt;)appContext.get(regFamilyKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3121" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3122" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3123" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3124" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3125" href="#"></a></td>
<td><pre>        Locale l = getSystemStartupLocale();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3126" href="#"></a></td>
<td><pre>        synchronized (familyTable) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3127" href="#"></a></td>
<td><pre>            TreeMap&lt;String, String&gt; map = new TreeMap&lt;String, String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3128" href="#"></a></td>
<td><pre>            for (FontFamily f : familyTable.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3129" href="#"></a></td>
<td><pre>                Font2D font2D = f.getFont(Font.PLAIN);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3130" href="#"></a></td>
<td><pre>                if (font2D == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3131" href="#"></a></td>
<td><pre>                    font2D = f.getClosestStyle(Font.PLAIN);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3132" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3133" href="#"></a></td>
<td><pre>                String name = font2D.getFamilyName(l);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3134" href="#"></a></td>
<td><pre>                map.put(name.toLowerCase(l), name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3135" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3136" href="#"></a></td>
<td><pre>            return map;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3137" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3138" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3139" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3140" href="#"></a></td>
<td><pre>    public Font[] getCreatedFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3141" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3142" href="#"></a></td>
<td><pre>        Hashtable&lt;String,Font2D&gt; nameTable;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3143" href="#"></a></td>
<td><pre>        if (fontsAreRegistered) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3144" href="#"></a></td>
<td><pre>            nameTable = createdByFullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3145" href="#"></a></td>
<td><pre>        } else if (fontsAreRegisteredPerAppContext) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3146" href="#"></a></td>
<td><pre>            AppContext appContext = AppContext.getAppContext();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3147" href="#"></a></td>
<td><pre>            nameTable =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3148" href="#"></a></td>
<td><pre>                (Hashtable&lt;String,Font2D&gt;)appContext.get(regFullNameKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3149" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3150" href="#"></a></td>
<td><pre>            return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3151" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3152" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3153" href="#"></a></td>
<td><pre>        Locale l = getSystemStartupLocale();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3154" href="#"></a></td>
<td><pre>        synchronized (nameTable) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3155" href="#"></a></td>
<td><pre>            Font[] fonts = new Font[nameTable.size()];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3156" href="#"></a></td>
<td><pre>            int i=0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3157" href="#"></a></td>
<td><pre>            for (Font2D font2D : nameTable.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3158" href="#"></a></td>
<td><pre>                fonts[i++] = new Font(font2D.getFontName(l), Font.PLAIN, 1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3159" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3160" href="#"></a></td>
<td><pre>            return fonts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3161" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3162" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3163" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3164" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3165" href="#"></a></td>
<td><pre>    protected String[] getPlatformFontDirs(boolean noType1Fonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3166" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3167" href="#"></a></td>
<td><pre>        /* First check if we already initialised path dirs */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3168" href="#"></a></td>
<td><pre>        if (pathDirs != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3169" href="#"></a></td>
<td><pre>            return pathDirs;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3170" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3171" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3172" href="#"></a></td>
<td><pre>        String path = getPlatformFontPath(noType1Fonts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3173" href="#"></a></td>
<td><pre>        StringTokenizer parser =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3174" href="#"></a></td>
<td><pre>            new StringTokenizer(path, File.pathSeparator);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3175" href="#"></a></td>
<td><pre>        ArrayList&lt;String&gt; pathList = new ArrayList&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3176" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3177" href="#"></a></td>
<td><pre>            while (parser.hasMoreTokens()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3178" href="#"></a></td>
<td><pre>                pathList.add(parser.nextToken());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3179" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3180" href="#"></a></td>
<td><pre>        } catch (NoSuchElementException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3181" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3182" href="#"></a></td>
<td><pre>        pathDirs = pathList.toArray(new String[0]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3183" href="#"></a></td>
<td><pre>        return pathDirs;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3184" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3185" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3186" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3187" href="#"></a></td>
<td><pre>     * Returns an array of two strings. The first element is the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3188" href="#"></a></td>
<td><pre>     * name of the font. The second element is the file name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3189" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3190" href="#"></a></td>
<td><pre>    public abstract String[] getDefaultPlatformFont();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3191" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3192" href="#"></a></td>
<td><pre>    // Begin: Refactored from SunGraphicsEnviroment.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3193" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3194" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3195" href="#"></a></td>
<td><pre>     * helper function for registerFonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3196" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3197" href="#"></a></td>
<td><pre>    private void addDirFonts(String dirName, File dirFile,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3198" href="#"></a></td>
<td><pre>                             FilenameFilter filter,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3199" href="#"></a></td>
<td><pre>                             int fontFormat, boolean useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3200" href="#"></a></td>
<td><pre>                             int fontRank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3201" href="#"></a></td>
<td><pre>                             boolean defer, boolean resolveSymLinks) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3202" href="#"></a></td>
<td><pre>        String[] ls = dirFile.list(filter);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3203" href="#"></a></td>
<td><pre>        if (ls == null || ls.length == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3204" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3205" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3206" href="#"></a></td>
<td><pre>        String[] fontNames = new String[ls.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3207" href="#"></a></td>
<td><pre>        String[][] nativeNames = new String[ls.length][];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3208" href="#"></a></td>
<td><pre>        int fontCount = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3209" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3210" href="#"></a></td>
<td><pre>        for (int i=0; i &lt; ls.length; i++ ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3211" href="#"></a></td>
<td><pre>            File theFile = new File(dirFile, ls[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3212" href="#"></a></td>
<td><pre>            String fullName = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3213" href="#"></a></td>
<td><pre>            if (resolveSymLinks) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3214" href="#"></a></td>
<td><pre>                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3215" href="#"></a></td>
<td><pre>                    fullName = theFile.getCanonicalPath();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3216" href="#"></a></td>
<td><pre>                } catch (IOException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3217" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3218" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3219" href="#"></a></td>
<td><pre>            if (fullName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3220" href="#"></a></td>
<td><pre>                fullName = dirName + File.separator + ls[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3221" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3222" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3223" href="#"></a></td>
<td><pre>            // REMIND: case compare depends on platform</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3224" href="#"></a></td>
<td><pre>            if (registeredFontFiles.contains(fullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3225" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3226" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3227" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3228" href="#"></a></td>
<td><pre>            if (badFonts != null &amp;&amp; badFonts.contains(fullName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3229" href="#"></a></td>
<td><pre>                if (FontUtilities.debugFonts()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3230" href="#"></a></td>
<td><pre>                    FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3231" href="#"></a></td>
<td><pre>                                         .warning(&quot;skip bad font &quot; + fullName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3232" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3233" href="#"></a></td>
<td><pre>                continue; // skip this font file.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3234" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3235" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3236" href="#"></a></td>
<td><pre>            registeredFontFiles.add(fullName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3237" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3238" href="#"></a></td>
<td><pre>            if (FontUtilities.debugFonts()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3239" href="#"></a></td>
<td><pre>                &amp;&amp; FontUtilities.getLogger().isLoggable(PlatformLogger.Level.INFO)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3240" href="#"></a></td>
<td><pre>                String message = &quot;Registering font &quot; + fullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3241" href="#"></a></td>
<td><pre>                String[] natNames = getNativeNames(fullName, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3242" href="#"></a></td>
<td><pre>                if (natNames == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3243" href="#"></a></td>
<td><pre>                    message += &quot; with no native name&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3244" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3245" href="#"></a></td>
<td><pre>                    message += &quot; with native name(s) &quot; + natNames[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3246" href="#"></a></td>
<td><pre>                    for (int nn = 1; nn &lt; natNames.length; nn++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3247" href="#"></a></td>
<td><pre>                        message += &quot;, &quot; + natNames[nn];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3248" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3249" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3250" href="#"></a></td>
<td><pre>                FontUtilities.getLogger().info(message);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3251" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3252" href="#"></a></td>
<td><pre>            fontNames[fontCount] = fullName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3253" href="#"></a></td>
<td><pre>            nativeNames[fontCount++] = getNativeNames(fullName, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3254" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3255" href="#"></a></td>
<td><pre>        registerFonts(fontNames, nativeNames, fontCount, fontFormat,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3256" href="#"></a></td>
<td><pre>                         useJavaRasterizer, fontRank, defer);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3257" href="#"></a></td>
<td><pre>        return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3258" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3259" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3260" href="#"></a></td>
<td><pre>    protected String[] getNativeNames(String fontFileName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3261" href="#"></a></td>
<td><pre>                                      String platformName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3262" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3263" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3264" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3265" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3266" href="#"></a></td>
<td><pre>     * Returns a file name for the physical font represented by this platform</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3267" href="#"></a></td>
<td><pre>     * font name. The default implementation tries to obtain the file name</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3268" href="#"></a></td>
<td><pre>     * from the font configuration.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3269" href="#"></a></td>
<td><pre>     * Subclasses may override to provide information from other sources.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3270" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3271" href="#"></a></td>
<td><pre>    protected String getFileNameFromPlatformName(String platformFontName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3272" href="#"></a></td>
<td><pre>        return fontConfig.getFileNameFromPlatformName(platformFontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3273" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3274" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3275" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3276" href="#"></a></td>
<td><pre>     * Return the default font configuration.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3277" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3278" href="#"></a></td>
<td><pre>    public FontConfiguration getFontConfiguration() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3279" href="#"></a></td>
<td><pre>        return fontConfig;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3280" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3281" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3282" href="#"></a></td>
<td><pre>    /* A call to this method should be followed by a call to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3283" href="#"></a></td>
<td><pre>     * registerFontDirs(..)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3284" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3285" href="#"></a></td>
<td><pre>    public String getPlatformFontPath(boolean noType1Font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3286" href="#"></a></td>
<td><pre>        if (fontPath == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3287" href="#"></a></td>
<td><pre>            fontPath = getFontPath(noType1Font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3288" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3289" href="#"></a></td>
<td><pre>        return fontPath;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3290" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3291" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3292" href="#"></a></td>
<td><pre>    public static boolean isOpenJDK() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3293" href="#"></a></td>
<td><pre>        return FontUtilities.isOpenJDK;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3294" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3295" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3296" href="#"></a></td>
<td><pre>    protected void loadFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3297" href="#"></a></td>
<td><pre>        if (discoveredAllFonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3298" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3299" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3300" href="#"></a></td>
<td><pre>        /* Use lock specific to the font system */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3301" href="#"></a></td>
<td><pre>        synchronized (this) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3302" href="#"></a></td>
<td><pre>            if (FontUtilities.debugFonts()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3303" href="#"></a></td>
<td><pre>                Thread.dumpStack();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3304" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3305" href="#"></a></td>
<td><pre>                            .info(&quot;SunGraphicsEnvironment.loadFonts() called&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3306" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3307" href="#"></a></td>
<td><pre>            initialiseDeferredFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3308" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3309" href="#"></a></td>
<td><pre>            java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3310" href="#"></a></td>
<td><pre>                                    new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3311" href="#"></a></td>
<td><pre>                public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3312" href="#"></a></td>
<td><pre>                    if (fontPath == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3313" href="#"></a></td>
<td><pre>                        fontPath = getPlatformFontPath(noType1Font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3314" href="#"></a></td>
<td><pre>                        registerFontDirs(fontPath);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3315" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3316" href="#"></a></td>
<td><pre>                    if (fontPath != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3317" href="#"></a></td>
<td><pre>                        // this will find all fonts including those already</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3318" href="#"></a></td>
<td><pre>                        // registered. But we have checks in place to prevent</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3319" href="#"></a></td>
<td><pre>                        // double registration.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3320" href="#"></a></td>
<td><pre>                        if (! gotFontsFromPlatform()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3321" href="#"></a></td>
<td><pre>                            registerFontsOnPath(fontPath, false,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3322" href="#"></a></td>
<td><pre>                                                Font2D.UNKNOWN_RANK,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3323" href="#"></a></td>
<td><pre>                                                false, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3324" href="#"></a></td>
<td><pre>                            loadedAllFontFiles = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3325" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3326" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3327" href="#"></a></td>
<td><pre>                    registerOtherFontFiles(registeredFontFiles);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3328" href="#"></a></td>
<td><pre>                    discoveredAllFonts = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3329" href="#"></a></td>
<td><pre>                    return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3330" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3331" href="#"></a></td>
<td><pre>            });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3332" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3333" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3334" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3335" href="#"></a></td>
<td><pre>    protected void registerFontDirs(String pathName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3336" href="#"></a></td>
<td><pre>        return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3337" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3338" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3339" href="#"></a></td>
<td><pre>    private void registerFontsOnPath(String pathName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3340" href="#"></a></td>
<td><pre>                                     boolean useJavaRasterizer, int fontRank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3341" href="#"></a></td>
<td><pre>                                     boolean defer, boolean resolveSymLinks) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3342" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3343" href="#"></a></td>
<td><pre>        StringTokenizer parser = new StringTokenizer(pathName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3344" href="#"></a></td>
<td><pre>                File.pathSeparator);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3345" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3346" href="#"></a></td>
<td><pre>            while (parser.hasMoreTokens()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3347" href="#"></a></td>
<td><pre>                registerFontsInDir(parser.nextToken(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3348" href="#"></a></td>
<td><pre>                        useJavaRasterizer, fontRank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3349" href="#"></a></td>
<td><pre>                        defer, resolveSymLinks);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3350" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3351" href="#"></a></td>
<td><pre>        } catch (NoSuchElementException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3352" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3353" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3354" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3355" href="#"></a></td>
<td><pre>    /* Called to register fall back fonts */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3356" href="#"></a></td>
<td><pre>    public void registerFontsInDir(String dirName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3357" href="#"></a></td>
<td><pre>        registerFontsInDir(dirName, true, Font2D.JRE_RANK, true, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3358" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3359" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3360" href="#"></a></td>
<td><pre>    // MACOSX begin -- need to access this in subclass</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3361" href="#"></a></td>
<td><pre>    protected void registerFontsInDir(String dirName, boolean useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3362" href="#"></a></td>
<td><pre>    // MACOSX end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3363" href="#"></a></td>
<td><pre>                                    int fontRank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3364" href="#"></a></td>
<td><pre>                                    boolean defer, boolean resolveSymLinks) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3365" href="#"></a></td>
<td><pre>        File pathFile = new File(dirName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3366" href="#"></a></td>
<td><pre>        addDirFonts(dirName, pathFile, ttFilter,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3367" href="#"></a></td>
<td><pre>                    FONTFORMAT_TRUETYPE, useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3368" href="#"></a></td>
<td><pre>                    fontRank==Font2D.UNKNOWN_RANK ?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3369" href="#"></a></td>
<td><pre>                    Font2D.TTF_RANK : fontRank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3370" href="#"></a></td>
<td><pre>                    defer, resolveSymLinks);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3371" href="#"></a></td>
<td><pre>        addDirFonts(dirName, pathFile, t1Filter,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3372" href="#"></a></td>
<td><pre>                    FONTFORMAT_TYPE1, useJavaRasterizer,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3373" href="#"></a></td>
<td><pre>                    fontRank==Font2D.UNKNOWN_RANK ?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3374" href="#"></a></td>
<td><pre>                    Font2D.TYPE1_RANK : fontRank,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3375" href="#"></a></td>
<td><pre>                    defer, resolveSymLinks);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3376" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3377" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3378" href="#"></a></td>
<td><pre>    protected void registerFontDir(String path) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3379" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3380" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3381" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3382" href="#"></a></td>
<td><pre>     * Returns file name for default font, either absolute</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3383" href="#"></a></td>
<td><pre>     * or relative as needed by registerFontFile.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3384" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3385" href="#"></a></td>
<td><pre>    public synchronized String getDefaultFontFile() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3386" href="#"></a></td>
<td><pre>        if (defaultFontFileName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3387" href="#"></a></td>
<td><pre>            initDefaultFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3388" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3389" href="#"></a></td>
<td><pre>        return defaultFontFileName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3390" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3391" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3392" href="#"></a></td>
<td><pre>    private void initDefaultFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3393" href="#"></a></td>
<td><pre>        if (!isOpenJDK()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3394" href="#"></a></td>
<td><pre>            defaultFontName = lucidaFontName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3395" href="#"></a></td>
<td><pre>            if (useAbsoluteFontFileNames()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3396" href="#"></a></td>
<td><pre>                defaultFontFileName =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3397" href="#"></a></td>
<td><pre>                    jreFontDirName + File.separator + FontUtilities.LUCIDA_FILE_NAME;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3398" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3399" href="#"></a></td>
<td><pre>                defaultFontFileName = FontUtilities.LUCIDA_FILE_NAME;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3400" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3401" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3402" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3403" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3404" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3405" href="#"></a></td>
<td><pre>     * Whether registerFontFile expects absolute or relative</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3406" href="#"></a></td>
<td><pre>     * font file names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3407" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3408" href="#"></a></td>
<td><pre>    protected boolean useAbsoluteFontFileNames() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3409" href="#"></a></td>
<td><pre>        return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3410" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3411" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3412" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3413" href="#"></a></td>
<td><pre>     * Creates this environment's FontConfiguration.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3414" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3415" href="#"></a></td>
<td><pre>    protected abstract FontConfiguration createFontConfiguration();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3416" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3417" href="#"></a></td>
<td><pre>    public abstract FontConfiguration</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3418" href="#"></a></td>
<td><pre>    createFontConfiguration(boolean preferLocaleFonts,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3419" href="#"></a></td>
<td><pre>                            boolean preferPropFonts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3420" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3421" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3422" href="#"></a></td>
<td><pre>     * Returns face name for default font, or null if</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3423" href="#"></a></td>
<td><pre>     * no face names are used for CompositeFontDescriptors</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3424" href="#"></a></td>
<td><pre>     * for this platform.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3425" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3426" href="#"></a></td>
<td><pre>    public synchronized String getDefaultFontFaceName() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3427" href="#"></a></td>
<td><pre>        if (defaultFontName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3428" href="#"></a></td>
<td><pre>            initDefaultFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3429" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3430" href="#"></a></td>
<td><pre>        return defaultFontName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3431" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3432" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3433" href="#"></a></td>
<td><pre>    public void loadFontFiles() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3434" href="#"></a></td>
<td><pre>        loadFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3435" href="#"></a></td>
<td><pre>        if (loadedAllFontFiles) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3436" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3437" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3438" href="#"></a></td>
<td><pre>        /* Use lock specific to the font system */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3439" href="#"></a></td>
<td><pre>        synchronized (this) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3440" href="#"></a></td>
<td><pre>            if (FontUtilities.debugFonts()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3441" href="#"></a></td>
<td><pre>                Thread.dumpStack();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3442" href="#"></a></td>
<td><pre>                FontUtilities.getLogger().info(&quot;loadAllFontFiles() called&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3443" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3444" href="#"></a></td>
<td><pre>            java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3445" href="#"></a></td>
<td><pre>                                    new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3446" href="#"></a></td>
<td><pre>                public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3447" href="#"></a></td>
<td><pre>                    if (fontPath == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3448" href="#"></a></td>
<td><pre>                        fontPath = getPlatformFontPath(noType1Font);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3449" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3450" href="#"></a></td>
<td><pre>                    if (fontPath != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3451" href="#"></a></td>
<td><pre>                        // this will find all fonts including those already</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3452" href="#"></a></td>
<td><pre>                        // registered. But we have checks in place to prevent</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3453" href="#"></a></td>
<td><pre>                        // double registration.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3454" href="#"></a></td>
<td><pre>                        registerFontsOnPath(fontPath, false,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3455" href="#"></a></td>
<td><pre>                                            Font2D.UNKNOWN_RANK,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3456" href="#"></a></td>
<td><pre>                                            false, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3457" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3458" href="#"></a></td>
<td><pre>                    loadedAllFontFiles = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3459" href="#"></a></td>
<td><pre>                    return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3460" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3461" href="#"></a></td>
<td><pre>            });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3462" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3463" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3464" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3465" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3466" href="#"></a></td>
<td><pre>     * This method asks the font configuration API for all platform names</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3467" href="#"></a></td>
<td><pre>     * used as components of composite/logical fonts and iterates over these</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3468" href="#"></a></td>
<td><pre>     * looking up their corresponding file name and registers these fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3469" href="#"></a></td>
<td><pre>     * It also ensures that the fonts are accessible via platform APIs.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3470" href="#"></a></td>
<td><pre>     * The composites themselves are then registered.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3471" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3472" href="#"></a></td>
<td><pre>    private void</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3473" href="#"></a></td>
<td><pre>        initCompositeFonts(FontConfiguration fontConfig,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3474" href="#"></a></td>
<td><pre>                           ConcurrentHashMap&lt;String, Font2D&gt;  altNameCache) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3475" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3476" href="#"></a></td>
<td><pre>        if (FontUtilities.isLogging()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3477" href="#"></a></td>
<td><pre>            FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3478" href="#"></a></td>
<td><pre>                            .info(&quot;Initialising composite fonts&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3479" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3480" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3481" href="#"></a></td>
<td><pre>        int numCoreFonts = fontConfig.getNumberCoreFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3482" href="#"></a></td>
<td><pre>        String[] fcFonts = fontConfig.getPlatformFontNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3483" href="#"></a></td>
<td><pre>        for (int f=0; f&lt;fcFonts.length; f++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3484" href="#"></a></td>
<td><pre>            String platformFontName = fcFonts[f];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3485" href="#"></a></td>
<td><pre>            String fontFileName =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3486" href="#"></a></td>
<td><pre>                getFileNameFromPlatformName(platformFontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3487" href="#"></a></td>
<td><pre>            String[] nativeNames = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3488" href="#"></a></td>
<td><pre>            if (fontFileName == null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3489" href="#"></a></td>
<td><pre>                || fontFileName.equals(platformFontName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3490" href="#"></a></td>
<td><pre>                /* No file located, so register using the platform name,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3491" href="#"></a></td>
<td><pre>                 * i.e. as a native font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3492" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3493" href="#"></a></td>
<td><pre>                fontFileName = platformFontName;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3494" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3495" href="#"></a></td>
<td><pre>                if (f &lt; numCoreFonts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3496" href="#"></a></td>
<td><pre>                    /* If platform APIs also need to access the font, add it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3497" href="#"></a></td>
<td><pre>                     * to a set to be registered with the platform too.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3498" href="#"></a></td>
<td><pre>                     * This may be used to add the parent directory to the X11</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3499" href="#"></a></td>
<td><pre>                     * font path if its not already there. See the docs for the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3500" href="#"></a></td>
<td><pre>                     * subclass implementation.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3501" href="#"></a></td>
<td><pre>                     * This is now mainly for the benefit of X11-based AWT</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3502" href="#"></a></td>
<td><pre>                     * But for historical reasons, 2D initialisation code</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3503" href="#"></a></td>
<td><pre>                     * makes these calls.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3504" href="#"></a></td>
<td><pre>                     * If the fontconfiguration file is properly set up</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3505" href="#"></a></td>
<td><pre>                     * so that all fonts are mapped to files and all their</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3506" href="#"></a></td>
<td><pre>                     * appropriate directories are specified, then this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3507" href="#"></a></td>
<td><pre>                     * method will be low cost as it will return after</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3508" href="#"></a></td>
<td><pre>                     * a test that finds a null lookup map.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3509" href="#"></a></td>
<td><pre>                     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3510" href="#"></a></td>
<td><pre>                    addFontToPlatformFontPath(platformFontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3511" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3512" href="#"></a></td>
<td><pre>                nativeNames = getNativeNames(fontFileName, platformFontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3513" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3514" href="#"></a></td>
<td><pre>            /* Uncomment these two lines to &quot;generate&quot; the XLFD-&gt;filename</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3515" href="#"></a></td>
<td><pre>             * mappings needed to speed start-up on Solaris.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3516" href="#"></a></td>
<td><pre>             * Augment this with the appendedpathname and the mappings</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3517" href="#"></a></td>
<td><pre>             * for native (F3) fonts</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3518" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3519" href="#"></a></td>
<td><pre>            //String platName = platformFontName.replaceAll(&quot; &quot;, &quot;_&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3520" href="#"></a></td>
<td><pre>            //System.out.println(&quot;filename.&quot;+platName+&quot;=&quot;+fontFileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3521" href="#"></a></td>
<td><pre>            registerFontFile(fontFileName, nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3522" href="#"></a></td>
<td><pre>                             Font2D.FONT_CONFIG_RANK, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3523" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3524" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3525" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3526" href="#"></a></td>
<td><pre>        /* This registers accumulated paths from the calls to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3527" href="#"></a></td>
<td><pre>         * addFontToPlatformFontPath(..) and any specified by</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3528" href="#"></a></td>
<td><pre>         * the font configuration. Rather than registering</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3529" href="#"></a></td>
<td><pre>         * the fonts it puts them in a place and form suitable for</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3530" href="#"></a></td>
<td><pre>         * the Toolkit to pick up and use if a toolkit is initialised,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3531" href="#"></a></td>
<td><pre>         * and if it uses X11 fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3532" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3533" href="#"></a></td>
<td><pre>        registerPlatformFontsUsedByFontConfiguration();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3534" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3535" href="#"></a></td>
<td><pre>        CompositeFontDescriptor[] compositeFontInfo</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3536" href="#"></a></td>
<td><pre>                = fontConfig.get2DCompositeFontInfo();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3537" href="#"></a></td>
<td><pre>        for (int i = 0; i &lt; compositeFontInfo.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3538" href="#"></a></td>
<td><pre>            CompositeFontDescriptor descriptor = compositeFontInfo[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3539" href="#"></a></td>
<td><pre>            String[] componentFileNames = descriptor.getComponentFileNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3540" href="#"></a></td>
<td><pre>            String[] componentFaceNames = descriptor.getComponentFaceNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3541" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3542" href="#"></a></td>
<td><pre>            /* It would be better eventually to handle this in the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3543" href="#"></a></td>
<td><pre>             * FontConfiguration code which should also remove duplicate slots</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3544" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3545" href="#"></a></td>
<td><pre>            if (missingFontFiles != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3546" href="#"></a></td>
<td><pre>                for (int ii=0; ii&lt;componentFileNames.length; ii++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3547" href="#"></a></td>
<td><pre>                    if (missingFontFiles.contains(componentFileNames[ii])) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3548" href="#"></a></td>
<td><pre>                        componentFileNames[ii] = getDefaultFontFile();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3549" href="#"></a></td>
<td><pre>                        componentFaceNames[ii] = getDefaultFontFaceName();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3550" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3551" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3552" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3553" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3554" href="#"></a></td>
<td><pre>            /* FontConfiguration needs to convey how many fonts it has added</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3555" href="#"></a></td>
<td><pre>             * as fallback component fonts which should not affect metrics.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3556" href="#"></a></td>
<td><pre>             * The core component count will be the number of metrics slots.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3557" href="#"></a></td>
<td><pre>             * This does not preclude other mechanisms for adding</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3558" href="#"></a></td>
<td><pre>             * fall back component fonts to the composite.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3559" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3560" href="#"></a></td>
<td><pre>            if (altNameCache != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3561" href="#"></a></td>
<td><pre>                SunFontManager.registerCompositeFont(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3562" href="#"></a></td>
<td><pre>                    descriptor.getFaceName(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3563" href="#"></a></td>
<td><pre>                    componentFileNames, componentFaceNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3564" href="#"></a></td>
<td><pre>                    descriptor.getCoreComponentCount(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3565" href="#"></a></td>
<td><pre>                    descriptor.getExclusionRanges(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3566" href="#"></a></td>
<td><pre>                    descriptor.getExclusionRangeLimits(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3567" href="#"></a></td>
<td><pre>                    true,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3568" href="#"></a></td>
<td><pre>                    altNameCache);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3569" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3570" href="#"></a></td>
<td><pre>                registerCompositeFont(descriptor.getFaceName(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3571" href="#"></a></td>
<td><pre>                                      componentFileNames, componentFaceNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3572" href="#"></a></td>
<td><pre>                                      descriptor.getCoreComponentCount(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3573" href="#"></a></td>
<td><pre>                                      descriptor.getExclusionRanges(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3574" href="#"></a></td>
<td><pre>                                      descriptor.getExclusionRangeLimits(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3575" href="#"></a></td>
<td><pre>                                      true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3576" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3577" href="#"></a></td>
<td><pre>            if (FontUtilities.debugFonts()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3578" href="#"></a></td>
<td><pre>                FontUtilities.getLogger()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3579" href="#"></a></td>
<td><pre>                               .info(&quot;registered &quot; + descriptor.getFaceName());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3580" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3581" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3582" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3583" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3584" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3585" href="#"></a></td>
<td><pre>     * Notifies graphics environment that the logical font configuration</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3586" href="#"></a></td>
<td><pre>     * uses the given platform font name. The graphics environment may</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3587" href="#"></a></td>
<td><pre>     * use this for platform specific initialization.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3588" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3589" href="#"></a></td>
<td><pre>    protected void addFontToPlatformFontPath(String platformFontName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3590" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3591" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3592" href="#"></a></td>
<td><pre>    protected void registerFontFile(String fontFileName, String[] nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3593" href="#"></a></td>
<td><pre>                                    int fontRank, boolean defer) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3594" href="#"></a></td>
<td><pre>//      REMIND: case compare depends on platform</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3595" href="#"></a></td>
<td><pre>        if (registeredFontFiles.contains(fontFileName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3596" href="#"></a></td>
<td><pre>            return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3597" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3598" href="#"></a></td>
<td><pre>        int fontFormat;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3599" href="#"></a></td>
<td><pre>        if (ttFilter.accept(null, fontFileName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3600" href="#"></a></td>
<td><pre>            fontFormat = FONTFORMAT_TRUETYPE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3601" href="#"></a></td>
<td><pre>        } else if (t1Filter.accept(null, fontFileName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3602" href="#"></a></td>
<td><pre>            fontFormat = FONTFORMAT_TYPE1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3603" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3604" href="#"></a></td>
<td><pre>            fontFormat = FONTFORMAT_NATIVE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3605" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3606" href="#"></a></td>
<td><pre>        registeredFontFiles.add(fontFileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3607" href="#"></a></td>
<td><pre>        if (defer) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3608" href="#"></a></td>
<td><pre>            registerDeferredFont(fontFileName, fontFileName, nativeNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3609" href="#"></a></td>
<td><pre>                                 fontFormat, false, fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3610" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3611" href="#"></a></td>
<td><pre>            registerFontFile(fontFileName, nativeNames, fontFormat, false,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3612" href="#"></a></td>
<td><pre>                             fontRank);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3613" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3614" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3615" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3616" href="#"></a></td>
<td><pre>    protected void registerPlatformFontsUsedByFontConfiguration() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3617" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3618" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3619" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3620" href="#"></a></td>
<td><pre>     * A GE may verify whether a font file used in a fontconfiguration</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3621" href="#"></a></td>
<td><pre>     * exists. If it doesn't then either we may substitute the default</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3622" href="#"></a></td>
<td><pre>     * font, or perhaps elide it altogether from the composite font.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3623" href="#"></a></td>
<td><pre>     * This makes some sense on windows where the font file is only</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3624" href="#"></a></td>
<td><pre>     * likely to be in one place. But on other OSes, eg Linux, the file</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3625" href="#"></a></td>
<td><pre>     * can move around depending. So there we probably don't want to assume</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3626" href="#"></a></td>
<td><pre>     * its missing and so won't add it to this list.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3627" href="#"></a></td>
<td><pre>     * If this list - missingFontFiles - is non-null then the composite</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3628" href="#"></a></td>
<td><pre>     * font initialisation logic tests to see if a font file is in that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3629" href="#"></a></td>
<td><pre>     * set.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3630" href="#"></a></td>
<td><pre>     * Only one thread should be able to add to this set so we don't</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3631" href="#"></a></td>
<td><pre>     * synchronize.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3632" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3633" href="#"></a></td>
<td><pre>    protected void addToMissingFontFileList(String fileName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3634" href="#"></a></td>
<td><pre>        if (missingFontFiles == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3635" href="#"></a></td>
<td><pre>            missingFontFiles = new HashSet&lt;String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3636" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3637" href="#"></a></td>
<td><pre>        missingFontFiles.add(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3638" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3639" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3640" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3641" href="#"></a></td>
<td><pre>     * This is for use only within getAllFonts().</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3642" href="#"></a></td>
<td><pre>     * Fonts listed in the fontconfig files for windows were all</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3643" href="#"></a></td>
<td><pre>     * on the &quot;deferred&quot; initialisation list. They were registered</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3644" href="#"></a></td>
<td><pre>     * either in the course of the application, or in the call to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3645" href="#"></a></td>
<td><pre>     * loadFonts() within getAllFonts(). The fontconfig file specifies</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3646" href="#"></a></td>
<td><pre>     * the names of the fonts using the English names. If there's a</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3647" href="#"></a></td>
<td><pre>     * different name in the execution locale, then the platform will</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3648" href="#"></a></td>
<td><pre>     * report that, and we will construct the font with both names, and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3649" href="#"></a></td>
<td><pre>     * thereby enumerate it twice. This happens for Japanese fonts listed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3650" href="#"></a></td>
<td><pre>     * in the windows fontconfig, when run in the JA locale. The solution</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3651" href="#"></a></td>
<td><pre>     * is to rely (in this case) on the platform's font-&gt;file mapping to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3652" href="#"></a></td>
<td><pre>     * determine that this name corresponds to a file we already registered.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3653" href="#"></a></td>
<td><pre>     * This works because</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3654" href="#"></a></td>
<td><pre>     * - we know when we get here all deferred fonts are already initialised</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3655" href="#"></a></td>
<td><pre>     * - when we register a font file, we register all fonts in it.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3656" href="#"></a></td>
<td><pre>     * - we know the fontconfig fonts are all in the windows registry</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3657" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3658" href="#"></a></td>
<td><pre>    private boolean isNameForRegisteredFile(String fontName) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3659" href="#"></a></td>
<td><pre>        String fileName = getFileNameForFontName(fontName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3660" href="#"></a></td>
<td><pre>        if (fileName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3661" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3662" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3663" href="#"></a></td>
<td><pre>        return registeredFontFiles.contains(fileName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3664" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3665" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3666" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3667" href="#"></a></td>
<td><pre>     * This invocation is not in a privileged block because</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3668" href="#"></a></td>
<td><pre>     * all privileged operations (reading files and properties)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3669" href="#"></a></td>
<td><pre>     * was conducted on the creation of the GE</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3670" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3671" href="#"></a></td>
<td><pre>    public void</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3672" href="#"></a></td>
<td><pre>        createCompositeFonts(ConcurrentHashMap&lt;String, Font2D&gt; altNameCache,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3673" href="#"></a></td>
<td><pre>                             boolean preferLocale,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3674" href="#"></a></td>
<td><pre>                             boolean preferProportional) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3675" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3676" href="#"></a></td>
<td><pre>        FontConfiguration fontConfig =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3677" href="#"></a></td>
<td><pre>            createFontConfiguration(preferLocale, preferProportional);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3678" href="#"></a></td>
<td><pre>        initCompositeFonts(fontConfig, altNameCache);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3679" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3680" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3681" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3682" href="#"></a></td>
<td><pre>     * Returns all fonts installed in this environment.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3683" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3684" href="#"></a></td>
<td><pre>    public Font[] getAllInstalledFonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3685" href="#"></a></td>
<td><pre>        if (allFonts == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3686" href="#"></a></td>
<td><pre>            loadFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3687" href="#"></a></td>
<td><pre>            TreeMap fontMapNames = new TreeMap();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3688" href="#"></a></td>
<td><pre>            /* warning: the number of composite fonts could change dynamically</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3689" href="#"></a></td>
<td><pre>             * if applications are allowed to create them. &quot;allfonts&quot; could</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3690" href="#"></a></td>
<td><pre>             * then be stale.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3691" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3692" href="#"></a></td>
<td><pre>            Font2D[] allfonts = getRegisteredFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3693" href="#"></a></td>
<td><pre>            for (int i=0; i &lt; allfonts.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3694" href="#"></a></td>
<td><pre>                if (!(allfonts[i] instanceof NativeFont)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3695" href="#"></a></td>
<td><pre>                    fontMapNames.put(allfonts[i].getFontName(null),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3696" href="#"></a></td>
<td><pre>                                     allfonts[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3697" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3698" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3699" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3700" href="#"></a></td>
<td><pre>            String[] platformNames = getFontNamesFromPlatform();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3701" href="#"></a></td>
<td><pre>            if (platformNames != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3702" href="#"></a></td>
<td><pre>                for (int i=0; i&lt;platformNames.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3703" href="#"></a></td>
<td><pre>                    if (!isNameForRegisteredFile(platformNames[i])) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3704" href="#"></a></td>
<td><pre>                        fontMapNames.put(platformNames[i], null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3705" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3706" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3707" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3708" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3709" href="#"></a></td>
<td><pre>            String[] fontNames = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3710" href="#"></a></td>
<td><pre>            if (fontMapNames.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3711" href="#"></a></td>
<td><pre>                fontNames = new String[fontMapNames.size()];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3712" href="#"></a></td>
<td><pre>                Object [] keyNames = fontMapNames.keySet().toArray();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3713" href="#"></a></td>
<td><pre>                for (int i=0; i &lt; keyNames.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3714" href="#"></a></td>
<td><pre>                    fontNames[i] = (String)keyNames[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3715" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3716" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3717" href="#"></a></td>
<td><pre>            Font[] fonts = new Font[fontNames.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3718" href="#"></a></td>
<td><pre>            for (int i=0; i &lt; fontNames.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3719" href="#"></a></td>
<td><pre>                fonts[i] = new Font(fontNames[i], Font.PLAIN, 1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3720" href="#"></a></td>
<td><pre>                Font2D f2d = (Font2D)fontMapNames.get(fontNames[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3721" href="#"></a></td>
<td><pre>                if (f2d  != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3722" href="#"></a></td>
<td><pre>                    FontAccess.getFontAccess().setFont2D(fonts[i], f2d.handle);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3723" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3724" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3725" href="#"></a></td>
<td><pre>            allFonts = fonts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3726" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3727" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3728" href="#"></a></td>
<td><pre>        Font []copyFonts = new Font[allFonts.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3729" href="#"></a></td>
<td><pre>        System.arraycopy(allFonts, 0, copyFonts, 0, allFonts.length);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3730" href="#"></a></td>
<td><pre>        return copyFonts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3731" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3732" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3733" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3734" href="#"></a></td>
<td><pre>     * Get a list of installed fonts in the requested {@link Locale}.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3735" href="#"></a></td>
<td><pre>     * The list contains the fonts Family Names.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3736" href="#"></a></td>
<td><pre>     * If Locale is null, the default locale is used.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3737" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3738" href="#"></a></td>
<td><pre>     * @param requestedLocale, if null the default locale is used.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3739" href="#"></a></td>
<td><pre>     * @return list of installed fonts in the system.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3740" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3741" href="#"></a></td>
<td><pre>    public String[] getInstalledFontFamilyNames(Locale requestedLocale) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3742" href="#"></a></td>
<td><pre>        if (requestedLocale == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3743" href="#"></a></td>
<td><pre>            requestedLocale = Locale.getDefault();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3744" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3745" href="#"></a></td>
<td><pre>        if (allFamilies != null &amp;&amp; lastDefaultLocale != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3746" href="#"></a></td>
<td><pre>            requestedLocale.equals(lastDefaultLocale)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3747" href="#"></a></td>
<td><pre>                String[] copyFamilies = new String[allFamilies.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3748" href="#"></a></td>
<td><pre>                System.arraycopy(allFamilies, 0, copyFamilies,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3749" href="#"></a></td>
<td><pre>                                 0, allFamilies.length);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3750" href="#"></a></td>
<td><pre>                return copyFamilies;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3751" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3752" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3753" href="#"></a></td>
<td><pre>        TreeMap&lt;String,String&gt; familyNames = new TreeMap&lt;String,String&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3754" href="#"></a></td>
<td><pre>        //  these names are always there and aren't localised</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3755" href="#"></a></td>
<td><pre>        String str;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3756" href="#"></a></td>
<td><pre>        str = Font.SERIF;         familyNames.put(str.toLowerCase(), str);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3757" href="#"></a></td>
<td><pre>        str = Font.SANS_SERIF;    familyNames.put(str.toLowerCase(), str);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3758" href="#"></a></td>
<td><pre>        str = Font.MONOSPACED;    familyNames.put(str.toLowerCase(), str);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3759" href="#"></a></td>
<td><pre>        str = Font.DIALOG;        familyNames.put(str.toLowerCase(), str);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3760" href="#"></a></td>
<td><pre>        str = Font.DIALOG_INPUT;  familyNames.put(str.toLowerCase(), str);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3761" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3762" href="#"></a></td>
<td><pre>        /* Platform APIs may be used to get the set of available family</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3763" href="#"></a></td>
<td><pre>         * names for the current default locale so long as it is the same</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3764" href="#"></a></td>
<td><pre>         * as the start-up system locale, rather than loading all fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3765" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3766" href="#"></a></td>
<td><pre>        if (requestedLocale.equals(getSystemStartupLocale()) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3767" href="#"></a></td>
<td><pre>            getFamilyNamesFromPlatform(familyNames, requestedLocale)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3768" href="#"></a></td>
<td><pre>            /* Augment platform names with JRE font family names */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3769" href="#"></a></td>
<td><pre>            getJREFontFamilyNames(familyNames, requestedLocale);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3770" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3771" href="#"></a></td>
<td><pre>            loadFontFiles();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3772" href="#"></a></td>
<td><pre>            Font2D[] physicalfonts = getPhysicalFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3773" href="#"></a></td>
<td><pre>            for (int i=0; i &lt; physicalfonts.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3774" href="#"></a></td>
<td><pre>                if (!(physicalfonts[i] instanceof NativeFont)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3775" href="#"></a></td>
<td><pre>                    String name =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3776" href="#"></a></td>
<td><pre>                        physicalfonts[i].getFamilyName(requestedLocale);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3777" href="#"></a></td>
<td><pre>                    familyNames.put(name.toLowerCase(requestedLocale), name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3778" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3779" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3780" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3781" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3782" href="#"></a></td>
<td><pre>        // Add any native font family names here</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3783" href="#"></a></td>
<td><pre>        addNativeFontFamilyNames(familyNames, requestedLocale);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3784" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3785" href="#"></a></td>
<td><pre>        String[] retval =  new String[familyNames.size()];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3786" href="#"></a></td>
<td><pre>        Object [] keyNames = familyNames.keySet().toArray();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3787" href="#"></a></td>
<td><pre>        for (int i=0; i &lt; keyNames.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3788" href="#"></a></td>
<td><pre>            retval[i] = (String)familyNames.get(keyNames[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3789" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3790" href="#"></a></td>
<td><pre>        if (requestedLocale.equals(Locale.getDefault())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3791" href="#"></a></td>
<td><pre>            lastDefaultLocale = requestedLocale;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3792" href="#"></a></td>
<td><pre>            allFamilies = new String[retval.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3793" href="#"></a></td>
<td><pre>            System.arraycopy(retval, 0, allFamilies, 0, allFamilies.length);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3794" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3795" href="#"></a></td>
<td><pre>        return retval;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3796" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3797" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3798" href="#"></a></td>
<td><pre>    // Provides an aperture to add native font family names to the map</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3799" href="#"></a></td>
<td><pre>    protected void addNativeFontFamilyNames(TreeMap&lt;String, String&gt; familyNames, Locale requestedLocale) { }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3800" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3801" href="#"></a></td>
<td><pre>    public void register1dot0Fonts() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3802" href="#"></a></td>
<td><pre>        java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3803" href="#"></a></td>
<td><pre>                            new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3804" href="#"></a></td>
<td><pre>            public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3805" href="#"></a></td>
<td><pre>                String type1Dir = &quot;/usr/openwin/lib/X11/fonts/Type1&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3806" href="#"></a></td>
<td><pre>                registerFontsInDir(type1Dir, true, Font2D.TYPE1_RANK,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3807" href="#"></a></td>
<td><pre>                                   false, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3808" href="#"></a></td>
<td><pre>                return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3809" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3810" href="#"></a></td>
<td><pre>        });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3811" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3812" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3813" href="#"></a></td>
<td><pre>    /* Really we need only the JRE fonts family names, but there's little</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3814" href="#"></a></td>
<td><pre>     * overhead in doing this the easy way by adding all the currently</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3815" href="#"></a></td>
<td><pre>     * known fonts.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3816" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3817" href="#"></a></td>
<td><pre>    protected void getJREFontFamilyNames(TreeMap&lt;String,String&gt; familyNames,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3818" href="#"></a></td>
<td><pre>                                         Locale requestedLocale) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3819" href="#"></a></td>
<td><pre>        registerDeferredJREFonts(jreFontDirName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3820" href="#"></a></td>
<td><pre>        Font2D[] physicalfonts = getPhysicalFonts();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3821" href="#"></a></td>
<td><pre>        for (int i=0; i &lt; physicalfonts.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3822" href="#"></a></td>
<td><pre>            if (!(physicalfonts[i] instanceof NativeFont)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3823" href="#"></a></td>
<td><pre>                String name =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3824" href="#"></a></td>
<td><pre>                    physicalfonts[i].getFamilyName(requestedLocale);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3825" href="#"></a></td>
<td><pre>                familyNames.put(name.toLowerCase(requestedLocale), name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3826" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3827" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3828" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3829" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3830" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3831" href="#"></a></td>
<td><pre>     * Default locale can be changed but we need to know the initial locale</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3832" href="#"></a></td>
<td><pre>     * as that is what is used by native code. Changing Java default locale</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3833" href="#"></a></td>
<td><pre>     * doesn't affect that.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3834" href="#"></a></td>
<td><pre>     * Returns the locale in use when using native code to communicate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3835" href="#"></a></td>
<td><pre>     * with platform APIs. On windows this is known as the &quot;system&quot; locale,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3836" href="#"></a></td>
<td><pre>     * and it is usually the same as the platform locale, but not always,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3837" href="#"></a></td>
<td><pre>     * so this method also checks an implementation property used only</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3838" href="#"></a></td>
<td><pre>     * on windows and uses that if set.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3839" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3840" href="#"></a></td>
<td><pre>    private static Locale systemLocale = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3841" href="#"></a></td>
<td><pre>    private static Locale getSystemStartupLocale() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3842" href="#"></a></td>
<td><pre>        if (systemLocale == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3843" href="#"></a></td>
<td><pre>            systemLocale = (Locale)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3844" href="#"></a></td>
<td><pre>                java.security.AccessController.doPrivileged(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3845" href="#"></a></td>
<td><pre>                                    new java.security.PrivilegedAction() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3846" href="#"></a></td>
<td><pre>            public Object run() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3847" href="#"></a></td>
<td><pre>                /* On windows the system locale may be different than the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3848" href="#"></a></td>
<td><pre>                 * user locale. This is an unsupported configuration, but</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3849" href="#"></a></td>
<td><pre>                 * in that case we want to return a dummy locale that will</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3850" href="#"></a></td>
<td><pre>                 * never cause a match in the usage of this API. This is</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3851" href="#"></a></td>
<td><pre>                 * important because Windows documents that the family</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3852" href="#"></a></td>
<td><pre>                 * names of fonts are enumerated using the language of</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3853" href="#"></a></td>
<td><pre>                 * the system locale. BY returning a dummy locale in that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3854" href="#"></a></td>
<td><pre>                 * case we do not use the platform API which would not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3855" href="#"></a></td>
<td><pre>                 * return us the names we want.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3856" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3857" href="#"></a></td>
<td><pre>                String fileEncoding = System.getProperty(&quot;file.encoding&quot;, &quot;&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3858" href="#"></a></td>
<td><pre>                String sysEncoding = System.getProperty(&quot;sun.jnu.encoding&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3859" href="#"></a></td>
<td><pre>                if (sysEncoding != null &amp;&amp; !sysEncoding.equals(fileEncoding)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3860" href="#"></a></td>
<td><pre>                    return Locale.ROOT;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3861" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3862" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3863" href="#"></a></td>
<td><pre>                String language = System.getProperty(&quot;user.language&quot;, &quot;en&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3864" href="#"></a></td>
<td><pre>                String country  = System.getProperty(&quot;user.country&quot;,&quot;&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3865" href="#"></a></td>
<td><pre>                String variant  = System.getProperty(&quot;user.variant&quot;,&quot;&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3866" href="#"></a></td>
<td><pre>                return new Locale(language, country, variant);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3867" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3868" href="#"></a></td>
<td><pre>        });</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3869" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3870" href="#"></a></td>
<td><pre>        return systemLocale;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3871" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3872" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3873" href="#"></a></td>
<td><pre>    void addToPool(FileFont font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3874" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3875" href="#"></a></td>
<td><pre>        FileFont fontFileToClose = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3876" href="#"></a></td>
<td><pre>        int freeSlot = -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3877" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3878" href="#"></a></td>
<td><pre>        synchronized (fontFileCache) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3879" href="#"></a></td>
<td><pre>            /* Avoid duplicate entries in the pool, and don't close() it,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3880" href="#"></a></td>
<td><pre>             * since this method is called only from within open().</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3881" href="#"></a></td>
<td><pre>             * Seeing a duplicate is most likely to happen if the thread</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3882" href="#"></a></td>
<td><pre>             * was interrupted during a read, forcing perhaps repeated</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3883" href="#"></a></td>
<td><pre>             * close and open calls and it eventually it ends up pointing</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3884" href="#"></a></td>
<td><pre>             * at the same slot.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3885" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3886" href="#"></a></td>
<td><pre>            for (int i=0;i&lt;CHANNELPOOLSIZE;i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3887" href="#"></a></td>
<td><pre>                if (fontFileCache[i] == font) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3888" href="#"></a></td>
<td><pre>                    return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3889" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3890" href="#"></a></td>
<td><pre>                if (fontFileCache[i] == null &amp;&amp; freeSlot &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3891" href="#"></a></td>
<td><pre>                    freeSlot = i;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3892" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3893" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3894" href="#"></a></td>
<td><pre>            if (freeSlot &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3895" href="#"></a></td>
<td><pre>                fontFileCache[freeSlot] = font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3896" href="#"></a></td>
<td><pre>                return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3897" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3898" href="#"></a></td>
<td><pre>                /* replace with new font. */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3899" href="#"></a></td>
<td><pre>                fontFileToClose = fontFileCache[lastPoolIndex];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3900" href="#"></a></td>
<td><pre>                fontFileCache[lastPoolIndex] = font;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3901" href="#"></a></td>
<td><pre>                /* lastPoolIndex is updated so that the least recently opened</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3902" href="#"></a></td>
<td><pre>                 * file will be closed next.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3903" href="#"></a></td>
<td><pre>                 */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3904" href="#"></a></td>
<td><pre>                lastPoolIndex = (lastPoolIndex+1) % CHANNELPOOLSIZE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3905" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3906" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3907" href="#"></a></td>
<td><pre>        /* Need to close the font file outside of the synchronized block,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3908" href="#"></a></td>
<td><pre>         * since its possible some other thread is in an open() call on</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3909" href="#"></a></td>
<td><pre>         * this font file, and could be holding its lock and the pool lock.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3910" href="#"></a></td>
<td><pre>         * Releasing the pool lock allows that thread to continue, so it can</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3911" href="#"></a></td>
<td><pre>         * then release the lock on this font, allowing the close() call</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3912" href="#"></a></td>
<td><pre>         * below to proceed.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3913" href="#"></a></td>
<td><pre>         * Also, calling close() is safe because any other thread using</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3914" href="#"></a></td>
<td><pre>         * the font we are closing() synchronizes all reading, so we</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3915" href="#"></a></td>
<td><pre>         * will not close the file while its in use.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3916" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3917" href="#"></a></td>
<td><pre>        if (fontFileToClose != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3918" href="#"></a></td>
<td><pre>            fontFileToClose.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3919" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3920" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3921" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3922" href="#"></a></td>
<td><pre>    protected FontUIResource getFontConfigFUIR(String family, int style,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3923" href="#"></a></td>
<td><pre>                                               int size)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3924" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3925" href="#"></a></td>
<td><pre>        return new FontUIResource(family, style, size);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3926" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3927" href="#"></a></td>
<td><pre>}</pre></td>
</tr>
</table>
</body>
</html>
