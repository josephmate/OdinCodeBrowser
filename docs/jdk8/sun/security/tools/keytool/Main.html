<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/OdinCodeBrowser/css/styles.css"/>
    </head>
<body>
<table>
<tr>
<td><a class="linenum-cell" data-linenum="1" href="#"></a></td>
<td><pre>/*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2" href="#"></a></td>
<td><pre> * Copyright (c) 1997, 2013, Oracle and/or its affiliates. All rights reserved.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3" href="#"></a></td>
<td><pre> * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="5" href="#"></a></td>
<td><pre> * This code is free software; you can redistribute it and/or modify it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="6" href="#"></a></td>
<td><pre> * under the terms of the GNU General Public License version 2 only, as</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="7" href="#"></a></td>
<td><pre> * published by the Free Software Foundation.  Oracle designates this</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="8" href="#"></a></td>
<td><pre> * particular file as subject to the &quot;Classpath&quot; exception as provided</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="9" href="#"></a></td>
<td><pre> * by Oracle in the LICENSE file that accompanied this code.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="10" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="11" href="#"></a></td>
<td><pre> * This code is distributed in the hope that it will be useful, but WITHOUT</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="12" href="#"></a></td>
<td><pre> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="13" href="#"></a></td>
<td><pre> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="14" href="#"></a></td>
<td><pre> * version 2 for more details (a copy is included in the LICENSE file that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="15" href="#"></a></td>
<td><pre> * accompanied this code).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="16" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="17" href="#"></a></td>
<td><pre> * You should have received a copy of the GNU General Public License version</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="18" href="#"></a></td>
<td><pre> * 2 along with this work; if not, write to the Free Software Foundation,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="19" href="#"></a></td>
<td><pre> * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="20" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="21" href="#"></a></td>
<td><pre> * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="22" href="#"></a></td>
<td><pre> * or visit www.oracle.com if you need additional information or have any</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="23" href="#"></a></td>
<td><pre> * questions.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="24" href="#"></a></td>
<td><pre> */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="25" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="26" href="#"></a></td>
<td><pre>package sun.security.tools.keytool;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="27" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="28" href="#"></a></td>
<td><pre>import java.io.*;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="29" href="#"></a></td>
<td><pre>import java.security.CodeSigner;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="30" href="#"></a></td>
<td><pre>import java.security.KeyStore;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="31" href="#"></a></td>
<td><pre>import java.security.KeyStoreException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="32" href="#"></a></td>
<td><pre>import java.security.MessageDigest;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="33" href="#"></a></td>
<td><pre>import java.security.Key;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="34" href="#"></a></td>
<td><pre>import java.security.PublicKey;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="35" href="#"></a></td>
<td><pre>import java.security.PrivateKey;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="36" href="#"></a></td>
<td><pre>import java.security.Security;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="37" href="#"></a></td>
<td><pre>import java.security.Signature;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="38" href="#"></a></td>
<td><pre>import java.security.Timestamp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="39" href="#"></a></td>
<td><pre>import java.security.UnrecoverableEntryException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="40" href="#"></a></td>
<td><pre>import java.security.UnrecoverableKeyException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="41" href="#"></a></td>
<td><pre>import java.security.NoSuchAlgorithmException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="42" href="#"></a></td>
<td><pre>import java.security.Principal;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="43" href="#"></a></td>
<td><pre>import java.security.Provider;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="44" href="#"></a></td>
<td><pre>import java.security.cert.Certificate;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="45" href="#"></a></td>
<td><pre>import java.security.cert.CertificateFactory;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="46" href="#"></a></td>
<td><pre>import java.security.cert.CertStoreException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="47" href="#"></a></td>
<td><pre>import java.security.cert.CRL;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="48" href="#"></a></td>
<td><pre>import java.security.cert.X509Certificate;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="49" href="#"></a></td>
<td><pre>import java.security.cert.CertificateException;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="50" href="#"></a></td>
<td><pre>import java.text.Collator;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="51" href="#"></a></td>
<td><pre>import java.text.MessageFormat;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="52" href="#"></a></td>
<td><pre>import java.util.*;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="53" href="#"></a></td>
<td><pre>import java.util.jar.JarEntry;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="54" href="#"></a></td>
<td><pre>import java.util.jar.JarFile;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="55" href="#"></a></td>
<td><pre>import java.lang.reflect.Constructor;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="56" href="#"></a></td>
<td><pre>import java.math.BigInteger;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="57" href="#"></a></td>
<td><pre>import java.net.URI;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="58" href="#"></a></td>
<td><pre>import java.net.URL;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="59" href="#"></a></td>
<td><pre>import java.net.URLClassLoader;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="60" href="#"></a></td>
<td><pre>import java.security.cert.CertStore;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="61" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="62" href="#"></a></td>
<td><pre>import java.security.cert.X509CRL;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="63" href="#"></a></td>
<td><pre>import java.security.cert.X509CRLEntry;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="64" href="#"></a></td>
<td><pre>import java.security.cert.X509CRLSelector;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="65" href="#"></a></td>
<td><pre>import javax.security.auth.x500.X500Principal;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="66" href="#"></a></td>
<td><pre>import java.util.Base64;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="67" href="#"></a></td>
<td><pre>import sun.security.util.ObjectIdentifier;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="68" href="#"></a></td>
<td><pre>import sun.security.pkcs10.PKCS10;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="69" href="#"></a></td>
<td><pre>import sun.security.pkcs10.PKCS10Attribute;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="70" href="#"></a></td>
<td><pre>import sun.security.provider.X509Factory;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="71" href="#"></a></td>
<td><pre>import sun.security.provider.certpath.CertStoreHelper;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="72" href="#"></a></td>
<td><pre>import sun.security.util.Password;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="73" href="#"></a></td>
<td><pre>import javax.crypto.KeyGenerator;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="74" href="#"></a></td>
<td><pre>import javax.crypto.SecretKey;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="75" href="#"></a></td>
<td><pre>import javax.crypto.SecretKeyFactory;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="76" href="#"></a></td>
<td><pre>import javax.crypto.spec.PBEKeySpec;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="77" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="78" href="#"></a></td>
<td><pre>import sun.security.pkcs.PKCS9Attribute;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="79" href="#"></a></td>
<td><pre>import sun.security.tools.KeyStoreUtil;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="80" href="#"></a></td>
<td><pre>import sun.security.tools.PathList;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="81" href="#"></a></td>
<td><pre>import sun.security.util.DerValue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="82" href="#"></a></td>
<td><pre>import sun.security.x509.*;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="83" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="84" href="#"></a></td>
<td><pre>import static java.security.KeyStore.*;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="85" href="#"></a></td>
<td><pre>import static sun.security.tools.keytool.Main.Command.*;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="86" href="#"></a></td>
<td><pre>import static sun.security.tools.keytool.Main.Option.*;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="87" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="88" href="#"></a></td>
<td><pre>/**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="89" href="#"></a></td>
<td><pre> * This tool manages keystores.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="90" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="91" href="#"></a></td>
<td><pre> * @author Jan Luehe</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="92" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="93" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="94" href="#"></a></td>
<td><pre> * @see java.security.KeyStore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="95" href="#"></a></td>
<td><pre> * @see sun.security.provider.KeyProtector</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="96" href="#"></a></td>
<td><pre> * @see sun.security.provider.JavaKeyStore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="97" href="#"></a></td>
<td><pre> *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="98" href="#"></a></td>
<td><pre> * @since 1.2</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="99" href="#"></a></td>
<td><pre> */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="100" href="#"></a></td>
<td><pre>public final class Main {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="101" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="102" href="#"></a></td>
<td><pre>    private boolean debug = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="103" href="#"></a></td>
<td><pre>    private Command command = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="104" href="#"></a></td>
<td><pre>    private String sigAlgName = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="105" href="#"></a></td>
<td><pre>    private String keyAlgName = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="106" href="#"></a></td>
<td><pre>    private boolean verbose = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="107" href="#"></a></td>
<td><pre>    private int keysize = -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="108" href="#"></a></td>
<td><pre>    private boolean rfc = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="109" href="#"></a></td>
<td><pre>    private long validity = (long)90;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="110" href="#"></a></td>
<td><pre>    private String alias = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="111" href="#"></a></td>
<td><pre>    private String dname = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="112" href="#"></a></td>
<td><pre>    private String dest = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="113" href="#"></a></td>
<td><pre>    private String filename = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="114" href="#"></a></td>
<td><pre>    private String infilename = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="115" href="#"></a></td>
<td><pre>    private String outfilename = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="116" href="#"></a></td>
<td><pre>    private String srcksfname = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="117" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="118" href="#"></a></td>
<td><pre>    // User-specified providers are added before any command is called.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="119" href="#"></a></td>
<td><pre>    // However, they are not removed before the end of the main() method.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="120" href="#"></a></td>
<td><pre>    // If you're calling KeyTool.main() directly in your own Java program,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="121" href="#"></a></td>
<td><pre>    // please programtically add any providers you need and do not specify</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="122" href="#"></a></td>
<td><pre>    // them through the command line.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="123" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="124" href="#"></a></td>
<td><pre>    private Set&lt;Pair &lt;String, String&gt;&gt; providers = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="125" href="#"></a></td>
<td><pre>    private String storetype = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="126" href="#"></a></td>
<td><pre>    private String srcProviderName = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="127" href="#"></a></td>
<td><pre>    private String providerName = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="128" href="#"></a></td>
<td><pre>    private String pathlist = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="129" href="#"></a></td>
<td><pre>    private char[] storePass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="130" href="#"></a></td>
<td><pre>    private char[] storePassNew = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="131" href="#"></a></td>
<td><pre>    private char[] keyPass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="132" href="#"></a></td>
<td><pre>    private char[] keyPassNew = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="133" href="#"></a></td>
<td><pre>    private char[] newPass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="134" href="#"></a></td>
<td><pre>    private char[] destKeyPass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="135" href="#"></a></td>
<td><pre>    private char[] srckeyPass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="136" href="#"></a></td>
<td><pre>    private String ksfname = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="137" href="#"></a></td>
<td><pre>    private File ksfile = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="138" href="#"></a></td>
<td><pre>    private InputStream ksStream = null; // keystore stream</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="139" href="#"></a></td>
<td><pre>    private String sslserver = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="140" href="#"></a></td>
<td><pre>    private String jarfile = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="141" href="#"></a></td>
<td><pre>    private KeyStore keyStore = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="142" href="#"></a></td>
<td><pre>    private boolean token = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="143" href="#"></a></td>
<td><pre>    private boolean nullStream = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="144" href="#"></a></td>
<td><pre>    private boolean kssave = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="145" href="#"></a></td>
<td><pre>    private boolean noprompt = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="146" href="#"></a></td>
<td><pre>    private boolean trustcacerts = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="147" href="#"></a></td>
<td><pre>    private boolean protectedPath = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="148" href="#"></a></td>
<td><pre>    private boolean srcprotectedPath = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="149" href="#"></a></td>
<td><pre>    private CertificateFactory cf = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="150" href="#"></a></td>
<td><pre>    private KeyStore caks = null; // &quot;cacerts&quot; keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="151" href="#"></a></td>
<td><pre>    private char[] srcstorePass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="152" href="#"></a></td>
<td><pre>    private String srcstoretype = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="153" href="#"></a></td>
<td><pre>    private Set&lt;char[]&gt; passwords = new HashSet&lt;&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="154" href="#"></a></td>
<td><pre>    private String startDate = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="155" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="156" href="#"></a></td>
<td><pre>    private List&lt;String&gt; ids = new ArrayList&lt;&gt;();   // used in GENCRL</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="157" href="#"></a></td>
<td><pre>    private List&lt;String&gt; v3ext = new ArrayList&lt;&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="158" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="159" href="#"></a></td>
<td><pre>    enum Command {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="160" href="#"></a></td>
<td><pre>        CERTREQ(&quot;Generates.a.certificate.request&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="161" href="#"></a></td>
<td><pre>            ALIAS, SIGALG, FILEOUT, KEYPASS, KEYSTORE, DNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="162" href="#"></a></td>
<td><pre>            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="163" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="164" href="#"></a></td>
<td><pre>        CHANGEALIAS(&quot;Changes.an.entry.s.alias&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="165" href="#"></a></td>
<td><pre>            ALIAS, DESTALIAS, KEYPASS, KEYSTORE, STOREPASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="166" href="#"></a></td>
<td><pre>            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="167" href="#"></a></td>
<td><pre>            PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="168" href="#"></a></td>
<td><pre>        DELETE(&quot;Deletes.an.entry&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="169" href="#"></a></td>
<td><pre>            ALIAS, KEYSTORE, STOREPASS, STORETYPE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="170" href="#"></a></td>
<td><pre>            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="171" href="#"></a></td>
<td><pre>            PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="172" href="#"></a></td>
<td><pre>        EXPORTCERT(&quot;Exports.certificate&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="173" href="#"></a></td>
<td><pre>            RFC, ALIAS, FILEOUT, KEYSTORE, STOREPASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="174" href="#"></a></td>
<td><pre>            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="175" href="#"></a></td>
<td><pre>            PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="176" href="#"></a></td>
<td><pre>        GENKEYPAIR(&quot;Generates.a.key.pair&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="177" href="#"></a></td>
<td><pre>            ALIAS, KEYALG, KEYSIZE, SIGALG, DESTALIAS, DNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="178" href="#"></a></td>
<td><pre>            STARTDATE, EXT, VALIDITY, KEYPASS, KEYSTORE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="179" href="#"></a></td>
<td><pre>            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="180" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="181" href="#"></a></td>
<td><pre>        GENSECKEY(&quot;Generates.a.secret.key&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="182" href="#"></a></td>
<td><pre>            ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="183" href="#"></a></td>
<td><pre>            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="184" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="185" href="#"></a></td>
<td><pre>        GENCERT(&quot;Generates.certificate.from.a.certificate.request&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="186" href="#"></a></td>
<td><pre>            RFC, INFILE, OUTFILE, ALIAS, SIGALG, DNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="187" href="#"></a></td>
<td><pre>            STARTDATE, EXT, VALIDITY, KEYPASS, KEYSTORE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="188" href="#"></a></td>
<td><pre>            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="189" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="190" href="#"></a></td>
<td><pre>        IMPORTCERT(&quot;Imports.a.certificate.or.a.certificate.chain&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="191" href="#"></a></td>
<td><pre>            NOPROMPT, TRUSTCACERTS, PROTECTED, ALIAS, FILEIN,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="192" href="#"></a></td>
<td><pre>            KEYPASS, KEYSTORE, STOREPASS, STORETYPE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="193" href="#"></a></td>
<td><pre>            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="194" href="#"></a></td>
<td><pre>            PROVIDERPATH, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="195" href="#"></a></td>
<td><pre>        IMPORTPASS(&quot;Imports.a.password&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="196" href="#"></a></td>
<td><pre>            ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="197" href="#"></a></td>
<td><pre>            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="198" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="199" href="#"></a></td>
<td><pre>        IMPORTKEYSTORE(&quot;Imports.one.or.all.entries.from.another.keystore&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="200" href="#"></a></td>
<td><pre>            SRCKEYSTORE, DESTKEYSTORE, SRCSTORETYPE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="201" href="#"></a></td>
<td><pre>            DESTSTORETYPE, SRCSTOREPASS, DESTSTOREPASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="202" href="#"></a></td>
<td><pre>            SRCPROTECTED, SRCPROVIDERNAME, DESTPROVIDERNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="203" href="#"></a></td>
<td><pre>            SRCALIAS, DESTALIAS, SRCKEYPASS, DESTKEYPASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="204" href="#"></a></td>
<td><pre>            NOPROMPT, PROVIDERCLASS, PROVIDERARG, PROVIDERPATH,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="205" href="#"></a></td>
<td><pre>            V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="206" href="#"></a></td>
<td><pre>        KEYPASSWD(&quot;Changes.the.key.password.of.an.entry&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="207" href="#"></a></td>
<td><pre>            ALIAS, KEYPASS, NEW, KEYSTORE, STOREPASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="208" href="#"></a></td>
<td><pre>            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="209" href="#"></a></td>
<td><pre>            PROVIDERPATH, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="210" href="#"></a></td>
<td><pre>        LIST(&quot;Lists.entries.in.a.keystore&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="211" href="#"></a></td>
<td><pre>            RFC, ALIAS, KEYSTORE, STOREPASS, STORETYPE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="212" href="#"></a></td>
<td><pre>            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="213" href="#"></a></td>
<td><pre>            PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="214" href="#"></a></td>
<td><pre>        PRINTCERT(&quot;Prints.the.content.of.a.certificate&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="215" href="#"></a></td>
<td><pre>            RFC, FILEIN, SSLSERVER, JARFILE, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="216" href="#"></a></td>
<td><pre>        PRINTCERTREQ(&quot;Prints.the.content.of.a.certificate.request&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="217" href="#"></a></td>
<td><pre>            FILEIN, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="218" href="#"></a></td>
<td><pre>        PRINTCRL(&quot;Prints.the.content.of.a.CRL.file&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="219" href="#"></a></td>
<td><pre>            FILEIN, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="220" href="#"></a></td>
<td><pre>        STOREPASSWD(&quot;Changes.the.store.password.of.a.keystore&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="221" href="#"></a></td>
<td><pre>            NEW, KEYSTORE, STOREPASS, STORETYPE, PROVIDERNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="222" href="#"></a></td>
<td><pre>            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="223" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="224" href="#"></a></td>
<td><pre>        // Undocumented start here, KEYCLONE is used a marker in -help;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="225" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="226" href="#"></a></td>
<td><pre>        KEYCLONE(&quot;Clones.a.key.entry&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="227" href="#"></a></td>
<td><pre>            ALIAS, DESTALIAS, KEYPASS, NEW, STORETYPE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="228" href="#"></a></td>
<td><pre>            KEYSTORE, STOREPASS, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="229" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="230" href="#"></a></td>
<td><pre>        SELFCERT(&quot;Generates.a.self.signed.certificate&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="231" href="#"></a></td>
<td><pre>            ALIAS, SIGALG, DNAME, STARTDATE, VALIDITY, KEYPASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="232" href="#"></a></td>
<td><pre>            STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="233" href="#"></a></td>
<td><pre>            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="234" href="#"></a></td>
<td><pre>        GENCRL(&quot;Generates.CRL&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="235" href="#"></a></td>
<td><pre>            RFC, FILEOUT, ID,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="236" href="#"></a></td>
<td><pre>            ALIAS, SIGALG, EXT, KEYPASS, KEYSTORE,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="237" href="#"></a></td>
<td><pre>            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="238" href="#"></a></td>
<td><pre>            PROVIDERARG, PROVIDERPATH, V, PROTECTED),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="239" href="#"></a></td>
<td><pre>        IDENTITYDB(&quot;Imports.entries.from.a.JDK.1.1.x.style.identity.database&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="240" href="#"></a></td>
<td><pre>            FILEIN, STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="241" href="#"></a></td>
<td><pre>            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="242" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="243" href="#"></a></td>
<td><pre>        final String description;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="244" href="#"></a></td>
<td><pre>        final Option[] options;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="245" href="#"></a></td>
<td><pre>        Command(String d, Option... o) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="246" href="#"></a></td>
<td><pre>            description = d;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="247" href="#"></a></td>
<td><pre>            options = o;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="248" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="249" href="#"></a></td>
<td><pre>        @Override</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="250" href="#"></a></td>
<td><pre>        public String toString() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="251" href="#"></a></td>
<td><pre>            return &quot;-&quot; + name().toLowerCase(Locale.ENGLISH);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="252" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="253" href="#"></a></td>
<td><pre>    };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="254" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="255" href="#"></a></td>
<td><pre>    enum Option {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="256" href="#"></a></td>
<td><pre>        ALIAS(&quot;alias&quot;, &quot;&lt;alias&gt;&quot;, &quot;alias.name.of.the.entry.to.process&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="257" href="#"></a></td>
<td><pre>        DESTALIAS(&quot;destalias&quot;, &quot;&lt;destalias&gt;&quot;, &quot;destination.alias&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="258" href="#"></a></td>
<td><pre>        DESTKEYPASS(&quot;destkeypass&quot;, &quot;&lt;arg&gt;&quot;, &quot;destination.key.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="259" href="#"></a></td>
<td><pre>        DESTKEYSTORE(&quot;destkeystore&quot;, &quot;&lt;destkeystore&gt;&quot;, &quot;destination.keystore.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="260" href="#"></a></td>
<td><pre>        DESTPROTECTED(&quot;destprotected&quot;, null, &quot;destination.keystore.password.protected&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="261" href="#"></a></td>
<td><pre>        DESTPROVIDERNAME(&quot;destprovidername&quot;, &quot;&lt;destprovidername&gt;&quot;, &quot;destination.keystore.provider.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="262" href="#"></a></td>
<td><pre>        DESTSTOREPASS(&quot;deststorepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;destination.keystore.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="263" href="#"></a></td>
<td><pre>        DESTSTORETYPE(&quot;deststoretype&quot;, &quot;&lt;deststoretype&gt;&quot;, &quot;destination.keystore.type&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="264" href="#"></a></td>
<td><pre>        DNAME(&quot;dname&quot;, &quot;&lt;dname&gt;&quot;, &quot;distinguished.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="265" href="#"></a></td>
<td><pre>        EXT(&quot;ext&quot;, &quot;&lt;value&gt;&quot;, &quot;X.509.extension&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="266" href="#"></a></td>
<td><pre>        FILEOUT(&quot;file&quot;, &quot;&lt;filename&gt;&quot;, &quot;output.file.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="267" href="#"></a></td>
<td><pre>        FILEIN(&quot;file&quot;, &quot;&lt;filename&gt;&quot;, &quot;input.file.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="268" href="#"></a></td>
<td><pre>        ID(&quot;id&quot;, &quot;&lt;id:reason&gt;&quot;, &quot;Serial.ID.of.cert.to.revoke&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="269" href="#"></a></td>
<td><pre>        INFILE(&quot;infile&quot;, &quot;&lt;filename&gt;&quot;, &quot;input.file.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="270" href="#"></a></td>
<td><pre>        KEYALG(&quot;keyalg&quot;, &quot;&lt;keyalg&gt;&quot;, &quot;key.algorithm.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="271" href="#"></a></td>
<td><pre>        KEYPASS(&quot;keypass&quot;, &quot;&lt;arg&gt;&quot;, &quot;key.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="272" href="#"></a></td>
<td><pre>        KEYSIZE(&quot;keysize&quot;, &quot;&lt;keysize&gt;&quot;, &quot;key.bit.size&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="273" href="#"></a></td>
<td><pre>        KEYSTORE(&quot;keystore&quot;, &quot;&lt;keystore&gt;&quot;, &quot;keystore.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="274" href="#"></a></td>
<td><pre>        NEW(&quot;new&quot;, &quot;&lt;arg&gt;&quot;, &quot;new.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="275" href="#"></a></td>
<td><pre>        NOPROMPT(&quot;noprompt&quot;, null, &quot;do.not.prompt&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="276" href="#"></a></td>
<td><pre>        OUTFILE(&quot;outfile&quot;, &quot;&lt;filename&gt;&quot;, &quot;output.file.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="277" href="#"></a></td>
<td><pre>        PROTECTED(&quot;protected&quot;, null, &quot;password.through.protected.mechanism&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="278" href="#"></a></td>
<td><pre>        PROVIDERARG(&quot;providerarg&quot;, &quot;&lt;arg&gt;&quot;, &quot;provider.argument&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="279" href="#"></a></td>
<td><pre>        PROVIDERCLASS(&quot;providerclass&quot;, &quot;&lt;providerclass&gt;&quot;, &quot;provider.class.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="280" href="#"></a></td>
<td><pre>        PROVIDERNAME(&quot;providername&quot;, &quot;&lt;providername&gt;&quot;, &quot;provider.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="281" href="#"></a></td>
<td><pre>        PROVIDERPATH(&quot;providerpath&quot;, &quot;&lt;pathlist&gt;&quot;, &quot;provider.classpath&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="282" href="#"></a></td>
<td><pre>        RFC(&quot;rfc&quot;, null, &quot;output.in.RFC.style&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="283" href="#"></a></td>
<td><pre>        SIGALG(&quot;sigalg&quot;, &quot;&lt;sigalg&gt;&quot;, &quot;signature.algorithm.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="284" href="#"></a></td>
<td><pre>        SRCALIAS(&quot;srcalias&quot;, &quot;&lt;srcalias&gt;&quot;, &quot;source.alias&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="285" href="#"></a></td>
<td><pre>        SRCKEYPASS(&quot;srckeypass&quot;, &quot;&lt;arg&gt;&quot;, &quot;source.key.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="286" href="#"></a></td>
<td><pre>        SRCKEYSTORE(&quot;srckeystore&quot;, &quot;&lt;srckeystore&gt;&quot;, &quot;source.keystore.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="287" href="#"></a></td>
<td><pre>        SRCPROTECTED(&quot;srcprotected&quot;, null, &quot;source.keystore.password.protected&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="288" href="#"></a></td>
<td><pre>        SRCPROVIDERNAME(&quot;srcprovidername&quot;, &quot;&lt;srcprovidername&gt;&quot;, &quot;source.keystore.provider.name&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="289" href="#"></a></td>
<td><pre>        SRCSTOREPASS(&quot;srcstorepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;source.keystore.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="290" href="#"></a></td>
<td><pre>        SRCSTORETYPE(&quot;srcstoretype&quot;, &quot;&lt;srcstoretype&gt;&quot;, &quot;source.keystore.type&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="291" href="#"></a></td>
<td><pre>        SSLSERVER(&quot;sslserver&quot;, &quot;&lt;server[:port]&gt;&quot;, &quot;SSL.server.host.and.port&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="292" href="#"></a></td>
<td><pre>        JARFILE(&quot;jarfile&quot;, &quot;&lt;filename&gt;&quot;, &quot;signed.jar.file&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="293" href="#"></a></td>
<td><pre>        STARTDATE(&quot;startdate&quot;, &quot;&lt;startdate&gt;&quot;, &quot;certificate.validity.start.date.time&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="294" href="#"></a></td>
<td><pre>        STOREPASS(&quot;storepass&quot;, &quot;&lt;arg&gt;&quot;, &quot;keystore.password&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="295" href="#"></a></td>
<td><pre>        STORETYPE(&quot;storetype&quot;, &quot;&lt;storetype&gt;&quot;, &quot;keystore.type&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="296" href="#"></a></td>
<td><pre>        TRUSTCACERTS(&quot;trustcacerts&quot;, null, &quot;trust.certificates.from.cacerts&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="297" href="#"></a></td>
<td><pre>        V(&quot;v&quot;, null, &quot;verbose.output&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="298" href="#"></a></td>
<td><pre>        VALIDITY(&quot;validity&quot;, &quot;&lt;valDays&gt;&quot;, &quot;validity.number.of.days&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="299" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="300" href="#"></a></td>
<td><pre>        final String name, arg, description;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="301" href="#"></a></td>
<td><pre>        Option(String name, String arg, String description) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="302" href="#"></a></td>
<td><pre>            this.name = name;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="303" href="#"></a></td>
<td><pre>            this.arg = arg;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="304" href="#"></a></td>
<td><pre>            this.description = description;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="305" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="306" href="#"></a></td>
<td><pre>        @Override</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="307" href="#"></a></td>
<td><pre>        public String toString() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="308" href="#"></a></td>
<td><pre>            return &quot;-&quot; + name;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="309" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="310" href="#"></a></td>
<td><pre>    };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="311" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="312" href="#"></a></td>
<td><pre>    private static final Class&lt;?&gt;[] PARAM_STRING = { String.class };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="313" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="314" href="#"></a></td>
<td><pre>    private static final String NONE = &quot;NONE&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="315" href="#"></a></td>
<td><pre>    private static final String P11KEYSTORE = &quot;PKCS11&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="316" href="#"></a></td>
<td><pre>    private static final String P12KEYSTORE = &quot;PKCS12&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="317" href="#"></a></td>
<td><pre>    private final String keyAlias = &quot;mykey&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="318" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="319" href="#"></a></td>
<td><pre>    // for i18n</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="320" href="#"></a></td>
<td><pre>    private static final java.util.ResourceBundle rb =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="321" href="#"></a></td>
<td><pre>        java.util.ResourceBundle.getBundle(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="322" href="#"></a></td>
<td><pre>            &quot;sun.security.tools.keytool.Resources&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="323" href="#"></a></td>
<td><pre>    private static final Collator collator = Collator.getInstance();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="324" href="#"></a></td>
<td><pre>    static {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="325" href="#"></a></td>
<td><pre>        // this is for case insensitive string comparisons</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="326" href="#"></a></td>
<td><pre>        collator.setStrength(Collator.PRIMARY);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="327" href="#"></a></td>
<td><pre>    };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="328" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="329" href="#"></a></td>
<td><pre>    private Main() { }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="330" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="331" href="#"></a></td>
<td><pre>    public static void main(String[] args) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="332" href="#"></a></td>
<td><pre>        Main kt = new Main();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="333" href="#"></a></td>
<td><pre>        kt.run(args, System.out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="334" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="335" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="336" href="#"></a></td>
<td><pre>    private void run(String[] args, PrintStream out) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="337" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="338" href="#"></a></td>
<td><pre>            parseArgs(args);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="339" href="#"></a></td>
<td><pre>            if (command != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="340" href="#"></a></td>
<td><pre>                doCommands(out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="341" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="342" href="#"></a></td>
<td><pre>        } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="343" href="#"></a></td>
<td><pre>            System.out.println(rb.getString(&quot;keytool.error.&quot;) + e);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="344" href="#"></a></td>
<td><pre>            if (verbose) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="345" href="#"></a></td>
<td><pre>                e.printStackTrace(System.out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="346" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="347" href="#"></a></td>
<td><pre>            if (!debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="348" href="#"></a></td>
<td><pre>                System.exit(1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="349" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="350" href="#"></a></td>
<td><pre>                throw e;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="351" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="352" href="#"></a></td>
<td><pre>        } finally {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="353" href="#"></a></td>
<td><pre>            for (char[] pass : passwords) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="354" href="#"></a></td>
<td><pre>                if (pass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="355" href="#"></a></td>
<td><pre>                    Arrays.fill(pass, ' ');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="356" href="#"></a></td>
<td><pre>                    pass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="357" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="358" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="359" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="360" href="#"></a></td>
<td><pre>            if (ksStream != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="361" href="#"></a></td>
<td><pre>                ksStream.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="362" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="363" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="364" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="365" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="366" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="367" href="#"></a></td>
<td><pre>     * Parse command line arguments.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="368" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="369" href="#"></a></td>
<td><pre>    void parseArgs(String[] args) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="370" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="371" href="#"></a></td>
<td><pre>        int i=0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="372" href="#"></a></td>
<td><pre>        boolean help = args.length == 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="373" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="374" href="#"></a></td>
<td><pre>        for (i=0; (i &lt; args.length) &amp;&amp; args[i].startsWith(&quot;-&quot;); i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="375" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="376" href="#"></a></td>
<td><pre>            String flags = args[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="377" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="378" href="#"></a></td>
<td><pre>            // Check if the last option needs an arg</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="379" href="#"></a></td>
<td><pre>            if (i == args.length - 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="380" href="#"></a></td>
<td><pre>                for (Option option: Option.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="381" href="#"></a></td>
<td><pre>                    // Only options with an arg need to be checked</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="382" href="#"></a></td>
<td><pre>                    if (collator.compare(flags, option.toString()) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="383" href="#"></a></td>
<td><pre>                        if (option.arg != null) errorNeedArgument(flags);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="384" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="385" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="386" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="387" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="388" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="389" href="#"></a></td>
<td><pre>            /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="390" href="#"></a></td>
<td><pre>             * Check modifiers</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="391" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="392" href="#"></a></td>
<td><pre>            String modifier = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="393" href="#"></a></td>
<td><pre>            int pos = flags.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="394" href="#"></a></td>
<td><pre>            if (pos &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="395" href="#"></a></td>
<td><pre>                modifier = flags.substring(pos+1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="396" href="#"></a></td>
<td><pre>                flags = flags.substring(0, pos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="397" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="398" href="#"></a></td>
<td><pre>            /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="399" href="#"></a></td>
<td><pre>             * command modes</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="400" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="401" href="#"></a></td>
<td><pre>            boolean isCommand = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="402" href="#"></a></td>
<td><pre>            for (Command c: Command.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="403" href="#"></a></td>
<td><pre>                if (collator.compare(flags, c.toString()) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="404" href="#"></a></td>
<td><pre>                    command = c;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="405" href="#"></a></td>
<td><pre>                    isCommand = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="406" href="#"></a></td>
<td><pre>                    break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="407" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="408" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="409" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="410" href="#"></a></td>
<td><pre>            if (isCommand) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="411" href="#"></a></td>
<td><pre>                // already recognized as a command</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="412" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-export&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="413" href="#"></a></td>
<td><pre>                command = EXPORTCERT;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="414" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-genkey&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="415" href="#"></a></td>
<td><pre>                command = GENKEYPAIR;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="416" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-import&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="417" href="#"></a></td>
<td><pre>                command = IMPORTCERT;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="418" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-importpassword&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="419" href="#"></a></td>
<td><pre>                command = IMPORTPASS;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="420" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="421" href="#"></a></td>
<td><pre>            /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="422" href="#"></a></td>
<td><pre>             * Help</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="423" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="424" href="#"></a></td>
<td><pre>            else if (collator.compare(flags, &quot;-help&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="425" href="#"></a></td>
<td><pre>                help = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="426" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="427" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="428" href="#"></a></td>
<td><pre>            /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="429" href="#"></a></td>
<td><pre>             * specifiers</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="430" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="431" href="#"></a></td>
<td><pre>            else if (collator.compare(flags, &quot;-keystore&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="432" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-destkeystore&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="433" href="#"></a></td>
<td><pre>                ksfname = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="434" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-storepass&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="435" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-deststorepass&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="436" href="#"></a></td>
<td><pre>                storePass = getPass(modifier, args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="437" href="#"></a></td>
<td><pre>                passwords.add(storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="438" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-storetype&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="439" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-deststoretype&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="440" href="#"></a></td>
<td><pre>                storetype = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="441" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-srcstorepass&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="442" href="#"></a></td>
<td><pre>                srcstorePass = getPass(modifier, args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="443" href="#"></a></td>
<td><pre>                passwords.add(srcstorePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="444" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-srcstoretype&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="445" href="#"></a></td>
<td><pre>                srcstoretype = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="446" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-srckeypass&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="447" href="#"></a></td>
<td><pre>                srckeyPass = getPass(modifier, args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="448" href="#"></a></td>
<td><pre>                passwords.add(srckeyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="449" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-srcprovidername&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="450" href="#"></a></td>
<td><pre>                srcProviderName = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="451" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-providername&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="452" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-destprovidername&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="453" href="#"></a></td>
<td><pre>                providerName = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="454" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-providerpath&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="455" href="#"></a></td>
<td><pre>                pathlist = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="456" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-keypass&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="457" href="#"></a></td>
<td><pre>                keyPass = getPass(modifier, args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="458" href="#"></a></td>
<td><pre>                passwords.add(keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="459" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-new&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="460" href="#"></a></td>
<td><pre>                newPass = getPass(modifier, args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="461" href="#"></a></td>
<td><pre>                passwords.add(newPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="462" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-destkeypass&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="463" href="#"></a></td>
<td><pre>                destKeyPass = getPass(modifier, args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="464" href="#"></a></td>
<td><pre>                passwords.add(destKeyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="465" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-alias&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="466" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-srcalias&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="467" href="#"></a></td>
<td><pre>                alias = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="468" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-dest&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="469" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-destalias&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="470" href="#"></a></td>
<td><pre>                dest = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="471" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-dname&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="472" href="#"></a></td>
<td><pre>                dname = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="473" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-keysize&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="474" href="#"></a></td>
<td><pre>                keysize = Integer.parseInt(args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="475" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-keyalg&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="476" href="#"></a></td>
<td><pre>                keyAlgName = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="477" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-sigalg&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="478" href="#"></a></td>
<td><pre>                sigAlgName = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="479" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-startdate&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="480" href="#"></a></td>
<td><pre>                startDate = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="481" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-validity&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="482" href="#"></a></td>
<td><pre>                validity = Long.parseLong(args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="483" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-ext&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="484" href="#"></a></td>
<td><pre>                v3ext.add(args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="485" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-id&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="486" href="#"></a></td>
<td><pre>                ids.add(args[++i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="487" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-file&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="488" href="#"></a></td>
<td><pre>                filename = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="489" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-infile&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="490" href="#"></a></td>
<td><pre>                infilename = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="491" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-outfile&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="492" href="#"></a></td>
<td><pre>                outfilename = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="493" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-sslserver&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="494" href="#"></a></td>
<td><pre>                sslserver = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="495" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-jarfile&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="496" href="#"></a></td>
<td><pre>                jarfile = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="497" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-srckeystore&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="498" href="#"></a></td>
<td><pre>                srcksfname = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="499" href="#"></a></td>
<td><pre>            } else if ((collator.compare(flags, &quot;-provider&quot;) == 0) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="500" href="#"></a></td>
<td><pre>                        (collator.compare(flags, &quot;-providerclass&quot;) == 0)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="501" href="#"></a></td>
<td><pre>                if (providers == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="502" href="#"></a></td>
<td><pre>                    providers = new HashSet&lt;Pair &lt;String, String&gt;&gt; (3);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="503" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="504" href="#"></a></td>
<td><pre>                String providerClass = args[++i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="505" href="#"></a></td>
<td><pre>                String providerArg = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="506" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="507" href="#"></a></td>
<td><pre>                if (args.length &gt; (i+1)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="508" href="#"></a></td>
<td><pre>                    flags = args[i+1];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="509" href="#"></a></td>
<td><pre>                    if (collator.compare(flags, &quot;-providerarg&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="510" href="#"></a></td>
<td><pre>                        if (args.length == (i+2)) errorNeedArgument(flags);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="511" href="#"></a></td>
<td><pre>                        providerArg = args[i+2];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="512" href="#"></a></td>
<td><pre>                        i += 2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="513" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="514" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="515" href="#"></a></td>
<td><pre>                providers.add(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="516" href="#"></a></td>
<td><pre>                        Pair.of(providerClass, providerArg));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="517" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="518" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="519" href="#"></a></td>
<td><pre>            /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="520" href="#"></a></td>
<td><pre>             * options</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="521" href="#"></a></td>
<td><pre>             */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="522" href="#"></a></td>
<td><pre>            else if (collator.compare(flags, &quot;-v&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="523" href="#"></a></td>
<td><pre>                verbose = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="524" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-debug&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="525" href="#"></a></td>
<td><pre>                debug = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="526" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-rfc&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="527" href="#"></a></td>
<td><pre>                rfc = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="528" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-noprompt&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="529" href="#"></a></td>
<td><pre>                noprompt = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="530" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-trustcacerts&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="531" href="#"></a></td>
<td><pre>                trustcacerts = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="532" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-protected&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="533" href="#"></a></td>
<td><pre>                    collator.compare(flags, &quot;-destprotected&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="534" href="#"></a></td>
<td><pre>                protectedPath = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="535" href="#"></a></td>
<td><pre>            } else if (collator.compare(flags, &quot;-srcprotected&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="536" href="#"></a></td>
<td><pre>                srcprotectedPath = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="537" href="#"></a></td>
<td><pre>            } else  {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="538" href="#"></a></td>
<td><pre>                System.err.println(rb.getString(&quot;Illegal.option.&quot;) + flags);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="539" href="#"></a></td>
<td><pre>                tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="540" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="541" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="542" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="543" href="#"></a></td>
<td><pre>        if (i&lt;args.length) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="544" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(&quot;Illegal.option.&quot;) + args[i]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="545" href="#"></a></td>
<td><pre>            tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="546" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="547" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="548" href="#"></a></td>
<td><pre>        if (command == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="549" href="#"></a></td>
<td><pre>            if (help) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="550" href="#"></a></td>
<td><pre>                usage();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="551" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="552" href="#"></a></td>
<td><pre>                System.err.println(rb.getString(&quot;Usage.error.no.command.provided&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="553" href="#"></a></td>
<td><pre>                tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="554" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="555" href="#"></a></td>
<td><pre>        } else if (help) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="556" href="#"></a></td>
<td><pre>            usage();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="557" href="#"></a></td>
<td><pre>            command = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="558" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="559" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="560" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="561" href="#"></a></td>
<td><pre>    boolean isKeyStoreRelated(Command cmd) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="562" href="#"></a></td>
<td><pre>        return cmd != PRINTCERT &amp;&amp; cmd != PRINTCERTREQ;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="563" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="564" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="565" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="566" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="567" href="#"></a></td>
<td><pre>     * Execute the commands.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="568" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="569" href="#"></a></td>
<td><pre>    void doCommands(PrintStream out) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="570" href="#"></a></td>
<td><pre>        if (storetype == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="571" href="#"></a></td>
<td><pre>            storetype = KeyStore.getDefaultType();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="572" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="573" href="#"></a></td>
<td><pre>        storetype = KeyStoreUtil.niceStoreTypeName(storetype);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="574" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="575" href="#"></a></td>
<td><pre>        if (srcstoretype == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="576" href="#"></a></td>
<td><pre>            srcstoretype = KeyStore.getDefaultType();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="577" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="578" href="#"></a></td>
<td><pre>        srcstoretype = KeyStoreUtil.niceStoreTypeName(srcstoretype);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="579" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="580" href="#"></a></td>
<td><pre>        if (P11KEYSTORE.equalsIgnoreCase(storetype) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="581" href="#"></a></td>
<td><pre>                KeyStoreUtil.isWindowsKeyStore(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="582" href="#"></a></td>
<td><pre>            token = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="583" href="#"></a></td>
<td><pre>            if (ksfname == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="584" href="#"></a></td>
<td><pre>                ksfname = NONE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="585" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="586" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="587" href="#"></a></td>
<td><pre>        if (NONE.equals(ksfname)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="588" href="#"></a></td>
<td><pre>            nullStream = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="589" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="590" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="591" href="#"></a></td>
<td><pre>        if (token &amp;&amp; !nullStream) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="592" href="#"></a></td>
<td><pre>            System.err.println(MessageFormat.format(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="593" href="#"></a></td>
<td><pre>                (&quot;.keystore.must.be.NONE.if.storetype.is.{0}&quot;), storetype));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="594" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="595" href="#"></a></td>
<td><pre>            tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="596" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="597" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="598" href="#"></a></td>
<td><pre>        if (token &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="599" href="#"></a></td>
<td><pre>            (command == KEYPASSWD || command == STOREPASSWD)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="600" href="#"></a></td>
<td><pre>            throw new UnsupportedOperationException(MessageFormat.format(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="601" href="#"></a></td>
<td><pre>                        (&quot;.storepasswd.and.keypasswd.commands.not.supported.if.storetype.is.{0}&quot;), storetype));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="602" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="603" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="604" href="#"></a></td>
<td><pre>        if (P12KEYSTORE.equalsIgnoreCase(storetype) &amp;&amp; command == KEYPASSWD) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="605" href="#"></a></td>
<td><pre>            throw new UnsupportedOperationException(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="606" href="#"></a></td>
<td><pre>                        (&quot;.keypasswd.commands.not.supported.if.storetype.is.PKCS12&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="607" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="608" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="609" href="#"></a></td>
<td><pre>        if (token &amp;&amp; (keyPass != null || newPass != null || destKeyPass != null)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="610" href="#"></a></td>
<td><pre>            throw new IllegalArgumentException(MessageFormat.format(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="611" href="#"></a></td>
<td><pre>                (&quot;.keypass.and.new.can.not.be.specified.if.storetype.is.{0}&quot;), storetype));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="612" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="613" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="614" href="#"></a></td>
<td><pre>        if (protectedPath) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="615" href="#"></a></td>
<td><pre>            if (storePass != null || keyPass != null ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="616" href="#"></a></td>
<td><pre>                    newPass != null || destKeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="617" href="#"></a></td>
<td><pre>                throw new IllegalArgumentException(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="618" href="#"></a></td>
<td><pre>                        (&quot;if.protected.is.specified.then.storepass.keypass.and.new.must.not.be.specified&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="619" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="620" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="621" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="622" href="#"></a></td>
<td><pre>        if (srcprotectedPath) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="623" href="#"></a></td>
<td><pre>            if (srcstorePass != null || srckeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="624" href="#"></a></td>
<td><pre>                throw new IllegalArgumentException(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="625" href="#"></a></td>
<td><pre>                        (&quot;if.srcprotected.is.specified.then.srcstorepass.and.srckeypass.must.not.be.specified&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="626" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="627" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="628" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="629" href="#"></a></td>
<td><pre>        if (KeyStoreUtil.isWindowsKeyStore(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="630" href="#"></a></td>
<td><pre>            if (storePass != null || keyPass != null ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="631" href="#"></a></td>
<td><pre>                    newPass != null || destKeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="632" href="#"></a></td>
<td><pre>                throw new IllegalArgumentException(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="633" href="#"></a></td>
<td><pre>                        (&quot;if.keystore.is.not.password.protected.then.storepass.keypass.and.new.must.not.be.specified&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="634" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="635" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="636" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="637" href="#"></a></td>
<td><pre>        if (KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="638" href="#"></a></td>
<td><pre>            if (srcstorePass != null || srckeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="639" href="#"></a></td>
<td><pre>                throw new IllegalArgumentException(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="640" href="#"></a></td>
<td><pre>                        (&quot;if.source.keystore.is.not.password.protected.then.srcstorepass.and.srckeypass.must.not.be.specified&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="641" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="642" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="643" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="644" href="#"></a></td>
<td><pre>        if (validity &lt;= (long)0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="645" href="#"></a></td>
<td><pre>            throw new Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="646" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Validity.must.be.greater.than.zero&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="647" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="648" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="649" href="#"></a></td>
<td><pre>        // Try to load and install specified provider</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="650" href="#"></a></td>
<td><pre>        if (providers != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="651" href="#"></a></td>
<td><pre>            ClassLoader cl = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="652" href="#"></a></td>
<td><pre>            if (pathlist != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="653" href="#"></a></td>
<td><pre>                String path = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="654" href="#"></a></td>
<td><pre>                path = PathList.appendPath(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="655" href="#"></a></td>
<td><pre>                        path, System.getProperty(&quot;java.class.path&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="656" href="#"></a></td>
<td><pre>                path = PathList.appendPath(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="657" href="#"></a></td>
<td><pre>                        path, System.getProperty(&quot;env.class.path&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="658" href="#"></a></td>
<td><pre>                path = PathList.appendPath(path, pathlist);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="659" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="660" href="#"></a></td>
<td><pre>                URL[] urls = PathList.pathToURLs(path);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="661" href="#"></a></td>
<td><pre>                cl = new URLClassLoader(urls);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="662" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="663" href="#"></a></td>
<td><pre>                cl = ClassLoader.getSystemClassLoader();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="664" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="665" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="666" href="#"></a></td>
<td><pre>            for (Pair &lt;String, String&gt; provider: providers) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="667" href="#"></a></td>
<td><pre>                String provName = provider.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="668" href="#"></a></td>
<td><pre>                Class&lt;?&gt; provClass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="669" href="#"></a></td>
<td><pre>                if (cl != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="670" href="#"></a></td>
<td><pre>                    provClass = cl.loadClass(provName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="671" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="672" href="#"></a></td>
<td><pre>                    provClass = Class.forName(provName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="673" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="674" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="675" href="#"></a></td>
<td><pre>                String provArg = provider.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="676" href="#"></a></td>
<td><pre>                Object obj;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="677" href="#"></a></td>
<td><pre>                if (provArg == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="678" href="#"></a></td>
<td><pre>                    obj = provClass.newInstance();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="679" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="680" href="#"></a></td>
<td><pre>                    Constructor&lt;?&gt; c = provClass.getConstructor(PARAM_STRING);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="681" href="#"></a></td>
<td><pre>                    obj = c.newInstance(provArg);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="682" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="683" href="#"></a></td>
<td><pre>                if (!(obj instanceof Provider)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="684" href="#"></a></td>
<td><pre>                    MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="685" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;provName.not.a.provider&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="686" href="#"></a></td>
<td><pre>                    Object[] source = {provName};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="687" href="#"></a></td>
<td><pre>                    throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="688" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="689" href="#"></a></td>
<td><pre>                Security.addProvider((Provider)obj);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="690" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="691" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="692" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="693" href="#"></a></td>
<td><pre>        if (command == LIST &amp;&amp; verbose &amp;&amp; rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="694" href="#"></a></td>
<td><pre>            System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="695" href="#"></a></td>
<td><pre>                (&quot;Must.not.specify.both.v.and.rfc.with.list.command&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="696" href="#"></a></td>
<td><pre>            tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="697" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="698" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="699" href="#"></a></td>
<td><pre>        // Make sure provided passwords are at least 6 characters long</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="700" href="#"></a></td>
<td><pre>        if (command == GENKEYPAIR &amp;&amp; keyPass!=null &amp;&amp; keyPass.length &lt; 6) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="701" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="702" href="#"></a></td>
<td><pre>                (&quot;Key.password.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="703" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="704" href="#"></a></td>
<td><pre>        if (newPass != null &amp;&amp; newPass.length &lt; 6) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="705" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="706" href="#"></a></td>
<td><pre>                (&quot;New.password.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="707" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="708" href="#"></a></td>
<td><pre>        if (destKeyPass != null &amp;&amp; destKeyPass.length &lt; 6) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="709" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="710" href="#"></a></td>
<td><pre>                (&quot;New.password.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="711" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="712" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="713" href="#"></a></td>
<td><pre>        // Check if keystore exists.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="714" href="#"></a></td>
<td><pre>        // If no keystore has been specified at the command line, try to use</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="715" href="#"></a></td>
<td><pre>        // the default, which is located in $HOME/.keystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="716" href="#"></a></td>
<td><pre>        // If the command is &quot;genkey&quot;, &quot;identitydb&quot;, &quot;import&quot;, or &quot;printcert&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="717" href="#"></a></td>
<td><pre>        // it is OK not to have a keystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="718" href="#"></a></td>
<td><pre>        if (isKeyStoreRelated(command)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="719" href="#"></a></td>
<td><pre>            if (ksfname == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="720" href="#"></a></td>
<td><pre>                ksfname = System.getProperty(&quot;user.home&quot;) + File.separator</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="721" href="#"></a></td>
<td><pre>                    + &quot;.keystore&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="722" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="723" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="724" href="#"></a></td>
<td><pre>            if (!nullStream) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="725" href="#"></a></td>
<td><pre>                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="726" href="#"></a></td>
<td><pre>                    ksfile = new File(ksfname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="727" href="#"></a></td>
<td><pre>                    // Check if keystore file is empty</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="728" href="#"></a></td>
<td><pre>                    if (ksfile.exists() &amp;&amp; ksfile.length() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="729" href="#"></a></td>
<td><pre>                        throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="730" href="#"></a></td>
<td><pre>                        (&quot;Keystore.file.exists.but.is.empty.&quot;) + ksfname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="731" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="732" href="#"></a></td>
<td><pre>                    ksStream = new FileInputStream(ksfile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="733" href="#"></a></td>
<td><pre>                } catch (FileNotFoundException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="734" href="#"></a></td>
<td><pre>                    if (command != GENKEYPAIR &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="735" href="#"></a></td>
<td><pre>                        command != GENSECKEY &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="736" href="#"></a></td>
<td><pre>                        command != IDENTITYDB &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="737" href="#"></a></td>
<td><pre>                        command != IMPORTCERT &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="738" href="#"></a></td>
<td><pre>                        command != IMPORTPASS &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="739" href="#"></a></td>
<td><pre>                        command != IMPORTKEYSTORE &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="740" href="#"></a></td>
<td><pre>                        command != PRINTCRL) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="741" href="#"></a></td>
<td><pre>                        throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="742" href="#"></a></td>
<td><pre>                                (&quot;Keystore.file.does.not.exist.&quot;) + ksfname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="743" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="744" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="745" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="746" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="747" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="748" href="#"></a></td>
<td><pre>        if ((command == KEYCLONE || command == CHANGEALIAS)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="749" href="#"></a></td>
<td><pre>                &amp;&amp; dest == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="750" href="#"></a></td>
<td><pre>            dest = getAlias(&quot;destination&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="751" href="#"></a></td>
<td><pre>            if (&quot;&quot;.equals(dest)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="752" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="753" href="#"></a></td>
<td><pre>                        (&quot;Must.specify.destination.alias&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="754" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="755" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="756" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="757" href="#"></a></td>
<td><pre>        if (command == DELETE &amp;&amp; alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="758" href="#"></a></td>
<td><pre>            alias = getAlias(null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="759" href="#"></a></td>
<td><pre>            if (&quot;&quot;.equals(alias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="760" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString(&quot;Must.specify.alias&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="761" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="762" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="763" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="764" href="#"></a></td>
<td><pre>        // Create new keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="765" href="#"></a></td>
<td><pre>        if (providerName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="766" href="#"></a></td>
<td><pre>            keyStore = KeyStore.getInstance(storetype);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="767" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="768" href="#"></a></td>
<td><pre>            keyStore = KeyStore.getInstance(storetype, providerName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="769" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="770" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="771" href="#"></a></td>
<td><pre>        /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="772" href="#"></a></td>
<td><pre>         * Load the keystore data.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="773" href="#"></a></td>
<td><pre>         *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="774" href="#"></a></td>
<td><pre>         * At this point, it's OK if no keystore password has been provided.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="775" href="#"></a></td>
<td><pre>         * We want to make sure that we can load the keystore data, i.e.,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="776" href="#"></a></td>
<td><pre>         * the keystore data has the right format. If we cannot load the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="777" href="#"></a></td>
<td><pre>         * keystore, why bother asking the user for his or her password?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="778" href="#"></a></td>
<td><pre>         * Only if we were able to load the keystore, and no keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="779" href="#"></a></td>
<td><pre>         * password has been provided, will we prompt the user for the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="780" href="#"></a></td>
<td><pre>         * keystore password to verify the keystore integrity.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="781" href="#"></a></td>
<td><pre>         * This means that the keystore is loaded twice: first load operation</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="782" href="#"></a></td>
<td><pre>         * checks the keystore format, second load operation verifies the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="783" href="#"></a></td>
<td><pre>         * keystore integrity.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="784" href="#"></a></td>
<td><pre>         *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="785" href="#"></a></td>
<td><pre>         * If the keystore password has already been provided (at the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="786" href="#"></a></td>
<td><pre>         * command line), however, the keystore is loaded only once, and the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="787" href="#"></a></td>
<td><pre>         * keystore format and integrity are checked &quot;at the same time&quot;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="788" href="#"></a></td>
<td><pre>         *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="789" href="#"></a></td>
<td><pre>         * Null stream keystores are loaded later.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="790" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="791" href="#"></a></td>
<td><pre>        if (!nullStream) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="792" href="#"></a></td>
<td><pre>            keyStore.load(ksStream, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="793" href="#"></a></td>
<td><pre>            if (ksStream != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="794" href="#"></a></td>
<td><pre>                ksStream.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="795" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="796" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="797" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="798" href="#"></a></td>
<td><pre>        // All commands that create or modify the keystore require a keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="799" href="#"></a></td>
<td><pre>        // password.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="800" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="801" href="#"></a></td>
<td><pre>        if (nullStream &amp;&amp; storePass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="802" href="#"></a></td>
<td><pre>            keyStore.load(null, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="803" href="#"></a></td>
<td><pre>        } else if (!nullStream &amp;&amp; storePass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="804" href="#"></a></td>
<td><pre>            // If we are creating a new non nullStream-based keystore,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="805" href="#"></a></td>
<td><pre>            // insist that the password be at least 6 characters</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="806" href="#"></a></td>
<td><pre>            if (ksStream == null &amp;&amp; storePass.length &lt; 6) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="807" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="808" href="#"></a></td>
<td><pre>                        (&quot;Keystore.password.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="809" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="810" href="#"></a></td>
<td><pre>        } else if (storePass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="811" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="812" href="#"></a></td>
<td><pre>            // only prompt if (protectedPath == false)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="813" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="814" href="#"></a></td>
<td><pre>            if (!protectedPath &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="815" href="#"></a></td>
<td><pre>                (command == CERTREQ ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="816" href="#"></a></td>
<td><pre>                        command == DELETE ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="817" href="#"></a></td>
<td><pre>                        command == GENKEYPAIR ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="818" href="#"></a></td>
<td><pre>                        command == GENSECKEY ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="819" href="#"></a></td>
<td><pre>                        command == IMPORTCERT ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="820" href="#"></a></td>
<td><pre>                        command == IMPORTPASS ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="821" href="#"></a></td>
<td><pre>                        command == IMPORTKEYSTORE ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="822" href="#"></a></td>
<td><pre>                        command == KEYCLONE ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="823" href="#"></a></td>
<td><pre>                        command == CHANGEALIAS ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="824" href="#"></a></td>
<td><pre>                        command == SELFCERT ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="825" href="#"></a></td>
<td><pre>                        command == STOREPASSWD ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="826" href="#"></a></td>
<td><pre>                        command == KEYPASSWD ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="827" href="#"></a></td>
<td><pre>                        command == IDENTITYDB)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="828" href="#"></a></td>
<td><pre>                int count = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="829" href="#"></a></td>
<td><pre>                do {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="830" href="#"></a></td>
<td><pre>                    if (command == IMPORTKEYSTORE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="831" href="#"></a></td>
<td><pre>                        System.err.print</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="832" href="#"></a></td>
<td><pre>                                (rb.getString(&quot;Enter.destination.keystore.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="833" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="834" href="#"></a></td>
<td><pre>                        System.err.print</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="835" href="#"></a></td>
<td><pre>                                (rb.getString(&quot;Enter.keystore.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="836" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="837" href="#"></a></td>
<td><pre>                    System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="838" href="#"></a></td>
<td><pre>                    storePass = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="839" href="#"></a></td>
<td><pre>                    passwords.add(storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="840" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="841" href="#"></a></td>
<td><pre>                    // If we are creating a new non nullStream-based keystore,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="842" href="#"></a></td>
<td><pre>                    // insist that the password be at least 6 characters</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="843" href="#"></a></td>
<td><pre>                    if (!nullStream &amp;&amp; (storePass == null || storePass.length &lt; 6)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="844" href="#"></a></td>
<td><pre>                        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="845" href="#"></a></td>
<td><pre>                                (&quot;Keystore.password.is.too.short.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="846" href="#"></a></td>
<td><pre>                        storePass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="847" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="848" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="849" href="#"></a></td>
<td><pre>                    // If the keystore file does not exist and needs to be</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="850" href="#"></a></td>
<td><pre>                    // created, the storepass should be prompted twice.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="851" href="#"></a></td>
<td><pre>                    if (storePass != null &amp;&amp; !nullStream &amp;&amp; ksStream == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="852" href="#"></a></td>
<td><pre>                        System.err.print(rb.getString(&quot;Re.enter.new.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="853" href="#"></a></td>
<td><pre>                        char[] storePassAgain = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="854" href="#"></a></td>
<td><pre>                        passwords.add(storePassAgain);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="855" href="#"></a></td>
<td><pre>                        if (!Arrays.equals(storePass, storePassAgain)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="856" href="#"></a></td>
<td><pre>                            System.err.println</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="857" href="#"></a></td>
<td><pre>                                (rb.getString(&quot;They.don.t.match.Try.again&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="858" href="#"></a></td>
<td><pre>                            storePass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="859" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="860" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="861" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="862" href="#"></a></td>
<td><pre>                    count++;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="863" href="#"></a></td>
<td><pre>                } while ((storePass == null) &amp;&amp; count &lt; 3);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="864" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="865" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="866" href="#"></a></td>
<td><pre>                if (storePass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="867" href="#"></a></td>
<td><pre>                    System.err.println</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="868" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;Too.many.failures.try.later&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="869" href="#"></a></td>
<td><pre>                    return;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="870" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="871" href="#"></a></td>
<td><pre>            } else if (!protectedPath</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="872" href="#"></a></td>
<td><pre>                    &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="873" href="#"></a></td>
<td><pre>                    &amp;&amp; isKeyStoreRelated(command)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="874" href="#"></a></td>
<td><pre>                // here we have EXPORTCERT and LIST (info valid until STOREPASSWD)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="875" href="#"></a></td>
<td><pre>                if (command != PRINTCRL) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="876" href="#"></a></td>
<td><pre>                    System.err.print(rb.getString(&quot;Enter.keystore.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="877" href="#"></a></td>
<td><pre>                    System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="878" href="#"></a></td>
<td><pre>                    storePass = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="879" href="#"></a></td>
<td><pre>                    passwords.add(storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="880" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="881" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="882" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="883" href="#"></a></td>
<td><pre>            // Now load a nullStream-based keystore,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="884" href="#"></a></td>
<td><pre>            // or verify the integrity of an input stream-based keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="885" href="#"></a></td>
<td><pre>            if (nullStream) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="886" href="#"></a></td>
<td><pre>                keyStore.load(null, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="887" href="#"></a></td>
<td><pre>            } else if (ksStream != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="888" href="#"></a></td>
<td><pre>                ksStream = new FileInputStream(ksfile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="889" href="#"></a></td>
<td><pre>                keyStore.load(ksStream, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="890" href="#"></a></td>
<td><pre>                ksStream.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="891" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="892" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="893" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="894" href="#"></a></td>
<td><pre>        if (storePass != null &amp;&amp; P12KEYSTORE.equalsIgnoreCase(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="895" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="896" href="#"></a></td>
<td><pre>                &quot;Warning.Different.store.and.key.passwords.not.supported.for.PKCS12.KeyStores.Ignoring.user.specified.command.value.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="897" href="#"></a></td>
<td><pre>            if (keyPass != null &amp;&amp; !Arrays.equals(storePass, keyPass)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="898" href="#"></a></td>
<td><pre>                Object[] source = {&quot;-keypass&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="899" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="900" href="#"></a></td>
<td><pre>                keyPass = storePass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="901" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="902" href="#"></a></td>
<td><pre>            if (newPass != null &amp;&amp; !Arrays.equals(storePass, newPass)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="903" href="#"></a></td>
<td><pre>                Object[] source = {&quot;-new&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="904" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="905" href="#"></a></td>
<td><pre>                newPass = storePass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="906" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="907" href="#"></a></td>
<td><pre>            if (destKeyPass != null &amp;&amp; !Arrays.equals(storePass, destKeyPass)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="908" href="#"></a></td>
<td><pre>                Object[] source = {&quot;-destkeypass&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="909" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="910" href="#"></a></td>
<td><pre>                destKeyPass = storePass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="911" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="912" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="913" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="914" href="#"></a></td>
<td><pre>        // Create a certificate factory</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="915" href="#"></a></td>
<td><pre>        if (command == PRINTCERT || command == IMPORTCERT</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="916" href="#"></a></td>
<td><pre>                || command == IDENTITYDB || command == PRINTCRL) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="917" href="#"></a></td>
<td><pre>            cf = CertificateFactory.getInstance(&quot;X509&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="918" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="919" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="920" href="#"></a></td>
<td><pre>        if (trustcacerts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="921" href="#"></a></td>
<td><pre>            caks = KeyStoreUtil.getCacertsKeyStore();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="922" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="923" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="924" href="#"></a></td>
<td><pre>        // Perform the specified command</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="925" href="#"></a></td>
<td><pre>        if (command == CERTREQ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="926" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="927" href="#"></a></td>
<td><pre>                try (PrintStream ps = new PrintStream(new FileOutputStream</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="928" href="#"></a></td>
<td><pre>                                                      (filename))) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="929" href="#"></a></td>
<td><pre>                    doCertReq(alias, sigAlgName, ps);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="930" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="931" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="932" href="#"></a></td>
<td><pre>                doCertReq(alias, sigAlgName, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="933" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="934" href="#"></a></td>
<td><pre>            if (verbose &amp;&amp; filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="935" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="936" href="#"></a></td>
<td><pre>                        (&quot;Certification.request.stored.in.file.filename.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="937" href="#"></a></td>
<td><pre>                Object[] source = {filename};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="938" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="939" href="#"></a></td>
<td><pre>                System.err.println(rb.getString(&quot;Submit.this.to.your.CA&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="940" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="941" href="#"></a></td>
<td><pre>        } else if (command == DELETE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="942" href="#"></a></td>
<td><pre>            doDeleteEntry(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="943" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="944" href="#"></a></td>
<td><pre>        } else if (command == EXPORTCERT) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="945" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="946" href="#"></a></td>
<td><pre>                try (PrintStream ps = new PrintStream(new FileOutputStream</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="947" href="#"></a></td>
<td><pre>                                                   (filename))) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="948" href="#"></a></td>
<td><pre>                    doExportCert(alias, ps);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="949" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="950" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="951" href="#"></a></td>
<td><pre>                doExportCert(alias, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="952" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="953" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="954" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="955" href="#"></a></td>
<td><pre>                        (&quot;Certificate.stored.in.file.filename.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="956" href="#"></a></td>
<td><pre>                Object[] source = {filename};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="957" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="958" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="959" href="#"></a></td>
<td><pre>        } else if (command == GENKEYPAIR) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="960" href="#"></a></td>
<td><pre>            if (keyAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="961" href="#"></a></td>
<td><pre>                keyAlgName = &quot;DSA&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="962" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="963" href="#"></a></td>
<td><pre>            doGenKeyPair(alias, dname, keyAlgName, keysize, sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="964" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="965" href="#"></a></td>
<td><pre>        } else if (command == GENSECKEY) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="966" href="#"></a></td>
<td><pre>            if (keyAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="967" href="#"></a></td>
<td><pre>                keyAlgName = &quot;DES&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="968" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="969" href="#"></a></td>
<td><pre>            doGenSecretKey(alias, keyAlgName, keysize);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="970" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="971" href="#"></a></td>
<td><pre>        } else if (command == IMPORTPASS) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="972" href="#"></a></td>
<td><pre>            if (keyAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="973" href="#"></a></td>
<td><pre>                keyAlgName = &quot;PBE&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="974" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="975" href="#"></a></td>
<td><pre>            // password is stored as a secret key</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="976" href="#"></a></td>
<td><pre>            doGenSecretKey(alias, keyAlgName, keysize);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="977" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="978" href="#"></a></td>
<td><pre>        } else if (command == IDENTITYDB) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="979" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="980" href="#"></a></td>
<td><pre>                try (InputStream inStream = new FileInputStream(filename)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="981" href="#"></a></td>
<td><pre>                    doImportIdentityDatabase(inStream);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="982" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="983" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="984" href="#"></a></td>
<td><pre>                doImportIdentityDatabase(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="985" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="986" href="#"></a></td>
<td><pre>        } else if (command == IMPORTCERT) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="987" href="#"></a></td>
<td><pre>            InputStream inStream = System.in;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="988" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="989" href="#"></a></td>
<td><pre>                inStream = new FileInputStream(filename);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="990" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="991" href="#"></a></td>
<td><pre>            String importAlias = (alias!=null)?alias:keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="992" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="993" href="#"></a></td>
<td><pre>                if (keyStore.entryInstanceOf(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="994" href="#"></a></td>
<td><pre>                        importAlias, KeyStore.PrivateKeyEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="995" href="#"></a></td>
<td><pre>                    kssave = installReply(importAlias, inStream);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="996" href="#"></a></td>
<td><pre>                    if (kssave) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="997" href="#"></a></td>
<td><pre>                        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="998" href="#"></a></td>
<td><pre>                            (&quot;Certificate.reply.was.installed.in.keystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="999" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1000" href="#"></a></td>
<td><pre>                        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1001" href="#"></a></td>
<td><pre>                            (&quot;Certificate.reply.was.not.installed.in.keystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1002" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1003" href="#"></a></td>
<td><pre>                } else if (!keyStore.containsAlias(importAlias) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1004" href="#"></a></td>
<td><pre>                        keyStore.entryInstanceOf(importAlias,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1005" href="#"></a></td>
<td><pre>                            KeyStore.TrustedCertificateEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1006" href="#"></a></td>
<td><pre>                    kssave = addTrustedCert(importAlias, inStream);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1007" href="#"></a></td>
<td><pre>                    if (kssave) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1008" href="#"></a></td>
<td><pre>                        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1009" href="#"></a></td>
<td><pre>                            (&quot;Certificate.was.added.to.keystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1010" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1011" href="#"></a></td>
<td><pre>                        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1012" href="#"></a></td>
<td><pre>                            (&quot;Certificate.was.not.added.to.keystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1013" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1014" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1015" href="#"></a></td>
<td><pre>            } finally {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1016" href="#"></a></td>
<td><pre>                if (inStream != System.in) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1017" href="#"></a></td>
<td><pre>                    inStream.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1018" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1019" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1020" href="#"></a></td>
<td><pre>        } else if (command == IMPORTKEYSTORE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1021" href="#"></a></td>
<td><pre>            doImportKeyStore();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1022" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1023" href="#"></a></td>
<td><pre>        } else if (command == KEYCLONE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1024" href="#"></a></td>
<td><pre>            keyPassNew = newPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1025" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1026" href="#"></a></td>
<td><pre>            // added to make sure only key can go thru</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1027" href="#"></a></td>
<td><pre>            if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1028" href="#"></a></td>
<td><pre>                alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1029" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1030" href="#"></a></td>
<td><pre>            if (keyStore.containsAlias(alias) == false) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1031" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1032" href="#"></a></td>
<td><pre>                    (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1033" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1034" href="#"></a></td>
<td><pre>                throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1035" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1036" href="#"></a></td>
<td><pre>            if (!keyStore.entryInstanceOf(alias, KeyStore.PrivateKeyEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1037" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1038" href="#"></a></td>
<td><pre>                        &quot;Alias.alias.references.an.entry.type.that.is.not.a.private.key.entry.The.keyclone.command.only.supports.cloning.of.private.key&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1039" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1040" href="#"></a></td>
<td><pre>                throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1041" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1042" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1043" href="#"></a></td>
<td><pre>            doCloneEntry(alias, dest, true);  // Now everything can be cloned</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1044" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1045" href="#"></a></td>
<td><pre>        } else if (command == CHANGEALIAS) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1046" href="#"></a></td>
<td><pre>            if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1047" href="#"></a></td>
<td><pre>                alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1048" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1049" href="#"></a></td>
<td><pre>            doCloneEntry(alias, dest, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1050" href="#"></a></td>
<td><pre>            // in PKCS11, clone a PrivateKeyEntry will delete the old one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1051" href="#"></a></td>
<td><pre>            if (keyStore.containsAlias(alias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1052" href="#"></a></td>
<td><pre>                doDeleteEntry(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1053" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1054" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1055" href="#"></a></td>
<td><pre>        } else if (command == KEYPASSWD) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1056" href="#"></a></td>
<td><pre>            keyPassNew = newPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1057" href="#"></a></td>
<td><pre>            doChangeKeyPasswd(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1058" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1059" href="#"></a></td>
<td><pre>        } else if (command == LIST) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1060" href="#"></a></td>
<td><pre>            if (alias != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1061" href="#"></a></td>
<td><pre>                doPrintEntry(alias, out, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1062" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1063" href="#"></a></td>
<td><pre>                doPrintEntries(out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1064" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1065" href="#"></a></td>
<td><pre>        } else if (command == PRINTCERT) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1066" href="#"></a></td>
<td><pre>            doPrintCert(out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1067" href="#"></a></td>
<td><pre>        } else if (command == SELFCERT) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1068" href="#"></a></td>
<td><pre>            doSelfCert(alias, dname, sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1069" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1070" href="#"></a></td>
<td><pre>        } else if (command == STOREPASSWD) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1071" href="#"></a></td>
<td><pre>            storePassNew = newPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1072" href="#"></a></td>
<td><pre>            if (storePassNew == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1073" href="#"></a></td>
<td><pre>                storePassNew = getNewPasswd(&quot;keystore password&quot;, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1074" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1075" href="#"></a></td>
<td><pre>            kssave = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1076" href="#"></a></td>
<td><pre>        } else if (command == GENCERT) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1077" href="#"></a></td>
<td><pre>            if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1078" href="#"></a></td>
<td><pre>                alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1079" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1080" href="#"></a></td>
<td><pre>            InputStream inStream = System.in;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1081" href="#"></a></td>
<td><pre>            if (infilename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1082" href="#"></a></td>
<td><pre>                inStream = new FileInputStream(infilename);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1083" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1084" href="#"></a></td>
<td><pre>            PrintStream ps = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1085" href="#"></a></td>
<td><pre>            if (outfilename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1086" href="#"></a></td>
<td><pre>                ps = new PrintStream(new FileOutputStream(outfilename));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1087" href="#"></a></td>
<td><pre>                out = ps;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1088" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1089" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1090" href="#"></a></td>
<td><pre>                doGenCert(alias, sigAlgName, inStream, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1091" href="#"></a></td>
<td><pre>            } finally {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1092" href="#"></a></td>
<td><pre>                if (inStream != System.in) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1093" href="#"></a></td>
<td><pre>                    inStream.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1094" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1095" href="#"></a></td>
<td><pre>                if (ps != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1096" href="#"></a></td>
<td><pre>                    ps.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1097" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1098" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1099" href="#"></a></td>
<td><pre>        } else if (command == GENCRL) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1100" href="#"></a></td>
<td><pre>            if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1101" href="#"></a></td>
<td><pre>                alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1102" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1103" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1104" href="#"></a></td>
<td><pre>                try (PrintStream ps =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1105" href="#"></a></td>
<td><pre>                         new PrintStream(new FileOutputStream(filename))) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1106" href="#"></a></td>
<td><pre>                    doGenCRL(ps);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1107" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1108" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1109" href="#"></a></td>
<td><pre>                doGenCRL(out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1110" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1111" href="#"></a></td>
<td><pre>        } else if (command == PRINTCERTREQ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1112" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1113" href="#"></a></td>
<td><pre>                try (InputStream inStream = new FileInputStream(filename)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1114" href="#"></a></td>
<td><pre>                    doPrintCertReq(inStream, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1115" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1116" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1117" href="#"></a></td>
<td><pre>                doPrintCertReq(System.in, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1118" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1119" href="#"></a></td>
<td><pre>        } else if (command == PRINTCRL) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1120" href="#"></a></td>
<td><pre>            doPrintCRL(filename, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1121" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1122" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1123" href="#"></a></td>
<td><pre>        // If we need to save the keystore, do so.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1124" href="#"></a></td>
<td><pre>        if (kssave) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1125" href="#"></a></td>
<td><pre>            if (verbose) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1126" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1127" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;.Storing.ksfname.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1128" href="#"></a></td>
<td><pre>                Object[] source = {nullStream ? &quot;keystore&quot; : ksfname};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1129" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1130" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1131" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1132" href="#"></a></td>
<td><pre>            if (token) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1133" href="#"></a></td>
<td><pre>                keyStore.store(null, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1134" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1135" href="#"></a></td>
<td><pre>                char[] pass = (storePassNew!=null) ? storePassNew : storePass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1136" href="#"></a></td>
<td><pre>                if (nullStream) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1137" href="#"></a></td>
<td><pre>                    keyStore.store(null, pass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1138" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1139" href="#"></a></td>
<td><pre>                    ByteArrayOutputStream bout = new ByteArrayOutputStream();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1140" href="#"></a></td>
<td><pre>                    keyStore.store(bout, pass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1141" href="#"></a></td>
<td><pre>                    try (FileOutputStream fout = new FileOutputStream(ksfname)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1142" href="#"></a></td>
<td><pre>                        fout.write(bout.toByteArray());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1143" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1144" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1145" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1146" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1147" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1148" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1149" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1150" href="#"></a></td>
<td><pre>     * Generate a certificate: Read PKCS10 request from in, and print</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1151" href="#"></a></td>
<td><pre>     * certificate to out. Use alias as CA, sigAlgName as the signature</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1152" href="#"></a></td>
<td><pre>     * type.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1153" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1154" href="#"></a></td>
<td><pre>    private void doGenCert(String alias, String sigAlgName, InputStream in, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1155" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1156" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1157" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1158" href="#"></a></td>
<td><pre>        Certificate signerCert = keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1159" href="#"></a></td>
<td><pre>        byte[] encoded = signerCert.getEncoded();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1160" href="#"></a></td>
<td><pre>        X509CertImpl signerCertImpl = new X509CertImpl(encoded);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1161" href="#"></a></td>
<td><pre>        X509CertInfo signerCertInfo = (X509CertInfo)signerCertImpl.get(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1162" href="#"></a></td>
<td><pre>                X509CertImpl.NAME + &quot;.&quot; + X509CertImpl.INFO);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1163" href="#"></a></td>
<td><pre>        X500Name issuer = (X500Name)signerCertInfo.get(X509CertInfo.SUBJECT + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1164" href="#"></a></td>
<td><pre>                                           X509CertInfo.DN_NAME);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1165" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1166" href="#"></a></td>
<td><pre>        Date firstDate = getStartDate(startDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1167" href="#"></a></td>
<td><pre>        Date lastDate = new Date();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1168" href="#"></a></td>
<td><pre>        lastDate.setTime(firstDate.getTime() + validity*1000L*24L*60L*60L);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1169" href="#"></a></td>
<td><pre>        CertificateValidity interval = new CertificateValidity(firstDate,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1170" href="#"></a></td>
<td><pre>                                                               lastDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1171" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1172" href="#"></a></td>
<td><pre>        PrivateKey privateKey =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1173" href="#"></a></td>
<td><pre>                (PrivateKey)recoverKey(alias, storePass, keyPass).fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1174" href="#"></a></td>
<td><pre>        if (sigAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1175" href="#"></a></td>
<td><pre>            sigAlgName = getCompatibleSigAlgName(privateKey.getAlgorithm());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1176" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1177" href="#"></a></td>
<td><pre>        Signature signature = Signature.getInstance(sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1178" href="#"></a></td>
<td><pre>        signature.initSign(privateKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1179" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1180" href="#"></a></td>
<td><pre>        X509CertInfo info = new X509CertInfo();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1181" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.VALIDITY, interval);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1182" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1183" href="#"></a></td>
<td><pre>                    new java.util.Random().nextInt() &amp; 0x7fffffff));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1184" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.VERSION,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1185" href="#"></a></td>
<td><pre>                    new CertificateVersion(CertificateVersion.V3));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1186" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.ALGORITHM_ID,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1187" href="#"></a></td>
<td><pre>                    new CertificateAlgorithmId(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1188" href="#"></a></td>
<td><pre>                        AlgorithmId.get(sigAlgName)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1189" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.ISSUER, issuer);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1190" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1191" href="#"></a></td>
<td><pre>        BufferedReader reader = new BufferedReader(new InputStreamReader(in));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1192" href="#"></a></td>
<td><pre>        boolean canRead = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1193" href="#"></a></td>
<td><pre>        StringBuffer sb = new StringBuffer();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1194" href="#"></a></td>
<td><pre>        while (true) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1195" href="#"></a></td>
<td><pre>            String s = reader.readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1196" href="#"></a></td>
<td><pre>            if (s == null) break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1197" href="#"></a></td>
<td><pre>            // OpenSSL does not use NEW</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1198" href="#"></a></td>
<td><pre>            //if (s.startsWith(&quot;-----BEGIN NEW CERTIFICATE REQUEST-----&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1199" href="#"></a></td>
<td><pre>            if (s.startsWith(&quot;-----BEGIN&quot;) &amp;&amp; s.indexOf(&quot;REQUEST&quot;) &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1200" href="#"></a></td>
<td><pre>                canRead = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1201" href="#"></a></td>
<td><pre>            //} else if (s.startsWith(&quot;-----END NEW CERTIFICATE REQUEST-----&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1202" href="#"></a></td>
<td><pre>            } else if (s.startsWith(&quot;-----END&quot;) &amp;&amp; s.indexOf(&quot;REQUEST&quot;) &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1203" href="#"></a></td>
<td><pre>                break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1204" href="#"></a></td>
<td><pre>            } else if (canRead) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1205" href="#"></a></td>
<td><pre>                sb.append(s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1206" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1207" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1208" href="#"></a></td>
<td><pre>        byte[] rawReq = Base64.getMimeDecoder().decode(new String(sb));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1209" href="#"></a></td>
<td><pre>        PKCS10 req = new PKCS10(rawReq);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1210" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1211" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.KEY, new CertificateX509Key(req.getSubjectPublicKeyInfo()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1212" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.SUBJECT,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1213" href="#"></a></td>
<td><pre>                    dname==null?req.getSubjectName():new X500Name(dname));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1214" href="#"></a></td>
<td><pre>        CertificateExtensions reqex = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1215" href="#"></a></td>
<td><pre>        Iterator&lt;PKCS10Attribute&gt; attrs = req.getAttributes().getAttributes().iterator();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1216" href="#"></a></td>
<td><pre>        while (attrs.hasNext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1217" href="#"></a></td>
<td><pre>            PKCS10Attribute attr = attrs.next();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1218" href="#"></a></td>
<td><pre>            if (attr.getAttributeId().equals((Object)PKCS9Attribute.EXTENSION_REQUEST_OID)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1219" href="#"></a></td>
<td><pre>                reqex = (CertificateExtensions)attr.getAttributeValue();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1220" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1221" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1222" href="#"></a></td>
<td><pre>        CertificateExtensions ext = createV3Extensions(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1223" href="#"></a></td>
<td><pre>                reqex,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1224" href="#"></a></td>
<td><pre>                null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1225" href="#"></a></td>
<td><pre>                v3ext,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1226" href="#"></a></td>
<td><pre>                req.getSubjectPublicKeyInfo(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1227" href="#"></a></td>
<td><pre>                signerCert.getPublicKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1228" href="#"></a></td>
<td><pre>        info.set(X509CertInfo.EXTENSIONS, ext);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1229" href="#"></a></td>
<td><pre>        X509CertImpl cert = new X509CertImpl(info);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1230" href="#"></a></td>
<td><pre>        cert.sign(privateKey, sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1231" href="#"></a></td>
<td><pre>        dumpCert(cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1232" href="#"></a></td>
<td><pre>        for (Certificate ca: keyStore.getCertificateChain(alias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1233" href="#"></a></td>
<td><pre>            if (ca instanceof X509Certificate) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1234" href="#"></a></td>
<td><pre>                X509Certificate xca = (X509Certificate)ca;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1235" href="#"></a></td>
<td><pre>                if (!isSelfSigned(xca)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1236" href="#"></a></td>
<td><pre>                    dumpCert(xca, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1237" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1238" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1239" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1240" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1241" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1242" href="#"></a></td>
<td><pre>    private void doGenCRL(PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1243" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1244" href="#"></a></td>
<td><pre>        if (ids == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1245" href="#"></a></td>
<td><pre>            throw new Exception(&quot;Must provide -id when -gencrl&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1246" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1247" href="#"></a></td>
<td><pre>        Certificate signerCert = keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1248" href="#"></a></td>
<td><pre>        byte[] encoded = signerCert.getEncoded();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1249" href="#"></a></td>
<td><pre>        X509CertImpl signerCertImpl = new X509CertImpl(encoded);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1250" href="#"></a></td>
<td><pre>        X509CertInfo signerCertInfo = (X509CertInfo)signerCertImpl.get(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1251" href="#"></a></td>
<td><pre>                X509CertImpl.NAME + &quot;.&quot; + X509CertImpl.INFO);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1252" href="#"></a></td>
<td><pre>        X500Name owner = (X500Name)signerCertInfo.get(X509CertInfo.SUBJECT + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1253" href="#"></a></td>
<td><pre>                                                      X509CertInfo.DN_NAME);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1254" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1255" href="#"></a></td>
<td><pre>        Date firstDate = getStartDate(startDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1256" href="#"></a></td>
<td><pre>        Date lastDate = (Date) firstDate.clone();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1257" href="#"></a></td>
<td><pre>        lastDate.setTime(lastDate.getTime() + validity*1000*24*60*60);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1258" href="#"></a></td>
<td><pre>        CertificateValidity interval = new CertificateValidity(firstDate,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1259" href="#"></a></td>
<td><pre>                                                               lastDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1260" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1261" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1262" href="#"></a></td>
<td><pre>        PrivateKey privateKey =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1263" href="#"></a></td>
<td><pre>                (PrivateKey)recoverKey(alias, storePass, keyPass).fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1264" href="#"></a></td>
<td><pre>        if (sigAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1265" href="#"></a></td>
<td><pre>            sigAlgName = getCompatibleSigAlgName(privateKey.getAlgorithm());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1266" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1267" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1268" href="#"></a></td>
<td><pre>        X509CRLEntry[] badCerts = new X509CRLEntry[ids.size()];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1269" href="#"></a></td>
<td><pre>        for (int i=0; i&lt;ids.size(); i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1270" href="#"></a></td>
<td><pre>            String id = ids.get(i);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1271" href="#"></a></td>
<td><pre>            int d = id.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1272" href="#"></a></td>
<td><pre>            if (d &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1273" href="#"></a></td>
<td><pre>                CRLExtensions ext = new CRLExtensions();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1274" href="#"></a></td>
<td><pre>                ext.set(&quot;Reason&quot;, new CRLReasonCodeExtension(Integer.parseInt(id.substring(d+1))));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1275" href="#"></a></td>
<td><pre>                badCerts[i] = new X509CRLEntryImpl(new BigInteger(id.substring(0, d)),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1276" href="#"></a></td>
<td><pre>                        firstDate, ext);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1277" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1278" href="#"></a></td>
<td><pre>                badCerts[i] = new X509CRLEntryImpl(new BigInteger(ids.get(i)), firstDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1279" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1280" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1281" href="#"></a></td>
<td><pre>        X509CRLImpl crl = new X509CRLImpl(owner, firstDate, lastDate, badCerts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1282" href="#"></a></td>
<td><pre>        crl.sign(privateKey, sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1283" href="#"></a></td>
<td><pre>        if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1284" href="#"></a></td>
<td><pre>            out.println(&quot;-----BEGIN X509 CRL-----&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1285" href="#"></a></td>
<td><pre>            out.println(Base64.getMimeEncoder().encodeToString(crl.getEncodedInternal()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1286" href="#"></a></td>
<td><pre>            out.println(&quot;-----END X509 CRL-----&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1287" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1288" href="#"></a></td>
<td><pre>            out.write(crl.getEncodedInternal());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1289" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1290" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1291" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1292" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1293" href="#"></a></td>
<td><pre>     * Creates a PKCS#10 cert signing request, corresponding to the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1294" href="#"></a></td>
<td><pre>     * keys (and name) associated with a given alias.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1295" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1296" href="#"></a></td>
<td><pre>    private void doCertReq(String alias, String sigAlgName, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1297" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1298" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1299" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1300" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1301" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1302" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1303" href="#"></a></td>
<td><pre>        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1304" href="#"></a></td>
<td><pre>        PrivateKey privKey = (PrivateKey)objs.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1305" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1306" href="#"></a></td>
<td><pre>            keyPass = objs.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1307" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1308" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1309" href="#"></a></td>
<td><pre>        Certificate cert = keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1310" href="#"></a></td>
<td><pre>        if (cert == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1311" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1312" href="#"></a></td>
<td><pre>                (rb.getString(&quot;alias.has.no.public.key.certificate.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1313" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1314" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1315" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1316" href="#"></a></td>
<td><pre>        PKCS10 request = new PKCS10(cert.getPublicKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1317" href="#"></a></td>
<td><pre>        CertificateExtensions ext = createV3Extensions(null, null, v3ext, cert.getPublicKey(), null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1318" href="#"></a></td>
<td><pre>        // Attribute name is not significant</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1319" href="#"></a></td>
<td><pre>        request.getAttributes().setAttribute(X509CertInfo.EXTENSIONS,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1320" href="#"></a></td>
<td><pre>                new PKCS10Attribute(PKCS9Attribute.EXTENSION_REQUEST_OID, ext));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1321" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1322" href="#"></a></td>
<td><pre>        // Construct a Signature object, so that we can sign the request</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1323" href="#"></a></td>
<td><pre>        if (sigAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1324" href="#"></a></td>
<td><pre>            sigAlgName = getCompatibleSigAlgName(privKey.getAlgorithm());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1325" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1326" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1327" href="#"></a></td>
<td><pre>        Signature signature = Signature.getInstance(sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1328" href="#"></a></td>
<td><pre>        signature.initSign(privKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1329" href="#"></a></td>
<td><pre>        X500Name subject = dname == null?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1330" href="#"></a></td>
<td><pre>                new X500Name(((X509Certificate)cert).getSubjectDN().toString()):</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1331" href="#"></a></td>
<td><pre>                new X500Name(dname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1332" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1333" href="#"></a></td>
<td><pre>        // Sign the request and base-64 encode it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1334" href="#"></a></td>
<td><pre>        request.encodeAndSign(subject, signature);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1335" href="#"></a></td>
<td><pre>        request.print(out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1336" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1337" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1338" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1339" href="#"></a></td>
<td><pre>     * Deletes an entry from the keystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1340" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1341" href="#"></a></td>
<td><pre>    private void doDeleteEntry(String alias) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1342" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias) == false) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1343" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1344" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1345" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1346" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1347" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1348" href="#"></a></td>
<td><pre>        keyStore.deleteEntry(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1349" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1350" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1351" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1352" href="#"></a></td>
<td><pre>     * Exports a certificate from the keystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1353" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1354" href="#"></a></td>
<td><pre>    private void doExportCert(String alias, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1355" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1356" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1357" href="#"></a></td>
<td><pre>        if (storePass == null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1358" href="#"></a></td>
<td><pre>                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1359" href="#"></a></td>
<td><pre>            printWarning();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1360" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1361" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1362" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1363" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1364" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias) == false) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1365" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1366" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1367" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1368" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1369" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1370" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1371" href="#"></a></td>
<td><pre>        X509Certificate cert = (X509Certificate)keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1372" href="#"></a></td>
<td><pre>        if (cert == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1373" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1374" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.has.no.certificate&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1375" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1376" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1377" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1378" href="#"></a></td>
<td><pre>        dumpCert(cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1379" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1380" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1381" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1382" href="#"></a></td>
<td><pre>     * Prompt the user for a keypass when generating a key entry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1383" href="#"></a></td>
<td><pre>     * @param alias the entry we will set password for</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1384" href="#"></a></td>
<td><pre>     * @param orig the original entry of doing a dup, null if generate new</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1385" href="#"></a></td>
<td><pre>     * @param origPass the password to copy from if user press ENTER</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1386" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1387" href="#"></a></td>
<td><pre>    private char[] promptForKeyPass(String alias, String orig, char[] origPass) throws Exception{</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1388" href="#"></a></td>
<td><pre>        if (P12KEYSTORE.equalsIgnoreCase(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1389" href="#"></a></td>
<td><pre>            return origPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1390" href="#"></a></td>
<td><pre>        } else if (!token &amp;&amp; !protectedPath) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1391" href="#"></a></td>
<td><pre>            // Prompt for key password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1392" href="#"></a></td>
<td><pre>            int count;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1393" href="#"></a></td>
<td><pre>            for (count = 0; count &lt; 3; count++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1394" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1395" href="#"></a></td>
<td><pre>                        (&quot;Enter.key.password.for.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1396" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1397" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1398" href="#"></a></td>
<td><pre>                if (orig == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1399" href="#"></a></td>
<td><pre>                    System.err.print(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1400" href="#"></a></td>
<td><pre>                            (&quot;.RETURN.if.same.as.keystore.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1401" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1402" href="#"></a></td>
<td><pre>                    form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1403" href="#"></a></td>
<td><pre>                            (&quot;.RETURN.if.same.as.for.otherAlias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1404" href="#"></a></td>
<td><pre>                    Object[] src = {orig};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1405" href="#"></a></td>
<td><pre>                    System.err.print(form.format(src));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1406" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1407" href="#"></a></td>
<td><pre>                System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1408" href="#"></a></td>
<td><pre>                char[] entered = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1409" href="#"></a></td>
<td><pre>                passwords.add(entered);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1410" href="#"></a></td>
<td><pre>                if (entered == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1411" href="#"></a></td>
<td><pre>                    return origPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1412" href="#"></a></td>
<td><pre>                } else if (entered.length &gt;= 6) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1413" href="#"></a></td>
<td><pre>                    System.err.print(rb.getString(&quot;Re.enter.new.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1414" href="#"></a></td>
<td><pre>                    char[] passAgain = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1415" href="#"></a></td>
<td><pre>                    passwords.add(passAgain);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1416" href="#"></a></td>
<td><pre>                    if (!Arrays.equals(entered, passAgain)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1417" href="#"></a></td>
<td><pre>                        System.err.println</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1418" href="#"></a></td>
<td><pre>                            (rb.getString(&quot;They.don.t.match.Try.again&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1419" href="#"></a></td>
<td><pre>                        continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1420" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1421" href="#"></a></td>
<td><pre>                    return entered;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1422" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1423" href="#"></a></td>
<td><pre>                    System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1424" href="#"></a></td>
<td><pre>                        (&quot;Key.password.is.too.short.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1425" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1426" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1427" href="#"></a></td>
<td><pre>            if (count == 3) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1428" href="#"></a></td>
<td><pre>                if (command == KEYCLONE) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1429" href="#"></a></td>
<td><pre>                    throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1430" href="#"></a></td>
<td><pre>                        (&quot;Too.many.failures.Key.entry.not.cloned&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1431" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1432" href="#"></a></td>
<td><pre>                    throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1433" href="#"></a></td>
<td><pre>                            (&quot;Too.many.failures.key.not.added.to.keystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1434" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1435" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1436" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1437" href="#"></a></td>
<td><pre>        return null;    // PKCS11, MSCAPI, or -protected</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1438" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1439" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1440" href="#"></a></td>
<td><pre>    /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1441" href="#"></a></td>
<td><pre>     * Prompt the user for the password credential to be stored.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1442" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1443" href="#"></a></td>
<td><pre>    private char[] promptForCredential() throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1444" href="#"></a></td>
<td><pre>        // Handle password supplied via stdin</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1445" href="#"></a></td>
<td><pre>        if (System.console() == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1446" href="#"></a></td>
<td><pre>            char[] importPass = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1447" href="#"></a></td>
<td><pre>            passwords.add(importPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1448" href="#"></a></td>
<td><pre>            return importPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1449" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1450" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1451" href="#"></a></td>
<td><pre>        int count;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1452" href="#"></a></td>
<td><pre>        for (count = 0; count &lt; 3; count++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1453" href="#"></a></td>
<td><pre>            System.err.print(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1454" href="#"></a></td>
<td><pre>                rb.getString(&quot;Enter.the.password.to.be.stored.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1455" href="#"></a></td>
<td><pre>            System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1456" href="#"></a></td>
<td><pre>            char[] entered = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1457" href="#"></a></td>
<td><pre>            passwords.add(entered);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1458" href="#"></a></td>
<td><pre>            System.err.print(rb.getString(&quot;Re.enter.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1459" href="#"></a></td>
<td><pre>            char[] passAgain = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1460" href="#"></a></td>
<td><pre>            passwords.add(passAgain);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1461" href="#"></a></td>
<td><pre>            if (!Arrays.equals(entered, passAgain)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1462" href="#"></a></td>
<td><pre>                System.err.println(rb.getString(&quot;They.don.t.match.Try.again&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1463" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1464" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1465" href="#"></a></td>
<td><pre>            return entered;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1466" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1467" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1468" href="#"></a></td>
<td><pre>        if (count == 3) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1469" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1470" href="#"></a></td>
<td><pre>                (&quot;Too.many.failures.key.not.added.to.keystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1471" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1472" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1473" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1474" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1475" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1476" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1477" href="#"></a></td>
<td><pre>     * Creates a new secret key.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1478" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1479" href="#"></a></td>
<td><pre>    private void doGenSecretKey(String alias, String keyAlgName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1480" href="#"></a></td>
<td><pre>                              int keysize)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1481" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1482" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1483" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1484" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1485" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1486" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1487" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1488" href="#"></a></td>
<td><pre>                (&quot;Secret.key.not.generated.alias.alias.already.exists&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1489" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1490" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1491" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1492" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1493" href="#"></a></td>
<td><pre>        // Use the keystore's default PBE algorithm for entry protection</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1494" href="#"></a></td>
<td><pre>        boolean useDefaultPBEAlgorithm = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1495" href="#"></a></td>
<td><pre>        SecretKey secKey = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1496" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1497" href="#"></a></td>
<td><pre>        if (keyAlgName.toUpperCase().startsWith(&quot;PBE&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1498" href="#"></a></td>
<td><pre>            SecretKeyFactory factory = SecretKeyFactory.getInstance(&quot;PBE&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1499" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1500" href="#"></a></td>
<td><pre>            // User is prompted for PBE credential</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1501" href="#"></a></td>
<td><pre>            secKey =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1502" href="#"></a></td>
<td><pre>                factory.generateSecret(new PBEKeySpec(promptForCredential()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1503" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1504" href="#"></a></td>
<td><pre>            // Check whether a specific PBE algorithm was specified</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1505" href="#"></a></td>
<td><pre>            if (!&quot;PBE&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1506" href="#"></a></td>
<td><pre>                useDefaultPBEAlgorithm = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1507" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1508" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1509" href="#"></a></td>
<td><pre>            if (verbose) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1510" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1511" href="#"></a></td>
<td><pre>                    &quot;Generated.keyAlgName.secret.key&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1512" href="#"></a></td>
<td><pre>                Object[] source =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1513" href="#"></a></td>
<td><pre>                    {useDefaultPBEAlgorithm ? &quot;PBE&quot; : secKey.getAlgorithm()};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1514" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1515" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1516" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1517" href="#"></a></td>
<td><pre>            KeyGenerator keygen = KeyGenerator.getInstance(keyAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1518" href="#"></a></td>
<td><pre>            if (keysize == -1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1519" href="#"></a></td>
<td><pre>                if (&quot;DES&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1520" href="#"></a></td>
<td><pre>                    keysize = 56;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1521" href="#"></a></td>
<td><pre>                } else if (&quot;DESede&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1522" href="#"></a></td>
<td><pre>                    keysize = 168;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1523" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1524" href="#"></a></td>
<td><pre>                    throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1525" href="#"></a></td>
<td><pre>                        (&quot;Please.provide.keysize.for.secret.key.generation&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1526" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1527" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1528" href="#"></a></td>
<td><pre>            keygen.init(keysize);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1529" href="#"></a></td>
<td><pre>            secKey = keygen.generateKey();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1530" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1531" href="#"></a></td>
<td><pre>            if (verbose) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1532" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1533" href="#"></a></td>
<td><pre>                    (&quot;Generated.keysize.bit.keyAlgName.secret.key&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1534" href="#"></a></td>
<td><pre>                Object[] source = {new Integer(keysize),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1535" href="#"></a></td>
<td><pre>                                    secKey.getAlgorithm()};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1536" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1537" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1538" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1539" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1540" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1541" href="#"></a></td>
<td><pre>            keyPass = promptForKeyPass(alias, null, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1542" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1543" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1544" href="#"></a></td>
<td><pre>        if (useDefaultPBEAlgorithm) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1545" href="#"></a></td>
<td><pre>            keyStore.setKeyEntry(alias, secKey, keyPass, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1546" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1547" href="#"></a></td>
<td><pre>            keyStore.setEntry(alias, new KeyStore.SecretKeyEntry(secKey),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1548" href="#"></a></td>
<td><pre>                new KeyStore.PasswordProtection(keyPass, keyAlgName, null));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1549" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1550" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1551" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1552" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1553" href="#"></a></td>
<td><pre>     * If no signature algorithm was specified at the command line,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1554" href="#"></a></td>
<td><pre>     * we choose one that is compatible with the selected private key</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1555" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1556" href="#"></a></td>
<td><pre>    private static String getCompatibleSigAlgName(String keyAlgName)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1557" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1558" href="#"></a></td>
<td><pre>        if (&quot;DSA&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1559" href="#"></a></td>
<td><pre>            return &quot;SHA1WithDSA&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1560" href="#"></a></td>
<td><pre>        } else if (&quot;RSA&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1561" href="#"></a></td>
<td><pre>            return &quot;SHA256WithRSA&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1562" href="#"></a></td>
<td><pre>        } else if (&quot;EC&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1563" href="#"></a></td>
<td><pre>            return &quot;SHA256withECDSA&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1564" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1565" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1566" href="#"></a></td>
<td><pre>                    (&quot;Cannot.derive.signature.algorithm&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1567" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1568" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1569" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1570" href="#"></a></td>
<td><pre>     * Creates a new key pair and self-signed certificate.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1571" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1572" href="#"></a></td>
<td><pre>    private void doGenKeyPair(String alias, String dname, String keyAlgName,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1573" href="#"></a></td>
<td><pre>                              int keysize, String sigAlgName)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1574" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1575" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1576" href="#"></a></td>
<td><pre>        if (keysize == -1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1577" href="#"></a></td>
<td><pre>            if (&quot;EC&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1578" href="#"></a></td>
<td><pre>                keysize = 256;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1579" href="#"></a></td>
<td><pre>            } else if (&quot;RSA&quot;.equalsIgnoreCase(keyAlgName)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1580" href="#"></a></td>
<td><pre>                keysize = 2048;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1581" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1582" href="#"></a></td>
<td><pre>                keysize = 1024;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1583" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1584" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1585" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1586" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1587" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1588" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1589" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1590" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1591" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1592" href="#"></a></td>
<td><pre>                (&quot;Key.pair.not.generated.alias.alias.already.exists&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1593" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1594" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1595" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1596" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1597" href="#"></a></td>
<td><pre>        if (sigAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1598" href="#"></a></td>
<td><pre>            sigAlgName = getCompatibleSigAlgName(keyAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1599" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1600" href="#"></a></td>
<td><pre>        CertAndKeyGen keypair =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1601" href="#"></a></td>
<td><pre>                new CertAndKeyGen(keyAlgName, sigAlgName, providerName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1602" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1603" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1604" href="#"></a></td>
<td><pre>        // If DN is provided, parse it. Otherwise, prompt the user for it.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1605" href="#"></a></td>
<td><pre>        X500Name x500Name;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1606" href="#"></a></td>
<td><pre>        if (dname == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1607" href="#"></a></td>
<td><pre>            x500Name = getX500Name();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1608" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1609" href="#"></a></td>
<td><pre>            x500Name = new X500Name(dname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1610" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1611" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1612" href="#"></a></td>
<td><pre>        keypair.generate(keysize);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1613" href="#"></a></td>
<td><pre>        PrivateKey privKey = keypair.getPrivateKey();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1614" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1615" href="#"></a></td>
<td><pre>        CertificateExtensions ext = createV3Extensions(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1616" href="#"></a></td>
<td><pre>                null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1617" href="#"></a></td>
<td><pre>                null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1618" href="#"></a></td>
<td><pre>                v3ext,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1619" href="#"></a></td>
<td><pre>                keypair.getPublicKeyAnyway(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1620" href="#"></a></td>
<td><pre>                null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1621" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1622" href="#"></a></td>
<td><pre>        X509Certificate[] chain = new X509Certificate[1];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1623" href="#"></a></td>
<td><pre>        chain[0] = keypair.getSelfCertificate(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1624" href="#"></a></td>
<td><pre>                x500Name, getStartDate(startDate), validity*24L*60L*60L, ext);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1625" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1626" href="#"></a></td>
<td><pre>        if (verbose) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1627" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1628" href="#"></a></td>
<td><pre>                (&quot;Generating.keysize.bit.keyAlgName.key.pair.and.self.signed.certificate.sigAlgName.with.a.validity.of.validality.days.for&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1629" href="#"></a></td>
<td><pre>            Object[] source = {new Integer(keysize),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1630" href="#"></a></td>
<td><pre>                                privKey.getAlgorithm(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1631" href="#"></a></td>
<td><pre>                                chain[0].getSigAlgName(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1632" href="#"></a></td>
<td><pre>                                new Long(validity),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1633" href="#"></a></td>
<td><pre>                                x500Name};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1634" href="#"></a></td>
<td><pre>            System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1635" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1636" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1637" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1638" href="#"></a></td>
<td><pre>            keyPass = promptForKeyPass(alias, null, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1639" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1640" href="#"></a></td>
<td><pre>        keyStore.setKeyEntry(alias, privKey, keyPass, chain);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1641" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1642" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1643" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1644" href="#"></a></td>
<td><pre>     * Clones an entry</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1645" href="#"></a></td>
<td><pre>     * @param orig original alias</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1646" href="#"></a></td>
<td><pre>     * @param dest destination alias</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1647" href="#"></a></td>
<td><pre>     * @changePassword if the password can be changed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1648" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1649" href="#"></a></td>
<td><pre>    private void doCloneEntry(String orig, String dest, boolean changePassword)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1650" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1651" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1652" href="#"></a></td>
<td><pre>        if (orig == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1653" href="#"></a></td>
<td><pre>            orig = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1654" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1655" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1656" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(dest)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1657" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1658" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Destination.alias.dest.already.exists&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1659" href="#"></a></td>
<td><pre>            Object[] source = {dest};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1660" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1661" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1662" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1663" href="#"></a></td>
<td><pre>        Pair&lt;Entry,char[]&gt; objs = recoverEntry(keyStore, orig, storePass, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1664" href="#"></a></td>
<td><pre>        Entry entry = objs.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1665" href="#"></a></td>
<td><pre>        keyPass = objs.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1666" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1667" href="#"></a></td>
<td><pre>        PasswordProtection pp = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1668" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1669" href="#"></a></td>
<td><pre>        if (keyPass != null) {  // protected</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1670" href="#"></a></td>
<td><pre>            if (!changePassword || P12KEYSTORE.equalsIgnoreCase(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1671" href="#"></a></td>
<td><pre>                keyPassNew = keyPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1672" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1673" href="#"></a></td>
<td><pre>                if (keyPassNew == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1674" href="#"></a></td>
<td><pre>                    keyPassNew = promptForKeyPass(dest, orig, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1675" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1676" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1677" href="#"></a></td>
<td><pre>            pp = new PasswordProtection(keyPassNew);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1678" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1679" href="#"></a></td>
<td><pre>        keyStore.setEntry(dest, entry, pp);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1680" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1681" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1682" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1683" href="#"></a></td>
<td><pre>     * Changes a key password.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1684" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1685" href="#"></a></td>
<td><pre>    private void doChangeKeyPasswd(String alias) throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1686" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1687" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1688" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1689" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1690" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1691" href="#"></a></td>
<td><pre>        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1692" href="#"></a></td>
<td><pre>        Key privKey = objs.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1693" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1694" href="#"></a></td>
<td><pre>            keyPass = objs.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1695" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1696" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1697" href="#"></a></td>
<td><pre>        if (keyPassNew == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1698" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1699" href="#"></a></td>
<td><pre>                (rb.getString(&quot;key.password.for.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1700" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1701" href="#"></a></td>
<td><pre>            keyPassNew = getNewPasswd(form.format(source), keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1702" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1703" href="#"></a></td>
<td><pre>        keyStore.setKeyEntry(alias, privKey, keyPassNew,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1704" href="#"></a></td>
<td><pre>                             keyStore.getCertificateChain(alias));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1705" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1706" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1707" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1708" href="#"></a></td>
<td><pre>     * Imports a JDK 1.1-style identity database. We can only store one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1709" href="#"></a></td>
<td><pre>     * certificate per identity, because we use the identity's name as the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1710" href="#"></a></td>
<td><pre>     * alias (which references a keystore entry), and aliases must be unique.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1711" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1712" href="#"></a></td>
<td><pre>    private void doImportIdentityDatabase(InputStream in)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1713" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1714" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1715" href="#"></a></td>
<td><pre>        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1716" href="#"></a></td>
<td><pre>            (&quot;No.entries.from.identity.database.added&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1717" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1718" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1719" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1720" href="#"></a></td>
<td><pre>     * Prints a single keystore entry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1721" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1722" href="#"></a></td>
<td><pre>    private void doPrintEntry(String alias, PrintStream out,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1723" href="#"></a></td>
<td><pre>                              boolean printWarning)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1724" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1725" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1726" href="#"></a></td>
<td><pre>        if (storePass == null &amp;&amp; printWarning</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1727" href="#"></a></td>
<td><pre>                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1728" href="#"></a></td>
<td><pre>            printWarning();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1729" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1730" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1731" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias) == false) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1732" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1733" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1734" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1735" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1736" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1737" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1738" href="#"></a></td>
<td><pre>        if (verbose || rfc || debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1739" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1740" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.name.alias&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1741" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1742" href="#"></a></td>
<td><pre>            out.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1743" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1744" href="#"></a></td>
<td><pre>            if (!token) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1745" href="#"></a></td>
<td><pre>                form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1746" href="#"></a></td>
<td><pre>                    (&quot;Creation.date.keyStore.getCreationDate.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1747" href="#"></a></td>
<td><pre>                Object[] src = {keyStore.getCreationDate(alias)};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1748" href="#"></a></td>
<td><pre>                out.println(form.format(src));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1749" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1750" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1751" href="#"></a></td>
<td><pre>            if (!token) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1752" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1753" href="#"></a></td>
<td><pre>                    (rb.getString(&quot;alias.keyStore.getCreationDate.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1754" href="#"></a></td>
<td><pre>                Object[] source = {alias, keyStore.getCreationDate(alias)};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1755" href="#"></a></td>
<td><pre>                out.print(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1756" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1757" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1758" href="#"></a></td>
<td><pre>                    (rb.getString(&quot;alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1759" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1760" href="#"></a></td>
<td><pre>                out.print(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1761" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1762" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1763" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1764" href="#"></a></td>
<td><pre>        if (keyStore.entryInstanceOf(alias, KeyStore.SecretKeyEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1765" href="#"></a></td>
<td><pre>            if (verbose || rfc || debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1766" href="#"></a></td>
<td><pre>                Object[] source = {&quot;SecretKeyEntry&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1767" href="#"></a></td>
<td><pre>                out.println(new MessageFormat(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1768" href="#"></a></td>
<td><pre>                        rb.getString(&quot;Entry.type.type.&quot;)).format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1769" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1770" href="#"></a></td>
<td><pre>                out.println(&quot;SecretKeyEntry, &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1771" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1772" href="#"></a></td>
<td><pre>        } else if (keyStore.entryInstanceOf(alias, KeyStore.PrivateKeyEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1773" href="#"></a></td>
<td><pre>            if (verbose || rfc || debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1774" href="#"></a></td>
<td><pre>                Object[] source = {&quot;PrivateKeyEntry&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1775" href="#"></a></td>
<td><pre>                out.println(new MessageFormat(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1776" href="#"></a></td>
<td><pre>                        rb.getString(&quot;Entry.type.type.&quot;)).format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1777" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1778" href="#"></a></td>
<td><pre>                out.println(&quot;PrivateKeyEntry, &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1779" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1780" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1781" href="#"></a></td>
<td><pre>            // Get the chain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1782" href="#"></a></td>
<td><pre>            Certificate[] chain = keyStore.getCertificateChain(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1783" href="#"></a></td>
<td><pre>            if (chain != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1784" href="#"></a></td>
<td><pre>                if (verbose || rfc || debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1785" href="#"></a></td>
<td><pre>                    out.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1786" href="#"></a></td>
<td><pre>                        (&quot;Certificate.chain.length.&quot;) + chain.length);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1787" href="#"></a></td>
<td><pre>                    for (int i = 0; i &lt; chain.length; i ++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1788" href="#"></a></td>
<td><pre>                        MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1789" href="#"></a></td>
<td><pre>                                (rb.getString(&quot;Certificate.i.1.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1790" href="#"></a></td>
<td><pre>                        Object[] source = {new Integer((i + 1))};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1791" href="#"></a></td>
<td><pre>                        out.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1792" href="#"></a></td>
<td><pre>                        if (verbose &amp;&amp; (chain[i] instanceof X509Certificate)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1793" href="#"></a></td>
<td><pre>                            printX509Cert((X509Certificate)(chain[i]), out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1794" href="#"></a></td>
<td><pre>                        } else if (debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1795" href="#"></a></td>
<td><pre>                            out.println(chain[i].toString());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1796" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1797" href="#"></a></td>
<td><pre>                            dumpCert(chain[i], out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1798" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1799" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1800" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1801" href="#"></a></td>
<td><pre>                    // Print the digest of the user cert only</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1802" href="#"></a></td>
<td><pre>                    out.println</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1803" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;Certificate.fingerprint.SHA1.&quot;) +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1804" href="#"></a></td>
<td><pre>                        getCertFingerPrint(&quot;SHA1&quot;, chain[0]));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1805" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1806" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1807" href="#"></a></td>
<td><pre>        } else if (keyStore.entryInstanceOf(alias,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1808" href="#"></a></td>
<td><pre>                KeyStore.TrustedCertificateEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1809" href="#"></a></td>
<td><pre>            // We have a trusted certificate entry</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1810" href="#"></a></td>
<td><pre>            Certificate cert = keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1811" href="#"></a></td>
<td><pre>            Object[] source = {&quot;trustedCertEntry&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1812" href="#"></a></td>
<td><pre>            String mf = new MessageFormat(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1813" href="#"></a></td>
<td><pre>                    rb.getString(&quot;Entry.type.type.&quot;)).format(source) + &quot;\n&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1814" href="#"></a></td>
<td><pre>            if (verbose &amp;&amp; (cert instanceof X509Certificate)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1815" href="#"></a></td>
<td><pre>                out.println(mf);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1816" href="#"></a></td>
<td><pre>                printX509Cert((X509Certificate)cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1817" href="#"></a></td>
<td><pre>            } else if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1818" href="#"></a></td>
<td><pre>                out.println(mf);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1819" href="#"></a></td>
<td><pre>                dumpCert(cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1820" href="#"></a></td>
<td><pre>            } else if (debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1821" href="#"></a></td>
<td><pre>                out.println(cert.toString());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1822" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1823" href="#"></a></td>
<td><pre>                out.println(&quot;trustedCertEntry, &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1824" href="#"></a></td>
<td><pre>                out.println(rb.getString(&quot;Certificate.fingerprint.SHA1.&quot;)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1825" href="#"></a></td>
<td><pre>                            + getCertFingerPrint(&quot;SHA1&quot;, cert));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1826" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1827" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1828" href="#"></a></td>
<td><pre>            out.println(rb.getString(&quot;Unknown.Entry.Type&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1829" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1830" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1831" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1832" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1833" href="#"></a></td>
<td><pre>     * Load the srckeystore from a stream, used in -importkeystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1834" href="#"></a></td>
<td><pre>     * @returns the src KeyStore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1835" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1836" href="#"></a></td>
<td><pre>    KeyStore loadSourceKeyStore() throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1837" href="#"></a></td>
<td><pre>        boolean isPkcs11 = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1838" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1839" href="#"></a></td>
<td><pre>        InputStream is = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1840" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1841" href="#"></a></td>
<td><pre>        if (P11KEYSTORE.equalsIgnoreCase(srcstoretype) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1842" href="#"></a></td>
<td><pre>                KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1843" href="#"></a></td>
<td><pre>            if (!NONE.equals(srcksfname)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1844" href="#"></a></td>
<td><pre>                System.err.println(MessageFormat.format(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1845" href="#"></a></td>
<td><pre>                    (&quot;.keystore.must.be.NONE.if.storetype.is.{0}&quot;), srcstoretype));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1846" href="#"></a></td>
<td><pre>                System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1847" href="#"></a></td>
<td><pre>                tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1848" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1849" href="#"></a></td>
<td><pre>            isPkcs11 = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1850" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1851" href="#"></a></td>
<td><pre>            if (srcksfname != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1852" href="#"></a></td>
<td><pre>                File srcksfile = new File(srcksfname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1853" href="#"></a></td>
<td><pre>                    if (srcksfile.exists() &amp;&amp; srcksfile.length() == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1854" href="#"></a></td>
<td><pre>                        throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1855" href="#"></a></td>
<td><pre>                                (&quot;Source.keystore.file.exists.but.is.empty.&quot;) +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1856" href="#"></a></td>
<td><pre>                                srcksfname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1857" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1858" href="#"></a></td>
<td><pre>                is = new FileInputStream(srcksfile);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1859" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1860" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1861" href="#"></a></td>
<td><pre>                        (&quot;Please.specify.srckeystore&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1862" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1863" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1864" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1865" href="#"></a></td>
<td><pre>        KeyStore store;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1866" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1867" href="#"></a></td>
<td><pre>            if (srcProviderName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1868" href="#"></a></td>
<td><pre>                store = KeyStore.getInstance(srcstoretype);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1869" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1870" href="#"></a></td>
<td><pre>                store = KeyStore.getInstance(srcstoretype, srcProviderName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1871" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1872" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1873" href="#"></a></td>
<td><pre>            if (srcstorePass == null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1874" href="#"></a></td>
<td><pre>                    &amp;&amp; !srcprotectedPath</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1875" href="#"></a></td>
<td><pre>                    &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1876" href="#"></a></td>
<td><pre>                System.err.print(rb.getString(&quot;Enter.source.keystore.password.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1877" href="#"></a></td>
<td><pre>                System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1878" href="#"></a></td>
<td><pre>                srcstorePass = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1879" href="#"></a></td>
<td><pre>                passwords.add(srcstorePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1880" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1881" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1882" href="#"></a></td>
<td><pre>            // always let keypass be storepass when using pkcs12</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1883" href="#"></a></td>
<td><pre>            if (P12KEYSTORE.equalsIgnoreCase(srcstoretype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1884" href="#"></a></td>
<td><pre>                if (srckeyPass != null &amp;&amp; srcstorePass != null &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1885" href="#"></a></td>
<td><pre>                        !Arrays.equals(srcstorePass, srckeyPass)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1886" href="#"></a></td>
<td><pre>                    MessageFormat form = new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1887" href="#"></a></td>
<td><pre>                        &quot;Warning.Different.store.and.key.passwords.not.supported.for.PKCS12.KeyStores.Ignoring.user.specified.command.value.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1888" href="#"></a></td>
<td><pre>                    Object[] source = {&quot;-srckeypass&quot;};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1889" href="#"></a></td>
<td><pre>                    System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1890" href="#"></a></td>
<td><pre>                    srckeyPass = srcstorePass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1891" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1892" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1893" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1894" href="#"></a></td>
<td><pre>            store.load(is, srcstorePass);   // &quot;is&quot; already null in PKCS11</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1895" href="#"></a></td>
<td><pre>        } finally {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1896" href="#"></a></td>
<td><pre>            if (is != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1897" href="#"></a></td>
<td><pre>                is.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1898" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1899" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1900" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1901" href="#"></a></td>
<td><pre>        if (srcstorePass == null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1902" href="#"></a></td>
<td><pre>                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(srcstoretype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1903" href="#"></a></td>
<td><pre>            // anti refactoring, copied from printWarning(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1904" href="#"></a></td>
<td><pre>            // but change 2 lines</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1905" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1906" href="#"></a></td>
<td><pre>            System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1907" href="#"></a></td>
<td><pre>                (&quot;.WARNING.WARNING.WARNING.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1908" href="#"></a></td>
<td><pre>            System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1909" href="#"></a></td>
<td><pre>                (&quot;.The.integrity.of.the.information.stored.in.the.srckeystore.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1910" href="#"></a></td>
<td><pre>            System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1911" href="#"></a></td>
<td><pre>                (&quot;.WARNING.WARNING.WARNING.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1912" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1913" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1914" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1915" href="#"></a></td>
<td><pre>        return store;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1916" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1917" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1918" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1919" href="#"></a></td>
<td><pre>     * import all keys and certs from importkeystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1920" href="#"></a></td>
<td><pre>     * keep alias unchanged if no name conflict, otherwise, prompt.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1921" href="#"></a></td>
<td><pre>     * keep keypass unchanged for keys</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1922" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1923" href="#"></a></td>
<td><pre>    private void doImportKeyStore() throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1924" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1925" href="#"></a></td>
<td><pre>        if (alias != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1926" href="#"></a></td>
<td><pre>            doImportKeyStoreSingle(loadSourceKeyStore(), alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1927" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1928" href="#"></a></td>
<td><pre>            if (dest != null || srckeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1929" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1930" href="#"></a></td>
<td><pre>                        &quot;if.alias.not.specified.destalias.and.srckeypass.must.not.be.specified&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1931" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1932" href="#"></a></td>
<td><pre>            doImportKeyStoreAll(loadSourceKeyStore());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1933" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1934" href="#"></a></td>
<td><pre>        /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1935" href="#"></a></td>
<td><pre>         * Information display rule of -importkeystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1936" href="#"></a></td>
<td><pre>         * 1. inside single, shows failure</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1937" href="#"></a></td>
<td><pre>         * 2. inside all, shows sucess</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1938" href="#"></a></td>
<td><pre>         * 3. inside all where there is a failure, prompt for continue</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1939" href="#"></a></td>
<td><pre>         * 4. at the final of all, shows summary</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1940" href="#"></a></td>
<td><pre>         */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1941" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1942" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1943" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1944" href="#"></a></td>
<td><pre>     * Import a single entry named alias from srckeystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1945" href="#"></a></td>
<td><pre>     * @returns 1 if the import action succeed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1946" href="#"></a></td>
<td><pre>     *          0 if user choose to ignore an alias-dumplicated entry</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1947" href="#"></a></td>
<td><pre>     *          2 if setEntry throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1948" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1949" href="#"></a></td>
<td><pre>    private int doImportKeyStoreSingle(KeyStore srckeystore, String alias)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1950" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1951" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1952" href="#"></a></td>
<td><pre>        String newAlias = (dest==null) ? alias : dest;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1953" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1954" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(newAlias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1955" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1956" href="#"></a></td>
<td><pre>            if (noprompt) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1957" href="#"></a></td>
<td><pre>                System.err.println(new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1958" href="#"></a></td>
<td><pre>                        &quot;Warning.Overwriting.existing.alias.alias.in.destination.keystore&quot;)).format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1959" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1960" href="#"></a></td>
<td><pre>                String reply = getYesNoReply(new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1961" href="#"></a></td>
<td><pre>                        &quot;Existing.entry.alias.alias.exists.overwrite.no.&quot;)).format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1962" href="#"></a></td>
<td><pre>                if (&quot;NO&quot;.equals(reply)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1963" href="#"></a></td>
<td><pre>                    newAlias = inputStringFromStdin(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1964" href="#"></a></td>
<td><pre>                            (&quot;Enter.new.alias.name.RETURN.to.cancel.import.for.this.entry.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1965" href="#"></a></td>
<td><pre>                    if (&quot;&quot;.equals(newAlias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1966" href="#"></a></td>
<td><pre>                        System.err.println(new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1967" href="#"></a></td>
<td><pre>                                &quot;Entry.for.alias.alias.not.imported.&quot;)).format(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1968" href="#"></a></td>
<td><pre>                                source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1969" href="#"></a></td>
<td><pre>                        return 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1970" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1971" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1972" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1973" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1974" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1975" href="#"></a></td>
<td><pre>        Pair&lt;Entry,char[]&gt; objs = recoverEntry(srckeystore, alias, srcstorePass, srckeyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1976" href="#"></a></td>
<td><pre>        Entry entry = objs.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1977" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1978" href="#"></a></td>
<td><pre>        PasswordProtection pp = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1979" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1980" href="#"></a></td>
<td><pre>        // According to keytool.html, &quot;The destination entry will be protected</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1981" href="#"></a></td>
<td><pre>        // using destkeypass. If destkeypass is not provided, the destination</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1982" href="#"></a></td>
<td><pre>        // entry will be protected with the source entry password.&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1983" href="#"></a></td>
<td><pre>        // so always try to protect with destKeyPass.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1984" href="#"></a></td>
<td><pre>        char[] newPass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1985" href="#"></a></td>
<td><pre>        if (destKeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1986" href="#"></a></td>
<td><pre>            newPass = destKeyPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1987" href="#"></a></td>
<td><pre>            pp = new PasswordProtection(destKeyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1988" href="#"></a></td>
<td><pre>        } else if (objs.snd != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1989" href="#"></a></td>
<td><pre>            newPass = objs.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1990" href="#"></a></td>
<td><pre>            pp = new PasswordProtection(objs.snd);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1991" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1992" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1993" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1994" href="#"></a></td>
<td><pre>            keyStore.setEntry(newAlias, entry, pp);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1995" href="#"></a></td>
<td><pre>            // Place the check so that only successful imports are blocked.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1996" href="#"></a></td>
<td><pre>            // For example, we don't block a failed SecretEntry import.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1997" href="#"></a></td>
<td><pre>            if (P12KEYSTORE.equalsIgnoreCase(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1998" href="#"></a></td>
<td><pre>                if (newPass != null &amp;&amp; !Arrays.equals(newPass, storePass)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="1999" href="#"></a></td>
<td><pre>                    throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2000" href="#"></a></td>
<td><pre>                            &quot;The.destination.pkcs12.keystore.has.different.storepass.and.keypass.Please.retry.with.destkeypass.specified.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2001" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2002" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2003" href="#"></a></td>
<td><pre>            return 1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2004" href="#"></a></td>
<td><pre>        } catch (KeyStoreException kse) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2005" href="#"></a></td>
<td><pre>            Object[] source2 = {alias, kse.toString()};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2006" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2007" href="#"></a></td>
<td><pre>                    &quot;Problem.importing.entry.for.alias.alias.exception.Entry.for.alias.alias.not.imported.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2008" href="#"></a></td>
<td><pre>            System.err.println(form.format(source2));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2009" href="#"></a></td>
<td><pre>            return 2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2010" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2011" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2012" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2013" href="#"></a></td>
<td><pre>    private void doImportKeyStoreAll(KeyStore srckeystore) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2014" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2015" href="#"></a></td>
<td><pre>        int ok = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2016" href="#"></a></td>
<td><pre>        int count = srckeystore.size();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2017" href="#"></a></td>
<td><pre>        for (Enumeration&lt;String&gt; e = srckeystore.aliases();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2018" href="#"></a></td>
<td><pre>                                        e.hasMoreElements(); ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2019" href="#"></a></td>
<td><pre>            String alias = e.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2020" href="#"></a></td>
<td><pre>            int result = doImportKeyStoreSingle(srckeystore, alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2021" href="#"></a></td>
<td><pre>            if (result == 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2022" href="#"></a></td>
<td><pre>                ok++;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2023" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2024" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString(&quot;Entry.for.alias.alias.successfully.imported.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2025" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2026" href="#"></a></td>
<td><pre>            } else if (result == 2) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2027" href="#"></a></td>
<td><pre>                if (!noprompt) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2028" href="#"></a></td>
<td><pre>                    String reply = getYesNoReply(&quot;Do you want to quit the import process? [no]:  &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2029" href="#"></a></td>
<td><pre>                    if (&quot;YES&quot;.equals(reply)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2030" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2031" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2032" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2033" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2034" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2035" href="#"></a></td>
<td><pre>        Object[] source = {ok, count-ok};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2036" href="#"></a></td>
<td><pre>        MessageFormat form = new MessageFormat(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2037" href="#"></a></td>
<td><pre>                &quot;Import.command.completed.ok.entries.successfully.imported.fail.entries.failed.or.cancelled&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2038" href="#"></a></td>
<td><pre>        System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2039" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2040" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2041" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2042" href="#"></a></td>
<td><pre>     * Prints all keystore entries.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2043" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2044" href="#"></a></td>
<td><pre>    private void doPrintEntries(PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2045" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2046" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2047" href="#"></a></td>
<td><pre>        if (storePass == null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2048" href="#"></a></td>
<td><pre>                &amp;&amp; !KeyStoreUtil.isWindowsKeyStore(storetype)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2049" href="#"></a></td>
<td><pre>            printWarning();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2050" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2051" href="#"></a></td>
<td><pre>            out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2052" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2053" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2054" href="#"></a></td>
<td><pre>        out.println(rb.getString(&quot;Keystore.type.&quot;) + keyStore.getType());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2055" href="#"></a></td>
<td><pre>        out.println(rb.getString(&quot;Keystore.provider.&quot;) +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2056" href="#"></a></td>
<td><pre>                keyStore.getProvider().getName());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2057" href="#"></a></td>
<td><pre>        out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2058" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2059" href="#"></a></td>
<td><pre>        MessageFormat form;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2060" href="#"></a></td>
<td><pre>        form = (keyStore.size() == 1) ?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2061" href="#"></a></td>
<td><pre>                new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2062" href="#"></a></td>
<td><pre>                        (&quot;Your.keystore.contains.keyStore.size.entry&quot;)) :</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2063" href="#"></a></td>
<td><pre>                new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2064" href="#"></a></td>
<td><pre>                        (&quot;Your.keystore.contains.keyStore.size.entries&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2065" href="#"></a></td>
<td><pre>        Object[] source = {new Integer(keyStore.size())};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2066" href="#"></a></td>
<td><pre>        out.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2067" href="#"></a></td>
<td><pre>        out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2068" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2069" href="#"></a></td>
<td><pre>        for (Enumeration&lt;String&gt; e = keyStore.aliases();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2070" href="#"></a></td>
<td><pre>                                        e.hasMoreElements(); ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2071" href="#"></a></td>
<td><pre>            String alias = e.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2072" href="#"></a></td>
<td><pre>            doPrintEntry(alias, out, false);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2073" href="#"></a></td>
<td><pre>            if (verbose || rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2074" href="#"></a></td>
<td><pre>                out.println(rb.getString(&quot;NEWLINE&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2075" href="#"></a></td>
<td><pre>                out.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2076" href="#"></a></td>
<td><pre>                        (&quot;STAR&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2077" href="#"></a></td>
<td><pre>                out.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2078" href="#"></a></td>
<td><pre>                        (&quot;STARNN&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2079" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2080" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2081" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2082" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2083" href="#"></a></td>
<td><pre>    private static &lt;T&gt; Iterable&lt;T&gt; e2i(final Enumeration&lt;T&gt; e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2084" href="#"></a></td>
<td><pre>        return new Iterable&lt;T&gt;() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2085" href="#"></a></td>
<td><pre>            @Override</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2086" href="#"></a></td>
<td><pre>            public Iterator&lt;T&gt; iterator() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2087" href="#"></a></td>
<td><pre>                return new Iterator&lt;T&gt;() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2088" href="#"></a></td>
<td><pre>                    @Override</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2089" href="#"></a></td>
<td><pre>                    public boolean hasNext() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2090" href="#"></a></td>
<td><pre>                        return e.hasMoreElements();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2091" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2092" href="#"></a></td>
<td><pre>                    @Override</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2093" href="#"></a></td>
<td><pre>                    public T next() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2094" href="#"></a></td>
<td><pre>                        return e.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2095" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2096" href="#"></a></td>
<td><pre>                    public void remove() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2097" href="#"></a></td>
<td><pre>                        throw new UnsupportedOperationException(&quot;Not supported yet.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2098" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2099" href="#"></a></td>
<td><pre>                };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2100" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2101" href="#"></a></td>
<td><pre>        };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2102" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2103" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2104" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2105" href="#"></a></td>
<td><pre>     * Loads CRLs from a source. This method is also called in JarSigner.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2106" href="#"></a></td>
<td><pre>     * @param src the source, which means System.in if null, or a URI,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2107" href="#"></a></td>
<td><pre>     *        or a bare file path name</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2108" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2109" href="#"></a></td>
<td><pre>    public static Collection&lt;? extends CRL&gt; loadCRLs(String src) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2110" href="#"></a></td>
<td><pre>        InputStream in = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2111" href="#"></a></td>
<td><pre>        URI uri = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2112" href="#"></a></td>
<td><pre>        if (src == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2113" href="#"></a></td>
<td><pre>            in = System.in;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2114" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2115" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2116" href="#"></a></td>
<td><pre>                uri = new URI(src);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2117" href="#"></a></td>
<td><pre>                if (uri.getScheme().equals(&quot;ldap&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2118" href="#"></a></td>
<td><pre>                    // No input stream for LDAP</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2119" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2120" href="#"></a></td>
<td><pre>                    in = uri.toURL().openStream();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2121" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2122" href="#"></a></td>
<td><pre>            } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2123" href="#"></a></td>
<td><pre>                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2124" href="#"></a></td>
<td><pre>                    in = new FileInputStream(src);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2125" href="#"></a></td>
<td><pre>                } catch (Exception e2) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2126" href="#"></a></td>
<td><pre>                    if (uri == null || uri.getScheme() == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2127" href="#"></a></td>
<td><pre>                        throw e2;   // More likely a bare file path</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2128" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2129" href="#"></a></td>
<td><pre>                        throw e;    // More likely a protocol or network problem</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2130" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2131" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2132" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2133" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2134" href="#"></a></td>
<td><pre>        if (in != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2135" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2136" href="#"></a></td>
<td><pre>                // Read the full stream before feeding to X509Factory,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2137" href="#"></a></td>
<td><pre>                // otherwise, keytool -gencrl | keytool -printcrl</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2138" href="#"></a></td>
<td><pre>                // might not work properly, since -gencrl is slow</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2139" href="#"></a></td>
<td><pre>                // and there's no data in the pipe at the beginning.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2140" href="#"></a></td>
<td><pre>                ByteArrayOutputStream bout = new ByteArrayOutputStream();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2141" href="#"></a></td>
<td><pre>                byte[] b = new byte[4096];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2142" href="#"></a></td>
<td><pre>                while (true) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2143" href="#"></a></td>
<td><pre>                    int len = in.read(b);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2144" href="#"></a></td>
<td><pre>                    if (len &lt; 0) break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2145" href="#"></a></td>
<td><pre>                    bout.write(b, 0, len);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2146" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2147" href="#"></a></td>
<td><pre>                return CertificateFactory.getInstance(&quot;X509&quot;).generateCRLs(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2148" href="#"></a></td>
<td><pre>                        new ByteArrayInputStream(bout.toByteArray()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2149" href="#"></a></td>
<td><pre>            } finally {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2150" href="#"></a></td>
<td><pre>                if (in != System.in) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2151" href="#"></a></td>
<td><pre>                    in.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2152" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2153" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2154" href="#"></a></td>
<td><pre>        } else {    // must be LDAP, and uri is not null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2155" href="#"></a></td>
<td><pre>            // Lazily load LDAPCertStoreHelper if present</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2156" href="#"></a></td>
<td><pre>            CertStoreHelper helper = CertStoreHelper.getInstance(&quot;LDAP&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2157" href="#"></a></td>
<td><pre>            String path = uri.getPath();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2158" href="#"></a></td>
<td><pre>            if (path.charAt(0) == '/') path = path.substring(1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2159" href="#"></a></td>
<td><pre>            CertStore s = helper.getCertStore(uri);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2160" href="#"></a></td>
<td><pre>            X509CRLSelector sel =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2161" href="#"></a></td>
<td><pre>                    helper.wrap(new X509CRLSelector(), null, path);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2162" href="#"></a></td>
<td><pre>            return s.getCRLs(sel);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2163" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2164" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2165" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2166" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2167" href="#"></a></td>
<td><pre>     * Returns CRLs described in a X509Certificate's CRLDistributionPoints</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2168" href="#"></a></td>
<td><pre>     * Extension. Only those containing a general name of type URI are read.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2169" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2170" href="#"></a></td>
<td><pre>    public static List&lt;CRL&gt; readCRLsFromCert(X509Certificate cert)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2171" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2172" href="#"></a></td>
<td><pre>        List&lt;CRL&gt; crls = new ArrayList&lt;&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2173" href="#"></a></td>
<td><pre>        CRLDistributionPointsExtension ext =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2174" href="#"></a></td>
<td><pre>                X509CertImpl.toImpl(cert).getCRLDistributionPointsExtension();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2175" href="#"></a></td>
<td><pre>        if (ext == null) return crls;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2176" href="#"></a></td>
<td><pre>        List&lt;DistributionPoint&gt; distPoints =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2177" href="#"></a></td>
<td><pre>                ext.get(CRLDistributionPointsExtension.POINTS);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2178" href="#"></a></td>
<td><pre>        for (DistributionPoint o: distPoints) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2179" href="#"></a></td>
<td><pre>            GeneralNames names = o.getFullName();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2180" href="#"></a></td>
<td><pre>            if (names != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2181" href="#"></a></td>
<td><pre>                for (GeneralName name: names.names()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2182" href="#"></a></td>
<td><pre>                    if (name.getType() == GeneralNameInterface.NAME_URI) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2183" href="#"></a></td>
<td><pre>                        URIName uriName = (URIName)name.getName();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2184" href="#"></a></td>
<td><pre>                        for (CRL crl: loadCRLs(uriName.getName())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2185" href="#"></a></td>
<td><pre>                            if (crl instanceof X509CRL) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2186" href="#"></a></td>
<td><pre>                                crls.add((X509CRL)crl);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2187" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2188" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2189" href="#"></a></td>
<td><pre>                        break;  // Different name should point to same CRL</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2190" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2191" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2192" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2193" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2194" href="#"></a></td>
<td><pre>        return crls;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2195" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2196" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2197" href="#"></a></td>
<td><pre>    private static String verifyCRL(KeyStore ks, CRL crl)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2198" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2199" href="#"></a></td>
<td><pre>        X509CRLImpl xcrl = (X509CRLImpl)crl;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2200" href="#"></a></td>
<td><pre>        X500Principal issuer = xcrl.getIssuerX500Principal();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2201" href="#"></a></td>
<td><pre>        for (String s: e2i(ks.aliases())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2202" href="#"></a></td>
<td><pre>            Certificate cert = ks.getCertificate(s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2203" href="#"></a></td>
<td><pre>            if (cert instanceof X509Certificate) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2204" href="#"></a></td>
<td><pre>                X509Certificate xcert = (X509Certificate)cert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2205" href="#"></a></td>
<td><pre>                if (xcert.getSubjectX500Principal().equals(issuer)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2206" href="#"></a></td>
<td><pre>                    try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2207" href="#"></a></td>
<td><pre>                        ((X509CRLImpl)crl).verify(cert.getPublicKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2208" href="#"></a></td>
<td><pre>                        return s;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2209" href="#"></a></td>
<td><pre>                    } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2210" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2211" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2212" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2213" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2214" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2215" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2216" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2217" href="#"></a></td>
<td><pre>    private void doPrintCRL(String src, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2218" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2219" href="#"></a></td>
<td><pre>        for (CRL crl: loadCRLs(src)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2220" href="#"></a></td>
<td><pre>            printCRL(crl, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2221" href="#"></a></td>
<td><pre>            String issuer = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2222" href="#"></a></td>
<td><pre>            if (caks != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2223" href="#"></a></td>
<td><pre>                issuer = verifyCRL(caks, crl);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2224" href="#"></a></td>
<td><pre>                if (issuer != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2225" href="#"></a></td>
<td><pre>                    out.printf(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2226" href="#"></a></td>
<td><pre>                            &quot;verified.by.s.in.s&quot;), issuer, &quot;cacerts&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2227" href="#"></a></td>
<td><pre>                    out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2228" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2229" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2230" href="#"></a></td>
<td><pre>            if (issuer == null &amp;&amp; keyStore != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2231" href="#"></a></td>
<td><pre>                issuer = verifyCRL(keyStore, crl);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2232" href="#"></a></td>
<td><pre>                if (issuer != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2233" href="#"></a></td>
<td><pre>                    out.printf(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2234" href="#"></a></td>
<td><pre>                            &quot;verified.by.s.in.s&quot;), issuer, &quot;keystore&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2235" href="#"></a></td>
<td><pre>                    out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2236" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2237" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2238" href="#"></a></td>
<td><pre>            if (issuer == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2239" href="#"></a></td>
<td><pre>                out.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2240" href="#"></a></td>
<td><pre>                        (&quot;STAR&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2241" href="#"></a></td>
<td><pre>                out.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2242" href="#"></a></td>
<td><pre>                        (&quot;warning.not.verified.make.sure.keystore.is.correct&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2243" href="#"></a></td>
<td><pre>                out.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2244" href="#"></a></td>
<td><pre>                        (&quot;STARNN&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2245" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2246" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2247" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2248" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2249" href="#"></a></td>
<td><pre>    private void printCRL(CRL crl, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2250" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2251" href="#"></a></td>
<td><pre>        if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2252" href="#"></a></td>
<td><pre>            X509CRL xcrl = (X509CRL)crl;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2253" href="#"></a></td>
<td><pre>            out.println(&quot;-----BEGIN X509 CRL-----&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2254" href="#"></a></td>
<td><pre>            out.println(Base64.getMimeEncoder().encodeToString(xcrl.getEncoded()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2255" href="#"></a></td>
<td><pre>            out.println(&quot;-----END X509 CRL-----&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2256" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2257" href="#"></a></td>
<td><pre>            out.println(crl.toString());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2258" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2259" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2260" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2261" href="#"></a></td>
<td><pre>    private void doPrintCertReq(InputStream in, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2262" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2263" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2264" href="#"></a></td>
<td><pre>        BufferedReader reader = new BufferedReader(new InputStreamReader(in));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2265" href="#"></a></td>
<td><pre>        StringBuffer sb = new StringBuffer();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2266" href="#"></a></td>
<td><pre>        boolean started = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2267" href="#"></a></td>
<td><pre>        while (true) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2268" href="#"></a></td>
<td><pre>            String s = reader.readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2269" href="#"></a></td>
<td><pre>            if (s == null) break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2270" href="#"></a></td>
<td><pre>            if (!started) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2271" href="#"></a></td>
<td><pre>                if (s.startsWith(&quot;-----&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2272" href="#"></a></td>
<td><pre>                    started = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2273" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2274" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2275" href="#"></a></td>
<td><pre>                if (s.startsWith(&quot;-----&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2276" href="#"></a></td>
<td><pre>                    break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2277" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2278" href="#"></a></td>
<td><pre>                sb.append(s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2279" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2280" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2281" href="#"></a></td>
<td><pre>        PKCS10 req = new PKCS10(Base64.getMimeDecoder().decode(new String(sb)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2282" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2283" href="#"></a></td>
<td><pre>        PublicKey pkey = req.getSubjectPublicKeyInfo();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2284" href="#"></a></td>
<td><pre>        out.printf(rb.getString(&quot;PKCS.10.Certificate.Request.Version.1.0.Subject.s.Public.Key.s.format.s.key.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2285" href="#"></a></td>
<td><pre>                req.getSubjectName(), pkey.getFormat(), pkey.getAlgorithm());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2286" href="#"></a></td>
<td><pre>        for (PKCS10Attribute attr: req.getAttributes().getAttributes()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2287" href="#"></a></td>
<td><pre>            ObjectIdentifier oid = attr.getAttributeId();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2288" href="#"></a></td>
<td><pre>            if (oid.equals((Object)PKCS9Attribute.EXTENSION_REQUEST_OID)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2289" href="#"></a></td>
<td><pre>                CertificateExtensions exts = (CertificateExtensions)attr.getAttributeValue();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2290" href="#"></a></td>
<td><pre>                if (exts != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2291" href="#"></a></td>
<td><pre>                    printExtensions(rb.getString(&quot;Extension.Request.&quot;), exts, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2292" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2293" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2294" href="#"></a></td>
<td><pre>                out.println(&quot;Attribute: &quot; + attr.getAttributeId());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2295" href="#"></a></td>
<td><pre>                PKCS9Attribute pkcs9Attr =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2296" href="#"></a></td>
<td><pre>                        new PKCS9Attribute(attr.getAttributeId(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2297" href="#"></a></td>
<td><pre>                                           attr.getAttributeValue());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2298" href="#"></a></td>
<td><pre>                out.print(pkcs9Attr.getName() + &quot;: &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2299" href="#"></a></td>
<td><pre>                Object attrVal = attr.getAttributeValue();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2300" href="#"></a></td>
<td><pre>                out.println(attrVal instanceof String[] ?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2301" href="#"></a></td>
<td><pre>                            Arrays.toString((String[]) attrVal) :</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2302" href="#"></a></td>
<td><pre>                            attrVal);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2303" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2304" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2305" href="#"></a></td>
<td><pre>        if (debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2306" href="#"></a></td>
<td><pre>            out.println(req);   // Just to see more, say, public key length...</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2307" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2308" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2309" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2310" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2311" href="#"></a></td>
<td><pre>     * Reads a certificate (or certificate chain) and prints its contents in</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2312" href="#"></a></td>
<td><pre>     * a human readable format.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2313" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2314" href="#"></a></td>
<td><pre>    private void printCertFromStream(InputStream in, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2315" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2316" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2317" href="#"></a></td>
<td><pre>        Collection&lt;? extends Certificate&gt; c = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2318" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2319" href="#"></a></td>
<td><pre>            c = cf.generateCertificates(in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2320" href="#"></a></td>
<td><pre>        } catch (CertificateException ce) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2321" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(&quot;Failed.to.parse.input&quot;), ce);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2322" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2323" href="#"></a></td>
<td><pre>        if (c.isEmpty()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2324" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(&quot;Empty.input&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2325" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2326" href="#"></a></td>
<td><pre>        Certificate[] certs = c.toArray(new Certificate[c.size()]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2327" href="#"></a></td>
<td><pre>        for (int i=0; i&lt;certs.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2328" href="#"></a></td>
<td><pre>            X509Certificate x509Cert = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2329" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2330" href="#"></a></td>
<td><pre>                x509Cert = (X509Certificate)certs[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2331" href="#"></a></td>
<td><pre>            } catch (ClassCastException cce) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2332" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString(&quot;Not.X.509.certificate&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2333" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2334" href="#"></a></td>
<td><pre>            if (certs.length &gt; 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2335" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2336" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;Certificate.i.1.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2337" href="#"></a></td>
<td><pre>                Object[] source = {new Integer(i + 1)};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2338" href="#"></a></td>
<td><pre>                out.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2339" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2340" href="#"></a></td>
<td><pre>            if (rfc)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2341" href="#"></a></td>
<td><pre>                dumpCert(x509Cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2342" href="#"></a></td>
<td><pre>            else</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2343" href="#"></a></td>
<td><pre>                printX509Cert(x509Cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2344" href="#"></a></td>
<td><pre>            if (i &lt; (certs.length-1)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2345" href="#"></a></td>
<td><pre>                out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2346" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2347" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2348" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2349" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2350" href="#"></a></td>
<td><pre>    private void doPrintCert(final PrintStream out) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2351" href="#"></a></td>
<td><pre>        if (jarfile != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2352" href="#"></a></td>
<td><pre>            JarFile jf = new JarFile(jarfile, true);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2353" href="#"></a></td>
<td><pre>            Enumeration&lt;JarEntry&gt; entries = jf.entries();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2354" href="#"></a></td>
<td><pre>            Set&lt;CodeSigner&gt; ss = new HashSet&lt;&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2355" href="#"></a></td>
<td><pre>            byte[] buffer = new byte[8192];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2356" href="#"></a></td>
<td><pre>            int pos = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2357" href="#"></a></td>
<td><pre>            while (entries.hasMoreElements()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2358" href="#"></a></td>
<td><pre>                JarEntry je = entries.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2359" href="#"></a></td>
<td><pre>                try (InputStream is = jf.getInputStream(je)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2360" href="#"></a></td>
<td><pre>                    while (is.read(buffer) != -1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2361" href="#"></a></td>
<td><pre>                        // we just read. this will throw a SecurityException</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2362" href="#"></a></td>
<td><pre>                        // if a signature/digest check fails. This also</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2363" href="#"></a></td>
<td><pre>                        // populate the signers</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2364" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2365" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2366" href="#"></a></td>
<td><pre>                CodeSigner[] signers = je.getCodeSigners();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2367" href="#"></a></td>
<td><pre>                if (signers != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2368" href="#"></a></td>
<td><pre>                    for (CodeSigner signer: signers) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2369" href="#"></a></td>
<td><pre>                        if (!ss.contains(signer)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2370" href="#"></a></td>
<td><pre>                            ss.add(signer);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2371" href="#"></a></td>
<td><pre>                            out.printf(rb.getString(&quot;Signer.d.&quot;), ++pos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2372" href="#"></a></td>
<td><pre>                            out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2373" href="#"></a></td>
<td><pre>                            out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2374" href="#"></a></td>
<td><pre>                            out.println(rb.getString(&quot;Signature.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2375" href="#"></a></td>
<td><pre>                            out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2376" href="#"></a></td>
<td><pre>                            for (Certificate cert: signer.getSignerCertPath().getCertificates()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2377" href="#"></a></td>
<td><pre>                                X509Certificate x = (X509Certificate)cert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2378" href="#"></a></td>
<td><pre>                                if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2379" href="#"></a></td>
<td><pre>                                    out.println(rb.getString(&quot;Certificate.owner.&quot;) + x.getSubjectDN() + &quot;\n&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2380" href="#"></a></td>
<td><pre>                                    dumpCert(x, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2381" href="#"></a></td>
<td><pre>                                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2382" href="#"></a></td>
<td><pre>                                    printX509Cert(x, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2383" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2384" href="#"></a></td>
<td><pre>                                out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2385" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2386" href="#"></a></td>
<td><pre>                            Timestamp ts = signer.getTimestamp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2387" href="#"></a></td>
<td><pre>                            if (ts != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2388" href="#"></a></td>
<td><pre>                                out.println(rb.getString(&quot;Timestamp.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2389" href="#"></a></td>
<td><pre>                                out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2390" href="#"></a></td>
<td><pre>                                for (Certificate cert: ts.getSignerCertPath().getCertificates()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2391" href="#"></a></td>
<td><pre>                                    X509Certificate x = (X509Certificate)cert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2392" href="#"></a></td>
<td><pre>                                    if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2393" href="#"></a></td>
<td><pre>                                        out.println(rb.getString(&quot;Certificate.owner.&quot;) + x.getSubjectDN() + &quot;\n&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2394" href="#"></a></td>
<td><pre>                                        dumpCert(x, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2395" href="#"></a></td>
<td><pre>                                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2396" href="#"></a></td>
<td><pre>                                        printX509Cert(x, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2397" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2398" href="#"></a></td>
<td><pre>                                    out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2399" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2400" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2401" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2402" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2403" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2404" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2405" href="#"></a></td>
<td><pre>            jf.close();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2406" href="#"></a></td>
<td><pre>            if (ss.isEmpty()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2407" href="#"></a></td>
<td><pre>                out.println(rb.getString(&quot;Not.a.signed.jar.file&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2408" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2409" href="#"></a></td>
<td><pre>        } else if (sslserver != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2410" href="#"></a></td>
<td><pre>            // Lazily load SSLCertStoreHelper if present</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2411" href="#"></a></td>
<td><pre>            CertStoreHelper helper = CertStoreHelper.getInstance(&quot;SSLServer&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2412" href="#"></a></td>
<td><pre>            CertStore cs = helper.getCertStore(new URI(&quot;https://&quot; + sslserver));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2413" href="#"></a></td>
<td><pre>            Collection&lt;? extends Certificate&gt; chain;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2414" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2415" href="#"></a></td>
<td><pre>                chain = cs.getCertificates(null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2416" href="#"></a></td>
<td><pre>                if (chain.isEmpty()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2417" href="#"></a></td>
<td><pre>                    // If the certs are not retrieved, we consider it an error</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2418" href="#"></a></td>
<td><pre>                    // even if the URL connection is successful.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2419" href="#"></a></td>
<td><pre>                    throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2420" href="#"></a></td>
<td><pre>                                        &quot;No.certificate.from.the.SSL.server&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2421" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2422" href="#"></a></td>
<td><pre>            } catch (CertStoreException cse) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2423" href="#"></a></td>
<td><pre>                if (cse.getCause() instanceof IOException) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2424" href="#"></a></td>
<td><pre>                    throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2425" href="#"></a></td>
<td><pre>                                        &quot;No.certificate.from.the.SSL.server&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2426" href="#"></a></td>
<td><pre>                                        cse.getCause());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2427" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2428" href="#"></a></td>
<td><pre>                    throw cse;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2429" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2430" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2431" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2432" href="#"></a></td>
<td><pre>            int i = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2433" href="#"></a></td>
<td><pre>            for (Certificate cert : chain) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2434" href="#"></a></td>
<td><pre>                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2435" href="#"></a></td>
<td><pre>                    if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2436" href="#"></a></td>
<td><pre>                        dumpCert(cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2437" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2438" href="#"></a></td>
<td><pre>                        out.println(&quot;Certificate #&quot; + i++);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2439" href="#"></a></td>
<td><pre>                        out.println(&quot;====================================&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2440" href="#"></a></td>
<td><pre>                        printX509Cert((X509Certificate)cert, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2441" href="#"></a></td>
<td><pre>                        out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2442" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2443" href="#"></a></td>
<td><pre>                } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2444" href="#"></a></td>
<td><pre>                    if (debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2445" href="#"></a></td>
<td><pre>                        e.printStackTrace();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2446" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2447" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2448" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2449" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2450" href="#"></a></td>
<td><pre>            if (filename != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2451" href="#"></a></td>
<td><pre>                try (FileInputStream inStream = new FileInputStream(filename)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2452" href="#"></a></td>
<td><pre>                    printCertFromStream(inStream, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2453" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2454" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2455" href="#"></a></td>
<td><pre>                printCertFromStream(System.in, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2456" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2457" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2458" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2459" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2460" href="#"></a></td>
<td><pre>     * Creates a self-signed certificate, and stores it as a single-element</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2461" href="#"></a></td>
<td><pre>     * certificate chain.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2462" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2463" href="#"></a></td>
<td><pre>    private void doSelfCert(String alias, String dname, String sigAlgName)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2464" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2465" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2466" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2467" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2468" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2469" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2470" href="#"></a></td>
<td><pre>        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2471" href="#"></a></td>
<td><pre>        PrivateKey privKey = (PrivateKey)objs.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2472" href="#"></a></td>
<td><pre>        if (keyPass == null)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2473" href="#"></a></td>
<td><pre>            keyPass = objs.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2474" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2475" href="#"></a></td>
<td><pre>        // Determine the signature algorithm</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2476" href="#"></a></td>
<td><pre>        if (sigAlgName == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2477" href="#"></a></td>
<td><pre>            sigAlgName = getCompatibleSigAlgName(privKey.getAlgorithm());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2478" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2479" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2480" href="#"></a></td>
<td><pre>        // Get the old certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2481" href="#"></a></td>
<td><pre>        Certificate oldCert = keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2482" href="#"></a></td>
<td><pre>        if (oldCert == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2483" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2484" href="#"></a></td>
<td><pre>                (rb.getString(&quot;alias.has.no.public.key&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2485" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2486" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2487" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2488" href="#"></a></td>
<td><pre>        if (!(oldCert instanceof X509Certificate)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2489" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2490" href="#"></a></td>
<td><pre>                (rb.getString(&quot;alias.has.no.X.509.certificate&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2491" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2492" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2493" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2494" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2495" href="#"></a></td>
<td><pre>        // convert to X509CertImpl, so that we can modify selected fields</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2496" href="#"></a></td>
<td><pre>        // (no public APIs available yet)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2497" href="#"></a></td>
<td><pre>        byte[] encoded = oldCert.getEncoded();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2498" href="#"></a></td>
<td><pre>        X509CertImpl certImpl = new X509CertImpl(encoded);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2499" href="#"></a></td>
<td><pre>        X509CertInfo certInfo = (X509CertInfo)certImpl.get(X509CertImpl.NAME</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2500" href="#"></a></td>
<td><pre>                                                           + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2501" href="#"></a></td>
<td><pre>                                                           X509CertImpl.INFO);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2502" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2503" href="#"></a></td>
<td><pre>        // Extend its validity</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2504" href="#"></a></td>
<td><pre>        Date firstDate = getStartDate(startDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2505" href="#"></a></td>
<td><pre>        Date lastDate = new Date();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2506" href="#"></a></td>
<td><pre>        lastDate.setTime(firstDate.getTime() + validity*1000L*24L*60L*60L);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2507" href="#"></a></td>
<td><pre>        CertificateValidity interval = new CertificateValidity(firstDate,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2508" href="#"></a></td>
<td><pre>                                                               lastDate);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2509" href="#"></a></td>
<td><pre>        certInfo.set(X509CertInfo.VALIDITY, interval);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2510" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2511" href="#"></a></td>
<td><pre>        // Make new serial number</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2512" href="#"></a></td>
<td><pre>        certInfo.set(X509CertInfo.SERIAL_NUMBER, new CertificateSerialNumber(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2513" href="#"></a></td>
<td><pre>                    new java.util.Random().nextInt() &amp; 0x7fffffff));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2514" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2515" href="#"></a></td>
<td><pre>        // Set owner and issuer fields</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2516" href="#"></a></td>
<td><pre>        X500Name owner;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2517" href="#"></a></td>
<td><pre>        if (dname == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2518" href="#"></a></td>
<td><pre>            // Get the owner name from the certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2519" href="#"></a></td>
<td><pre>            owner = (X500Name)certInfo.get(X509CertInfo.SUBJECT + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2520" href="#"></a></td>
<td><pre>                                           X509CertInfo.DN_NAME);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2521" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2522" href="#"></a></td>
<td><pre>            // Use the owner name specified at the command line</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2523" href="#"></a></td>
<td><pre>            owner = new X500Name(dname);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2524" href="#"></a></td>
<td><pre>            certInfo.set(X509CertInfo.SUBJECT + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2525" href="#"></a></td>
<td><pre>                         X509CertInfo.DN_NAME, owner);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2526" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2527" href="#"></a></td>
<td><pre>        // Make issuer same as owner (self-signed!)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2528" href="#"></a></td>
<td><pre>        certInfo.set(X509CertInfo.ISSUER + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2529" href="#"></a></td>
<td><pre>                     X509CertInfo.DN_NAME, owner);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2530" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2531" href="#"></a></td>
<td><pre>        // The inner and outer signature algorithms have to match.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2532" href="#"></a></td>
<td><pre>        // The way we achieve that is really ugly, but there seems to be no</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2533" href="#"></a></td>
<td><pre>        // other solution: We first sign the cert, then retrieve the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2534" href="#"></a></td>
<td><pre>        // outer sigalg and use it to set the inner sigalg</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2535" href="#"></a></td>
<td><pre>        X509CertImpl newCert = new X509CertImpl(certInfo);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2536" href="#"></a></td>
<td><pre>        newCert.sign(privKey, sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2537" href="#"></a></td>
<td><pre>        AlgorithmId sigAlgid = (AlgorithmId)newCert.get(X509CertImpl.SIG_ALG);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2538" href="#"></a></td>
<td><pre>        certInfo.set(CertificateAlgorithmId.NAME + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2539" href="#"></a></td>
<td><pre>                     CertificateAlgorithmId.ALGORITHM, sigAlgid);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2540" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2541" href="#"></a></td>
<td><pre>        certInfo.set(X509CertInfo.VERSION,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2542" href="#"></a></td>
<td><pre>                        new CertificateVersion(CertificateVersion.V3));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2543" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2544" href="#"></a></td>
<td><pre>        CertificateExtensions ext = createV3Extensions(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2545" href="#"></a></td>
<td><pre>                null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2546" href="#"></a></td>
<td><pre>                (CertificateExtensions)certInfo.get(X509CertInfo.EXTENSIONS),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2547" href="#"></a></td>
<td><pre>                v3ext,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2548" href="#"></a></td>
<td><pre>                oldCert.getPublicKey(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2549" href="#"></a></td>
<td><pre>                null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2550" href="#"></a></td>
<td><pre>        certInfo.set(X509CertInfo.EXTENSIONS, ext);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2551" href="#"></a></td>
<td><pre>        // Sign the new certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2552" href="#"></a></td>
<td><pre>        newCert = new X509CertImpl(certInfo);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2553" href="#"></a></td>
<td><pre>        newCert.sign(privKey, sigAlgName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2554" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2555" href="#"></a></td>
<td><pre>        // Store the new certificate as a single-element certificate chain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2556" href="#"></a></td>
<td><pre>        keyStore.setKeyEntry(alias, privKey,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2557" href="#"></a></td>
<td><pre>                             (keyPass != null) ? keyPass : storePass,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2558" href="#"></a></td>
<td><pre>                             new Certificate[] { newCert } );</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2559" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2560" href="#"></a></td>
<td><pre>        if (verbose) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2561" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(&quot;New.certificate.self.signed.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2562" href="#"></a></td>
<td><pre>            System.err.print(newCert.toString());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2563" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2564" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2565" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2566" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2567" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2568" href="#"></a></td>
<td><pre>     * Processes a certificate reply from a certificate authority.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2569" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2570" href="#"></a></td>
<td><pre>     * &lt;p&gt;Builds a certificate chain on top of the certificate reply,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2571" href="#"></a></td>
<td><pre>     * using trusted certificates from the keystore. The chain is complete</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2572" href="#"></a></td>
<td><pre>     * after a self-signed certificate has been encountered. The self-signed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2573" href="#"></a></td>
<td><pre>     * certificate is considered a root certificate authority, and is stored</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2574" href="#"></a></td>
<td><pre>     * at the end of the chain.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2575" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2576" href="#"></a></td>
<td><pre>     * &lt;p&gt;The newly generated chain replaces the old chain associated with the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2577" href="#"></a></td>
<td><pre>     * key entry.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2578" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2579" href="#"></a></td>
<td><pre>     * @return true if the certificate reply was installed, otherwise false.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2580" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2581" href="#"></a></td>
<td><pre>    private boolean installReply(String alias, InputStream in)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2582" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2583" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2584" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2585" href="#"></a></td>
<td><pre>            alias = keyAlias;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2586" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2587" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2588" href="#"></a></td>
<td><pre>        Pair&lt;Key,char[]&gt; objs = recoverKey(alias, storePass, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2589" href="#"></a></td>
<td><pre>        PrivateKey privKey = (PrivateKey)objs.fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2590" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2591" href="#"></a></td>
<td><pre>            keyPass = objs.snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2592" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2593" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2594" href="#"></a></td>
<td><pre>        Certificate userCert = keyStore.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2595" href="#"></a></td>
<td><pre>        if (userCert == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2596" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2597" href="#"></a></td>
<td><pre>                (rb.getString(&quot;alias.has.no.public.key.certificate.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2598" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2599" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2600" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2601" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2602" href="#"></a></td>
<td><pre>        // Read the certificates in the reply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2603" href="#"></a></td>
<td><pre>        Collection&lt;? extends Certificate&gt; c = cf.generateCertificates(in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2604" href="#"></a></td>
<td><pre>        if (c.isEmpty()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2605" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(&quot;Reply.has.no.certificates&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2606" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2607" href="#"></a></td>
<td><pre>        Certificate[] replyCerts = c.toArray(new Certificate[c.size()]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2608" href="#"></a></td>
<td><pre>        Certificate[] newChain;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2609" href="#"></a></td>
<td><pre>        if (replyCerts.length == 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2610" href="#"></a></td>
<td><pre>            // single-cert reply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2611" href="#"></a></td>
<td><pre>            newChain = establishCertChain(userCert, replyCerts[0]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2612" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2613" href="#"></a></td>
<td><pre>            // cert-chain reply (e.g., PKCS#7)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2614" href="#"></a></td>
<td><pre>            newChain = validateReply(alias, userCert, replyCerts);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2615" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2616" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2617" href="#"></a></td>
<td><pre>        // Now store the newly established chain in the keystore. The new</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2618" href="#"></a></td>
<td><pre>        // chain replaces the old one.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2619" href="#"></a></td>
<td><pre>        if (newChain != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2620" href="#"></a></td>
<td><pre>            keyStore.setKeyEntry(alias, privKey,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2621" href="#"></a></td>
<td><pre>                                 (keyPass != null) ? keyPass : storePass,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2622" href="#"></a></td>
<td><pre>                                 newChain);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2623" href="#"></a></td>
<td><pre>            return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2624" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2625" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2626" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2627" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2628" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2629" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2630" href="#"></a></td>
<td><pre>     * Imports a certificate and adds it to the list of trusted certificates.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2631" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2632" href="#"></a></td>
<td><pre>     * @return true if the certificate was added, otherwise false.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2633" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2634" href="#"></a></td>
<td><pre>    private boolean addTrustedCert(String alias, InputStream in)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2635" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2636" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2637" href="#"></a></td>
<td><pre>        if (alias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2638" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(&quot;Must.specify.alias&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2639" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2640" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2641" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2642" href="#"></a></td>
<td><pre>                (&quot;Certificate.not.imported.alias.alias.already.exists&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2643" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2644" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2645" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2646" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2647" href="#"></a></td>
<td><pre>        // Read the certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2648" href="#"></a></td>
<td><pre>        X509Certificate cert = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2649" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2650" href="#"></a></td>
<td><pre>            cert = (X509Certificate)cf.generateCertificate(in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2651" href="#"></a></td>
<td><pre>        } catch (ClassCastException | CertificateException ce) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2652" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(&quot;Input.not.an.X.509.certificate&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2653" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2654" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2655" href="#"></a></td>
<td><pre>        // if certificate is self-signed, make sure it verifies</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2656" href="#"></a></td>
<td><pre>        boolean selfSigned = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2657" href="#"></a></td>
<td><pre>        if (isSelfSigned(cert)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2658" href="#"></a></td>
<td><pre>            cert.verify(cert.getPublicKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2659" href="#"></a></td>
<td><pre>            selfSigned = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2660" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2661" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2662" href="#"></a></td>
<td><pre>        if (noprompt) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2663" href="#"></a></td>
<td><pre>            keyStore.setCertificateEntry(alias, cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2664" href="#"></a></td>
<td><pre>            return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2665" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2666" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2667" href="#"></a></td>
<td><pre>        // check if cert already exists in keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2668" href="#"></a></td>
<td><pre>        String reply = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2669" href="#"></a></td>
<td><pre>        String trustalias = keyStore.getCertificateAlias(cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2670" href="#"></a></td>
<td><pre>        if (trustalias != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2671" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2672" href="#"></a></td>
<td><pre>                (&quot;Certificate.already.exists.in.keystore.under.alias.trustalias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2673" href="#"></a></td>
<td><pre>            Object[] source = {trustalias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2674" href="#"></a></td>
<td><pre>            System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2675" href="#"></a></td>
<td><pre>            reply = getYesNoReply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2676" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Do.you.still.want.to.add.it.no.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2677" href="#"></a></td>
<td><pre>        } else if (selfSigned) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2678" href="#"></a></td>
<td><pre>            if (trustcacerts &amp;&amp; (caks != null) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2679" href="#"></a></td>
<td><pre>                    ((trustalias=caks.getCertificateAlias(cert)) != null)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2680" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2681" href="#"></a></td>
<td><pre>                        (&quot;Certificate.already.exists.in.system.wide.CA.keystore.under.alias.trustalias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2682" href="#"></a></td>
<td><pre>                Object[] source = {trustalias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2683" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2684" href="#"></a></td>
<td><pre>                reply = getYesNoReply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2685" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;Do.you.still.want.to.add.it.to.your.own.keystore.no.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2686" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2687" href="#"></a></td>
<td><pre>            if (trustalias == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2688" href="#"></a></td>
<td><pre>                // Print the cert and ask user if they really want to add</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2689" href="#"></a></td>
<td><pre>                // it to their keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2690" href="#"></a></td>
<td><pre>                printX509Cert(cert, System.out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2691" href="#"></a></td>
<td><pre>                reply = getYesNoReply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2692" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;Trust.this.certificate.no.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2693" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2694" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2695" href="#"></a></td>
<td><pre>        if (reply != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2696" href="#"></a></td>
<td><pre>            if (&quot;YES&quot;.equals(reply)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2697" href="#"></a></td>
<td><pre>                keyStore.setCertificateEntry(alias, cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2698" href="#"></a></td>
<td><pre>                return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2699" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2700" href="#"></a></td>
<td><pre>                return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2701" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2702" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2703" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2704" href="#"></a></td>
<td><pre>        // Try to establish trust chain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2705" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2706" href="#"></a></td>
<td><pre>            Certificate[] chain = establishCertChain(null, cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2707" href="#"></a></td>
<td><pre>            if (chain != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2708" href="#"></a></td>
<td><pre>                keyStore.setCertificateEntry(alias, cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2709" href="#"></a></td>
<td><pre>                return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2710" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2711" href="#"></a></td>
<td><pre>        } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2712" href="#"></a></td>
<td><pre>            // Print the cert and ask user if they really want to add it to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2713" href="#"></a></td>
<td><pre>            // their keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2714" href="#"></a></td>
<td><pre>            printX509Cert(cert, System.out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2715" href="#"></a></td>
<td><pre>            reply = getYesNoReply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2716" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Trust.this.certificate.no.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2717" href="#"></a></td>
<td><pre>            if (&quot;YES&quot;.equals(reply)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2718" href="#"></a></td>
<td><pre>                keyStore.setCertificateEntry(alias, cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2719" href="#"></a></td>
<td><pre>                return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2720" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2721" href="#"></a></td>
<td><pre>                return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2722" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2723" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2724" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2725" href="#"></a></td>
<td><pre>        return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2726" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2727" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2728" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2729" href="#"></a></td>
<td><pre>     * Prompts user for new password. New password must be different from</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2730" href="#"></a></td>
<td><pre>     * old one.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2731" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2732" href="#"></a></td>
<td><pre>     * @param prompt the message that gets prompted on the screen</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2733" href="#"></a></td>
<td><pre>     * @param oldPasswd the current (i.e., old) password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2734" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2735" href="#"></a></td>
<td><pre>    private char[] getNewPasswd(String prompt, char[] oldPasswd)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2736" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2737" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2738" href="#"></a></td>
<td><pre>        char[] entered = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2739" href="#"></a></td>
<td><pre>        char[] reentered = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2740" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2741" href="#"></a></td>
<td><pre>        for (int count = 0; count &lt; 3; count++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2742" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2743" href="#"></a></td>
<td><pre>                (rb.getString(&quot;New.prompt.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2744" href="#"></a></td>
<td><pre>            Object[] source = {prompt};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2745" href="#"></a></td>
<td><pre>            System.err.print(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2746" href="#"></a></td>
<td><pre>            entered = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2747" href="#"></a></td>
<td><pre>            passwords.add(entered);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2748" href="#"></a></td>
<td><pre>            if (entered == null || entered.length &lt; 6) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2749" href="#"></a></td>
<td><pre>                System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2750" href="#"></a></td>
<td><pre>                    (&quot;Password.is.too.short.must.be.at.least.6.characters&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2751" href="#"></a></td>
<td><pre>            } else if (Arrays.equals(entered, oldPasswd)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2752" href="#"></a></td>
<td><pre>                System.err.println(rb.getString(&quot;Passwords.must.differ&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2753" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2754" href="#"></a></td>
<td><pre>                form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2755" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;Re.enter.new.prompt.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2756" href="#"></a></td>
<td><pre>                Object[] src = {prompt};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2757" href="#"></a></td>
<td><pre>                System.err.print(form.format(src));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2758" href="#"></a></td>
<td><pre>                reentered = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2759" href="#"></a></td>
<td><pre>                passwords.add(reentered);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2760" href="#"></a></td>
<td><pre>                if (!Arrays.equals(entered, reentered)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2761" href="#"></a></td>
<td><pre>                    System.err.println</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2762" href="#"></a></td>
<td><pre>                        (rb.getString(&quot;They.don.t.match.Try.again&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2763" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2764" href="#"></a></td>
<td><pre>                    Arrays.fill(reentered, ' ');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2765" href="#"></a></td>
<td><pre>                    return entered;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2766" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2767" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2768" href="#"></a></td>
<td><pre>            if (entered != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2769" href="#"></a></td>
<td><pre>                Arrays.fill(entered, ' ');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2770" href="#"></a></td>
<td><pre>                entered = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2771" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2772" href="#"></a></td>
<td><pre>            if (reentered != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2773" href="#"></a></td>
<td><pre>                Arrays.fill(reentered, ' ');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2774" href="#"></a></td>
<td><pre>                reentered = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2775" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2776" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2777" href="#"></a></td>
<td><pre>        throw new Exception(rb.getString(&quot;Too.many.failures.try.later&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2778" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2779" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2780" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2781" href="#"></a></td>
<td><pre>     * Prompts user for alias name.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2782" href="#"></a></td>
<td><pre>     * @param prompt the {0} of &quot;Enter {0} alias name:  &quot; in prompt line</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2783" href="#"></a></td>
<td><pre>     * @returns the string entered by the user, without the \n at the end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2784" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2785" href="#"></a></td>
<td><pre>    private String getAlias(String prompt) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2786" href="#"></a></td>
<td><pre>        if (prompt != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2787" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2788" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Enter.prompt.alias.name.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2789" href="#"></a></td>
<td><pre>            Object[] source = {prompt};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2790" href="#"></a></td>
<td><pre>            System.err.print(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2791" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2792" href="#"></a></td>
<td><pre>            System.err.print(rb.getString(&quot;Enter.alias.name.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2793" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2794" href="#"></a></td>
<td><pre>        return (new BufferedReader(new InputStreamReader(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2795" href="#"></a></td>
<td><pre>                                        System.in))).readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2796" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2797" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2798" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2799" href="#"></a></td>
<td><pre>     * Prompts user for an input string from the command line (System.in)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2800" href="#"></a></td>
<td><pre>     * @prompt the prompt string printed</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2801" href="#"></a></td>
<td><pre>     * @returns the string entered by the user, without the \n at the end</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2802" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2803" href="#"></a></td>
<td><pre>    private String inputStringFromStdin(String prompt) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2804" href="#"></a></td>
<td><pre>        System.err.print(prompt);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2805" href="#"></a></td>
<td><pre>        return (new BufferedReader(new InputStreamReader(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2806" href="#"></a></td>
<td><pre>                                        System.in))).readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2807" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2808" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2809" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2810" href="#"></a></td>
<td><pre>     * Prompts user for key password. User may select to choose the same</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2811" href="#"></a></td>
<td><pre>     * password (&lt;code&gt;otherKeyPass&lt;/code&gt;) as for &lt;code&gt;otherAlias&lt;/code&gt;.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2812" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2813" href="#"></a></td>
<td><pre>    private char[] getKeyPasswd(String alias, String otherAlias,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2814" href="#"></a></td>
<td><pre>                                char[] otherKeyPass)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2815" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2816" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2817" href="#"></a></td>
<td><pre>        int count = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2818" href="#"></a></td>
<td><pre>        char[] keyPass = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2819" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2820" href="#"></a></td>
<td><pre>        do {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2821" href="#"></a></td>
<td><pre>            if (otherKeyPass != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2822" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2823" href="#"></a></td>
<td><pre>                        (&quot;Enter.key.password.for.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2824" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2825" href="#"></a></td>
<td><pre>                System.err.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2826" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2827" href="#"></a></td>
<td><pre>                form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2828" href="#"></a></td>
<td><pre>                        (&quot;.RETURN.if.same.as.for.otherAlias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2829" href="#"></a></td>
<td><pre>                Object[] src = {otherAlias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2830" href="#"></a></td>
<td><pre>                System.err.print(form.format(src));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2831" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2832" href="#"></a></td>
<td><pre>                MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2833" href="#"></a></td>
<td><pre>                        (&quot;Enter.key.password.for.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2834" href="#"></a></td>
<td><pre>                Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2835" href="#"></a></td>
<td><pre>                System.err.print(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2836" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2837" href="#"></a></td>
<td><pre>            System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2838" href="#"></a></td>
<td><pre>            keyPass = Password.readPassword(System.in);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2839" href="#"></a></td>
<td><pre>            passwords.add(keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2840" href="#"></a></td>
<td><pre>            if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2841" href="#"></a></td>
<td><pre>                keyPass = otherKeyPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2842" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2843" href="#"></a></td>
<td><pre>            count++;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2844" href="#"></a></td>
<td><pre>        } while ((keyPass == null) &amp;&amp; count &lt; 3);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2845" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2846" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2847" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(&quot;Too.many.failures.try.later&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2848" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2849" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2850" href="#"></a></td>
<td><pre>        return keyPass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2851" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2852" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2853" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2854" href="#"></a></td>
<td><pre>     * Prints a certificate in a human readable format.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2855" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2856" href="#"></a></td>
<td><pre>    private void printX509Cert(X509Certificate cert, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2857" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2858" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2859" href="#"></a></td>
<td><pre>        /*</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2860" href="#"></a></td>
<td><pre>        out.println(&quot;Owner: &quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2861" href="#"></a></td>
<td><pre>                    + cert.getSubjectDN().toString()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2862" href="#"></a></td>
<td><pre>                    + &quot;\n&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2863" href="#"></a></td>
<td><pre>                    + &quot;Issuer: &quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2864" href="#"></a></td>
<td><pre>                    + cert.getIssuerDN().toString()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2865" href="#"></a></td>
<td><pre>                    + &quot;\n&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2866" href="#"></a></td>
<td><pre>                    + &quot;Serial number: &quot; + cert.getSerialNumber().toString(16)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2867" href="#"></a></td>
<td><pre>                    + &quot;\n&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2868" href="#"></a></td>
<td><pre>                    + &quot;Valid from: &quot; + cert.getNotBefore().toString()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2869" href="#"></a></td>
<td><pre>                    + &quot; until: &quot; + cert.getNotAfter().toString()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2870" href="#"></a></td>
<td><pre>                    + &quot;\n&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2871" href="#"></a></td>
<td><pre>                    + &quot;Certificate fingerprints:\n&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2872" href="#"></a></td>
<td><pre>                    + &quot;\t MD5:  &quot; + getCertFingerPrint(&quot;MD5&quot;, cert)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2873" href="#"></a></td>
<td><pre>                    + &quot;\n&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2874" href="#"></a></td>
<td><pre>                    + &quot;\t SHA1: &quot; + getCertFingerPrint(&quot;SHA1&quot;, cert));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2875" href="#"></a></td>
<td><pre>        */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2876" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2877" href="#"></a></td>
<td><pre>        MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2878" href="#"></a></td>
<td><pre>                (rb.getString(&quot;.PATTERN.printX509Cert&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2879" href="#"></a></td>
<td><pre>        Object[] source = {cert.getSubjectDN().toString(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2880" href="#"></a></td>
<td><pre>                        cert.getIssuerDN().toString(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2881" href="#"></a></td>
<td><pre>                        cert.getSerialNumber().toString(16),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2882" href="#"></a></td>
<td><pre>                        cert.getNotBefore().toString(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2883" href="#"></a></td>
<td><pre>                        cert.getNotAfter().toString(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2884" href="#"></a></td>
<td><pre>                        getCertFingerPrint(&quot;MD5&quot;, cert),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2885" href="#"></a></td>
<td><pre>                        getCertFingerPrint(&quot;SHA1&quot;, cert),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2886" href="#"></a></td>
<td><pre>                        getCertFingerPrint(&quot;SHA-256&quot;, cert),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2887" href="#"></a></td>
<td><pre>                        cert.getSigAlgName(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2888" href="#"></a></td>
<td><pre>                        cert.getVersion()</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2889" href="#"></a></td>
<td><pre>                        };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2890" href="#"></a></td>
<td><pre>        out.println(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2891" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2892" href="#"></a></td>
<td><pre>        if (cert instanceof X509CertImpl) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2893" href="#"></a></td>
<td><pre>            X509CertImpl impl = (X509CertImpl)cert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2894" href="#"></a></td>
<td><pre>            X509CertInfo certInfo = (X509CertInfo)impl.get(X509CertImpl.NAME</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2895" href="#"></a></td>
<td><pre>                                                           + &quot;.&quot; +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2896" href="#"></a></td>
<td><pre>                                                           X509CertImpl.INFO);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2897" href="#"></a></td>
<td><pre>            CertificateExtensions exts = (CertificateExtensions)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2898" href="#"></a></td>
<td><pre>                    certInfo.get(X509CertInfo.EXTENSIONS);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2899" href="#"></a></td>
<td><pre>            if (exts != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2900" href="#"></a></td>
<td><pre>                printExtensions(rb.getString(&quot;Extensions.&quot;), exts, out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2901" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2902" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2903" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2904" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2905" href="#"></a></td>
<td><pre>    private static void printExtensions(String title, CertificateExtensions exts, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2906" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2907" href="#"></a></td>
<td><pre>        int extnum = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2908" href="#"></a></td>
<td><pre>        Iterator&lt;Extension&gt; i1 = exts.getAllExtensions().iterator();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2909" href="#"></a></td>
<td><pre>        Iterator&lt;Extension&gt; i2 = exts.getUnparseableExtensions().values().iterator();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2910" href="#"></a></td>
<td><pre>        while (i1.hasNext() || i2.hasNext()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2911" href="#"></a></td>
<td><pre>            Extension ext = i1.hasNext()?i1.next():i2.next();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2912" href="#"></a></td>
<td><pre>            if (extnum == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2913" href="#"></a></td>
<td><pre>                out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2914" href="#"></a></td>
<td><pre>                out.println(title);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2915" href="#"></a></td>
<td><pre>                out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2916" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2917" href="#"></a></td>
<td><pre>            out.print(&quot;#&quot;+(++extnum)+&quot;: &quot;+ ext);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2918" href="#"></a></td>
<td><pre>            if (ext.getClass() == Extension.class) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2919" href="#"></a></td>
<td><pre>                byte[] v = ext.getExtensionValue();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2920" href="#"></a></td>
<td><pre>                if (v.length == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2921" href="#"></a></td>
<td><pre>                    out.println(rb.getString(&quot;.Empty.value.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2922" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2923" href="#"></a></td>
<td><pre>                    new sun.misc.HexDumpEncoder().encodeBuffer(ext.getExtensionValue(), out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2924" href="#"></a></td>
<td><pre>                    out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2925" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2926" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2927" href="#"></a></td>
<td><pre>            out.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2928" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2929" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2930" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2931" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2932" href="#"></a></td>
<td><pre>     * Returns true if the certificate is self-signed, false otherwise.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2933" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2934" href="#"></a></td>
<td><pre>    private boolean isSelfSigned(X509Certificate cert) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2935" href="#"></a></td>
<td><pre>        return signedBy(cert, cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2936" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2937" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2938" href="#"></a></td>
<td><pre>    private boolean signedBy(X509Certificate end, X509Certificate ca) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2939" href="#"></a></td>
<td><pre>        if (!ca.getSubjectDN().equals(end.getIssuerDN())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2940" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2941" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2942" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2943" href="#"></a></td>
<td><pre>            end.verify(ca.getPublicKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2944" href="#"></a></td>
<td><pre>            return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2945" href="#"></a></td>
<td><pre>        } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2946" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2947" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2948" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2949" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2950" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2951" href="#"></a></td>
<td><pre>     * Locates a signer for a given certificate from a given keystore and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2952" href="#"></a></td>
<td><pre>     * returns the signer's certificate.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2953" href="#"></a></td>
<td><pre>     * @param cert the certificate whose signer is searched, not null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2954" href="#"></a></td>
<td><pre>     * @param ks the keystore to search with, not null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2955" href="#"></a></td>
<td><pre>     * @return &lt;code&gt;cert&lt;/code&gt; itself if it's already inside &lt;code&gt;ks&lt;/code&gt;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2956" href="#"></a></td>
<td><pre>     * or a certificate inside &lt;code&gt;ks&lt;/code&gt; who signs &lt;code&gt;cert&lt;/code&gt;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2957" href="#"></a></td>
<td><pre>     * or null otherwise.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2958" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2959" href="#"></a></td>
<td><pre>    private static Certificate getTrustedSigner(Certificate cert, KeyStore ks)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2960" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2961" href="#"></a></td>
<td><pre>        if (ks.getCertificateAlias(cert) != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2962" href="#"></a></td>
<td><pre>            return cert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2963" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2964" href="#"></a></td>
<td><pre>        for (Enumeration&lt;String&gt; aliases = ks.aliases();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2965" href="#"></a></td>
<td><pre>                aliases.hasMoreElements(); ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2966" href="#"></a></td>
<td><pre>            String name = aliases.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2967" href="#"></a></td>
<td><pre>            Certificate trustedCert = ks.getCertificate(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2968" href="#"></a></td>
<td><pre>            if (trustedCert != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2969" href="#"></a></td>
<td><pre>                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2970" href="#"></a></td>
<td><pre>                    cert.verify(trustedCert.getPublicKey());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2971" href="#"></a></td>
<td><pre>                    return trustedCert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2972" href="#"></a></td>
<td><pre>                } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2973" href="#"></a></td>
<td><pre>                    // Not verified, skip to the next one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2974" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2975" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2976" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2977" href="#"></a></td>
<td><pre>        return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2978" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2979" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2980" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2981" href="#"></a></td>
<td><pre>     * Gets an X.500 name suitable for inclusion in a certification request.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2982" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2983" href="#"></a></td>
<td><pre>    private X500Name getX500Name() throws IOException {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2984" href="#"></a></td>
<td><pre>        BufferedReader in;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2985" href="#"></a></td>
<td><pre>        in = new BufferedReader(new InputStreamReader(System.in));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2986" href="#"></a></td>
<td><pre>        String commonName = &quot;Unknown&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2987" href="#"></a></td>
<td><pre>        String organizationalUnit = &quot;Unknown&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2988" href="#"></a></td>
<td><pre>        String organization = &quot;Unknown&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2989" href="#"></a></td>
<td><pre>        String city = &quot;Unknown&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2990" href="#"></a></td>
<td><pre>        String state = &quot;Unknown&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2991" href="#"></a></td>
<td><pre>        String country = &quot;Unknown&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2992" href="#"></a></td>
<td><pre>        X500Name name;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2993" href="#"></a></td>
<td><pre>        String userInput = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2994" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2995" href="#"></a></td>
<td><pre>        int maxRetry = 20;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2996" href="#"></a></td>
<td><pre>        do {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2997" href="#"></a></td>
<td><pre>            if (maxRetry-- &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2998" href="#"></a></td>
<td><pre>                throw new RuntimeException(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="2999" href="#"></a></td>
<td><pre>                        &quot;Too.many.retries.program.terminated&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3000" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3001" href="#"></a></td>
<td><pre>            commonName = inputString(in,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3002" href="#"></a></td>
<td><pre>                    rb.getString(&quot;What.is.your.first.and.last.name.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3003" href="#"></a></td>
<td><pre>                    commonName);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3004" href="#"></a></td>
<td><pre>            organizationalUnit = inputString(in,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3005" href="#"></a></td>
<td><pre>                    rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3006" href="#"></a></td>
<td><pre>                        (&quot;What.is.the.name.of.your.organizational.unit.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3007" href="#"></a></td>
<td><pre>                    organizationalUnit);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3008" href="#"></a></td>
<td><pre>            organization = inputString(in,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3009" href="#"></a></td>
<td><pre>                    rb.getString(&quot;What.is.the.name.of.your.organization.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3010" href="#"></a></td>
<td><pre>                    organization);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3011" href="#"></a></td>
<td><pre>            city = inputString(in,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3012" href="#"></a></td>
<td><pre>                    rb.getString(&quot;What.is.the.name.of.your.City.or.Locality.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3013" href="#"></a></td>
<td><pre>                    city);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3014" href="#"></a></td>
<td><pre>            state = inputString(in,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3015" href="#"></a></td>
<td><pre>                    rb.getString(&quot;What.is.the.name.of.your.State.or.Province.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3016" href="#"></a></td>
<td><pre>                    state);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3017" href="#"></a></td>
<td><pre>            country = inputString(in,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3018" href="#"></a></td>
<td><pre>                    rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3019" href="#"></a></td>
<td><pre>                        (&quot;What.is.the.two.letter.country.code.for.this.unit.&quot;),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3020" href="#"></a></td>
<td><pre>                    country);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3021" href="#"></a></td>
<td><pre>            name = new X500Name(commonName, organizationalUnit, organization,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3022" href="#"></a></td>
<td><pre>                                city, state, country);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3023" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3024" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Is.name.correct.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3025" href="#"></a></td>
<td><pre>            Object[] source = {name};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3026" href="#"></a></td>
<td><pre>            userInput = inputString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3027" href="#"></a></td>
<td><pre>                (in, form.format(source), rb.getString(&quot;no&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3028" href="#"></a></td>
<td><pre>        } while (collator.compare(userInput, rb.getString(&quot;yes&quot;)) != 0 &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3029" href="#"></a></td>
<td><pre>                 collator.compare(userInput, rb.getString(&quot;y&quot;)) != 0);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3030" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3031" href="#"></a></td>
<td><pre>        System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3032" href="#"></a></td>
<td><pre>        return name;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3033" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3034" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3035" href="#"></a></td>
<td><pre>    private String inputString(BufferedReader in, String prompt,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3036" href="#"></a></td>
<td><pre>                               String defaultValue)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3037" href="#"></a></td>
<td><pre>        throws IOException</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3038" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3039" href="#"></a></td>
<td><pre>        System.err.println(prompt);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3040" href="#"></a></td>
<td><pre>        MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3041" href="#"></a></td>
<td><pre>                (rb.getString(&quot;.defaultValue.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3042" href="#"></a></td>
<td><pre>        Object[] source = {defaultValue};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3043" href="#"></a></td>
<td><pre>        System.err.print(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3044" href="#"></a></td>
<td><pre>        System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3045" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3046" href="#"></a></td>
<td><pre>        String value = in.readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3047" href="#"></a></td>
<td><pre>        if (value == null || collator.compare(value, &quot;&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3048" href="#"></a></td>
<td><pre>            value = defaultValue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3049" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3050" href="#"></a></td>
<td><pre>        return value;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3051" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3052" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3053" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3054" href="#"></a></td>
<td><pre>     * Writes an X.509 certificate in base64 or binary encoding to an output</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3055" href="#"></a></td>
<td><pre>     * stream.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3056" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3057" href="#"></a></td>
<td><pre>    private void dumpCert(Certificate cert, PrintStream out)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3058" href="#"></a></td>
<td><pre>        throws IOException, CertificateException</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3059" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3060" href="#"></a></td>
<td><pre>        if (rfc) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3061" href="#"></a></td>
<td><pre>            out.println(X509Factory.BEGIN_CERT);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3062" href="#"></a></td>
<td><pre>            out.println(Base64.getMimeEncoder().encodeToString(cert.getEncoded()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3063" href="#"></a></td>
<td><pre>            out.println(X509Factory.END_CERT);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3064" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3065" href="#"></a></td>
<td><pre>            out.write(cert.getEncoded()); // binary</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3066" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3067" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3068" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3069" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3070" href="#"></a></td>
<td><pre>     * Converts a byte to hex digit and writes to the supplied buffer</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3071" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3072" href="#"></a></td>
<td><pre>    private void byte2hex(byte b, StringBuffer buf) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3073" href="#"></a></td>
<td><pre>        char[] hexChars = { '0', '1', '2', '3', '4', '5', '6', '7', '8',</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3074" href="#"></a></td>
<td><pre>                            '9', 'A', 'B', 'C', 'D', 'E', 'F' };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3075" href="#"></a></td>
<td><pre>        int high = ((b &amp; 0xf0) &gt;&gt; 4);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3076" href="#"></a></td>
<td><pre>        int low = (b &amp; 0x0f);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3077" href="#"></a></td>
<td><pre>        buf.append(hexChars[high]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3078" href="#"></a></td>
<td><pre>        buf.append(hexChars[low]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3079" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3080" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3081" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3082" href="#"></a></td>
<td><pre>     * Converts a byte array to hex string</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3083" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3084" href="#"></a></td>
<td><pre>    private String toHexString(byte[] block) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3085" href="#"></a></td>
<td><pre>        StringBuffer buf = new StringBuffer();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3086" href="#"></a></td>
<td><pre>        int len = block.length;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3087" href="#"></a></td>
<td><pre>        for (int i = 0; i &lt; len; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3088" href="#"></a></td>
<td><pre>             byte2hex(block[i], buf);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3089" href="#"></a></td>
<td><pre>             if (i &lt; len-1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3090" href="#"></a></td>
<td><pre>                 buf.append(&quot;:&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3091" href="#"></a></td>
<td><pre>             }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3092" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3093" href="#"></a></td>
<td><pre>        return buf.toString();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3094" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3095" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3096" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3097" href="#"></a></td>
<td><pre>     * Recovers (private) key associated with given alias.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3098" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3099" href="#"></a></td>
<td><pre>     * @return an array of objects, where the 1st element in the array is the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3100" href="#"></a></td>
<td><pre>     * recovered private key, and the 2nd element is the password used to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3101" href="#"></a></td>
<td><pre>     * recover it.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3102" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3103" href="#"></a></td>
<td><pre>    private Pair&lt;Key,char[]&gt; recoverKey(String alias, char[] storePass,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3104" href="#"></a></td>
<td><pre>                                       char[] keyPass)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3105" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3106" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3107" href="#"></a></td>
<td><pre>        Key key = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3108" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3109" href="#"></a></td>
<td><pre>        if (keyStore.containsAlias(alias) == false) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3110" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3111" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3112" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3113" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3114" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3115" href="#"></a></td>
<td><pre>        if (!keyStore.entryInstanceOf(alias, KeyStore.PrivateKeyEntry.class) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3116" href="#"></a></td>
<td><pre>                !keyStore.entryInstanceOf(alias, KeyStore.SecretKeyEntry.class)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3117" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3118" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.has.no.key&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3119" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3120" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3121" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3122" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3123" href="#"></a></td>
<td><pre>        if (keyPass == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3124" href="#"></a></td>
<td><pre>            // Try to recover the key using the keystore password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3125" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3126" href="#"></a></td>
<td><pre>                key = keyStore.getKey(alias, storePass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3127" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3128" href="#"></a></td>
<td><pre>                keyPass = storePass;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3129" href="#"></a></td>
<td><pre>                passwords.add(keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3130" href="#"></a></td>
<td><pre>            } catch (UnrecoverableKeyException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3131" href="#"></a></td>
<td><pre>                // Did not work out, so prompt user for key password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3132" href="#"></a></td>
<td><pre>                if (!token) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3133" href="#"></a></td>
<td><pre>                    keyPass = getKeyPasswd(alias, null, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3134" href="#"></a></td>
<td><pre>                    key = keyStore.getKey(alias, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3135" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3136" href="#"></a></td>
<td><pre>                    throw e;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3137" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3138" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3139" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3140" href="#"></a></td>
<td><pre>            key = keyStore.getKey(alias, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3141" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3142" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3143" href="#"></a></td>
<td><pre>        return Pair.of(key, keyPass);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3144" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3145" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3146" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3147" href="#"></a></td>
<td><pre>     * Recovers entry associated with given alias.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3148" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3149" href="#"></a></td>
<td><pre>     * @return an array of objects, where the 1st element in the array is the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3150" href="#"></a></td>
<td><pre>     * recovered entry, and the 2nd element is the password used to</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3151" href="#"></a></td>
<td><pre>     * recover it (null if no password).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3152" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3153" href="#"></a></td>
<td><pre>    private Pair&lt;Entry,char[]&gt; recoverEntry(KeyStore ks,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3154" href="#"></a></td>
<td><pre>                            String alias,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3155" href="#"></a></td>
<td><pre>                            char[] pstore,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3156" href="#"></a></td>
<td><pre>                            char[] pkey) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3157" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3158" href="#"></a></td>
<td><pre>        if (ks.containsAlias(alias) == false) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3159" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3160" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Alias.alias.does.not.exist&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3161" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3162" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3163" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3164" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3165" href="#"></a></td>
<td><pre>        PasswordProtection pp = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3166" href="#"></a></td>
<td><pre>        Entry entry;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3167" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3168" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3169" href="#"></a></td>
<td><pre>            // First attempt to access entry without key password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3170" href="#"></a></td>
<td><pre>            // (PKCS11 entry or trusted certificate entry, for example)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3171" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3172" href="#"></a></td>
<td><pre>            entry = ks.getEntry(alias, pp);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3173" href="#"></a></td>
<td><pre>            pkey = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3174" href="#"></a></td>
<td><pre>        } catch (UnrecoverableEntryException une) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3175" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3176" href="#"></a></td>
<td><pre>            if(P11KEYSTORE.equalsIgnoreCase(ks.getType()) ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3177" href="#"></a></td>
<td><pre>                KeyStoreUtil.isWindowsKeyStore(ks.getType())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3178" href="#"></a></td>
<td><pre>                // should not happen, but a possibility</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3179" href="#"></a></td>
<td><pre>                throw une;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3180" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3181" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3182" href="#"></a></td>
<td><pre>            // entry is protected</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3183" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3184" href="#"></a></td>
<td><pre>            if (pkey != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3185" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3186" href="#"></a></td>
<td><pre>                // try provided key password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3187" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3188" href="#"></a></td>
<td><pre>                pp = new PasswordProtection(pkey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3189" href="#"></a></td>
<td><pre>                entry = ks.getEntry(alias, pp);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3190" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3191" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3192" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3193" href="#"></a></td>
<td><pre>                // try store pass</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3194" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3195" href="#"></a></td>
<td><pre>                try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3196" href="#"></a></td>
<td><pre>                    pp = new PasswordProtection(pstore);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3197" href="#"></a></td>
<td><pre>                    entry = ks.getEntry(alias, pp);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3198" href="#"></a></td>
<td><pre>                    pkey = pstore;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3199" href="#"></a></td>
<td><pre>                } catch (UnrecoverableEntryException une2) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3200" href="#"></a></td>
<td><pre>                    if (P12KEYSTORE.equalsIgnoreCase(ks.getType())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3201" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3202" href="#"></a></td>
<td><pre>                        // P12 keystore currently does not support separate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3203" href="#"></a></td>
<td><pre>                        // store and entry passwords</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3204" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3205" href="#"></a></td>
<td><pre>                        throw une2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3206" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3207" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3208" href="#"></a></td>
<td><pre>                        // prompt for entry password</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3209" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3210" href="#"></a></td>
<td><pre>                        pkey = getKeyPasswd(alias, null, null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3211" href="#"></a></td>
<td><pre>                        pp = new PasswordProtection(pkey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3212" href="#"></a></td>
<td><pre>                        entry = ks.getEntry(alias, pp);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3213" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3214" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3215" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3216" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3217" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3218" href="#"></a></td>
<td><pre>        return Pair.of(entry, pkey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3219" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3220" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3221" href="#"></a></td>
<td><pre>     * Gets the requested finger print of the certificate.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3222" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3223" href="#"></a></td>
<td><pre>    private String getCertFingerPrint(String mdAlg, Certificate cert)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3224" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3225" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3226" href="#"></a></td>
<td><pre>        byte[] encCertInfo = cert.getEncoded();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3227" href="#"></a></td>
<td><pre>        MessageDigest md = MessageDigest.getInstance(mdAlg);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3228" href="#"></a></td>
<td><pre>        byte[] digest = md.digest(encCertInfo);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3229" href="#"></a></td>
<td><pre>        return toHexString(digest);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3230" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3231" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3232" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3233" href="#"></a></td>
<td><pre>     * Prints warning about missing integrity check.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3234" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3235" href="#"></a></td>
<td><pre>    private void printWarning() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3236" href="#"></a></td>
<td><pre>        System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3237" href="#"></a></td>
<td><pre>        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3238" href="#"></a></td>
<td><pre>            (&quot;.WARNING.WARNING.WARNING.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3239" href="#"></a></td>
<td><pre>        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3240" href="#"></a></td>
<td><pre>            (&quot;.The.integrity.of.the.information.stored.in.your.keystore.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3241" href="#"></a></td>
<td><pre>        System.err.println(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3242" href="#"></a></td>
<td><pre>            (&quot;.WARNING.WARNING.WARNING.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3243" href="#"></a></td>
<td><pre>        System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3244" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3245" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3246" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3247" href="#"></a></td>
<td><pre>     * Validates chain in certification reply, and returns the ordered</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3248" href="#"></a></td>
<td><pre>     * elements of the chain (with user certificate first, and root</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3249" href="#"></a></td>
<td><pre>     * certificate last in the array).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3250" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3251" href="#"></a></td>
<td><pre>     * @param alias the alias name</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3252" href="#"></a></td>
<td><pre>     * @param userCert the user certificate of the alias</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3253" href="#"></a></td>
<td><pre>     * @param replyCerts the chain provided in the reply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3254" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3255" href="#"></a></td>
<td><pre>    private Certificate[] validateReply(String alias,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3256" href="#"></a></td>
<td><pre>                                        Certificate userCert,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3257" href="#"></a></td>
<td><pre>                                        Certificate[] replyCerts)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3258" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3259" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3260" href="#"></a></td>
<td><pre>        // order the certs in the reply (bottom-up).</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3261" href="#"></a></td>
<td><pre>        // we know that all certs in the reply are of type X.509, because</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3262" href="#"></a></td>
<td><pre>        // we parsed them using an X.509 certificate factory</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3263" href="#"></a></td>
<td><pre>        int i;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3264" href="#"></a></td>
<td><pre>        PublicKey userPubKey = userCert.getPublicKey();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3265" href="#"></a></td>
<td><pre>        for (i=0; i&lt;replyCerts.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3266" href="#"></a></td>
<td><pre>            if (userPubKey.equals(replyCerts[i].getPublicKey())) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3267" href="#"></a></td>
<td><pre>                break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3268" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3269" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3270" href="#"></a></td>
<td><pre>        if (i == replyCerts.length) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3271" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3272" href="#"></a></td>
<td><pre>                (&quot;Certificate.reply.does.not.contain.public.key.for.alias.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3273" href="#"></a></td>
<td><pre>            Object[] source = {alias};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3274" href="#"></a></td>
<td><pre>            throw new Exception(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3275" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3276" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3277" href="#"></a></td>
<td><pre>        Certificate tmpCert = replyCerts[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3278" href="#"></a></td>
<td><pre>        replyCerts[0] = replyCerts[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3279" href="#"></a></td>
<td><pre>        replyCerts[i] = tmpCert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3280" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3281" href="#"></a></td>
<td><pre>        X509Certificate thisCert = (X509Certificate)replyCerts[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3282" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3283" href="#"></a></td>
<td><pre>        for (i=1; i &lt; replyCerts.length-1; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3284" href="#"></a></td>
<td><pre>            // find a cert in the reply who signs thisCert</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3285" href="#"></a></td>
<td><pre>            int j;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3286" href="#"></a></td>
<td><pre>            for (j=i; j&lt;replyCerts.length; j++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3287" href="#"></a></td>
<td><pre>                if (signedBy(thisCert, (X509Certificate)replyCerts[j])) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3288" href="#"></a></td>
<td><pre>                    tmpCert = replyCerts[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3289" href="#"></a></td>
<td><pre>                    replyCerts[i] = replyCerts[j];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3290" href="#"></a></td>
<td><pre>                    replyCerts[j] = tmpCert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3291" href="#"></a></td>
<td><pre>                    thisCert = (X509Certificate)replyCerts[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3292" href="#"></a></td>
<td><pre>                    break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3293" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3294" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3295" href="#"></a></td>
<td><pre>            if (j == replyCerts.length) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3296" href="#"></a></td>
<td><pre>                throw new Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3297" href="#"></a></td>
<td><pre>                    (rb.getString(&quot;Incomplete.certificate.chain.in.reply&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3298" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3299" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3300" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3301" href="#"></a></td>
<td><pre>        if (noprompt) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3302" href="#"></a></td>
<td><pre>            return replyCerts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3303" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3304" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3305" href="#"></a></td>
<td><pre>        // do we trust the cert at the top?</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3306" href="#"></a></td>
<td><pre>        Certificate topCert = replyCerts[replyCerts.length-1];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3307" href="#"></a></td>
<td><pre>        Certificate root = getTrustedSigner(topCert, keyStore);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3308" href="#"></a></td>
<td><pre>        if (root == null &amp;&amp; trustcacerts &amp;&amp; caks != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3309" href="#"></a></td>
<td><pre>            root = getTrustedSigner(topCert, caks);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3310" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3311" href="#"></a></td>
<td><pre>        if (root == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3312" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3313" href="#"></a></td>
<td><pre>            System.err.println</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3314" href="#"></a></td>
<td><pre>                    (rb.getString(&quot;Top.level.certificate.in.reply.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3315" href="#"></a></td>
<td><pre>            printX509Cert((X509Certificate)topCert, System.out);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3316" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3317" href="#"></a></td>
<td><pre>            System.err.print(rb.getString(&quot;.is.not.trusted.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3318" href="#"></a></td>
<td><pre>            String reply = getYesNoReply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3319" href="#"></a></td>
<td><pre>                    (rb.getString(&quot;Install.reply.anyway.no.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3320" href="#"></a></td>
<td><pre>            if (&quot;NO&quot;.equals(reply)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3321" href="#"></a></td>
<td><pre>                return null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3322" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3323" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3324" href="#"></a></td>
<td><pre>            if (root != topCert) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3325" href="#"></a></td>
<td><pre>                // append the root CA cert to the chain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3326" href="#"></a></td>
<td><pre>                Certificate[] tmpCerts =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3327" href="#"></a></td>
<td><pre>                    new Certificate[replyCerts.length+1];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3328" href="#"></a></td>
<td><pre>                System.arraycopy(replyCerts, 0, tmpCerts, 0,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3329" href="#"></a></td>
<td><pre>                                 replyCerts.length);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3330" href="#"></a></td>
<td><pre>                tmpCerts[tmpCerts.length-1] = root;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3331" href="#"></a></td>
<td><pre>                replyCerts = tmpCerts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3332" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3333" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3334" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3335" href="#"></a></td>
<td><pre>        return replyCerts;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3336" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3337" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3338" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3339" href="#"></a></td>
<td><pre>     * Establishes a certificate chain (using trusted certificates in the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3340" href="#"></a></td>
<td><pre>     * keystore), starting with the user certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3341" href="#"></a></td>
<td><pre>     * and ending at a self-signed certificate found in the keystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3342" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3343" href="#"></a></td>
<td><pre>     * @param userCert the user certificate of the alias</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3344" href="#"></a></td>
<td><pre>     * @param certToVerify the single certificate provided in the reply</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3345" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3346" href="#"></a></td>
<td><pre>    private Certificate[] establishCertChain(Certificate userCert,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3347" href="#"></a></td>
<td><pre>                                             Certificate certToVerify)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3348" href="#"></a></td>
<td><pre>        throws Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3349" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3350" href="#"></a></td>
<td><pre>        if (userCert != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3351" href="#"></a></td>
<td><pre>            // Make sure that the public key of the certificate reply matches</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3352" href="#"></a></td>
<td><pre>            // the original public key in the keystore</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3353" href="#"></a></td>
<td><pre>            PublicKey origPubKey = userCert.getPublicKey();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3354" href="#"></a></td>
<td><pre>            PublicKey replyPubKey = certToVerify.getPublicKey();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3355" href="#"></a></td>
<td><pre>            if (!origPubKey.equals(replyPubKey)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3356" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3357" href="#"></a></td>
<td><pre>                        (&quot;Public.keys.in.reply.and.keystore.don.t.match&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3358" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3359" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3360" href="#"></a></td>
<td><pre>            // If the two certs are identical, we're done: no need to import</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3361" href="#"></a></td>
<td><pre>            // anything</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3362" href="#"></a></td>
<td><pre>            if (certToVerify.equals(userCert)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3363" href="#"></a></td>
<td><pre>                throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3364" href="#"></a></td>
<td><pre>                        (&quot;Certificate.reply.and.certificate.in.keystore.are.identical&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3365" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3366" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3367" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3368" href="#"></a></td>
<td><pre>        // Build a hash table of all certificates in the keystore.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3369" href="#"></a></td>
<td><pre>        // Use the subject distinguished name as the key into the hash table.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3370" href="#"></a></td>
<td><pre>        // All certificates associated with the same subject distinguished</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3371" href="#"></a></td>
<td><pre>        // name are stored in the same hash table entry as a vector.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3372" href="#"></a></td>
<td><pre>        Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt; certs = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3373" href="#"></a></td>
<td><pre>        if (keyStore.size() &gt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3374" href="#"></a></td>
<td><pre>            certs = new Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt;(11);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3375" href="#"></a></td>
<td><pre>            keystorecerts2Hashtable(keyStore, certs);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3376" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3377" href="#"></a></td>
<td><pre>        if (trustcacerts) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3378" href="#"></a></td>
<td><pre>            if (caks!=null &amp;&amp; caks.size()&gt;0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3379" href="#"></a></td>
<td><pre>                if (certs == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3380" href="#"></a></td>
<td><pre>                    certs = new Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt;(11);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3381" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3382" href="#"></a></td>
<td><pre>                keystorecerts2Hashtable(caks, certs);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3383" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3384" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3385" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3386" href="#"></a></td>
<td><pre>        // start building chain</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3387" href="#"></a></td>
<td><pre>        Vector&lt;Certificate&gt; chain = new Vector&lt;&gt;(2);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3388" href="#"></a></td>
<td><pre>        if (buildChain((X509Certificate)certToVerify, chain, certs)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3389" href="#"></a></td>
<td><pre>            Certificate[] newChain = new Certificate[chain.size()];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3390" href="#"></a></td>
<td><pre>            // buildChain() returns chain with self-signed root-cert first and</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3391" href="#"></a></td>
<td><pre>            // user-cert last, so we need to invert the chain before we store</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3392" href="#"></a></td>
<td><pre>            // it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3393" href="#"></a></td>
<td><pre>            int j=0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3394" href="#"></a></td>
<td><pre>            for (int i=chain.size()-1; i&gt;=0; i--) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3395" href="#"></a></td>
<td><pre>                newChain[j] = chain.elementAt(i);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3396" href="#"></a></td>
<td><pre>                j++;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3397" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3398" href="#"></a></td>
<td><pre>            return newChain;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3399" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3400" href="#"></a></td>
<td><pre>            throw new Exception</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3401" href="#"></a></td>
<td><pre>                (rb.getString(&quot;Failed.to.establish.chain.from.reply&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3402" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3403" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3404" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3405" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3406" href="#"></a></td>
<td><pre>     * Recursively tries to establish chain from pool of trusted certs.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3407" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3408" href="#"></a></td>
<td><pre>     * @param certToVerify the cert that needs to be verified.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3409" href="#"></a></td>
<td><pre>     * @param chain the chain that's being built.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3410" href="#"></a></td>
<td><pre>     * @param certs the pool of trusted certs</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3411" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3412" href="#"></a></td>
<td><pre>     * @return true if successful, false otherwise.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3413" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3414" href="#"></a></td>
<td><pre>    private boolean buildChain(X509Certificate certToVerify,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3415" href="#"></a></td>
<td><pre>                        Vector&lt;Certificate&gt; chain,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3416" href="#"></a></td>
<td><pre>                        Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt; certs) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3417" href="#"></a></td>
<td><pre>        Principal issuer = certToVerify.getIssuerDN();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3418" href="#"></a></td>
<td><pre>        if (isSelfSigned(certToVerify)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3419" href="#"></a></td>
<td><pre>            // reached self-signed root cert;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3420" href="#"></a></td>
<td><pre>            // no verification needed because it's trusted.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3421" href="#"></a></td>
<td><pre>            chain.addElement(certToVerify);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3422" href="#"></a></td>
<td><pre>            return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3423" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3424" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3425" href="#"></a></td>
<td><pre>        // Get the issuer's certificate(s)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3426" href="#"></a></td>
<td><pre>        Vector&lt;Certificate&gt; vec = certs.get(issuer);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3427" href="#"></a></td>
<td><pre>        if (vec == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3428" href="#"></a></td>
<td><pre>            return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3429" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3430" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3431" href="#"></a></td>
<td><pre>        // Try out each certificate in the vector, until we find one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3432" href="#"></a></td>
<td><pre>        // whose public key verifies the signature of the certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3433" href="#"></a></td>
<td><pre>        // in question.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3434" href="#"></a></td>
<td><pre>        for (Enumeration&lt;Certificate&gt; issuerCerts = vec.elements();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3435" href="#"></a></td>
<td><pre>             issuerCerts.hasMoreElements(); ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3436" href="#"></a></td>
<td><pre>            X509Certificate issuerCert</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3437" href="#"></a></td>
<td><pre>                = (X509Certificate)issuerCerts.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3438" href="#"></a></td>
<td><pre>            PublicKey issuerPubKey = issuerCert.getPublicKey();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3439" href="#"></a></td>
<td><pre>            try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3440" href="#"></a></td>
<td><pre>                certToVerify.verify(issuerPubKey);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3441" href="#"></a></td>
<td><pre>            } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3442" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3443" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3444" href="#"></a></td>
<td><pre>            if (buildChain(issuerCert, chain, certs)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3445" href="#"></a></td>
<td><pre>                chain.addElement(certToVerify);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3446" href="#"></a></td>
<td><pre>                return true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3447" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3448" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3449" href="#"></a></td>
<td><pre>        return false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3450" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3451" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3452" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3453" href="#"></a></td>
<td><pre>     * Prompts user for yes/no decision.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3454" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3455" href="#"></a></td>
<td><pre>     * @return the user's decision, can only be &quot;YES&quot; or &quot;NO&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3456" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3457" href="#"></a></td>
<td><pre>    private String getYesNoReply(String prompt)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3458" href="#"></a></td>
<td><pre>        throws IOException</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3459" href="#"></a></td>
<td><pre>    {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3460" href="#"></a></td>
<td><pre>        String reply = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3461" href="#"></a></td>
<td><pre>        int maxRetry = 20;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3462" href="#"></a></td>
<td><pre>        do {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3463" href="#"></a></td>
<td><pre>            if (maxRetry-- &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3464" href="#"></a></td>
<td><pre>                throw new RuntimeException(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3465" href="#"></a></td>
<td><pre>                        &quot;Too.many.retries.program.terminated&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3466" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3467" href="#"></a></td>
<td><pre>            System.err.print(prompt);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3468" href="#"></a></td>
<td><pre>            System.err.flush();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3469" href="#"></a></td>
<td><pre>            reply = (new BufferedReader(new InputStreamReader</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3470" href="#"></a></td>
<td><pre>                                        (System.in))).readLine();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3471" href="#"></a></td>
<td><pre>            if (collator.compare(reply, &quot;&quot;) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3472" href="#"></a></td>
<td><pre>                collator.compare(reply, rb.getString(&quot;n&quot;)) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3473" href="#"></a></td>
<td><pre>                collator.compare(reply, rb.getString(&quot;no&quot;)) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3474" href="#"></a></td>
<td><pre>                reply = &quot;NO&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3475" href="#"></a></td>
<td><pre>            } else if (collator.compare(reply, rb.getString(&quot;y&quot;)) == 0 ||</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3476" href="#"></a></td>
<td><pre>                       collator.compare(reply, rb.getString(&quot;yes&quot;)) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3477" href="#"></a></td>
<td><pre>                reply = &quot;YES&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3478" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3479" href="#"></a></td>
<td><pre>                System.err.println(rb.getString(&quot;Wrong.answer.try.again&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3480" href="#"></a></td>
<td><pre>                reply = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3481" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3482" href="#"></a></td>
<td><pre>        } while (reply == null);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3483" href="#"></a></td>
<td><pre>        return reply;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3484" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3485" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3486" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3487" href="#"></a></td>
<td><pre>     * Stores the (leaf) certificates of a keystore in a hashtable.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3488" href="#"></a></td>
<td><pre>     * All certs belonging to the same CA are stored in a vector that</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3489" href="#"></a></td>
<td><pre>     * in turn is stored in the hashtable, keyed by the CA's subject DN</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3490" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3491" href="#"></a></td>
<td><pre>    private void keystorecerts2Hashtable(KeyStore ks,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3492" href="#"></a></td>
<td><pre>                Hashtable&lt;Principal, Vector&lt;Certificate&gt;&gt; hash)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3493" href="#"></a></td>
<td><pre>        throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3494" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3495" href="#"></a></td>
<td><pre>        for (Enumeration&lt;String&gt; aliases = ks.aliases();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3496" href="#"></a></td>
<td><pre>                                        aliases.hasMoreElements(); ) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3497" href="#"></a></td>
<td><pre>            String alias = aliases.nextElement();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3498" href="#"></a></td>
<td><pre>            Certificate cert = ks.getCertificate(alias);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3499" href="#"></a></td>
<td><pre>            if (cert != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3500" href="#"></a></td>
<td><pre>                Principal subjectDN = ((X509Certificate)cert).getSubjectDN();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3501" href="#"></a></td>
<td><pre>                Vector&lt;Certificate&gt; vec = hash.get(subjectDN);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3502" href="#"></a></td>
<td><pre>                if (vec == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3503" href="#"></a></td>
<td><pre>                    vec = new Vector&lt;Certificate&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3504" href="#"></a></td>
<td><pre>                    vec.addElement(cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3505" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3506" href="#"></a></td>
<td><pre>                    if (!vec.contains(cert)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3507" href="#"></a></td>
<td><pre>                        vec.addElement(cert);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3508" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3509" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3510" href="#"></a></td>
<td><pre>                hash.put(subjectDN, vec);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3511" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3512" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3513" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3514" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3515" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3516" href="#"></a></td>
<td><pre>     * Returns the issue time that's specified the -startdate option</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3517" href="#"></a></td>
<td><pre>     * @param s the value of -startdate option</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3518" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3519" href="#"></a></td>
<td><pre>    private static Date getStartDate(String s) throws IOException {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3520" href="#"></a></td>
<td><pre>        Calendar c = new GregorianCalendar();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3521" href="#"></a></td>
<td><pre>        if (s != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3522" href="#"></a></td>
<td><pre>            IOException ioe = new IOException(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3523" href="#"></a></td>
<td><pre>                    rb.getString(&quot;Illegal.startdate.value&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3524" href="#"></a></td>
<td><pre>            int len = s.length();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3525" href="#"></a></td>
<td><pre>            if (len == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3526" href="#"></a></td>
<td><pre>                throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3527" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3528" href="#"></a></td>
<td><pre>            if (s.charAt(0) == '-' || s.charAt(0) == '+') {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3529" href="#"></a></td>
<td><pre>                // Form 1: ([+-]nnn[ymdHMS])+</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3530" href="#"></a></td>
<td><pre>                int start = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3531" href="#"></a></td>
<td><pre>                while (start &lt; len) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3532" href="#"></a></td>
<td><pre>                    int sign = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3533" href="#"></a></td>
<td><pre>                    switch (s.charAt(start)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3534" href="#"></a></td>
<td><pre>                        case '+': sign = 1; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3535" href="#"></a></td>
<td><pre>                        case '-': sign = -1; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3536" href="#"></a></td>
<td><pre>                        default: throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3537" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3538" href="#"></a></td>
<td><pre>                    int i = start+1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3539" href="#"></a></td>
<td><pre>                    for (; i&lt;len; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3540" href="#"></a></td>
<td><pre>                        char ch = s.charAt(i);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3541" href="#"></a></td>
<td><pre>                        if (ch &lt; '0' || ch &gt; '9') break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3542" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3543" href="#"></a></td>
<td><pre>                    if (i == start+1) throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3544" href="#"></a></td>
<td><pre>                    int number = Integer.parseInt(s.substring(start+1, i));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3545" href="#"></a></td>
<td><pre>                    if (i &gt;= len) throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3546" href="#"></a></td>
<td><pre>                    int unit = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3547" href="#"></a></td>
<td><pre>                    switch (s.charAt(i)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3548" href="#"></a></td>
<td><pre>                        case 'y': unit = Calendar.YEAR; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3549" href="#"></a></td>
<td><pre>                        case 'm': unit = Calendar.MONTH; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3550" href="#"></a></td>
<td><pre>                        case 'd': unit = Calendar.DATE; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3551" href="#"></a></td>
<td><pre>                        case 'H': unit = Calendar.HOUR; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3552" href="#"></a></td>
<td><pre>                        case 'M': unit = Calendar.MINUTE; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3553" href="#"></a></td>
<td><pre>                        case 'S': unit = Calendar.SECOND; break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3554" href="#"></a></td>
<td><pre>                        default: throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3555" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3556" href="#"></a></td>
<td><pre>                    c.add(unit, sign * number);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3557" href="#"></a></td>
<td><pre>                    start = i + 1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3558" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3559" href="#"></a></td>
<td><pre>            } else  {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3560" href="#"></a></td>
<td><pre>                // Form 2: [yyyy/mm/dd] [HH:MM:SS]</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3561" href="#"></a></td>
<td><pre>                String date = null, time = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3562" href="#"></a></td>
<td><pre>                if (len == 19) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3563" href="#"></a></td>
<td><pre>                    date = s.substring(0, 10);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3564" href="#"></a></td>
<td><pre>                    time = s.substring(11);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3565" href="#"></a></td>
<td><pre>                    if (s.charAt(10) != ' ')</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3566" href="#"></a></td>
<td><pre>                        throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3567" href="#"></a></td>
<td><pre>                } else if (len == 10) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3568" href="#"></a></td>
<td><pre>                    date = s;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3569" href="#"></a></td>
<td><pre>                } else if (len == 8) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3570" href="#"></a></td>
<td><pre>                    time = s;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3571" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3572" href="#"></a></td>
<td><pre>                    throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3573" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3574" href="#"></a></td>
<td><pre>                if (date != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3575" href="#"></a></td>
<td><pre>                    if (date.matches(&quot;\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3576" href="#"></a></td>
<td><pre>                        c.set(Integer.valueOf(date.substring(0, 4)),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3577" href="#"></a></td>
<td><pre>                                Integer.valueOf(date.substring(5, 7))-1,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3578" href="#"></a></td>
<td><pre>                                Integer.valueOf(date.substring(8, 10)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3579" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3580" href="#"></a></td>
<td><pre>                        throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3581" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3582" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3583" href="#"></a></td>
<td><pre>                if (time != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3584" href="#"></a></td>
<td><pre>                    if (time.matches(&quot;\\d\\d:\\d\\d:\\d\\d&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3585" href="#"></a></td>
<td><pre>                        c.set(Calendar.HOUR_OF_DAY, Integer.valueOf(time.substring(0, 2)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3586" href="#"></a></td>
<td><pre>                        c.set(Calendar.MINUTE, Integer.valueOf(time.substring(0, 2)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3587" href="#"></a></td>
<td><pre>                        c.set(Calendar.SECOND, Integer.valueOf(time.substring(0, 2)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3588" href="#"></a></td>
<td><pre>                        c.set(Calendar.MILLISECOND, 0);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3589" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3590" href="#"></a></td>
<td><pre>                        throw ioe;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3591" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3592" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3593" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3594" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3595" href="#"></a></td>
<td><pre>        return c.getTime();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3596" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3597" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3598" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3599" href="#"></a></td>
<td><pre>     * Match a command (may be abbreviated) with a command set.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3600" href="#"></a></td>
<td><pre>     * @param s the command provided</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3601" href="#"></a></td>
<td><pre>     * @param list the legal command set. If there is a null, commands after it</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3602" href="#"></a></td>
<td><pre>     * are regarded experimental, which means they are supported but their</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3603" href="#"></a></td>
<td><pre>     * existence should not be revealed to user.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3604" href="#"></a></td>
<td><pre>     * @return the position of a single match, or -1 if none matched</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3605" href="#"></a></td>
<td><pre>     * @throws Exception if s is ambiguous</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3606" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3607" href="#"></a></td>
<td><pre>    private static int oneOf(String s, String... list) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3608" href="#"></a></td>
<td><pre>        int[] match = new int[list.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3609" href="#"></a></td>
<td><pre>        int nmatch = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3610" href="#"></a></td>
<td><pre>        int experiment = Integer.MAX_VALUE;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3611" href="#"></a></td>
<td><pre>        for (int i = 0; i&lt;list.length; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3612" href="#"></a></td>
<td><pre>            String one = list[i];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3613" href="#"></a></td>
<td><pre>            if (one == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3614" href="#"></a></td>
<td><pre>                experiment = i;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3615" href="#"></a></td>
<td><pre>                continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3616" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3617" href="#"></a></td>
<td><pre>            if (one.toLowerCase(Locale.ENGLISH)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3618" href="#"></a></td>
<td><pre>                    .startsWith(s.toLowerCase(Locale.ENGLISH))) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3619" href="#"></a></td>
<td><pre>                match[nmatch++] = i;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3620" href="#"></a></td>
<td><pre>            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3621" href="#"></a></td>
<td><pre>                StringBuffer sb = new StringBuffer();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3622" href="#"></a></td>
<td><pre>                boolean first = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3623" href="#"></a></td>
<td><pre>                for (char c: one.toCharArray()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3624" href="#"></a></td>
<td><pre>                    if (first) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3625" href="#"></a></td>
<td><pre>                        sb.append(c);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3626" href="#"></a></td>
<td><pre>                        first = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3627" href="#"></a></td>
<td><pre>                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3628" href="#"></a></td>
<td><pre>                        if (!Character.isLowerCase(c)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3629" href="#"></a></td>
<td><pre>                            sb.append(c);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3630" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3631" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3632" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3633" href="#"></a></td>
<td><pre>                if (sb.toString().equalsIgnoreCase(s)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3634" href="#"></a></td>
<td><pre>                    match[nmatch++] = i;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3635" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3636" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3637" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3638" href="#"></a></td>
<td><pre>        if (nmatch == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3639" href="#"></a></td>
<td><pre>            return -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3640" href="#"></a></td>
<td><pre>        } else if (nmatch == 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3641" href="#"></a></td>
<td><pre>            return match[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3642" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3643" href="#"></a></td>
<td><pre>            // If multiple matches is in experimental commands, ignore them</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3644" href="#"></a></td>
<td><pre>            if (match[1] &gt; experiment) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3645" href="#"></a></td>
<td><pre>                return match[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3646" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3647" href="#"></a></td>
<td><pre>            StringBuffer sb = new StringBuffer();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3648" href="#"></a></td>
<td><pre>            MessageFormat form = new MessageFormat(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3649" href="#"></a></td>
<td><pre>                (&quot;command.{0}.is.ambiguous.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3650" href="#"></a></td>
<td><pre>            Object[] source = {s};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3651" href="#"></a></td>
<td><pre>            sb.append(form.format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3652" href="#"></a></td>
<td><pre>            sb.append(&quot;\n    &quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3653" href="#"></a></td>
<td><pre>            for (int i=0; i&lt;nmatch &amp;&amp; match[i]&lt;experiment; i++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3654" href="#"></a></td>
<td><pre>                sb.append(' ');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3655" href="#"></a></td>
<td><pre>                sb.append(list[match[i]]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3656" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3657" href="#"></a></td>
<td><pre>            throw new Exception(sb.toString());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3658" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3659" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3660" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3661" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3662" href="#"></a></td>
<td><pre>     * Create a GeneralName object from known types</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3663" href="#"></a></td>
<td><pre>     * @param t one of 5 known types</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3664" href="#"></a></td>
<td><pre>     * @param v value</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3665" href="#"></a></td>
<td><pre>     * @return which one</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3666" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3667" href="#"></a></td>
<td><pre>    private GeneralName createGeneralName(String t, String v)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3668" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3669" href="#"></a></td>
<td><pre>        GeneralNameInterface gn;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3670" href="#"></a></td>
<td><pre>        int p = oneOf(t, &quot;EMAIL&quot;, &quot;URI&quot;, &quot;DNS&quot;, &quot;IP&quot;, &quot;OID&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3671" href="#"></a></td>
<td><pre>        if (p &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3672" href="#"></a></td>
<td><pre>            throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3673" href="#"></a></td>
<td><pre>                    &quot;Unrecognized.GeneralName.type.&quot;) + t);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3674" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3675" href="#"></a></td>
<td><pre>        switch (p) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3676" href="#"></a></td>
<td><pre>            case 0: gn = new RFC822Name(v); break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3677" href="#"></a></td>
<td><pre>            case 1: gn = new URIName(v); break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3678" href="#"></a></td>
<td><pre>            case 2: gn = new DNSName(v); break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3679" href="#"></a></td>
<td><pre>            case 3: gn = new IPAddressName(v); break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3680" href="#"></a></td>
<td><pre>            default: gn = new OIDName(v); break; //4</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3681" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3682" href="#"></a></td>
<td><pre>        return new GeneralName(gn);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3683" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3684" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3685" href="#"></a></td>
<td><pre>    private static final String[] extSupported = {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3686" href="#"></a></td>
<td><pre>                        &quot;BasicConstraints&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3687" href="#"></a></td>
<td><pre>                        &quot;KeyUsage&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3688" href="#"></a></td>
<td><pre>                        &quot;ExtendedKeyUsage&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3689" href="#"></a></td>
<td><pre>                        &quot;SubjectAlternativeName&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3690" href="#"></a></td>
<td><pre>                        &quot;IssuerAlternativeName&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3691" href="#"></a></td>
<td><pre>                        &quot;SubjectInfoAccess&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3692" href="#"></a></td>
<td><pre>                        &quot;AuthorityInfoAccess&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3693" href="#"></a></td>
<td><pre>                        null,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3694" href="#"></a></td>
<td><pre>                        &quot;CRLDistributionPoints&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3695" href="#"></a></td>
<td><pre>    };</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3696" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3697" href="#"></a></td>
<td><pre>    private ObjectIdentifier findOidForExtName(String type)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3698" href="#"></a></td>
<td><pre>            throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3699" href="#"></a></td>
<td><pre>        switch (oneOf(type, extSupported)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3700" href="#"></a></td>
<td><pre>            case 0: return PKIXExtensions.BasicConstraints_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3701" href="#"></a></td>
<td><pre>            case 1: return PKIXExtensions.KeyUsage_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3702" href="#"></a></td>
<td><pre>            case 2: return PKIXExtensions.ExtendedKeyUsage_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3703" href="#"></a></td>
<td><pre>            case 3: return PKIXExtensions.SubjectAlternativeName_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3704" href="#"></a></td>
<td><pre>            case 4: return PKIXExtensions.IssuerAlternativeName_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3705" href="#"></a></td>
<td><pre>            case 5: return PKIXExtensions.SubjectInfoAccess_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3706" href="#"></a></td>
<td><pre>            case 6: return PKIXExtensions.AuthInfoAccess_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3707" href="#"></a></td>
<td><pre>            case 8: return PKIXExtensions.CRLDistributionPoints_Id;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3708" href="#"></a></td>
<td><pre>            default: return new ObjectIdentifier(type);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3709" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3710" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3711" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3712" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3713" href="#"></a></td>
<td><pre>     * Create X509v3 extensions from a string representation. Note that the</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3714" href="#"></a></td>
<td><pre>     * SubjectKeyIdentifierExtension will always be created non-critical besides</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3715" href="#"></a></td>
<td><pre>     * the extension requested in the &lt;code&gt;extstr&lt;/code&gt; argument.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3716" href="#"></a></td>
<td><pre>     *</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3717" href="#"></a></td>
<td><pre>     * @param reqex the requested extensions, can be null, used for -gencert</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3718" href="#"></a></td>
<td><pre>     * @param ext the original extensions, can be null, used for -selfcert</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3719" href="#"></a></td>
<td><pre>     * @param extstrs -ext values, Read keytool doc</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3720" href="#"></a></td>
<td><pre>     * @param pkey the public key for the certificate</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3721" href="#"></a></td>
<td><pre>     * @param akey the public key for the authority (issuer)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3722" href="#"></a></td>
<td><pre>     * @return the created CertificateExtensions</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3723" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3724" href="#"></a></td>
<td><pre>    private CertificateExtensions createV3Extensions(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3725" href="#"></a></td>
<td><pre>            CertificateExtensions reqex,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3726" href="#"></a></td>
<td><pre>            CertificateExtensions ext,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3727" href="#"></a></td>
<td><pre>            List &lt;String&gt; extstrs,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3728" href="#"></a></td>
<td><pre>            PublicKey pkey,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3729" href="#"></a></td>
<td><pre>            PublicKey akey) throws Exception {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3730" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3731" href="#"></a></td>
<td><pre>        if (ext != null &amp;&amp; reqex != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3732" href="#"></a></td>
<td><pre>            // This should not happen</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3733" href="#"></a></td>
<td><pre>            throw new Exception(&quot;One of request and original should be null.&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3734" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3735" href="#"></a></td>
<td><pre>        if (ext == null) ext = new CertificateExtensions();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3736" href="#"></a></td>
<td><pre>        try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3737" href="#"></a></td>
<td><pre>            // name{:critical}{=value}</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3738" href="#"></a></td>
<td><pre>            // Honoring requested extensions</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3739" href="#"></a></td>
<td><pre>            if (reqex != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3740" href="#"></a></td>
<td><pre>                for(String extstr: extstrs) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3741" href="#"></a></td>
<td><pre>                    if (extstr.toLowerCase(Locale.ENGLISH).startsWith(&quot;honored=&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3742" href="#"></a></td>
<td><pre>                        List&lt;String&gt; list = Arrays.asList(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3743" href="#"></a></td>
<td><pre>                                extstr.toLowerCase(Locale.ENGLISH).substring(8).split(&quot;,&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3744" href="#"></a></td>
<td><pre>                        // First check existence of &quot;all&quot;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3745" href="#"></a></td>
<td><pre>                        if (list.contains(&quot;all&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3746" href="#"></a></td>
<td><pre>                            ext = reqex;    // we know ext was null</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3747" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3748" href="#"></a></td>
<td><pre>                        // one by one for others</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3749" href="#"></a></td>
<td><pre>                        for (String item: list) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3750" href="#"></a></td>
<td><pre>                            if (item.equals(&quot;all&quot;)) continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3751" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3752" href="#"></a></td>
<td><pre>                            // add or remove</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3753" href="#"></a></td>
<td><pre>                            boolean add = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3754" href="#"></a></td>
<td><pre>                            // -1, unchanged, 0 crtical, 1 non-critical</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3755" href="#"></a></td>
<td><pre>                            int action = -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3756" href="#"></a></td>
<td><pre>                            String type = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3757" href="#"></a></td>
<td><pre>                            if (item.startsWith(&quot;-&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3758" href="#"></a></td>
<td><pre>                                add = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3759" href="#"></a></td>
<td><pre>                                type = item.substring(1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3760" href="#"></a></td>
<td><pre>                            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3761" href="#"></a></td>
<td><pre>                                int colonpos = item.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3762" href="#"></a></td>
<td><pre>                                if (colonpos &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3763" href="#"></a></td>
<td><pre>                                    type = item.substring(0, colonpos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3764" href="#"></a></td>
<td><pre>                                    action = oneOf(item.substring(colonpos+1),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3765" href="#"></a></td>
<td><pre>                                            &quot;critical&quot;, &quot;non-critical&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3766" href="#"></a></td>
<td><pre>                                    if (action == -1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3767" href="#"></a></td>
<td><pre>                                        throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3768" href="#"></a></td>
<td><pre>                                            (&quot;Illegal.value.&quot;) + item);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3769" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3770" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3771" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3772" href="#"></a></td>
<td><pre>                            String n = reqex.getNameByOid(findOidForExtName(type));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3773" href="#"></a></td>
<td><pre>                            if (add) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3774" href="#"></a></td>
<td><pre>                                Extension e = reqex.get(n);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3775" href="#"></a></td>
<td><pre>                                if (!e.isCritical() &amp;&amp; action == 0</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3776" href="#"></a></td>
<td><pre>                                        || e.isCritical() &amp;&amp; action == 1) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3777" href="#"></a></td>
<td><pre>                                    e = Extension.newExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3778" href="#"></a></td>
<td><pre>                                            e.getExtensionId(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3779" href="#"></a></td>
<td><pre>                                            !e.isCritical(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3780" href="#"></a></td>
<td><pre>                                            e.getExtensionValue());</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3781" href="#"></a></td>
<td><pre>                                    ext.set(n, e);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3782" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3783" href="#"></a></td>
<td><pre>                            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3784" href="#"></a></td>
<td><pre>                                ext.delete(n);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3785" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3786" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3787" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3788" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3789" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3790" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3791" href="#"></a></td>
<td><pre>            for(String extstr: extstrs) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3792" href="#"></a></td>
<td><pre>                String name, value;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3793" href="#"></a></td>
<td><pre>                boolean isCritical = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3794" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3795" href="#"></a></td>
<td><pre>                int eqpos = extstr.indexOf('=');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3796" href="#"></a></td>
<td><pre>                if (eqpos &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3797" href="#"></a></td>
<td><pre>                    name = extstr.substring(0, eqpos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3798" href="#"></a></td>
<td><pre>                    value = extstr.substring(eqpos+1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3799" href="#"></a></td>
<td><pre>                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3800" href="#"></a></td>
<td><pre>                    name = extstr;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3801" href="#"></a></td>
<td><pre>                    value = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3802" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3803" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3804" href="#"></a></td>
<td><pre>                int colonpos = name.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3805" href="#"></a></td>
<td><pre>                if (colonpos &gt;= 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3806" href="#"></a></td>
<td><pre>                    if (oneOf(name.substring(colonpos+1), &quot;critical&quot;) == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3807" href="#"></a></td>
<td><pre>                        isCritical = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3808" href="#"></a></td>
<td><pre>                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3809" href="#"></a></td>
<td><pre>                    name = name.substring(0, colonpos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3810" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3811" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3812" href="#"></a></td>
<td><pre>                if (name.equalsIgnoreCase(&quot;honored&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3813" href="#"></a></td>
<td><pre>                    continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3814" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3815" href="#"></a></td>
<td><pre>                int exttype = oneOf(name, extSupported);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3816" href="#"></a></td>
<td><pre>                switch (exttype) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3817" href="#"></a></td>
<td><pre>                    case 0:     // BC</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3818" href="#"></a></td>
<td><pre>                        int pathLen = -1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3819" href="#"></a></td>
<td><pre>                        boolean isCA = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3820" href="#"></a></td>
<td><pre>                        if (value == null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3821" href="#"></a></td>
<td><pre>                            isCA = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3822" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3823" href="#"></a></td>
<td><pre>                            try {   // the abbr format</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3824" href="#"></a></td>
<td><pre>                                pathLen = Integer.parseInt(value);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3825" href="#"></a></td>
<td><pre>                                isCA = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3826" href="#"></a></td>
<td><pre>                            } catch (NumberFormatException ufe) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3827" href="#"></a></td>
<td><pre>                                // ca:true,pathlen:1</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3828" href="#"></a></td>
<td><pre>                                for (String part: value.split(&quot;,&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3829" href="#"></a></td>
<td><pre>                                    String[] nv = part.split(&quot;:&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3830" href="#"></a></td>
<td><pre>                                    if (nv.length != 2) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3831" href="#"></a></td>
<td><pre>                                        throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3832" href="#"></a></td>
<td><pre>                                                (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3833" href="#"></a></td>
<td><pre>                                    } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3834" href="#"></a></td>
<td><pre>                                        if (nv[0].equalsIgnoreCase(&quot;ca&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3835" href="#"></a></td>
<td><pre>                                            isCA = Boolean.parseBoolean(nv[1]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3836" href="#"></a></td>
<td><pre>                                        } else if (nv[0].equalsIgnoreCase(&quot;pathlen&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3837" href="#"></a></td>
<td><pre>                                            pathLen = Integer.parseInt(nv[1]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3838" href="#"></a></td>
<td><pre>                                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3839" href="#"></a></td>
<td><pre>                                            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3840" href="#"></a></td>
<td><pre>                                                (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3841" href="#"></a></td>
<td><pre>                                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3842" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3843" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3844" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3845" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3846" href="#"></a></td>
<td><pre>                        ext.set(BasicConstraintsExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3847" href="#"></a></td>
<td><pre>                                new BasicConstraintsExtension(isCritical, isCA,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3848" href="#"></a></td>
<td><pre>                                pathLen));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3849" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3850" href="#"></a></td>
<td><pre>                    case 1:     // KU</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3851" href="#"></a></td>
<td><pre>                        if(value != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3852" href="#"></a></td>
<td><pre>                            boolean[] ok = new boolean[9];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3853" href="#"></a></td>
<td><pre>                            for (String s: value.split(&quot;,&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3854" href="#"></a></td>
<td><pre>                                int p = oneOf(s,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3855" href="#"></a></td>
<td><pre>                                       &quot;digitalSignature&quot;,  // (0),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3856" href="#"></a></td>
<td><pre>                                       &quot;nonRepudiation&quot;,    // (1)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3857" href="#"></a></td>
<td><pre>                                       &quot;keyEncipherment&quot;,   // (2),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3858" href="#"></a></td>
<td><pre>                                       &quot;dataEncipherment&quot;,  // (3),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3859" href="#"></a></td>
<td><pre>                                       &quot;keyAgreement&quot;,      // (4),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3860" href="#"></a></td>
<td><pre>                                       &quot;keyCertSign&quot;,       // (5),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3861" href="#"></a></td>
<td><pre>                                       &quot;cRLSign&quot;,           // (6),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3862" href="#"></a></td>
<td><pre>                                       &quot;encipherOnly&quot;,      // (7),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3863" href="#"></a></td>
<td><pre>                                       &quot;decipherOnly&quot;,      // (8)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3864" href="#"></a></td>
<td><pre>                                       &quot;contentCommitment&quot;  // also (1)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3865" href="#"></a></td>
<td><pre>                                       );</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3866" href="#"></a></td>
<td><pre>                                if (p &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3867" href="#"></a></td>
<td><pre>                                    throw new Exception(rb.getString(&quot;Unknown.keyUsage.type.&quot;) + s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3868" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3869" href="#"></a></td>
<td><pre>                                if (p == 9) p = 1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3870" href="#"></a></td>
<td><pre>                                ok[p] = true;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3871" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3872" href="#"></a></td>
<td><pre>                            KeyUsageExtension kue = new KeyUsageExtension(ok);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3873" href="#"></a></td>
<td><pre>                            // The above KeyUsageExtension constructor does not</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3874" href="#"></a></td>
<td><pre>                            // allow isCritical value, so...</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3875" href="#"></a></td>
<td><pre>                            ext.set(KeyUsageExtension.NAME, Extension.newExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3876" href="#"></a></td>
<td><pre>                                    kue.getExtensionId(),</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3877" href="#"></a></td>
<td><pre>                                    isCritical,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3878" href="#"></a></td>
<td><pre>                                    kue.getExtensionValue()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3879" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3880" href="#"></a></td>
<td><pre>                            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3881" href="#"></a></td>
<td><pre>                                    (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3882" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3883" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3884" href="#"></a></td>
<td><pre>                    case 2:     // EKU</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3885" href="#"></a></td>
<td><pre>                        if(value != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3886" href="#"></a></td>
<td><pre>                            Vector&lt;ObjectIdentifier&gt; v = new Vector&lt;&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3887" href="#"></a></td>
<td><pre>                            for (String s: value.split(&quot;,&quot;)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3888" href="#"></a></td>
<td><pre>                                int p = oneOf(s,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3889" href="#"></a></td>
<td><pre>                                        &quot;anyExtendedKeyUsage&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3890" href="#"></a></td>
<td><pre>                                        &quot;serverAuth&quot;,       //1</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3891" href="#"></a></td>
<td><pre>                                        &quot;clientAuth&quot;,       //2</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3892" href="#"></a></td>
<td><pre>                                        &quot;codeSigning&quot;,      //3</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3893" href="#"></a></td>
<td><pre>                                        &quot;emailProtection&quot;,  //4</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3894" href="#"></a></td>
<td><pre>                                        &quot;&quot;,                 //5</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3895" href="#"></a></td>
<td><pre>                                        &quot;&quot;,                 //6</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3896" href="#"></a></td>
<td><pre>                                        &quot;&quot;,                 //7</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3897" href="#"></a></td>
<td><pre>                                        &quot;timeStamping&quot;,     //8</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3898" href="#"></a></td>
<td><pre>                                        &quot;OCSPSigning&quot;       //9</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3899" href="#"></a></td>
<td><pre>                                       );</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3900" href="#"></a></td>
<td><pre>                                if (p &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3901" href="#"></a></td>
<td><pre>                                    try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3902" href="#"></a></td>
<td><pre>                                        v.add(new ObjectIdentifier(s));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3903" href="#"></a></td>
<td><pre>                                    } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3904" href="#"></a></td>
<td><pre>                                        throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3905" href="#"></a></td>
<td><pre>                                                &quot;Unknown.extendedkeyUsage.type.&quot;) + s);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3906" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3907" href="#"></a></td>
<td><pre>                                } else if (p == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3908" href="#"></a></td>
<td><pre>                                    v.add(new ObjectIdentifier(&quot;2.5.29.37.0&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3909" href="#"></a></td>
<td><pre>                                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3910" href="#"></a></td>
<td><pre>                                    v.add(new ObjectIdentifier(&quot;1.3.6.1.5.5.7.3.&quot; + p));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3911" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3912" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3913" href="#"></a></td>
<td><pre>                            ext.set(ExtendedKeyUsageExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3914" href="#"></a></td>
<td><pre>                                    new ExtendedKeyUsageExtension(isCritical, v));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3915" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3916" href="#"></a></td>
<td><pre>                            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3917" href="#"></a></td>
<td><pre>                                    (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3918" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3919" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3920" href="#"></a></td>
<td><pre>                    case 3:     // SAN</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3921" href="#"></a></td>
<td><pre>                    case 4:     // IAN</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3922" href="#"></a></td>
<td><pre>                        if(value != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3923" href="#"></a></td>
<td><pre>                            String[] ps = value.split(&quot;,&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3924" href="#"></a></td>
<td><pre>                            GeneralNames gnames = new GeneralNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3925" href="#"></a></td>
<td><pre>                            for(String item: ps) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3926" href="#"></a></td>
<td><pre>                                colonpos = item.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3927" href="#"></a></td>
<td><pre>                                if (colonpos &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3928" href="#"></a></td>
<td><pre>                                    throw new Exception(&quot;Illegal item &quot; + item + &quot; in &quot; + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3929" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3930" href="#"></a></td>
<td><pre>                                String t = item.substring(0, colonpos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3931" href="#"></a></td>
<td><pre>                                String v = item.substring(colonpos+1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3932" href="#"></a></td>
<td><pre>                                gnames.add(createGeneralName(t, v));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3933" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3934" href="#"></a></td>
<td><pre>                            if (exttype == 3) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3935" href="#"></a></td>
<td><pre>                                ext.set(SubjectAlternativeNameExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3936" href="#"></a></td>
<td><pre>                                        new SubjectAlternativeNameExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3937" href="#"></a></td>
<td><pre>                                            isCritical, gnames));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3938" href="#"></a></td>
<td><pre>                            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3939" href="#"></a></td>
<td><pre>                                ext.set(IssuerAlternativeNameExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3940" href="#"></a></td>
<td><pre>                                        new IssuerAlternativeNameExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3941" href="#"></a></td>
<td><pre>                                            isCritical, gnames));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3942" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3943" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3944" href="#"></a></td>
<td><pre>                            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3945" href="#"></a></td>
<td><pre>                                    (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3946" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3947" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3948" href="#"></a></td>
<td><pre>                    case 5:     // SIA, always non-critical</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3949" href="#"></a></td>
<td><pre>                    case 6:     // AIA, always non-critical</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3950" href="#"></a></td>
<td><pre>                        if (isCritical) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3951" href="#"></a></td>
<td><pre>                            throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3952" href="#"></a></td>
<td><pre>                                    &quot;This.extension.cannot.be.marked.as.critical.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3953" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3954" href="#"></a></td>
<td><pre>                        if(value != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3955" href="#"></a></td>
<td><pre>                            List&lt;AccessDescription&gt; accessDescriptions =</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3956" href="#"></a></td>
<td><pre>                                    new ArrayList&lt;&gt;();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3957" href="#"></a></td>
<td><pre>                            String[] ps = value.split(&quot;,&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3958" href="#"></a></td>
<td><pre>                            for(String item: ps) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3959" href="#"></a></td>
<td><pre>                                colonpos = item.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3960" href="#"></a></td>
<td><pre>                                int colonpos2 = item.indexOf(':', colonpos+1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3961" href="#"></a></td>
<td><pre>                                if (colonpos &lt; 0 || colonpos2 &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3962" href="#"></a></td>
<td><pre>                                    throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3963" href="#"></a></td>
<td><pre>                                            (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3964" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3965" href="#"></a></td>
<td><pre>                                String m = item.substring(0, colonpos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3966" href="#"></a></td>
<td><pre>                                String t = item.substring(colonpos+1, colonpos2);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3967" href="#"></a></td>
<td><pre>                                String v = item.substring(colonpos2+1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3968" href="#"></a></td>
<td><pre>                                int p = oneOf(m,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3969" href="#"></a></td>
<td><pre>                                        &quot;&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3970" href="#"></a></td>
<td><pre>                                        &quot;ocsp&quot;,         //1</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3971" href="#"></a></td>
<td><pre>                                        &quot;caIssuers&quot;,    //2</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3972" href="#"></a></td>
<td><pre>                                        &quot;timeStamping&quot;, //3</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3973" href="#"></a></td>
<td><pre>                                        &quot;&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3974" href="#"></a></td>
<td><pre>                                        &quot;caRepository&quot;  //5</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3975" href="#"></a></td>
<td><pre>                                        );</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3976" href="#"></a></td>
<td><pre>                                ObjectIdentifier oid;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3977" href="#"></a></td>
<td><pre>                                if (p &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3978" href="#"></a></td>
<td><pre>                                    try {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3979" href="#"></a></td>
<td><pre>                                        oid = new ObjectIdentifier(m);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3980" href="#"></a></td>
<td><pre>                                    } catch (Exception e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3981" href="#"></a></td>
<td><pre>                                        throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3982" href="#"></a></td>
<td><pre>                                                &quot;Unknown.AccessDescription.type.&quot;) + m);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3983" href="#"></a></td>
<td><pre>                                    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3984" href="#"></a></td>
<td><pre>                                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3985" href="#"></a></td>
<td><pre>                                    oid = new ObjectIdentifier(&quot;1.3.6.1.5.5.7.48.&quot; + p);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3986" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3987" href="#"></a></td>
<td><pre>                                accessDescriptions.add(new AccessDescription(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3988" href="#"></a></td>
<td><pre>                                        oid, createGeneralName(t, v)));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3989" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3990" href="#"></a></td>
<td><pre>                            if (exttype == 5) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3991" href="#"></a></td>
<td><pre>                                ext.set(SubjectInfoAccessExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3992" href="#"></a></td>
<td><pre>                                        new SubjectInfoAccessExtension(accessDescriptions));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3993" href="#"></a></td>
<td><pre>                            } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3994" href="#"></a></td>
<td><pre>                                ext.set(AuthorityInfoAccessExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3995" href="#"></a></td>
<td><pre>                                        new AuthorityInfoAccessExtension(accessDescriptions));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3996" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3997" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3998" href="#"></a></td>
<td><pre>                            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="3999" href="#"></a></td>
<td><pre>                                    (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4000" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4001" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4002" href="#"></a></td>
<td><pre>                    case 8: // CRL, experimental, only support 1 distributionpoint</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4003" href="#"></a></td>
<td><pre>                        if(value != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4004" href="#"></a></td>
<td><pre>                            String[] ps = value.split(&quot;,&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4005" href="#"></a></td>
<td><pre>                            GeneralNames gnames = new GeneralNames();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4006" href="#"></a></td>
<td><pre>                            for(String item: ps) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4007" href="#"></a></td>
<td><pre>                                colonpos = item.indexOf(':');</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4008" href="#"></a></td>
<td><pre>                                if (colonpos &lt; 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4009" href="#"></a></td>
<td><pre>                                    throw new Exception(&quot;Illegal item &quot; + item + &quot; in &quot; + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4010" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4011" href="#"></a></td>
<td><pre>                                String t = item.substring(0, colonpos);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4012" href="#"></a></td>
<td><pre>                                String v = item.substring(colonpos+1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4013" href="#"></a></td>
<td><pre>                                gnames.add(createGeneralName(t, v));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4014" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4015" href="#"></a></td>
<td><pre>                            ext.set(CRLDistributionPointsExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4016" href="#"></a></td>
<td><pre>                                    new CRLDistributionPointsExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4017" href="#"></a></td>
<td><pre>                                        isCritical, Collections.singletonList(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4018" href="#"></a></td>
<td><pre>                                        new DistributionPoint(gnames, null, null))));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4019" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4020" href="#"></a></td>
<td><pre>                            throw new Exception(rb.getString</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4021" href="#"></a></td>
<td><pre>                                    (&quot;Illegal.value.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4022" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4023" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4024" href="#"></a></td>
<td><pre>                    case -1:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4025" href="#"></a></td>
<td><pre>                        ObjectIdentifier oid = new ObjectIdentifier(name);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4026" href="#"></a></td>
<td><pre>                        byte[] data = null;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4027" href="#"></a></td>
<td><pre>                        if (value != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4028" href="#"></a></td>
<td><pre>                            data = new byte[value.length() / 2 + 1];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4029" href="#"></a></td>
<td><pre>                            int pos = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4030" href="#"></a></td>
<td><pre>                            for (char c: value.toCharArray()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4031" href="#"></a></td>
<td><pre>                                int hex;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4032" href="#"></a></td>
<td><pre>                                if (c &gt;= '0' &amp;&amp; c &lt;= '9') {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4033" href="#"></a></td>
<td><pre>                                    hex = c - '0' ;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4034" href="#"></a></td>
<td><pre>                                } else if (c &gt;= 'A' &amp;&amp; c &lt;= 'F') {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4035" href="#"></a></td>
<td><pre>                                    hex = c - 'A' + 10;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4036" href="#"></a></td>
<td><pre>                                } else if (c &gt;= 'a' &amp;&amp; c &lt;= 'f') {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4037" href="#"></a></td>
<td><pre>                                    hex = c - 'a' + 10;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4038" href="#"></a></td>
<td><pre>                                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4039" href="#"></a></td>
<td><pre>                                    continue;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4040" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4041" href="#"></a></td>
<td><pre>                                if (pos % 2 == 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4042" href="#"></a></td>
<td><pre>                                    data[pos/2] = (byte)(hex &lt;&lt; 4);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4043" href="#"></a></td>
<td><pre>                                } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4044" href="#"></a></td>
<td><pre>                                    data[pos/2] += hex;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4045" href="#"></a></td>
<td><pre>                                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4046" href="#"></a></td>
<td><pre>                                pos++;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4047" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4048" href="#"></a></td>
<td><pre>                            if (pos % 2 != 0) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4049" href="#"></a></td>
<td><pre>                                throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4050" href="#"></a></td>
<td><pre>                                        &quot;Odd.number.of.hex.digits.found.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4051" href="#"></a></td>
<td><pre>                            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4052" href="#"></a></td>
<td><pre>                            data = Arrays.copyOf(data, pos/2);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4053" href="#"></a></td>
<td><pre>                        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4054" href="#"></a></td>
<td><pre>                            data = new byte[0];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4055" href="#"></a></td>
<td><pre>                        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4056" href="#"></a></td>
<td><pre>                        ext.set(oid.toString(), new Extension(oid, isCritical,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4057" href="#"></a></td>
<td><pre>                                new DerValue(DerValue.tag_OctetString, data)</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4058" href="#"></a></td>
<td><pre>                                        .toByteArray()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4059" href="#"></a></td>
<td><pre>                        break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4060" href="#"></a></td>
<td><pre>                    default:</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4061" href="#"></a></td>
<td><pre>                        throw new Exception(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4062" href="#"></a></td>
<td><pre>                                &quot;Unknown.extension.type.&quot;) + extstr);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4063" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4064" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4065" href="#"></a></td>
<td><pre>            // always non-critical</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4066" href="#"></a></td>
<td><pre>            ext.set(SubjectKeyIdentifierExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4067" href="#"></a></td>
<td><pre>                    new SubjectKeyIdentifierExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4068" href="#"></a></td>
<td><pre>                        new KeyIdentifier(pkey).getIdentifier()));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4069" href="#"></a></td>
<td><pre>            if (akey != null &amp;&amp; !pkey.equals(akey)) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4070" href="#"></a></td>
<td><pre>                ext.set(AuthorityKeyIdentifierExtension.NAME,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4071" href="#"></a></td>
<td><pre>                        new AuthorityKeyIdentifierExtension(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4072" href="#"></a></td>
<td><pre>                        new KeyIdentifier(akey), null, null));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4073" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4074" href="#"></a></td>
<td><pre>        } catch(IOException e) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4075" href="#"></a></td>
<td><pre>            throw new RuntimeException(e);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4076" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4077" href="#"></a></td>
<td><pre>        return ext;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4078" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4079" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4080" href="#"></a></td>
<td><pre>    /**</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4081" href="#"></a></td>
<td><pre>     * Prints the usage of this tool.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4082" href="#"></a></td>
<td><pre>     */</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4083" href="#"></a></td>
<td><pre>    private void usage() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4084" href="#"></a></td>
<td><pre>        if (command != null) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4085" href="#"></a></td>
<td><pre>            System.err.println(&quot;keytool &quot; + command +</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4086" href="#"></a></td>
<td><pre>                    rb.getString(&quot;.OPTION.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4087" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4088" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(command.description));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4089" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4090" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(&quot;Options.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4091" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4092" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4093" href="#"></a></td>
<td><pre>            // Left and right sides of the options list</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4094" href="#"></a></td>
<td><pre>            String[] left = new String[command.options.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4095" href="#"></a></td>
<td><pre>            String[] right = new String[command.options.length];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4096" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4097" href="#"></a></td>
<td><pre>            // Check if there's an unknown option</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4098" href="#"></a></td>
<td><pre>            boolean found = false;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4099" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4100" href="#"></a></td>
<td><pre>            // Length of left side of options list</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4101" href="#"></a></td>
<td><pre>            int lenLeft = 0;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4102" href="#"></a></td>
<td><pre>            for (int j=0; j&lt;left.length; j++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4103" href="#"></a></td>
<td><pre>                Option opt = command.options[j];</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4104" href="#"></a></td>
<td><pre>                left[j] = opt.toString();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4105" href="#"></a></td>
<td><pre>                if (opt.arg != null) left[j] += &quot; &quot; + opt.arg;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4106" href="#"></a></td>
<td><pre>                if (left[j].length() &gt; lenLeft) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4107" href="#"></a></td>
<td><pre>                    lenLeft = left[j].length();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4108" href="#"></a></td>
<td><pre>                }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4109" href="#"></a></td>
<td><pre>                right[j] = rb.getString(opt.description);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4110" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4111" href="#"></a></td>
<td><pre>            for (int j=0; j&lt;left.length; j++) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4112" href="#"></a></td>
<td><pre>                System.err.printf(&quot; %-&quot; + lenLeft + &quot;s  %s\n&quot;,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4113" href="#"></a></td>
<td><pre>                        left[j], right[j]);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4114" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4115" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4116" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4117" href="#"></a></td>
<td><pre>                    &quot;Use.keytool.help.for.all.available.commands&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4118" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4119" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4120" href="#"></a></td>
<td><pre>                    &quot;Key.and.Certificate.Management.Tool&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4121" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4122" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(&quot;Commands.&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4123" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4124" href="#"></a></td>
<td><pre>            for (Command c: Command.values()) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4125" href="#"></a></td>
<td><pre>                if (c == KEYCLONE) break;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4126" href="#"></a></td>
<td><pre>                System.err.printf(&quot; %-20s%s\n&quot;, c, rb.getString(c.description));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4127" href="#"></a></td>
<td><pre>            }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4128" href="#"></a></td>
<td><pre>            System.err.println();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4129" href="#"></a></td>
<td><pre>            System.err.println(rb.getString(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4130" href="#"></a></td>
<td><pre>                    &quot;Use.keytool.command.name.help.for.usage.of.command.name&quot;));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4131" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4132" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4133" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4134" href="#"></a></td>
<td><pre>    private void tinyHelp() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4135" href="#"></a></td>
<td><pre>        usage();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4136" href="#"></a></td>
<td><pre>        if (debug) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4137" href="#"></a></td>
<td><pre>            throw new RuntimeException(&quot;NO BIG ERROR, SORRY&quot;);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4138" href="#"></a></td>
<td><pre>        } else {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4139" href="#"></a></td>
<td><pre>            System.exit(1);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4140" href="#"></a></td>
<td><pre>        }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4141" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4142" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4143" href="#"></a></td>
<td><pre>    private void errorNeedArgument(String flag) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4144" href="#"></a></td>
<td><pre>        Object[] source = {flag};</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4145" href="#"></a></td>
<td><pre>        System.err.println(new MessageFormat(</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4146" href="#"></a></td>
<td><pre>                rb.getString(&quot;Command.option.flag.needs.an.argument.&quot;)).format(source));</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4147" href="#"></a></td>
<td><pre>        tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4148" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4149" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4150" href="#"></a></td>
<td><pre>    private char[] getPass(String modifier, String arg) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4151" href="#"></a></td>
<td><pre>        char[] output = KeyStoreUtil.getPassWithModifier(modifier, arg, rb);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4152" href="#"></a></td>
<td><pre>        if (output != null) return output;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4153" href="#"></a></td>
<td><pre>        tinyHelp();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4154" href="#"></a></td>
<td><pre>        return null;    // Useless, tinyHelp() already exits.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4155" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4156" href="#"></a></td>
<td><pre>}</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4157" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4158" href="#"></a></td>
<td><pre>// This class is exactly the same as com.sun.tools.javac.util.Pair,</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4159" href="#"></a></td>
<td><pre>// it's copied here since the original one is not included in JRE.</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4160" href="#"></a></td>
<td><pre>class Pair&lt;A, B&gt; {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4161" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4162" href="#"></a></td>
<td><pre>    public final A fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4163" href="#"></a></td>
<td><pre>    public final B snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4164" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4165" href="#"></a></td>
<td><pre>    public Pair(A fst, B snd) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4166" href="#"></a></td>
<td><pre>        this.fst = fst;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4167" href="#"></a></td>
<td><pre>        this.snd = snd;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4168" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4169" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4170" href="#"></a></td>
<td><pre>    public String toString() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4171" href="#"></a></td>
<td><pre>        return &quot;Pair[&quot; + fst + &quot;,&quot; + snd + &quot;]&quot;;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4172" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4173" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4174" href="#"></a></td>
<td><pre>    public boolean equals(Object other) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4175" href="#"></a></td>
<td><pre>        return</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4176" href="#"></a></td>
<td><pre>            other instanceof Pair &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4177" href="#"></a></td>
<td><pre>            Objects.equals(fst, ((Pair)other).fst) &amp;&amp;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4178" href="#"></a></td>
<td><pre>            Objects.equals(snd, ((Pair)other).snd);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4179" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4180" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4181" href="#"></a></td>
<td><pre>    public int hashCode() {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4182" href="#"></a></td>
<td><pre>        if (fst == null) return (snd == null) ? 0 : snd.hashCode() + 1;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4183" href="#"></a></td>
<td><pre>        else if (snd == null) return fst.hashCode() + 2;</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4184" href="#"></a></td>
<td><pre>        else return fst.hashCode() * 17 + snd.hashCode();</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4185" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4186" href="#"></a></td>
<td><pre></pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4187" href="#"></a></td>
<td><pre>    public static &lt;A,B&gt; Pair&lt;A,B&gt; of(A a, B b) {</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4188" href="#"></a></td>
<td><pre>        return new Pair&lt;&gt;(a,b);</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4189" href="#"></a></td>
<td><pre>    }</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4190" href="#"></a></td>
<td><pre>}</pre></td>
</tr>
<tr>
<td><a class="linenum-cell" data-linenum="4191" href="#"></a></td>
<td><pre></pre></td>
</tr>
</table>
</body>
</html>
