<html>
    <head>
        <link rel="stylesheet" type="text/css" href="/css/styles.css"/>
    </head>
<body>
<pre class="code">
/*
 * Copyright (c) 2005, 2013, Oracle and/or its affiliates. All rights reserved.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This code is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License version 2 only, as
 * published by the Free Software Foundation.  Oracle designates this
 * particular file as subject to the &quot;Classpath&quot; exception as provided
 * by Oracle in the LICENSE file that accompanied this code.
 *
 * This code is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
 * version 2 for more details (a copy is included in the LICENSE file that
 * accompanied this code).
 *
 * You should have received a copy of the GNU General Public License version
 * 2 along with this work; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Please contact Oracle, 500 Oracle Parkway, Redwood Shores, CA 94065 USA
 * or visit www.oracle.com if you need additional information or have any
 * questions.
 */

package sun.tools.jstack;

import java.lang.reflect.Method;
import java.lang.reflect.Constructor;
import java.io.IOException;
import java.io.InputStream;

import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.AttachNotSupportedException;
import sun.tools.attach.HotSpotVirtualMachine;

/*
 * This class is the main class for the JStack utility. It parses its arguments
 * and decides if the command should be executed by the SA JStack tool or by
 * obtained the thread dump from a target process using the VM attach mechanism
 */
public class JStack {
    public static void main(String[] args) throws Exception {
        if (args.length == 0) {
            usage(1); // no arguments
        }

        boolean useSA = false;
        boolean mixed = false;
        boolean locks = false;

        // Parse the options (arguments starting with &quot;-&quot; )
        int optionCount = 0;
        while (optionCount &lt; args.length) {
            String arg = args[optionCount];
            if (!arg.startsWith(&quot;-&quot;)) {
                break;
            }
            if (arg.equals(&quot;-help&quot;) || arg.equals(&quot;-h&quot;)) {
                usage(0);
            }
            else if (arg.equals(&quot;-F&quot;)) {
                useSA = true;
            }
            else {
                if (arg.equals(&quot;-m&quot;)) {
                    mixed = true;
                } else {
                    if (arg.equals(&quot;-l&quot;)) {
                       locks = true;
                    } else {
                        usage(1);
                    }
                }
            }
            optionCount++;
        }

        // mixed stack implies SA tool
        if (mixed) {
            useSA = true;
        }

        // Next we check the parameter count. If there are two parameters
        // we assume core file and executable so we use SA.
        int paramCount = args.length - optionCount;
        if (paramCount == 0 || paramCount &gt; 2) {
            usage(1);
        }
        if (paramCount == 2) {
            useSA = true;
        } else {
            // If we can't parse it as a pid then it must be debug server
            if (!args[optionCount].matches(&quot;[0-9]+&quot;)) {
                useSA = true;
            }
        }

        // now execute using the SA JStack tool or the built-in thread dumper
        if (useSA) {
            // parameters (&lt;pid&gt; or &lt;exe&gt; &lt;core&gt;
            String params[] = new String[paramCount];
            for (int i=optionCount; i&lt;args.length; i++ ){
                params[i-optionCount] = args[i];
            }
            runJStackTool(mixed, locks, params);
        } else {
            // pass -l to thread dump operation to get extra lock info
            String pid = args[optionCount];
            String params[];
            if (locks) {
                params = new String[] { &quot;-l&quot; };
            } else {
                params = new String[0];
            }
            runThreadDump(pid, params);
        }
    }


    // SA JStack tool
    private static void runJStackTool(boolean mixed, boolean locks, String args[]) throws Exception {
        Class&lt;?&gt; cl = loadSAClass();
        if (cl == null) {
            usage(1);            // SA not available
        }

        // JStack tool also takes -m and -l arguments
        if (mixed) {
            args = prepend(&quot;-m&quot;, args);
        }
        if (locks) {
            args = prepend(&quot;-l&quot;, args);
        }

        Class[] argTypes = { String[].class };
        Method m = cl.getDeclaredMethod(&quot;main&quot;, argTypes);

        Object[] invokeArgs = { args };
        m.invoke(null, invokeArgs);
    }

    // Returns sun.jvm.hotspot.tools.JStack if available, otherwise null.
    private static Class&lt;?&gt; loadSAClass() {
        //
        // Attempt to load JStack class - we specify the system class
        // loader so as to cater for development environments where
        // this class is on the boot class path but sa-jdi.jar is on
        // the system class path. Once the JDK is deployed then both
        // tools.jar and sa-jdi.jar are on the system class path.
        //
        try {
            return Class.forName(&quot;sun.jvm.hotspot.tools.JStack&quot;, true,
                                 ClassLoader.getSystemClassLoader());
        } catch (Exception x)  { }
        return null;
    }

    // Attach to pid and perform a thread dump
    private static void runThreadDump(String pid, String args[]) throws Exception {
        VirtualMachine vm = null;
        try {
            vm = VirtualMachine.attach(pid);
        } catch (Exception x) {
            String msg = x.getMessage();
            if (msg != null) {
                System.err.println(pid + &quot;: &quot; + msg);
            } else {
                x.printStackTrace();
            }
            if ((x instanceof AttachNotSupportedException) &amp;&amp;
                (loadSAClass() != null)) {
                System.err.println(&quot;The -F option can be used when the target &quot; +
                    &quot;process is not responding&quot;);
            }
            System.exit(1);
        }

        // Cast to HotSpotVirtualMachine as this is implementation specific
        // method.
        InputStream in = ((HotSpotVirtualMachine)vm).remoteDataDump((Object[])args);

        // read to EOF and just print output
        byte b[] = new byte[256];
        int n;
        do {
            n = in.read(b);
            if (n &gt; 0) {
                String s = new String(b, 0, n, &quot;UTF-8&quot;);
                System.out.print(s);
            }
        } while (n &gt; 0);
        in.close();
        vm.detach();
    }

    // return a new string array with arg as the first element
    private static String[] prepend(String arg, String args[]) {
        String[] newargs = new String[args.length+1];
        newargs[0] = arg;
        System.arraycopy(args, 0, newargs, 1, args.length);
        return newargs;
    }

    // print usage message
    private static void usage(int exit) {
        System.err.println(&quot;Usage:&quot;);
        System.err.println(&quot;    jstack [-l] &lt;pid&gt;&quot;);
        System.err.println(&quot;        (to connect to running process)&quot;);

        if (loadSAClass() != null) {
            System.err.println(&quot;    jstack -F [-m] [-l] &lt;pid&gt;&quot;);
            System.err.println(&quot;        (to connect to a hung process)&quot;);
            System.err.println(&quot;    jstack [-m] [-l] &lt;executable&gt; &lt;core&gt;&quot;);
            System.err.println(&quot;        (to connect to a core file)&quot;);
            System.err.println(&quot;    jstack [-m] [-l] [server_id@]&lt;remote server IP or hostname&gt;&quot;);
            System.err.println(&quot;        (to connect to a remote debug server)&quot;);
        }

        System.err.println(&quot;&quot;);
        System.err.println(&quot;Options:&quot;);

        if (loadSAClass() != null) {
            System.err.println(&quot;    -F  to force a thread dump. Use when jstack &lt;pid&gt; does not respond&quot; +
                &quot; (process is hung)&quot;);
            System.err.println(&quot;    -m  to print both java and native frames (mixed mode)&quot;);
        }

        System.err.println(&quot;    -l  long listing. Prints additional information about locks&quot;);
        System.err.println(&quot;    -h or -help to print this help message&quot;);
        System.exit(exit);
    }
}
</pre>
</body>
</html>
